<html>
<head>
<title>How to build a Trading bot with Python and SQlite.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Python和SQlite搭建交易机器人？</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/how-to-build-a-trading-bot-with-python-and-sqlite-5daeeda29451?source=collection_archive---------1-----------------------#2022-02-26">https://medium.com/coinmonks/how-to-build-a-trading-bot-with-python-and-sqlite-5daeeda29451?source=collection_archive---------1-----------------------#2022-02-26</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="53f4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">你好，欢迎来到另一篇关于python算法交易的文章。</p><p id="65cc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在<a class="ae jo" rel="noopener" href="/@shadyshfk/algorithmic-trading-a-beginners-guide-series-7ecb4cdd4281"> <strong class="is hu">上一篇文章</strong> </a>中我对算法交易做了一个浅显的介绍，我们开发了一个简单的交易机器人，</p><p id="7a5c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">今天，我们将开发另一个交易机器人，使用SQlite来保存数据并处理这些数据以执行交易。</p><h2 id="6954" class="jp jq ht bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj dt translated">让我们从连接币安和套接字管理器开始</h2><figure class="kl km kn ko fq kp fe ff paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="fe ff kk"><img src="../Images/7a1738004b852f7a5ca81941fd7820a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_mXmqS-37pWSR_SNW2ezlA.jpeg"/></div></div><figcaption class="kw kx fg fe ff ky kz bd b be z ek">websocket connection</figcaption></figure><p id="a397" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">WebSocket是一种通信协议，是客户端的web浏览器和服务器之间的双向连接全双工通信通道。</p><p id="361c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我正在使用Jupyter notebook、python和sqlite。</p><pre class="kl km kn ko fq la lb lc ld aw le dt"><span id="e34d" class="jp jq ht lb b fv lf lg l lh li">import pandas as pd<br/>!pip install python-binance<br/>from binance import Client<br/>from binance import BinanceSocketManager</span></pre><p id="2f35" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">导入熊猫，安装python币安，导入客户端和套接字管理器。</p><pre class="kl km kn ko fq la lb lc ld aw le dt"><span id="5d11" class="jp jq ht lb b fv lf lg l lh li">APIKEY= 'Your API Key'<br/>SECRETKEY = 'Your Secret Key'</span><span id="d332" class="jp jq ht lb b fv lj lg l lh li">client = Client(APIKEY,SECRETKEY)<br/>client.API_URL = '<a class="ae jo" href="https://testnet.binance.vision/api'" rel="noopener ugc nofollow" target="_blank">https://testnet.binance.vision/api'</a></span></pre><p id="2c1e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">获取API密钥和秘密密钥，将这两个密钥提供给客户端函数以建立连接。</p><p id="471e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">当事人。API_URL </strong> =这里我们提供了币安测试网的URL，用于测试网环境。</p><p id="5479" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">要生成API密钥和秘密密钥，请使用GitHub登录币安现场测试网络，并生成HMAC SHA256密钥。<br/>最后，用实际的键替换代码中的APIKEY和SECRETKEY变量。</p><pre class="kl km kn ko fq la lb lc ld aw le dt"><span id="dcba" class="jp jq ht lb b fv lf lg l lh li"><br/>from sqlalchemy import create_engine<br/>engine = create_engine(‘sqlite:///SqlDb.db’)</span></pre><p id="97bd" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">从<strong class="is hu">sqlalchemy</strong>(Python SQL toolkit和对象关系映射器)导入create_engine，然后定义新的数据库<strong class="is hu"> sqlDB.db. </strong></p><h2 id="51d1" class="jp jq ht bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj dt translated">使用币安套接字管理器获取数据</h2><p id="6316" class="pw-post-body-paragraph iq ir ht is b it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn hm dt translated">我将通过打印接收到的数据来测试币安套接字管理器连接。</p><pre class="kl km kn ko fq la lb lc ld aw le dt"><span id="f81d" class="jp jq ht lb b fv lf lg l lh li"><br/> bsm = BinanceSocketManager(client)<br/> ts = bsm.trade_socket(‘BTCUSDT’)<br/> await ts.__aenter__()<br/> msg = await ts.recv()<br/> print(msg)<br/></span><span id="9f0e" class="jp jq ht lb b fv lj lg l lh li">{‘e’: ‘trade’, ‘E’: 1645890024494, ‘s’: ‘BTCUSDT’, ‘t’: 1271100538, ‘p’: ‘39317.92000000’, ‘q’: ‘0.00051000’, ‘b’: 9560827435, ‘a’: 9560827538, ‘T’: 1645890024493, ‘m’: True, ‘M’: True}</span></pre><p id="27c2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在我们可以看到我们将收到什么，这是一个字典，其中<strong class="is hu">的'</strong>为<br/>货币<strong class="is hu">符号</strong>，<strong class="is hu"> p' </strong>为<strong class="is hu">价格</strong>和<strong class="is hu"> 'E' </strong>为<strong class="is hu">时间</strong>(UNIX格式)，这三个是我们关心的。</p><p id="9d23" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">下一步是获取实时数据流，并将这些数据发送给一个函数，以生成一个数据帧，我们将从后者开始。</p></div><div class="ab cl lp lq hb lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="hm hn ho hp hq"><pre class="kl km kn ko fq la lb lc ld aw le dt"><span id="1160" class="jp jq ht lb b fv lf lg l lh li"><br/>def dframe(msg):<br/> <br/> df = pd.DataFrame([msg])<br/> df = df.loc[:,[‘s’,’E’,’p’]] <br/> df.columns = [‘Symbol’,’Time’,’Price’]<br/> df.Price = df.Price.astype(float)<br/> df.set_index(‘Time’)</span><span id="3530" class="jp jq ht lb b fv lj lg l lh li"> return df</span></pre><p id="c961" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我定义了一个函数，它将接收到的字典，转换成熊猫数据帧切片符号，时间和价格。</p><pre class="kl km kn ko fq la lb lc ld aw le dt"><span id="555b" class="jp jq ht lb b fv lf lg l lh li"><br/>while True:<br/> bsm = BinanceSocketManager(client)<br/> ts = bsm.trade_socket(‘BTCUSDT’)<br/> await ts.__aenter__()<br/> msg = await ts.recv()<br/> frame = dframe(msg)<br/> frame.to_sql(‘BTCUSDT’,engine,if_exists=’append’,index=False)<br/> print(frame)</span></pre><p id="a956" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">为了获得数据流，我将无限循环地请求数据，在获得<strong class="is hu"> msg </strong>字典后，它将被发送到<strong class="is hu"> dframe </strong>函数以更新数据帧。</p><p id="eec4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">然后<strong class="is hu"> to_sql() </strong>将数据帧中存储的记录写入sql数据库。</p><p id="4b9f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这就是这个无限循环的输出，每秒钟用接收到的数据更新一个数据帧，并将记录写入SQl数据库中的BTCUSDT表。</p><pre class="kl km kn ko fq la lb lc ld aw le dt"><span id="f6b6" class="jp jq ht lb b fv lf lg l lh li">   Symbol           Time     Price<br/>0  BTCUSDT  1645891574400  39268.11<br/>    Symbol           Time     Price<br/>0  BTCUSDT  1645891576796  39268.89<br/>    Symbol           Time     Price<br/>0  BTCUSDT  1645891578340  39262.33<br/>    Symbol           Time     Price<br/>0  BTCUSDT  1645891579856  39262.33<br/>    Symbol           Time     Price<br/>0  BTCUSDT  1645891581334  39262.32<br/>    Symbol           Time    Price<br/>0  BTCUSDT  1645891582679  39250.4<br/>    Symbol           Time    Price<br/>0  BTCUSDT  1645891584140  39250.4<br/>    Symbol           Time     Price<br/>0  BTCUSDT  1645891585365  39250.39<br/>    Symbol           Time     Price<br/>0  BTCUSDT  1645891586707  39258.25<br/>    Symbol           Time    Price<br/>0  BTCUSDT  1645891587986  39262.4<br/>    Symbol           Time    Price<br/>0  BTCUSDT  1645891589897  39262.4<br/>    Symbol           Time     Price<br/>0  BTCUSDT  1645891591257  39262.39<br/>    Symbol           Time     Price<br/>0  BTCUSDT  1645891593257  39253.68<br/>    Symbol           Time     Price<br/>0  BTCUSDT  1645891594699  39253.68<br/>    Symbol           Time     Price<br/>0  BTCUSDT  1645891596403  39253.68<br/>    Symbol           Time     Price<br/>0  BTCUSDT  1645891597752  39253.68<br/>    Symbol           Time     Price<br/>0  BTCUSDT  1645891599107  39253.69<br/>    Symbol           Time     Price</span></pre></div><div class="ab cl lp lq hb lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="hm hn ho hp hq"><p id="f282" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们画一个图来形象化btc价格。</p><pre class="kl km kn ko fq la lb lc ld aw le dt"><span id="ba7b" class="jp jq ht lb b fv lf lg l lh li">import matplotlib.pyplot as plt</span><span id="1401" class="jp jq ht lb b fv lj lg l lh li">df = pd.read_sql('BTCUSDT',engine)</span><span id="73d6" class="jp jq ht lb b fv lj lg l lh li">plt.figure(figsize=(15, 8))<br/>plt.plot(df.Price,color='red',label = "Price", linewidth = 2, marker='*', markerfacecolor='black',markersize=9)</span><span id="694a" class="jp jq ht lb b fv lj lg l lh li">plt.title('BTC Price', color='black',size=20)<br/>plt.ylabel('Price', color='blue',size=16)<br/>plt.xlabel('no of records', color='blue',size=16)<br/>plt.legend()</span></pre><figure class="kl km kn ko fq kp fe ff paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="fe ff lw"><img src="../Images/10db20c66363924bc368fd6db20e265a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J50IW2dP51viWXHrvlcdtw.png"/></div></div><figcaption class="kw kx fg fe ff ky kz bd b be z ek">BTC price plot</figcaption></figure><h2 id="d441" class="jp jq ht bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj dt translated">趋势跟踪策略</h2><p id="2119" class="pw-post-body-paragraph iq ir ht is b it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn hm dt translated">我将定义一个足够简单的趋势跟踪策略，即如果价格上涨了一个百分比(0.1%)，就买入；如果价格上涨或下跌了一个百分比(+0.2%，-0.2%)，就卖出。</p><pre class="kl km kn ko fq la lb lc ld aw le dt"><span id="7047" class="jp jq ht lb b fv lf lg l lh li">def strategy(in_position=False):<br/>    percen = 0.001<br/>    periods = 100<br/>    <br/>    <br/>    while True:<br/>        df = pd.read_sql('BTCUSDT', engine)<br/>        df1 = df.tail(periods)<br/>        cumret = (df1.Price.pct_change() + 1).cumprod() - 1<br/>        if not in_position:<br/>            if cumret[cumret.last_valid_index()] &gt; percen:<br/>                buyOrder = client.create_order(symbol='BTCUSDT', <br/>                                              side='BUY', <br/>                                              type='MARKET' ,<br/>                                              quantity=0.001)<br/>                print(buyOrder)<br/>                in_position = True<br/>                break<br/>   if in_position:<br/>        while True:<br/>            df = pd.read_sql('BTCUSDT', engine)<br/>            orderPrice = df.loc[df.Time &gt; buyOrder['transactTime']]</span><span id="0ccb" class="jp jq ht lb b fv lj lg l lh li">            if len(orderPrice) &gt; 1 :</span><span id="3e4f" class="jp jq ht lb b fv lj lg l lh li">                postionRet = <br/>                      (orderPrice.Price.pct_change()+1).cumprod()-1</span><span id="5f9a" class="jp jq ht lb b fv lj lg l lh li">                lastRet = postionRet[postionRet.last_valid_index()] <br/>                <br/>                if lastRet &gt; 0.002 or lastRet &lt; -0.002:</span><span id="478c" class="jp jq ht lb b fv lj lg l lh li">                    sellOrder =   <br/>                               client.create_order(symbol='BTCUSDT',<br/>                                                   side='SELL' ,<br/>                                                   type='MARKET' ,<br/>                                                   quantity=0.001 )</span><span id="ed46" class="jp jq ht lb b fv lj lg l lh li">                    print(sellOrder)            <br/>                    break</span></pre><p id="318b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">从计算最后一笔记录开始，计算累计回报，当累计回报超过一定比例时，就会触发买单，然后打破while循环。</p><p id="4d82" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">买入订单将返回一个包含交易时间的字典，因此，我们将从该时间开始对数据帧进行切片，并等待切片数据帧的累计回报超过或低于卖出百分比，然后将触发卖出订单。</p><h2 id="a925" class="jp jq ht bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj dt translated">执行交易的时间到了…</h2><p id="c909" class="pw-post-body-paragraph iq ir ht is b it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn hm dt translated">是时候调用策略函数了。</p><pre class="kl km kn ko fq la lb lc ld aw le dt"><span id="dc09" class="jp jq ht lb b fv lf lg l lh li">strategy()</span></pre><p id="8349" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们得到一个价格为39166.91的订单</p><h2 id="a50e" class="jp jq ht bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj dt translated"><strong class="ak">购买订单</strong></h2><pre class="kl km kn ko fq la lb lc ld aw le dt"><span id="f50c" class="jp jq ht lb b fv lf lg l lh li">`{‘symbol’: ‘BTCUSDT’, ‘orderId’: 10940581, ‘orderListId’: -1, ‘clientOrderId’: ‘XCAVbax0xaQxRs0erpds5P’, ‘transactTime’: 1645895549187, ‘price’: ‘0.00000000’, ‘origQty’: ‘0.00100000’, ‘executedQty’: ‘0.00100000’, ‘cummulativeQuoteQty’: ‘39.16691000’, ‘status’: ‘FILLED’, ‘timeInForce’: ‘GTC’, ‘type’: ‘MARKET’, ‘side’: ‘BUY’, ‘fills’: [{‘price’: ‘39166.91000000’, ‘qty’: ‘0.00100000’, ‘commission’: ‘0.00000000’, ‘commissionAsset’: ‘BTC’, ‘tradeId’: 3562682}]}`</span></pre><p id="d87b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们得到一个价格为39097.37的卖单</p><h2 id="1eef" class="jp jq ht bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj dt translated">卖出订单</h2><pre class="kl km kn ko fq la lb lc ld aw le dt"><span id="ac80" class="jp jq ht lb b fv lf lg l lh li">`{‘symbol’: ‘BTCUSDT’, ‘orderId’: 10945890, ‘orderListId’: -1, ‘clientOrderId’: ‘txnRsAuc1gcMs3aRiQ6YGc’, ‘transactTime’: 1645896773538, ‘price’: ‘0.00000000’, ‘origQty’: ‘0.00100000’, ‘executedQty’: ‘0.00100000’, ‘cummulativeQuoteQty’: ‘39.09737000’, ‘status’: ‘FILLED’, ‘timeInForce’: ‘GTC’, ‘type’: ‘MARKET’, ‘side’: ‘SELL’, ‘fills’: [{‘price’: ‘39097.37000000’, ‘qty’: ‘0.00100000’, ‘commission’: ‘0.00000000’, ‘commissionAsset’: ‘USDT’, ‘tradeId’: 3564175}]}`</span></pre><p id="5e48" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们的交易亏损了0.18，这个策略是有效的，当然，如果你了解交易，你就不会对亏损感到惊讶，因为你不可能每次都赢，你只是想有一个好的胜率，总的来说会有利润。</p><h2 id="5914" class="jp jq ht bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj dt translated">下一步是什么？！</h2><p id="1a10" class="pw-post-body-paragraph iq ir ht is b it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn hm dt translated">您可以通过更改参数或操纵策略来优化这个机器人，使它变得更好。</p><p id="c877" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我将在接下来的文章中分享更多</p><p id="bf05" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这就是这篇文章，我希望你最好的。</p><blockquote class="lx"><p id="7c06" class="ly lz ht bd ma mb mc md me mf mg jn ek translated">加入Coinmonks <a class="ae jo" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae jo" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><div class="mh mi mj mk ml mm"><a rel="noopener follow" target="_blank" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a"><div class="mn ab ej"><div class="mo ab mp cl cj mq"><h2 class="bd hu fv z el mr eo ep ms er et hs dt translated">加密交易机器人——21款最佳免费加密交易机器人</h2><div class="mt l"><h3 class="bd b fv z el mr eo ep ms er et ek translated">2022年币安、比特币基地、库币和其他密码交易所的最佳密码交易机器人。Pionex，Bitsgap…</h3></div><div class="mu l"><p class="bd b gc z el mr eo ep ms er et ek translated">medium.com</p></div></div><div class="mv l"><div class="mw l mx my mz mv na ku mm"/></div></div></a></div><div class="nb nc fm fo nd mm"><a href="https://coincodecap.com/free-crypto-portfolio-trackers" rel="noopener  ugc nofollow" target="_blank"><div class="mn ab ej"><div class="mo ab mp cl cj mq"><h2 class="bd hu fv z el mr eo ep ms er et hs dt translated">2022年5个最佳免费加密投资组合追踪器</h2><div class="mt l"><h3 class="bd b fv z el mr eo ep ms er et ek translated">在这篇文章中，我们将带你通过一些最好的免费加密投资组合追踪器，让你选择最好的…</h3></div><div class="mu l"><p class="bd b gc z el mr eo ep ms er et ek translated">coincodecap.com</p></div></div><div class="mv l"><div class="ne l mx my mz mv na ku mm"/></div></div></a></div></div></div>    
</body>
</html>