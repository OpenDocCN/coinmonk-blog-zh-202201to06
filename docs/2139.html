<html>
<head>
<title>Pricing Uniswap V3 NFT positions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Uniswap V3 NFT头寸定价</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/pricing-uniswap-v3-nft-positions-ad18608b8c81?source=collection_archive---------3-----------------------#2022-03-10">https://medium.com/coinmonks/pricing-uniswap-v3-nft-positions-ad18608b8c81?source=collection_archive---------3-----------------------#2022-03-10</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/adca6e3b26583f6d3e9ed12c8aaf96b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*KSPIsAbOz_x2MC9TVp045Q.gif"/></div></div><figcaption class="jb jc fg fe ff jd je bd b be z ek">Uniswap V3 NFT (Courtesy: Uniswap)</figcaption></figure><p id="ea73" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">Uniswap V3是多边形、以太坊、仲裁和乐观上最突出的dex。但即使在v3池中锁定了超过20亿美元的流动性，也没有多少平台可以利用你的NFT头寸借入资产，以防有人需要资产来投资一个新的闪亮的defi项目，或者进入完全的degen模式并利用同一个uniswap池。</p><p id="4a00" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">假设有两个令牌，令牌a和令牌b。任何2个令牌在uniswap上都可以有4个池，按其费用等级区分。为了正确地给v3 NFT定价，需要以当前价格获取NFT头寸的可用代币数量。在不同的价格下，代币的比例将根据用户提供流动性的范围而不同。可以从chainlink或twap oracle获取tokenA和tokenB的当前价格，假设价格分别为priceA和priceB。</p><pre class="kd ke kf kg fq kh ki kj kk aw kl dt"><span id="20c7" class="km kn ht ki b fv ko kp l kq kr">function getPrices(address tokenA, address tokenB) public view returns (uint priceA, uint priceB) {</span><span id="ec04" class="km kn ht ki b fv ks kp l kq kr">    uint _priceA = priceFeed.price(tokenA);<br/>    uint _priceB = priceFeed.price(tokenB);<br/>    <br/>    priceA = 1 * 10**IERC20(tokenA).decimals();<br/>    priceB = _priceB * IERC20(tokenB).decimals()/_priceA;</span><span id="9861" class="km kn ht ki b fv ks kp l kq kr">}</span></pre><p id="187a" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">这样得到的priceA和priceB是，如果tokenA的价格是1个单位，那么等价tokenB是多少，根据价格，它将帮助我们计算比率。</p><p id="0dd2" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">现在，我们计算用于在Uniswap V3中处理价格的<strong class="jh hu"> sqrtPriceX96 </strong>，首先我们需要计算价格比率的平方根，然后乘以2**96，将其转换为V3中使用的定点表示。</p><pre class="kd ke kf kg fq kh ki kj kk aw kl dt"><span id="7a89" class="km kn ht ki b fv ko kp l kq kr">function _sqrt(uint _x) internal pure returns(uint y) {<br/>    uint z = (_x + 1) / 2;<br/>    y = _x;<br/>    while (z &lt; y) {<br/>        y = z;<br/>        z = (_x / z + z) / 2;<br/>    }<br/>}</span><span id="d0c3" class="km kn ht ki b fv ks kp l kq kr">function getSqrtPriceX96(uint priceA, uint priceB) public view returns (uint) {<br/>    uint ratioX192 = (priceA &lt;&lt; 192) / priceB;<br/>    return _sqrt(ratioX192);<br/>}</span></pre><p id="0a25" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">因此，现在我们有了基于tokenA和tokenB的pricefeed价格的当前sqrtPriceX96。Uniswap V3池中的价格范围按分笔成交点划分，以管理分笔成交点之间的集中流动性。给定sqrtPriceX96，我们现在将计算价格的分笔成交点(这将是较低的分笔成交点)。可以使用Uniswap TickMath库获取，这里是相关函数的链接<a class="ae kt" href="https://docs.uniswap.org/protocol/reference/core/libraries/TickMath#gettickatsqrtratio" rel="noopener ugc nofollow" target="_blank">https://docs . unis WAP . org/protocol/reference/core/libraries/tick math # gettickatzqrtratio</a></p><pre class="kd ke kf kg fq kh ki kj kk aw kl dt"><span id="98c6" class="km kn ht ki b fv ko kp l kq kr">function getTick(uint160 sqrtPriceX96) public view returns (int24 tick) {<br/>    tick = TickMath.getTickAtSqrtRatio(sqrtPriceX96);<br/>}</span></pre><p id="544d" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">在获得分笔成交点后，我们将从Uniswap V3头寸管理器中获取头寸的下限、上限分笔成交点和流动性金额。使用此流动性数量、下限价格点、上限价格点和之前计算的价格点，根据我们头寸的价格计算当前价格点的tokenA和tokenB的数量，使用uni swap<a class="ae kt" href="https://docs.uniswap.org/protocol/reference/periphery/libraries/LiquidityAmounts#getamountsforliquidity" rel="noopener ugc nofollow" target="_blank">https://docs . uni swap . org/protocol/reference/periphery/libraries/LiquidityAmounts # getamountsforliquidity</a>提供的liquidity amounts库</p><pre class="kd ke kf kg fq kh ki kj kk aw kl dt"><span id="5e26" class="km kn ht ki b fv ko kp l kq kr">function tokenAmounts(int24 tick, uint tokenId) public view returns(uint amountA, uint amountB) {<br/>    (,,,,,int24 tickLower, int24 tickUpper,uint liquidity,,,uint128 feeA,uint128 feeB) = uniNFTPosManager.positions(tokenId);<br/>   (amountA, amountB) = LiquidityAmounts.getAmountsForLiquidity(<br/>      TickMath.getSqrtRatioAtTick(tick),<br/>      TickMath.getSqrtRatioAtTick(tickLower),<br/>      TickMath.getSqrtRatioAtTick(tickUpper),<br/>      liquidity<br/>    );<br/>}</span></pre><p id="1b81" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">现在我们有了当前价格头寸的tokenA和tokenB的数量，然后我们可以将它们各自的价格相乘，得到<strong class="jh hu"> V3 NFT头寸的实际价格。</strong></p><pre class="kd ke kf kg fq kh ki kj kk aw kl dt"><span id="10c3" class="km kn ht ki b fv ko kp l kq kr">function getActualPrice(uint amountA, uint amountB, address tokenA, address tokenB) public view returns (uint price) {</span><span id="4ac3" class="km kn ht ki b fv ks kp l kq kr">    price = amountA*priceFeed.price(tokenA) + amountB*priceFeed.price(tokenB);</span><span id="eef6" class="km kn ht ki b fv ks kp l kq kr">}</span></pre><p id="7fc4" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">现在，我们有了NFT代币的价格，我们可以用它来创造借贷市场或由Uniswap V3 NFT担保的稳定的货币。这是回购的链接，其中包含Uniswap V3 NFTs的定价代码<a class="ae kt" href="https://github.com/0xparashar/UniV3NFTOracle" rel="noopener ugc nofollow" target="_blank">https://github.com/0xparashar/UniV3NFTOracle</a></p><p id="a917" class="pw-post-body-paragraph jf jg ht jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">如果有什么问题，请在https://twitter.com/AnkitParashar的<a class="ae kt" href="https://twitter.com/AnkitParashar" rel="noopener ugc nofollow" target="_blank">给我打电话或者发一个公关。</a></p></div></div>    
</body>
</html>