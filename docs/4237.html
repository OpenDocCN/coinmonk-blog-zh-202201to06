<html>
<head>
<title>Capture The Ether: retirement fund</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">捕捉以太:退休基金</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/capture-the-ether-retirement-fund-f56f7bb2e4de?source=collection_archive---------9-----------------------#2022-04-06">https://medium.com/coinmonks/capture-the-ether-retirement-fund-f56f7bb2e4de?source=collection_archive---------9-----------------------#2022-04-06</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="425d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这个挑战的解决方案非常直接:等到部署者绝望到在10年过去之前撤回他们的资金，将其中的10%留给我们，或者等待这10年并希望他们记住所有这一切。</p><p id="0f22" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">太好了！在下一篇文章中，我们将解决——只是开个玩笑。一定有别的方法不用等那么久就能赢得挑战，对吧？</p><p id="4eba" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们看看合同:</p><figure class="jp jq jr js fq jt fe ff paragraph-image"><div role="button" tabindex="0" class="ju jv di jw bf jx"><div class="fe ff jo"><img src="../Images/08426b71b19aec2d8018fc678b67c53b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*4V4r4JHLLg0liAOrY7wgdQ.png"/></div></div></figure><p id="2810" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">一开始我有点搞不清楚谁是第<code class="eh ka kb kc kd b">beneficiary</code>和第<code class="eh ka kb kc kd b">msg.sender</code>。澄清一下，虽然我们是<em class="ke">部署</em>这个契约实例的人，但前者实际上是我们自己(用来部署契约的<em class="ke"> EOA </em>)，而后者是<em class="ke">捕获以太的</em>团队中的其他人(或任何人，但不是我们)。我们可以在T21的以太网上查找我们的合同。</p><p id="19c4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">好了，现在我们已经清楚了这一点，让我们开始挑战吧。</p><p id="58e6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">有三个<em class="ke">可调用(即具有公共可见性)</em>函数:</p><ul class=""><li id="9af9" class="kg kh ht is b it iu ix iy jb ki jf kj jj kk jn kl km kn ko dt translated"><code class="eh ka kb kc kd b">isComplete()</code>:返回一个<em class="ke">布尔值，如果合同余额为0则返回</em>T3，否则返回<code class="eh ka kb kc kd b">false</code>。当我们用构造函数发送<code class="eh ka kb kc kd b">1 ether</code>时，默认值是<code class="eh ka kb kc kd b">false</code>，我们需要通过某种方式耗尽它的余额来改变它。</li><li id="ad2e" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><code class="eh ka kb kc kd b">withdraw()</code>:只能被<code class="eh ka kb kc kd b">owner</code>调用，正如我们所见，那不是我们。所以我们可以忘记这个，我很确定<code class="eh ka kb kc kd b">owner</code>也会忘记它，也不会调用它。</li><li id="4022" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><code class="eh ka kb kc kd b">collectPenalty()</code>:只能由我们调用然后做简单计算:<code class="eh ka kb kc kd b">uint256 withdrawn = startBalance — address(this).balance</code>。</li></ul><p id="0e77" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们把重点放在最后一个功能上，看看有哪些可能性。</p><p id="bdfb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这里的两个变量是<code class="eh ka kb kc kd b">startBalance</code>和<code class="eh ka kb kc kd b">address(this).balance</code>，因此，基本的情况是…</p><p id="15fe" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">A.10年过去了，带走了<code class="eh ka kb kc kd b">0.9 ether</code>，离开了我们<code class="eh ka kb kc kd b">0.1 ether</code>。在这种情况下<code class="eh ka kb kc kd b">startBalance = 1</code> &amp; <code class="eh ka kb kc kd b">address(this).balance = 0</code>如此<code class="eh ka kb kc kd b">withdrawn = 1</code>。在<em class="ke">要求语句</em>下，该功能不会恢复，但没有要传输的内容<em class="ke">。</em></p><p id="31f1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">B.<code class="eh ka kb kc kd b">owner</code>呼唤<code class="eh ka kb kc kd b">withdraw</code><em class="ke">10年过去了，带走了<code class="eh ka kb kc kd b">1 ether</code>，什么也没留给我们。在这种情况下<code class="eh ka kb kc kd b">startBalance = 1</code> &amp; <code class="eh ka kb kc kd b">address(this).balance = 0</code>所以<code class="eh ka kb kc kd b">withdrawn = 1</code>。该功能不会回复到<em class="ke">要求语句</em>上，但是没有要传输的内容<em class="ke">。</em></em></p><p id="2c67" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">C.<code class="eh ka kb kc kd b">owner</code>根本不调用<code class="eh ka kb kc kd b">withdraw</code>。在这种情况下<code class="eh ka kb kc kd b">startBalance = 1</code> &amp; <code class="eh ka kb kc kd b">address(this).balance = 1</code>所以<code class="eh ka kb kc kd b">withdrawn = 0</code>。该功能回复到<em class="ke">要求语句。</em></p><p id="705c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">还有其他选择吗？<code class="eh ka kb kc kd b">startBalance</code>或者<code class="eh ka kb kc kd b">address(this).balance</code>能是别的吗？如果我们在合同中加入更多乙醚，使价格更高，会怎么样？</p><p id="79af" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在这种情况下，假设<code class="eh ka kb kc kd b">owner</code>永远不会调用<code class="eh ka kb kc kd b">withdraw()</code>，如选项<em class="ke"> C- </em>所示，局部变量<code class="eh ka kb kc kd b">withdrawn</code>将<em class="ke">下溢</em>并最终成为一个巨大的<a class="ae kf" rel="noopener" href="/coinmonks/eli5-uint256-in-solidity-a16f22942166"> 78位数的数字</a>，通过<em class="ke"> require语句</em>并向我们发送契约的余额，到那时将是<code class="eh ka kb kc kd b">1 ether</code>。</p><p id="2073" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">听起来不错，但是有一个问题:没有直接的方法向这个契约发送以太网，因为它没有<em class="ke"> fallback/receive或payable </em>函数。我们可以尝试低等级的<code class="eh ka kb kc kd b">call</code>、a <code class="eh ka kb kc kd b">transfer</code>或<code class="eh ka kb kc kd b">send</code>，但是它们都会因为这个原因而恢复。可以试试。</p><p id="0971" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">不过，有几种方法可以让一个人把乙醚强制送到合同中。</p></div><div class="ab cl ku kv hb kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="hm hn ho hp hq"><p id="32d4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们将用来解决我们的挑战的一个与<em class="ke">自毁</em>功能&amp;操作码有关，我们可以在<a class="ae kf" href="https://docs.soliditylang.org/en/develop/units-and-global-variables.html#contract-related" rel="noopener ugc nofollow" target="_blank">文档</a>中读到:</p><blockquote class="lb lc ld"><p id="40e3" class="iq ir ke is b it iu iv iw ix iy iz ja le jc jd je lf jg jh ji lg jk jl jm jn hm dt translated">销毁当前合同，将其资金发送到给定的<a class="ae kf" href="https://docs.soliditylang.org/en/develop/types.html#address" rel="noopener ugc nofollow" target="_blank">地址</a>并结束执行。注意<code class="eh ka kb kc kd b">selfdestruct</code>有一些继承自EVM的特性:</p><p id="a883" class="iq ir ke is b it iu iv iw ix iy iz ja le jc jd je lf jg jh ji lg jk jl jm jn hm dt translated">不执行接收合同的接收功能。</p><p id="51c1" class="iq ir ke is b it iu iv iw ix iy iz ja le jc jd je lf jg jh ji lg jk jl jm jn hm dt translated">合同只有在交易结束时才真正被销毁，而<code class="eh ka kb kc kd b">revert</code> s可能会“撤销”销毁。</p></blockquote><p id="e807" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在这个报价中特别重要的是这样一行内容，即合同的receive函数没有执行。这意味着它甚至不需要一个添加乙醚到它的平衡。</p><p id="405e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">除此之外，由于这个事务中使用的操作码<code class="eh ka kb kc kd b">SELFDESTRUCT</code>在EVM级别上工作，任何用于停止它的可靠性函数都不起作用，而<em class="ke">以太</em>无论如何都会通过。</p><p id="1fef" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">*你可以在这里阅读两种以太传力方式<a class="ae kf" href="https://consensys.github.io/smart-contract-best-practices/attacks/force-feeding/" rel="noopener ugc nofollow" target="_blank">。</a></p></div><div class="ab cl ku kv hb kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="hm hn ho hp hq"><p id="0491" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们继续并将它应用到挑战中:我们在这里需要做的是用一些以太(<em class="ke"> 1维</em>就足够了)和一个<code class="eh ka kb kc kd b">selfdestruct</code>函数创建一个带有挑战地址的契约，这样当我们调用它时，<em class="ke">天平</em>就会转到它那里，使它成为<code class="eh ka kb kc kd b">&gt; 1 ether</code>。一旦完成，我们可以调用<code class="eh ka kb kc kd b">collectPenalty()</code>，我们将为自己获得整个<em class="ke">余额</em>。</p><p id="3e9d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这是我写的<code class="eh ka kb kc kd b">Attacker contract</code>,我尽量保持简单:</p><figure class="jp jq jr js fq jt"><div class="bz el l di"><div class="lh li l"/></div></figure></div><div class="ab cl ku kv hb kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="hm hn ho hp hq"><p id="e261" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在我们知道了这个漏洞，我们需要记住的重要事情是，我们必须永远不要认为合同的余额是或将是零。包括 <code class="eh ka kb kc kd b"><em class="ke">address(this).balance == 0</em></code> <em class="ke">在内的任何情况都应该避免，因为以太随时都可能被强制送到它那里。</em></p><figure class="jp jq jr js fq jt fe ff paragraph-image"><div role="button" tabindex="0" class="ju jv di jw bf jx"><div class="fe ff lj"><img src="../Images/0d9282607ca4615b16da431ec3eab70d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fdNs2aCdtQTZPzGzSeN9pg.png"/></div></div></figure><p id="1ef6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在下一篇文章中，我们将解决<em class="ke">映射</em>挑战。</p><blockquote class="lk"><p id="b3a1" class="ll lm ht bd ln lo lp lq lr ls lt jn ek translated">加入Coinmonks <a class="ae kf" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae kf" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h1 id="10e7" class="lu lv ht bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr dt translated">另外，阅读</h1><ul class=""><li id="f1b8" class="kg kh ht is b it ms ix mt jb mu jf mv jj mw jn kl km kn ko dt translated"><a class="ae kf" href="https://coincodecap.com/ascendex-staking" rel="noopener ugc nofollow" target="_blank">AscendEx Staking</a>|<a class="ae kf" href="https://coincodecap.com/bot-ocean-review" rel="noopener ugc nofollow" target="_blank">Bot Ocean Review</a>|<a class="ae kf" href="https://coincodecap.com/bitcoin-wallets-india" rel="noopener ugc nofollow" target="_blank">最佳比特币钱包</a></li><li id="ac9b" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae kf" href="https://coincodecap.com/huobi-review" rel="noopener ugc nofollow" target="_blank">霍比审核</a> | <a class="ae kf" href="https://coincodecap.com/okex-margin-trading" rel="noopener ugc nofollow" target="_blank"> OKEx保证金交易</a> | <a class="ae kf" href="https://coincodecap.com/futures-trading" rel="noopener ugc nofollow" target="_blank">期货交易</a></li><li id="2037" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae kf" href="https://coincodecap.com/grid-trading" rel="noopener ugc nofollow" target="_blank">网格交易机器人</a> | <a class="ae kf" rel="noopener" href="/coinmonks/cryptohopper-review-a388ff5bae88"> Cryptohopper审查</a> | <a class="ae kf" href="https://coincodecap.com/bexplus-review" rel="noopener ugc nofollow" target="_blank"> Bexplus审查</a></li><li id="a290" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae kf" href="https://coincodecap.com/zero-fee-crypto-exchanges" rel="noopener ugc nofollow" target="_blank"> 7个最佳零费用加密交易平台</a></li><li id="dced" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae kf" href="https://coincodecap.com/anny-trade-review" rel="noopener ugc nofollow" target="_blank">氹欞侊贸易评论</a> | <a class="ae kf" rel="noopener" href="/coinmonks/huobi-margin-trading-b3b06cdc1519">霍比保证金交易</a></li><li id="a1c0" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae kf" href="https://coincodecap.com/what-are-decentralized-exchanges" rel="noopener ugc nofollow" target="_blank">分散交易所</a> | <a class="ae kf" href="https://coincodecap.com/bitbns-fip" rel="noopener ugc nofollow" target="_blank">比特FIP </a> | <a class="ae kf" href="https://coincodecap.com/pionex-review-exchange-with-crypto-trading-bot" rel="noopener ugc nofollow" target="_blank"> Pionex评论</a></li><li id="0ea5" class="kg kh ht is b it kp ix kq jb kr jf ks jj kt jn kl km kn ko dt translated"><a class="ae kf" href="https://coincodecap.com/buy-crypto-with-credit-card" rel="noopener ugc nofollow" target="_blank">用信用卡购买密码的10个最佳地点</a></li></ul></div></div>    
</body>
</html>