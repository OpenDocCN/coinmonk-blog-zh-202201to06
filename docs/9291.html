<html>
<head>
<title>How to Implement Gasless Transactions? — KryptoMind</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何实现无气交易？—氪星思维</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/how-to-implement-gasless-transactions-kryptomind-2a12a992fdfd?source=collection_archive---------20-----------------------#2022-06-24">https://medium.com/coinmonks/how-to-implement-gasless-transactions-kryptomind-2a12a992fdfd?source=collection_archive---------20-----------------------#2022-06-24</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/373c46c2f78d61dc9b536f7202cf7f48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nEm4sJ69jJnPsyxHWKiQEA.png"/></div></div><figcaption class="jb jc fg fe ff jd je bd b be z ek">Implement Gasless Transactions</figcaption></figure><h1 id="8fbe" class="jf jg ht bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc dt translated">了解以太坊中的气体:</h1><p id="1ad8" class="pw-post-body-paragraph kd ke ht kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la hm dt translated">在以太坊的世界里，气体至关重要。举个例子，是燃料让它运行，就像汽车需要燃料来运行一样。根据定义，术语“gas”是指用于量化完成特定操作所需的计算量的单位。</p><p id="bdeb" class="pw-post-body-paragraph kd ke ht kf b kg lb ki kj kk lc km kn ko ld kq kr ks le ku kv kw lf ky kz la hm dt translated">每个以太坊交易都有成本，因为它们都需要计算资源来完成。以太坊的原生货币ETH是用来交燃气费的。此外，天然气价格通常以Gwei单位表示，Gwei单位本身也是ETH的一个单位。一个Gwei相当于0.000000001 ETH(或109 ETH)。</p><p id="8b87" class="pw-post-body-paragraph kd ke ht kf b kg lb ki kj kk lc km kn ko ld kq kr ks le ku kv kw lf ky kz la hm dt translated">例如，你经常会说你的煤气价格是1 Gwei，而不是0.000000001 ETH。Gwei，代表千兆卫，相当于1，000，000，000卫(1卫= 1018 ETH)，是一种计量单位。ETH的最低级单位叫做“微”,是以b货币的创始人的名字命名的。</p><h1 id="1db7" class="jf jg ht bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc dt translated">为什么会有气费？</h1><ul class=""><li id="3f9e" class="lg lh ht kf b kg kh kk kl ko li ks lj kw lk la ll lm ln lo dt translated">以太坊矿工因保护网络和确认交易而获得天然气费。</li><li id="681e" class="lg lh ht kf b kg lp kk lq ko lr ks ls kw lt la ll lm ln lo dt translated">天然气收费还可以防止欺诈用户用交易淹没网络，堵塞网络。</li></ul><p id="e922" class="pw-post-body-paragraph kd ke ht kf b kg lb ki kj kk lc km kn ko ld kq kr ks le ku kv kw lf ky kz la hm dt translated">用于确定以太坊燃气成本的算法是动态的。因此它们会波动。以太坊网络经常被批评收费高，性能差。例如，以太坊网络的平均交易成本往往高于比特币区块链。希望更快完成交易的以太坊网络用户只需支付更多费用。用户可能会选择网络流量相对较低的时段来降低燃气成本。如果他们不介意较慢的交易速度，他们也可以减少小费。</p><p id="5d20" class="pw-post-body-paragraph kd ke ht kf b kg lb ki kj kk lc km kn ko ld kq kr ks le ku kv kw lf ky kz la hm dt translated">这就提出了一个问题，这些天然气成本是否可以消除。</p><p id="3e53" class="pw-post-body-paragraph kd ke ht kf b kg lb ki kj kk lc km kn ko ld kq kr ks le ku kv kw lf ky kz la hm dt translated">是的，多亏了元交易，我们可以做到这一点。</p><h1 id="9ae7" class="jf jg ht bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc dt translated">元事务</h1><h2 id="8edd" class="lu jg ht bd jh lv lw lx jl ly lz ma jp ko mb mc jt ks md me jx kw mf mg kb mh dt translated">这是什么？</h2><p id="9f7d" class="pw-post-body-paragraph kd ke ht kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la hm dt translated">元交易是包括实际交易的标准以太坊交易。不需要天然气或区块链的参与，因为实际的交易是由用户签名并转发给运营商或类似的机构。运营商将该签署的交易提交给区块链，同时支付相关费用。转发智能合约在执行之前检查实际交易的有效签名。</p><h2 id="89d3" class="lu jg ht bd jh lv lw lx jl ly lz ma jp ko mb mc jt ks md me jx kw mf mg kb mh dt translated">以太坊的限制</h2><p id="6d6b" class="pw-post-body-paragraph kd ke ht kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la hm dt translated">在ERC 20协议令牌转移的上下文中存在一个关键的治理层:approve和transferFrom之间的交互，它允许令牌在外部拥有的帐户(EOA)之间转移，并通过抽象出msg在特定于应用程序的条件下用于其他合同。sender作为令牌访问控制的定义机制，可以说是ERC 20协议令牌成功的主要原因之一。</p><p id="e088" class="pw-post-body-paragraph kd ke ht kf b kg lb ki kj kk lc km kn ko ld kq kr ks le ku kv kw lf ky kz la hm dt translated">尽管如此，该解决方案受到ERC-20批准功能是根据msg.sender来指定的这一事实的限制。EOA必须利用ERC-20令牌来进行用户的初始活动。如果用户想要参与</p><p id="6ddf" class="pw-post-body-paragraph kd ke ht kf b kg lb ki kj kk lc km kn ko ld kq kr ks le ku kv kw lf ky kz la hm dt translated">对于智能协定，需要两个事务(approveand和智能协定调用，后者将在内部调用transferFrom)。用户必须拥有ETH来支付交易气体费用，即使是在支付另一个人的最基本的使用情况下。</p><h2 id="0b8e" class="lu jg ht bd jh lv lw lx jl ly lz ma jp ko mb mc jt ks md me jx kw mf mg kb mh dt translated">我们如何解决这个问题？</h2><p id="119f" class="pw-post-body-paragraph kd ke ht kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la hm dt translated">为了解决这个问题，我们可以在ERC-20令牌契约中添加一个新的函数permit，使用户能够使用已签名的消息(通过secp256k1签名)而不是使用msg.sender来更改许可映射。换句话说，通过提交帐户已签名的消息，permit方法可用于修改帐户的ERC-20许可(参见IERC20.allowance)。令牌持有者账户不需要进行交易，因此也没有必要保留任何ETH，因为它不依赖IERC20.approve。</p><p id="218a" class="pw-post-body-paragraph kd ke ht kf b kg lb ki kj kk lc km kn ko ld kq kr ks le ku kv kw lf ky kz la hm dt translated">签名的数据是按照EIP-712组织的，它已经被主要的RPC和钱包提供商广泛用于增强用户体验。</p><figure class="mj mk ml mm fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mi"><img src="../Images/c20a1113c94d8dc2dfb804d5a9cc25e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*20ZiYMg4uoZBNBRg"/></div></div></figure><h1 id="763f" class="jf jg ht bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc dt translated">实施无汽油交易</h1><p id="a740" class="pw-post-body-paragraph kd ke ht kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la hm dt translated"><strong class="kf hu">示例:</strong>我们的示例智能协定标记为Forwarder.sol，它实现了EIP-712域分隔符(_domainSeparatorV4)，该分隔符用作编码方案的一部分，编码的最后一步是获取消息摘要，然后通过ECDSA进行签名(_hashTypedDataV4)。</p><h1 id="c7a2" class="jf jg ht bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc dt translated">货代合同</h1><p id="ac8e" class="pw-post-body-paragraph kd ke ht kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la hm dt translated">以太坊上可扩展元事务转发的智能契约</p><p id="213a" class="pw-post-body-paragraph kd ke ht kf b kg lb ki kj kk lc km kn ko ld kq kr ks le ku kv kw lf ky kz la hm dt translated">智能合同转发器. sol扩展了EIP-2770，并包含以下核心功能:</p><p id="1520" class="pw-post-body-paragraph kd ke ht kf b kg lb ki kj kk lc km kn ko ld kq kr ks le ku kv kw lf ky kz la hm dt translated">verify:根据类型化的结构化数据验证签名。</p><pre class="mj mk ml mm fq mn mo mp mq aw mr dt"><span id="40b2" class="lu jg ht mo b fv ms mt l mu mv">/**</span><span id="5a77" class="lu jg ht mo b fv mw mt l mu mv">* @dev Verifies the signature based on typed structured data.</span><span id="f739" class="lu jg ht mo b fv mw mt l mu mv">* See https://eips.ethereum.org/EIPS/eip-712</span><span id="9f32" class="lu jg ht mo b fv mw mt l mu mv">*/</span><span id="58f0" class="lu jg ht mo b fv mw mt l mu mv">function verify(ForwardRequest calldata req, bytes calldata signature) public view returns (bool) {</span><span id="5096" class="lu jg ht mo b fv mw mt l mu mv">address signer = _hashTypedDataV4(keccak256(abi.encode(</span><span id="1f10" class="lu jg ht mo b fv mw mt l mu mv">_TYPEHASH,</span><span id="c1e9" class="lu jg ht mo b fv mw mt l mu mv">req.from,</span><span id="ebd7" class="lu jg ht mo b fv mw mt l mu mv">req.to,</span><span id="4ed4" class="lu jg ht mo b fv mw mt l mu mv">req.value,</span><span id="9d6a" class="lu jg ht mo b fv mw mt l mu mv">req.gas,</span><span id="7012" class="lu jg ht mo b fv mw mt l mu mv">req.nonce,</span><span id="2452" class="lu jg ht mo b fv mw mt l mu mv">keccak256(req.data)</span><span id="e480" class="lu jg ht mo b fv mw mt l mu mv">))).recover(signature);</span><span id="9d67" class="lu jg ht mo b fv mw mt l mu mv">return _nonces[req.from] == req.nonce &amp;&amp; signer == req.from;</span><span id="050f" class="lu jg ht mo b fv mw mt l mu mv">}</span><span id="1e84" class="lu jg ht mo b fv mw mt l mu mv">execute: Executes the meta-transaction via a low-level call.</span><span id="1a60" class="lu jg ht mo b fv mw mt l mu mv">/**</span><span id="e03c" class="lu jg ht mo b fv mw mt l mu mv">* @dev Main function; executes the meta-transaction via a low-level call.</span><span id="7c48" class="lu jg ht mo b fv mw mt l mu mv">*/</span><span id="45df" class="lu jg ht mo b fv mw mt l mu mv">function execute(ForwardRequest calldata req, bytes calldata signature) public payable whenNotPaused() returns (bool, bytes memory) {</span><span id="47aa" class="lu jg ht mo b fv mw mt l mu mv">require(_senderWhitelist[msg.sender], "AwlForwarder: sender of meta-transaction is not whitelisted");</span><span id="0613" class="lu jg ht mo b fv mw mt l mu mv">require(verify(req, signature), "AwlForwarder: signature does not match request");</span><span id="c6b1" class="lu jg ht mo b fv mw mt l mu mv">_nonces[req.from] = req.nonce + 1;</span><span id="7d4c" class="lu jg ht mo b fv mw mt l mu mv">// solhint-disable-next-line avoid-low-level-calls</span><span id="f487" class="lu jg ht mo b fv mw mt l mu mv">(bool success, bytes memory returndata) = req.to.call{gas: req.gas, value: req.value}(abi.encodePacked(req.data, req.from));</span><span id="1f56" class="lu jg ht mo b fv mw mt l mu mv">if (!success) {</span><span id="d5d0" class="lu jg ht mo b fv mw mt l mu mv">// solhint-disable-next-line no-inline-assembly</span><span id="e89c" class="lu jg ht mo b fv mw mt l mu mv">assembly {</span><span id="4344" class="lu jg ht mo b fv mw mt l mu mv">returndatacopy(0, 0, returndatasize())</span><span id="6261" class="lu jg ht mo b fv mw mt l mu mv">revert(0, returndatasize())</span><span id="c53e" class="lu jg ht mo b fv mw mt l mu mv">}</span><span id="0bb3" class="lu jg ht mo b fv mw mt l mu mv">}</span><span id="4f6d" class="lu jg ht mo b fv mw mt l mu mv">/**</span><span id="481c" class="lu jg ht mo b fv mw mt l mu mv">* @dev Validates that the relayer/forwarder EOA has sent enough gas for the call.</span><span id="ebf9" class="lu jg ht mo b fv mw mt l mu mv">* See https://ronan.eth.link/blog/ethereum-gas-dangers/.</span><span id="fb30" class="lu jg ht mo b fv mw mt l mu mv">*/</span><span id="8a9e" class="lu jg ht mo b fv mw mt l mu mv">assert(gasleft() &gt; req.gas / 63);</span><span id="42b0" class="lu jg ht mo b fv mw mt l mu mv">emit MetaTransactionExecuted(req.from, req.to, req.data);</span><span id="863e" class="lu jg ht mo b fv mw mt l mu mv">return (success, returndata);</span><span id="5c64" class="lu jg ht mo b fv mw mt l mu mv">}</span></pre><h1 id="dcf5" class="jf jg ht bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc dt translated">一些安全注意事项:</h1><p id="efb2" class="pw-post-body-paragraph kd ke ht kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la hm dt translated">我们跟踪链上的随机数映射以防止重放。此外，代运商防止任何人出于潜在的恶意目的公开交易。sol智能合同的执行功能受到白名单的保护。此外，智能契约是可拥有的，它提供了基本的访问控制机制，其中允许EOA(所有者)独占访问某些功能(即，addSenderToWhitelist、removeSenderFromWhitelist、killForwarder、pause、unpause)。此外，智能合同功能execute是可暂停的，这意味着它包含了一个紧急停止机制，所有者可以激活它。最后，使用函数killForwarder建立自毁操作作为紧急备份。</p><p id="b6f2" class="pw-post-body-paragraph kd ke ht kf b kg lb ki kj kk lc km kn ko ld kq kr ks le ku kv kw lf ky kz la hm dt translated">注意1:白名单中的eoa在发送事务之前仔细检查编码的(用户签名的)呼叫数据是非常重要的。</p><blockquote class="mx my mz"><p id="b2cc" class="kd ke na kf b kg lb ki kj kk lc km kn nb ld kq kr nc le ku kv nd lf ky kz la hm dt translated">交易新手？试试<a class="ae ne" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">密码交易机器人</a>或者<a class="ae ne" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">复制交易</a></p></blockquote><p id="17c3" class="pw-post-body-paragraph kd ke ht kf b kg lb ki kj kk lc km kn ko ld kq kr ks le ku kv kw lf ky kz la hm dt translated">注2: calldata是存储函数外部调用数据的地方。函数可以在内部调用，例如，从契约内部调用，或者当函数的可见性是外部的时，在外部调用。当这样的外部呼叫发生时，该呼叫的数据存储在calldata中。</p><p id="e959" class="pw-post-body-paragraph kd ke ht kf b kg lb ki kj kk lc km kn ko ld kq kr ks le ku kv kw lf ky kz la hm dt translated">注意3:对于addSenderToWhitelist和killForwarder函数，我们没有实现一个专用的严格策略来从不允许零地址0x0000000000000000000000000000。这样做的原因是，第一，函数通过被Ownable来保护，第二，可以认为像0x 000000000000000000000000000000001这样的地址是同样危险的，但是我们对此不做任何事情。</p></div><div class="ab cl nf ng hb nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="hm hn ho hp hq"><p id="0a27" class="pw-post-body-paragraph kd ke ht kf b kg lb ki kj kk lc km kn ko ld kq kr ks le ku kv kw lf ky kz la hm dt translated"><em class="na">原载于2022年6月24日</em><a class="ae ne" href="https://kryptomind.com/how-to-implement-gasless-transactions" rel="noopener ugc nofollow" target="_blank"><em class="na">【https://kryptomind.com】</em></a><em class="na">。</em></p><blockquote class="nm"><p id="d6d2" class="nn no ht bd np nq nr ns nt nu nv la ek translated">加入Coinmonks <a class="ae ne" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae ne" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h1 id="b5a7" class="jf jg ht bd jh ji jj jk jl jm jn jo jp jq nw js jt ju nx jw jx jy ny ka kb kc dt translated">另外，阅读</h1><ul class=""><li id="5e6d" class="lg lh ht kf b kg kh kk kl ko li ks lj kw lk la ll lm ln lo dt translated"><a class="ae ne" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c">密码本交易平台</a> | <a class="ae ne" rel="noopener" href="/coinmonks/coinmama-review-ace5641bde6e"> Coinmama审核</a></li><li id="f3da" class="lg lh ht kf b kg lp kk lq ko lr ks ls kw lt la ll lm ln lo dt translated"><a class="ae ne" rel="noopener" href="/coinmonks/bitcoin-exchange-in-india-7f1fe79715c9">印度的加密交易所</a> | <a class="ae ne" rel="noopener" href="/coinmonks/bitcoin-savings-account-e65b13f92451">比特币储蓄账户</a></li><li id="7c4f" class="lg lh ht kf b kg lp kk lq ko lr ks ls kw lt la ll lm ln lo dt translated"><a class="ae ne" href="https://coincodecap.com/okex-kucoin" rel="noopener ugc nofollow" target="_blank"> OKEx vs KuCoin </a> | <a class="ae ne" href="https://coincodecap.com/celsius-alternatives" rel="noopener ugc nofollow" target="_blank">摄氏替代品</a> | <a class="ae ne" href="https://coincodecap.com/buy-vechain" rel="noopener ugc nofollow" target="_blank">如何购买VeChain </a></li><li id="1512" class="lg lh ht kf b kg lp kk lq ko lr ks ls kw lt la ll lm ln lo dt translated"><a class="ae ne" href="https://coincodecap.com/binance-futures-trading" rel="noopener ugc nofollow" target="_blank">币安期货交易</a>|<a class="ae ne" href="https://coincodecap.com/mudrex-3commas-etoro" rel="noopener ugc nofollow" target="_blank">3 commas vs Mudrex vs eToro</a></li><li id="1ff6" class="lg lh ht kf b kg lp kk lq ko lr ks ls kw lt la ll lm ln lo dt translated"><a class="ae ne" href="https://coincodecap.com/buy-monero" rel="noopener ugc nofollow" target="_blank">如何购买Monero </a> | <a class="ae ne" href="https://coincodecap.com/idex-review" rel="noopener ugc nofollow" target="_blank"> IDEX评论</a> | <a class="ae ne" href="https://coincodecap.com/bitkan-trading-bot" rel="noopener ugc nofollow" target="_blank"> BitKan交易机器人</a></li></ul></div></div>    
</body>
</html>