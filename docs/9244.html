<html>
<head>
<title>Trust Fund</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">信托基金</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/trust-fund-2b2f6620bfb8?source=collection_archive---------32-----------------------#2022-06-23">https://medium.com/coinmonks/trust-fund-2b2f6620bfb8?source=collection_archive---------32-----------------------#2022-06-23</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="640d" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">安全创新区块链CTF报道(英文版)</h2></div><p id="e7e2" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">大家好！这篇文章也有泰文版，供那些喜欢的人阅读；<a class="ae ke" rel="noopener" href="/@teerasak.r/trust-fund-cb1f9739603e">请点击这里</a>。</p><p id="e1ba" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">สวัสดีครับบทความนี้มีเวอร์ชันภาษาไทยเหมือนกันนะสำหรับคนที่ต้องแบบภาษาไทยสามารถ<a class="ae ke" rel="noopener" href="/@teerasak.r/trust-fund-cb1f9739603e">คลิกที่นี่</a></p></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><h1 id="3257" class="km kn ht bd ko kp kq kr ks kt ku kv kw iz kx ja ky jc kz jd la jf lb jg lc ld dt translated">合同代码</h1><figure class="le lf lg lh fq li"><div class="bz el l di"><div class="lj lk l"/></div></figure><h1 id="0107" class="km kn ht bd ko kp ll kr ks kt lm kv kw iz ln ja ky jc lo jd la jf lp jg lc ld dt translated">解决办法</h1><p id="a7bc" class="pw-post-body-paragraph ji jj ht jk b jl lq iu jn jo lr ix jq jr ls jt ju jv lt jx jy jz lu kb kc kd hm dt translated">首先，我建议尝试学习合同的目的、工作流程和功能。这可以提供契约的概要，并提示您应该检查哪个功能。</p><p id="a0e2" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">这个挑战的目标是从合同中抽干所有的ETH。由于只有一个与传输ETH相关的功能，很容易注意到，<code class="eh lv lw lx ly b">withdraw()</code>。</p><p id="1908" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">因此，您可以直接使用<code class="eh lv lw lx ly b">withdraw()</code>函数，并考虑如何在不恢复的情况下调用它。它有两个<code class="eh lv lw lx ly b">require()</code>语句，你必须让它在调用时产生<code class="eh lv lw lx ly b">true</code>，但是怎么做呢？</p><p id="58eb" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我想缩小一点，解释一下这个挑战是关于什么的。它旨在锁定已部署的ETH，并允许您每年仅撤回1/10(<code class="eh lv lw lx ly b">allowancePerYear = msg.value.div(10);</code>)，因此，<strong class="jk hu">您将需要10年时间来解决这一挑战！</strong>等一下…，如果这么直，这就不是挑战了，不是吗？所以，我们来深入探讨一下怎么破吧！</p><p id="d777" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">第一个是<code class="eh lv lw lx ly b">allowancePerYear &gt; 0</code>，完全不用担心，它将始终大于零，因为它将被设置为ETH部署量除以10，该值始终大于零。</p><p id="2b47" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">第二个，<code class="eh lv lw lx ly b">withdrewThisYear</code>，打电话时必须是<code class="eh lv lw lx ly b">false</code>，表示你今年一定没有提款。在调用<code class="eh lv lw lx ly b">withdraw()</code>之后，它将被设置为真，如果你已经调用了它，你可以通过调用<code class="eh lv lw lx ly b">returnFund()</code>将它设置回假，其金额与你提取的金额相同。</p><p id="cf53" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">而且……破绽就在这里！如果您仔细查看第34–36行，您会注意到在<code class="eh lv lw lx ly b">withdrewThisYear</code>被设置为<code class="eh lv lw lx ly b">true</code>之前，资金被发送给调用者(<code class="eh lv lw lx ly b">msg.sender.call.value(allowancePerYear)()</code>)，这种模式引入了可重入攻击。我不打算解释这种攻击是什么，但是如果您以前没有听说过它或者对它不熟悉，请使用下面的来源作为起点来了解它的更多信息:</p><ul class=""><li id="b27f" class="lz ma ht jk b jl jm jo jp jr mb jv mc jz md kd me mf mg mh dt translated"><a class="ae ke" href="https://swcregistry.io/docs/SWC-107" rel="noopener ugc nofollow" target="_blank">https://swcregistry.io/docs/SWC-107</a></li><li id="ae6b" class="lz ma ht jk b jl mi jo mj jr mk jv ml jz mm kd me mf mg mh dt translated"><a class="ae ke" href="https://hackernoon.com/hack-solidity-reentrancy-attack" rel="noopener ugc nofollow" target="_blank">https://hackernoon.com/hack-solidity-reentrancy-attack</a></li></ul><p id="8a22" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">契约在设置值之前进行外部调用，在处理第35行之前，它将控制权交给被调用者。所以，你可以在<code class="eh lv lw lx ly b">withdrawThisYear</code>仍然是<code class="eh lv lw lx ly b">false</code>的时候再次调用<code class="eh lv lw lx ly b">withdraw()</code>。要在一个事务中执行多个调用，智能合约是不可避免的；没有智能合同就无法做到这一点。智能合约逻辑可以如下所示:</p><ol class=""><li id="e52d" class="lz ma ht jk b jl jm jo jp jr mb jv mc jz md kd mn mf mg mh dt translated">调用<code class="eh lv lw lx ly b">withdraw()</code>函数。</li><li id="5c0e" class="lz ma ht jk b jl mi jo mj jr mk jv ml jz mm kd mn mf mg mh dt translated">实现<code class="eh lv lw lx ly b">fallback()/receiver()</code>函数来递归调用<code class="eh lv lw lx ly b">withdraw()</code>函数。该功能将由每次呼叫的第34行触发。而且，您必须包括剩余余额检查，以在所有资金耗尽后停止递归。</li><li id="bd29" class="lz ma ht jk b jl mi jo mj jr mk jv ml jz mm kd mn mf mg mh dt translated">将你的智能合约中所有耗尽的ETH转移回给你(如果你愿意，你可以留下它)。</li></ol><p id="d994" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">下面是我根据上述逻辑实现的智能契约。</p><figure class="le lf lg lh fq li"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="8b26" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">您可以用您喜欢的任何方法来编译、部署和运行它。您只需在部署时输入挑战地址(TrustFund.sol)即可设定目标。</p><p id="3d20" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">如果你在<a class="ae ke" href="https://blockchain-ctf.securityinnovation.com/#/" rel="noopener ugc nofollow" target="_blank"> SecurityInnovation </a>网站上玩，别忘了挑战是继承自<code class="eh lv lw lx ly b">CtfFramework.sol</code>的。您必须通过调用<code class="eh lv lw lx ly b">ctf_challenge_add_authorized_sender()</code>将您部署的智能合约地址作为允许的调用方。</p><p id="f79c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">一切就绪后，只需调用<code class="eh lv lw lx ly b">pwn()</code>即可完成😎。</p><figure class="le lf lg lh fq li fe ff paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="fe ff mo"><img src="../Images/eefa6c13b352f156ead281e012b4b08b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jdZ2nOqNJ5_w8YXP5G0u_A.png"/></div></div></figure></div><div class="ab cl kf kg hb kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hm hn ho hp hq"><h1 id="3fe7" class="km kn ht bd ko kp kq kr ks kt ku kv kw iz kx ja ky jc kz jd la jf lb jg lc ld dt translated">吸取的教训</h1><p id="9888" class="pw-post-body-paragraph ji jj ht jk b jl lq iu jn jo lr ix jq jr ls jt ju jv lt jx jy jz lu kb kc kd hm dt translated">这个挑战显然是有重入攻击漏洞的，因此，<a class="ae ke" href="https://swcregistry.io/docs/SWC-107" rel="noopener ugc nofollow" target="_blank">这里可以找到很好的缓解方法</a>。我将总结如下:</p><ul class=""><li id="bc4b" class="lz ma ht jk b jl jm jo jp jr mb jv mc jz md kd me mf mg mh dt translated">最好不要在更改内部状态之前进行外部调用，但如果需要，请确保外部被调用方是可信的。</li><li id="85a6" class="lz ma ht jk b jl mi jo mj jr mk jv ml jz mm kd me mf mg mh dt translated">Openzeppelin的<a class="ae ke" href="https://docs.openzeppelin.com/contracts/4.x/api/security#ReentrancyGuard" rel="noopener ugc nofollow" target="_blank"> ReentrancyGuard </a>非常有帮助，是为此而生的。然而，只对需要不可重入的函数使用它，而不是对所有的函数，因为这包括更多的检查，所以，花费更多的汽油。</li><li id="847d" class="lz ma ht jk b jl mi jo mj jr mk jv ml jz mm kd me mf mg mh dt translated">你也可以考虑使用<a class="ae ke" href="https://github.com/Rari-Capital/solmate/blob/main/src/utils/ReentrancyGuard.sol" rel="noopener ugc nofollow" target="_blank"> Rari-Capital solmate的ReentrancyGuard </a>来获得比Openzeppelin更多的气体优化，如果你打算使用的话。</li></ul><blockquote class="mv"><p id="6544" class="mw mx ht bd my mz na nb nc nd ne kd ek translated"><em class="nf">加入Coinmonks </em> <a class="ae ke" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank"> <em class="nf">电报频道</em> </a> <em class="nf">和</em> <a class="ae ke" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> <em class="nf"> Youtube频道</em> </a> <em class="nf">了解加密交易和投资</em></p></blockquote><h1 id="5a28" class="km kn ht bd ko kp ll kr ks kt lm kv kw iz ng ja ky jc nh jd la jf ni jg lc ld dt translated">另外，阅读</h1><ul class=""><li id="b207" class="lz ma ht jk b jl lq jo lr jr nj jv nk jz nl kd me mf mg mh dt translated"><a class="ae ke" rel="noopener" href="/coinmonks/3commas-review-an-excellent-crypto-trading-bot-2020-1313a58bec92">3商业评论</a> | <a class="ae ke" href="https://coincodecap.com/pionex-review-exchange-with-crypto-trading-bot" rel="noopener ugc nofollow" target="_blank"> Pionex评论</a> | <a class="ae ke" rel="noopener" href="/coinmonks/coinrule-review-2021-a-beginner-friendly-crypto-trading-bot-daf0504848ba"> Coinrule评论</a></li><li id="3dc9" class="lz ma ht jk b jl mi jo mj jr mk jv ml jz mm kd me mf mg mh dt translated"><a class="ae ke" rel="noopener" href="/coinmonks/ledger-vs-ngrave-zero-7e40f0c1d694">莱杰vs n格拉夫</a> | <a class="ae ke" rel="noopener" href="/coinmonks/ledger-nano-s-vs-x-battery-hardware-price-storage-59a6663fe3b0">莱杰纳诺s vs x </a> | <a class="ae ke" rel="noopener" href="/coinmonks/binance-review-ee10d3bf3b6e">币安评论</a></li><li id="6fb7" class="lz ma ht jk b jl mi jo mj jr mk jv ml jz mm kd me mf mg mh dt translated"><a class="ae ke" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">加密交易机器人</a> | <a class="ae ke" href="https://coincodecap.com/bingbon-review" rel="noopener ugc nofollow" target="_blank"> Bingbon评论</a></li><li id="2039" class="lz ma ht jk b jl mi jo mj jr mk jv ml jz mm kd me mf mg mh dt translated"><a class="ae ke" rel="noopener" href="/coinmonks/bybit-exchange-review-dbd570019b71"> Bybit Exchange审查</a> | <a class="ae ke" href="https://coincodecap.com/bityard-reivew" rel="noopener ugc nofollow" target="_blank"> Bityard审查</a> | <a class="ae ke" href="https://coincodecap.com/jet-bot-review" rel="noopener ugc nofollow" target="_blank"> Jet-Bot审查</a></li><li id="53ca" class="lz ma ht jk b jl mi jo mj jr mk jv ml jz mm kd me mf mg mh dt translated"><a class="ae ke" rel="noopener" href="/coinmonks/3commas-vs-pionex-vs-cryptohopper-best-crypto-bot-6a98d2baa203">3 commas vs crypto hopper</a>|<a class="ae ke" rel="noopener" href="/coinmonks/earn-crypto-interest-b10b810fdda3">赚取加密利息</a></li><li id="7c3d" class="lz ma ht jk b jl mi jo mj jr mk jv ml jz mm kd me mf mg mh dt translated">最好的比特币<a class="ae ke" rel="noopener" href="/coinmonks/hardware-wallets-dfa1211730c6">硬件钱包</a> | <a class="ae ke" rel="noopener" href="/coinmonks/bitbox02-review-your-swiss-bitcoin-hardware-wallet-c36c88fff29"> BitBox02回顾</a></li></ul></div></div>    
</body>
</html>