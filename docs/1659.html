<html>
<head>
<title>Blockchain: Day3 — Writing your first smart contract</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">区块链:第3天——撰写你的第一份智能合同</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/blockchain-day3-writing-your-first-smart-contract-4a2ac655c8c0?source=collection_archive---------12-----------------------#2022-03-04">https://medium.com/coinmonks/blockchain-day3-writing-your-first-smart-contract-4a2ac655c8c0?source=collection_archive---------12-----------------------#2022-03-04</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/></div><div class="ab cl iq ir hb is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hm hn ho hp hq"><h1 id="f8f0" class="ix iy ht bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju dt translated"><strong class="ak">一、概述</strong></h1><p id="bb30" class="pw-post-body-paragraph jv jw ht jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">距离我的上一篇帖子已经过去几周了，因为我现在的项目太忙了。今天，我将继续我关于区块链的系列文章，学习如何使用solidity写一个简单的智能合同。</p><p id="dd45" class="pw-post-body-paragraph jv jw ht jx b jy kt ka kb kc ku ke kf kg kv ki kj kk kw km kn ko kx kq kr ks hm dt translated">让我们考虑一个关于一个令人敬畏的图书馆的简单场景。作为库，必须满足以下要求</p><ul class=""><li id="2e38" class="ky kz ht jx b jy kt kc ku kg la kk lb ko lc ks ld le lf lg dt translated">图书馆有藏书</li><li id="e15d" class="ky kz ht jx b jy lh kc li kg lj kk lk ko ll ks ld le lf lg dt translated">我们将用一些信息来表示每本书，比如isbn、作者、书名。</li><li id="89e8" class="ky kz ht jx b jy lh kc li kg lj kk lk ko ll ks ld le lf lg dt translated">只有图书馆的所有者可以添加图书</li><li id="9906" class="ky kz ht jx b jy lh kc li kg lj kk lk ko ll ks ld le lf lg dt translated">如果有书的话，其他人可以来借</li><li id="3684" class="ky kz ht jx b jy lh kc li kg lj kk lk ko ll ks ld le lf lg dt translated">书籍必须在阅读后归还给图书馆，以便其他人可以借阅</li></ul><h1 id="065b" class="ix iy ht bd iz ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq lq js jt ju dt translated">二。履行</h1><ul class=""><li id="a3ad" class="ky kz ht jx b jy jz kc kd kg lr kk ls ko lt ks ld le lf lg dt translated">第一步是定义我们的库</li></ul><pre class="lu lv lw lx fq ly lz ma mb aw mc dt"><span id="e396" class="md iy ht lz b fv me mf l mg mh">// SPDX-License-Identifier: GPL-3.0</span><span id="0d83" class="md iy ht lz b fv mi mf l mg mh">pragma solidity ^0.8.4;</span><span id="e104" class="md iy ht lz b fv mi mf l mg mh">contract Library{<br/>    string internal _name = "An Awesome Library"<br/>    /**</span><span id="a288" class="md iy ht lz b fv mi mf l mg mh">    * Return library name</span><span id="635b" class="md iy ht lz b fv mi mf l mg mh">    */</span><span id="4d79" class="md iy ht lz b fv mi mf l mg mh">    function name() public view returns (string memory) {</span><span id="6a48" class="md iy ht lz b fv mi mf l mg mh">       return _name;</span><span id="937b" class="md iy ht lz b fv mi mf l mg mh">    }</span><span id="8abd" class="md iy ht lz b fv mi mf l mg mh">}</span></pre><p id="f937" class="pw-post-body-paragraph jv jw ht jx b jy kt ka kb kc ku ke kf kg kv ki kj kk kw km kn ko kx kq kr ks hm dt translated">没有什么需要解释的，因为我们刚刚定义了一个具有初始名称的库。函数<code class="eh mj mk ml lz b">name()</code>除了返回当前库的名称之外什么也不做。</p><ul class=""><li id="3ff9" class="ky kz ht jx b jy kt kc ku kg la kk lb ko lc ks ld le lf lg dt translated">图书馆需要书，所以让我们简单地用<code class="eh mj mk ml lz b">struct</code>来定义一本书的样子:</li></ul><pre class="lu lv lw lx fq ly lz ma mb aw mc dt"><span id="9dff" class="md iy ht lz b fv me mf l mg mh">// Sample structure of a Book</span><span id="90d4" class="md iy ht lz b fv mi mf l mg mh">struct Book {</span><span id="025e" class="md iy ht lz b fv mi mf l mg mh">    string isbn;</span><span id="866e" class="md iy ht lz b fv mi mf l mg mh">    string title;</span><span id="750c" class="md iy ht lz b fv mi mf l mg mh">    string author;</span><span id="1268" class="md iy ht lz b fv mi mf l mg mh">}</span></pre><ul class=""><li id="ef0c" class="ky kz ht jx b jy kt kc ku kg la kk lb ko lc ks ld le lf lg dt translated">区块链在最大程度上是一个账本，可以用作数据库，让我们定义我们简单的数据库的表称为<code class="eh mj mk ml lz b">bookstore</code>，账本记录谁借了哪本书</li></ul><pre class="lu lv lw lx fq ly lz ma mb aw mc dt"><span id="b54b" class="md iy ht lz b fv me mf l mg mh">// Bookstore</span><span id="7777" class="md iy ht lz b fv mi mf l mg mh">Book[] internal bookstore;</span><span id="f6b0" class="md iy ht lz b fv mi mf l mg mh">//Book id -&gt; borrower </span><span id="e44a" class="md iy ht lz b fv mi mf l mg mh">mapping(uint256 =&gt; address) internal ledger;</span></pre><ul class=""><li id="a92a" class="ky kz ht jx b jy kt kc ku kg la kk lb ko lc ks ld le lf lg dt translated">现在一个构造函数来初始化我们刚刚创建的东西</li></ul><pre class="lu lv lw lx fq ly lz ma mb aw mc dt"><span id="d8d6" class="md iy ht lz b fv me mf l mg mh">constructor(string memory name_) {</span><span id="7d37" class="md iy ht lz b fv mi mf l mg mh">   _name = name_;</span><span id="3584" class="md iy ht lz b fv mi mf l mg mh">   bookstore.push(</span><span id="7953" class="md iy ht lz b fv mi mf l mg mh">      Book({</span><span id="3099" class="md iy ht lz b fv mi mf l mg mh">           isbn: "9781853260315",</span><span id="2b11" class="md iy ht lz b fv mi mf l mg mh">            title: "20,000 Leagues Under the Sea (Wordsworth Classics)",</span><span id="8f9f" class="md iy ht lz b fv mi mf l mg mh">         author: "Jules Verne"</span><span id="c903" class="md iy ht lz b fv mi mf l mg mh">     })</span><span id="e59f" class="md iy ht lz b fv mi mf l mg mh">   );</span><span id="6133" class="md iy ht lz b fv mi mf l mg mh">}</span></pre><p id="71b1" class="pw-post-body-paragraph jv jw ht jx b jy kt ka kb kc ku ke kf kg kv ki kj kk kw km kn ko kx kq kr ks hm dt translated">这里我们给所有者一个机会，在部署时定义他/她自己的图书馆名称，并把一本书推送到我们的书店，这只是一个例子。</p><ul class=""><li id="f481" class="ky kz ht jx b jy kt kc ku kg la kk lb ko lc ks ld le lf lg dt translated">所有者可以添加图书。我们可以做一个限制来满足这个要求。<code class="eh mj mk ml lz b">function modifier</code>这是我想到的第一件事，但由于我是一个懒惰的开发人员，我决定使用OpenZeppelin的<a class="ae mm" href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/access/Ownable.sol" rel="noopener ugc nofollow" target="_blank"> Ownable </a>合同来代替:</li></ul><pre class="lu lv lw lx fq ly lz ma mb aw mc dt"><span id="3335" class="md iy ht lz b fv me mf l mg mh">// SPDX-License-Identifier: GPL-3.0</span><span id="dcbe" class="md iy ht lz b fv mi mf l mg mh">pragma solidity ^0.8.4;</span><span id="b3d3" class="md iy ht lz b fv mi mf l mg mh">import "@openzeppelin/contracts/access/<strong class="lz hu">Ownable.sol</strong>";</span><span id="ce02" class="md iy ht lz b fv mi mf l mg mh">contract Library is <strong class="lz hu">Ownable</strong> {</span><span id="45a4" class="md iy ht lz b fv mi mf l mg mh">string internal _name = "A Wonderful Library";</span><span id="7399" class="md iy ht lz b fv mi mf l mg mh">// Sample structure of a Book</span><span id="3d1f" class="md iy ht lz b fv mi mf l mg mh">struct Book {</span><span id="8050" class="md iy ht lz b fv mi mf l mg mh">   string isbn;</span><span id="9bcb" class="md iy ht lz b fv mi mf l mg mh">   string title;</span><span id="a450" class="md iy ht lz b fv mi mf l mg mh">   string author;</span><span id="2eed" class="md iy ht lz b fv mi mf l mg mh">}</span><span id="82fc" class="md iy ht lz b fv mi mf l mg mh">// Bookstore</span><span id="6bf1" class="md iy ht lz b fv mi mf l mg mh">Book[] internal bookstore;</span><span id="0b1c" class="md iy ht lz b fv mi mf l mg mh">mapping(uint256 =&gt; address) internal ledger;</span><span id="7187" class="md iy ht lz b fv mi mf l mg mh">constructor(string memory name_) {</span><span id="4a0f" class="md iy ht lz b fv mi mf l mg mh">    _name = name_;</span><span id="89b0" class="md iy ht lz b fv mi mf l mg mh">    bookstore.push(</span><span id="4bc6" class="md iy ht lz b fv mi mf l mg mh">      Book({</span><span id="06c8" class="md iy ht lz b fv mi mf l mg mh">       isbn: "9781853260315",</span><span id="7433" class="md iy ht lz b fv mi mf l mg mh">       title: "20,000 Leagues Under the Sea (Wordsworth Classics)",</span><span id="f753" class="md iy ht lz b fv mi mf l mg mh">        author: "Jules Verne"</span><span id="3352" class="md iy ht lz b fv mi mf l mg mh">     })</span><span id="c1e4" class="md iy ht lz b fv mi mf l mg mh">   );</span><span id="2268" class="md iy ht lz b fv mi mf l mg mh">}</span><span id="e27e" class="md iy ht lz b fv mi mf l mg mh">/**</span><span id="84e0" class="md iy ht lz b fv mi mf l mg mh">* Return library name</span><span id="c2a2" class="md iy ht lz b fv mi mf l mg mh">*/</span><span id="6f8f" class="md iy ht lz b fv mi mf l mg mh">function name() public view returns (string memory) {</span><span id="cf1a" class="md iy ht lz b fv mi mf l mg mh">    return _name;</span><span id="f8c9" class="md iy ht lz b fv mi mf l mg mh">}</span><span id="86dc" class="md iy ht lz b fv mi mf l mg mh">/**</span><span id="3291" class="md iy ht lz b fv mi mf l mg mh">* Add new Book</span><span id="b9ef" class="md iy ht lz b fv mi mf l mg mh">*/</span><span id="9ab0" class="md iy ht lz b fv mi mf l mg mh">function addBook(string memory _isbn, string memory _title, string memory _author) public <strong class="lz hu">onlyOwner</strong> {</span><span id="d599" class="md iy ht lz b fv mi mf l mg mh">  bookstore.push(</span><span id="74fa" class="md iy ht lz b fv mi mf l mg mh">    Book({</span><span id="0584" class="md iy ht lz b fv mi mf l mg mh">      isbn: _isbn,</span><span id="15cc" class="md iy ht lz b fv mi mf l mg mh">      title: _title,</span><span id="b796" class="md iy ht lz b fv mi mf l mg mh">      author: _author</span><span id="df75" class="md iy ht lz b fv mi mf l mg mh">    })</span><span id="14ff" class="md iy ht lz b fv mi mf l mg mh">   );<br/> }</span><span id="3b14" class="md iy ht lz b fv mi mf l mg mh">}</span></pre><ul class=""><li id="9aeb" class="ky kz ht jx b jy kt kc ku kg la kk lb ko lc ks ld le lf lg dt translated">现在是<code class="eh mj mk ml lz b">borrow</code>和<code class="eh mj mk ml lz b">return</code>出书的时候了:</li></ul><pre class="lu lv lw lx fq ly lz ma mb aw mc dt"><span id="e54b" class="md iy ht lz b fv me mf l mg mh">function getBookById(uint256 _bookId) external view onlyValidBookId(_bookId) returns (</span><span id="c2cf" class="md iy ht lz b fv mi mf l mg mh">uint256 bookId,</span><span id="0eb8" class="md iy ht lz b fv mi mf l mg mh">string memory isbn, <br/>string memory title, <br/>string memory author, <br/>address borrower) {</span><span id="0039" class="md iy ht lz b fv mi mf l mg mh">   Book storage book = bookstore[_bookId];</span><span id="33dc" class="md iy ht lz b fv mi mf l mg mh">   bookId = _bookId;</span><span id="2366" class="md iy ht lz b fv mi mf l mg mh">   isbn = book.isbn;</span><span id="419c" class="md iy ht lz b fv mi mf l mg mh">   title = book.title;</span><span id="5581" class="md iy ht lz b fv mi mf l mg mh">   author = book.author;</span><span id="45c3" class="md iy ht lz b fv mi mf l mg mh">   borrower = ledger[_bookId];</span><span id="95cc" class="md iy ht lz b fv mi mf l mg mh">}</span><span id="6d55" class="md iy ht lz b fv mi mf l mg mh">/**</span><span id="f21b" class="md iy ht lz b fv mi mf l mg mh">Function: borrowingBook</span><span id="f818" class="md iy ht lz b fv mi mf l mg mh">Input : bookId</span><span id="2d43" class="md iy ht lz b fv mi mf l mg mh">Return : boolean</span><span id="c5eb" class="md iy ht lz b fv mi mf l mg mh">*/</span><span id="8df8" class="md iy ht lz b fv mi mf l mg mh">function isBorrowingBook(uint256 _bookId) public view onlyValidBookId(_bookId) returns (bool) {</span><span id="3716" class="md iy ht lz b fv mi mf l mg mh">    return msg.sender == _getBorrowerByBookId(_bookId);</span><span id="1596" class="md iy ht lz b fv mi mf l mg mh">}</span><span id="c419" class="md iy ht lz b fv mi mf l mg mh">function isAvailable(uint256 _bookId) public view onlyValidBookId(_bookId) returns(bool) {</span><span id="3045" class="md iy ht lz b fv mi mf l mg mh">    return ledger[_bookId] == address(0);</span><span id="96ee" class="md iy ht lz b fv mi mf l mg mh">}</span><span id="3b11" class="md iy ht lz b fv mi mf l mg mh">modifier onlyBorrowable(uint256 _bookId) {</span><span id="5b25" class="md iy ht lz b fv mi mf l mg mh">   require(</span><span id="ac30" class="md iy ht lz b fv mi mf l mg mh">      !isBorrowingBook(_bookId) &amp;&amp;</span><span id="a7d5" class="md iy ht lz b fv mi mf l mg mh">      isAvailable(_bookId),</span><span id="309f" class="md iy ht lz b fv mi mf l mg mh">      "Not available or already borrowed by you."</span><span id="8c4d" class="md iy ht lz b fv mi mf l mg mh">   );</span><span id="b5f1" class="md iy ht lz b fv mi mf l mg mh">   _;</span><span id="5dda" class="md iy ht lz b fv mi mf l mg mh">}</span><span id="2a14" class="md iy ht lz b fv mi mf l mg mh">/**</span><span id="378a" class="md iy ht lz b fv mi mf l mg mh">Function : borrow</span><span id="082d" class="md iy ht lz b fv mi mf l mg mh">Input : _bookId</span><span id="8e3e" class="md iy ht lz b fv mi mf l mg mh">*/</span><span id="b55a" class="md iy ht lz b fv mi mf l mg mh">function borrow(uint256 _bookId) public onlyBorrowable(_bookId) {</span><span id="4960" class="md iy ht lz b fv mi mf l mg mh">    ledger[_bookId] = msg.sender;</span><span id="9af6" class="md iy ht lz b fv mi mf l mg mh">    emit Borrow(msg.sender, _bookId);</span><span id="2f1c" class="md iy ht lz b fv mi mf l mg mh">}</span><span id="3c23" class="md iy ht lz b fv mi mf l mg mh">/**</span><span id="aa01" class="md iy ht lz b fv mi mf l mg mh">Function : borrow</span><span id="44e1" class="md iy ht lz b fv mi mf l mg mh">Input : _bookId</span><span id="559d" class="md iy ht lz b fv mi mf l mg mh">*/</span><span id="0b00" class="md iy ht lz b fv mi mf l mg mh">function takeBack(uint256 _bookId) public {</span><span id="a330" class="md iy ht lz b fv mi mf l mg mh">    require(</span><span id="1461" class="md iy ht lz b fv mi mf l mg mh">        isBorrowingBook(_bookId),</span><span id="9951" class="md iy ht lz b fv mi mf l mg mh">        "Can only return borrowing book."</span><span id="51b9" class="md iy ht lz b fv mi mf l mg mh">    );</span><span id="c75c" class="md iy ht lz b fv mi mf l mg mh">    ledger[_bookId] = address(0);</span><span id="e13c" class="md iy ht lz b fv mi mf l mg mh">    emit TakeBack(msg.sender, _bookId);</span><span id="dba7" class="md iy ht lz b fv mi mf l mg mh">}</span></pre><p id="a399" class="pw-post-body-paragraph jv jw ht jx b jy kt ka kb kc ku ke kf kg kv ki kj kk kw km kn ko kx kq kr ks hm dt translated">这里我们做一些验证</p><ul class=""><li id="41b1" class="ky kz ht jx b jy kt kc ku kg la kk lb ko lc ks ld le lf lg dt translated">我们想借的书的id是一个有效的id，不超过书店数组的最大id。</li><li id="54b7" class="ky kz ht jx b jy lh kc li kg lj kk lk ko ll ks ld le lf lg dt translated">如果分类账不包含借书历史或包含借书历史，但借书人是地址(0)，则认为该账簿可用。</li><li id="64d1" class="ky kz ht jx b jy lh kc li kg lj kk lk ko ll ks ld le lf lg dt translated">一个人只能在有书的时候借书</li><li id="c361" class="ky kz ht jx b jy lh kc li kg lj kk lk ko ll ks ld le lf lg dt translated">一个人只有在他/她是借书人的情况下才能把书还给图书馆</li></ul><p id="a4a1" class="pw-post-body-paragraph jv jw ht jx b jy kt ka kb kc ku ke kf kg kv ki kj kk kw km kn ko kx kq kr ks hm dt translated">我们还为对借书或还书事件感兴趣的客户发出事件。</p><h1 id="3dc7" class="ix iy ht bd iz ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq lq js jt ju dt translated">三。最后的话</h1><p id="91fa" class="pw-post-body-paragraph jv jw ht jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks hm dt translated">今天，我们使用以下知识创建了一个简单的图书馆智能合同:</p><ul class=""><li id="eda7" class="ky kz ht jx b jy kt kc ku kg la kk lb ko lc ks ld le lf lg dt translated">合同</li><li id="b488" class="ky kz ht jx b jy lh kc li kg lj kk lk ko ll ks ld le lf lg dt translated">功能</li><li id="ced2" class="ky kz ht jx b jy lh kc li kg lj kk lk ko ll ks ld le lf lg dt translated">访问修饰符:内部，公共…</li><li id="9efb" class="ky kz ht jx b jy lh kc li kg lj kk lk ko ll ks ld le lf lg dt translated">数据类型:基本类型，结构类型，数组，集合…</li><li id="7c12" class="ky kz ht jx b jy lh kc li kg lj kk lk ko ll ks ld le lf lg dt translated">功能修饰符</li><li id="e9fe" class="ky kz ht jx b jy lh kc li kg lj kk lk ko ll ks ld le lf lg dt translated">外部库(openzeppelin)</li></ul><p id="caee" class="pw-post-body-paragraph jv jw ht jx b jy kt ka kb kc ku ke kf kg kv ki kj kk kw km kn ko kx kq kr ks hm dt translated">在下一章，我们将看到如何使用etherjs与我们的智能合约进行交互。</p></div></div>    
</body>
</html>