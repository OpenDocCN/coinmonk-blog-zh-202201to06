<html>
<head>
<title>APE attack incident technical analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">APE攻击事件技术分析</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/technical-analysis-of-ape-attack-events-2c624d56c42d?source=collection_archive---------12-----------------------#2022-04-09">https://medium.com/coinmonks/technical-analysis-of-ape-attack-events-2c624d56c42d?source=collection_archive---------12-----------------------#2022-04-09</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/682f8accc66b3b08e431ddba3ab2310f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7u-f0kd-iq7ZNTw6o4666g.png"/></div></div></figure><h2 id="c115" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">0x01硬币</h2><p id="31a4" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated">在前一篇文章中我们已经提到了整个事件，这篇文章我们将以技术的方式进行分析。Apecoin是为无聊猿游艇俱乐部社区和相关社区服务的治理和实用工具。由于Bored Ape游艇俱乐部品牌的广泛流行，这次空投是NFT社区最受期待的空投之一。</p><h2 id="e4d2" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">0x02攻击者信息</h2><p id="afdc" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated">攻击发生在以太坊链条上，主要攻击信息如下:</p><p id="3c4b" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated"><strong class="kb hu">攻击者钱包地址:</strong></p><ul class=""><li id="19e2" class="kz la ht kb b kc ku kg kv jm lb jq lc ju ld kt le lf lg lh dt translated">0x 6703741 e 913 a 30d 6604481472 B6 d 81 F3 da 45 E6 e 8</li></ul><p id="e795" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">攻击者创建的相关合同地址:</p><ul class=""><li id="1475" class="kz la ht kb b kc ku kg kv jm lb jq lc ju ld kt le lf lg lh dt translated">0x 3 EBD 3d 86 f 810 b 141 f 9 B2 e9 b 15961 fc 66364 b 54 f 3</li><li id="b6bc" class="kz la ht kb b kc li kg lj jm lk jq ll ju lm kt le lf lg lh dt translated">0x 7797 a 99 a2 e 91646 abdc 9 DC 30 e 838 a 149 CCB 3013 b</li></ul><p id="d8a6" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated"><strong class="kb hu">代币合同(易受攻击合同):</strong></p><ul class=""><li id="282e" class="kz la ht kb b kc ku kg kv jm lb jq lc ju ld kt le lf lg lh dt translated">0x 025 c 6 da 5 BD 0 e 6 a5 DD 1350 FDA 9 E3 b 6 a 614 b 205 a1f</li></ul><p id="917a" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated"><strong class="kb hu">攻击交易流程:</strong></p><p id="abd3" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">0 xeb 8 C3 bebed 11 e 2e 4 fcd 30 CBF C2 FB 3c 55 C4 ca 166003 c 7 f 7d 319 e 78 ea ab 9747098</p><p id="227b" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated"><strong class="kb hu">漏洞相关合同:</strong></p><ul class=""><li id="64e8" class="kz la ht kb b kc ku kg kv jm lb jq lc ju ld kt le lf lg lh dt translated">beacon proxy:0 xea 47 b 64 E1 BF CCB 773 a 0420247 c 0 aa 0a 3a 3 C1 D2 e 5c 5</li><li id="deab" class="kz la ht kb b kc li kg lj jm lk jq ll ju lm kt le lf lg lh dt translated">nftxvaultupgradable:0x 73 D2 ff 81 fcea 9832 fc 9 ee 90521 abde 1150 f 6b 52a</li></ul><h2 id="94a8" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">0x03攻击分析</h2><figure class="lo lp lq lr fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff ln"><img src="../Images/a2f80a19c8646999671b14c991fb25c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FV0jfDEUIttnGMFqVL6n2w.png"/></div></div></figure><p id="b279" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated"><strong class="kb hu">攻击者主要进行了三个步骤:</strong></p><p id="1858" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated"><strong class="kb hu">第一步</strong>:攻击者通过闪贷获得ERC 20代币，并将其转换为NFT</p><p id="cf3d" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated"><strong class="kb hu">步骤2: </strong>攻击者使用交换的NFT获得APE空投令牌</p><p id="60b6" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated"><strong class="kb hu">第三步</strong>:归还NFT，获取质押的ERC 20代币，归还闪贷，将获利资金转入钱包地址</p><h2 id="46c2" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">0x04漏洞详细信息</h2><p id="ca95" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated">攻击成功的原因:</p><p id="b74c" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">第一步:快速贷款(合同:NFTXVaultUpgradeable)</p><figure class="lo lp lq lr fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff ls"><img src="../Images/d2388bd6f98d5c547a0a964093a1474a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hLNq_BYISy4Q9-IN4GVZvQ.png"/></div></div></figure><p id="f90d" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">如上图第999行所示:“数量+费用”的vToken会被破坏，所以攻击者准备的vToken需要大于借用的vToken才能执行flashLoan()函数。</p><p id="4caf" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">第二步:赎回NFT(合同:NFTXVaultUpgradeable)</p><figure class="lo lp lq lr fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff lt"><img src="../Images/c552925783fc9a790499043e7e858408.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qkDjFp6p9d-o90L-Jg1qRQ.png"/></div></div></figure><p id="cc65" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">如图:赎回函数调用<strong class="kb hu">赎回到</strong>函数，在2127行销毁代币，在2134行扣除手续费，在2137行直接将NFT发给调用者。</p><p id="124d" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">第三步:认领空投令牌(合同:AirdropGraphsToken)</p><figure class="lo lp lq lr fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff lu"><img src="../Images/22eeb9b578ffdc31c3ac1e779b65e0c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u8wqAioVFo3qAtFECPD25g.png"/></div></div></figure><p id="4825" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">如图所示:在第105行检查beta.balanceOf()和beta.balanceOf()，以确保调用者确实是BAYC/MAYC持有者。然后，在第114–115行，使用列表标记声明的tokenId。第110行中的getClaimableTokenAmountAndGammaToClaim()函数允许契约调用方只要求可以要求的ApeCoin的数量。</p><p id="3a9f" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">第4步:铸造(合同:NFTXVaultUpgradeable)</p><figure class="lo lp lq lr fq iu fe ff paragraph-image"><div class="fe ff lv"><img src="../Images/4ee5dd9d60a04673297f61f4fae903f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/1*x6ZHb-2crh4hMu3iNA8e7Q.png"/></div></figure><p id="c501" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">如图:2089行送NFT契约，2092行送代币，2094行消费手续费。整个NFTXVaultUpgradeable合同提供铸造、赎回和快速贷款功能。攻击者利用这种方法轻松绕过了对AirdropGraphsToken契约持有的当前NFT数量的检查，获得了很好的收益。</p><p id="b612" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">到目前为止，攻击者已经利用这一攻击过程攻击了<strong class="kb hu"> AirdropGraphsToken </strong>和<strong class="kb hu">nftxvaultupgradable</strong>合同，共获利约35万美元(以攻击时的市场价格计算)。</p><h2 id="2ff7" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">0x05总结</h2><p id="2f0a" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated">从这次攻击事件来看，攻击成功的最重要因素在AirdropGraphsToken合同中:没有对空投的原理进行合理的验证。攻击者可以通过用闪贷换取NFT来获得APE空投，然后把NFT币还给闪贷，对项目构成威胁。</p><h2 id="9acc" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">0x05安全建议</h2><ul class=""><li id="bd19" class="kz la ht kb b kc kd kg kh jm lw jq lx ju ly kt le lf lg lh dt translated">不依赖可以操纵的因素对资产进行定价</li><li id="b544" class="kz la ht kb b kc li kg lj jm lk jq ll ju lm kt le lf lg lh dt translated">使用机制来判断依赖条件是否合法(例如:判断依赖条件的持续时间)</li></ul><blockquote class="lz"><p id="2c78" class="ma mb ht bd mc md me mf mg mh mi kt ek translated">加入Coinmonks <a class="ae mj" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae mj" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h1 id="d40b" class="mk jc ht bd jd ml mm mn jh mo mp mq jl mr ms mt jp mu mv mw jt mx my mz jx na dt translated">另外，阅读</h1><ul class=""><li id="7437" class="kz la ht kb b kc kd kg kh jm lw jq lx ju ly kt le lf lg lh dt translated"><a class="ae mj" href="https://coincodecap.com/bookmap-review-2021-best-trading-software" rel="noopener ugc nofollow" target="_blank"> Bookmap评论</a> | <a class="ae mj" href="https://coincodecap.com/crypto-exchange-usa" rel="noopener ugc nofollow" target="_blank">美国5大最佳加密交易所</a></li><li id="5453" class="kz la ht kb b kc li kg lj jm lk jq ll ju lm kt le lf lg lh dt translated">最佳加密<a class="ae mj" rel="noopener" href="/coinmonks/hardware-wallets-dfa1211730c6">硬件钱包</a> | <a class="ae mj" rel="noopener" href="/coinmonks/bitbns-review-38256a07e161"> Bitbns评论</a></li><li id="48d4" class="kz la ht kb b kc li kg lj jm lk jq ll ju lm kt le lf lg lh dt translated"><a class="ae mj" href="https://coincodecap.com/crypto-exchange-in-singapore" rel="noopener ugc nofollow" target="_blank">新加坡十大最佳加密交易所</a> | <a class="ae mj" href="https://coincodecap.com/buy-axs-token" rel="noopener ugc nofollow" target="_blank">购买AXS </a></li><li id="df9a" class="kz la ht kb b kc li kg lj jm lk jq ll ju lm kt le lf lg lh dt translated"><a class="ae mj" href="https://coincodecap.com/red-dog-casino-review" rel="noopener ugc nofollow" target="_blank">红狗赌场评论</a> | <a class="ae mj" href="https://coincodecap.com/swyftx-review" rel="noopener ugc nofollow" target="_blank"> Swyftx评论</a> | <a class="ae mj" href="https://coincodecap.com/coingate-review" rel="noopener ugc nofollow" target="_blank"> CoinGate评论</a></li><li id="4ec2" class="kz la ht kb b kc li kg lj jm lk jq ll ju lm kt le lf lg lh dt translated"><a class="ae mj" href="https://coincodecap.com/best-crypto-to-invest-in-india-in-2021" rel="noopener ugc nofollow" target="_blank">投资印度的最佳密码</a>|<a class="ae mj" href="https://coincodecap.com/wazirx-p2p" rel="noopener ugc nofollow" target="_blank">WazirX P2P</a>|<a class="ae mj" href="https://coincodecap.com/hi-dollar-review" rel="noopener ugc nofollow" target="_blank">Hi Dollar Review</a></li></ul></div></div>    
</body>
</html>