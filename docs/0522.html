<html>
<head>
<title>Signing Transactions With React, Permit Transactions EIPS712</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用React签署交易，允许交易EIPS712</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/signing-transactions-with-react-permit-transactions-eips712-ec58b239bc7e?source=collection_archive---------0-----------------------#2022-02-09">https://medium.com/coinmonks/signing-transactions-with-react-permit-transactions-eips712-ec58b239bc7e?source=collection_archive---------0-----------------------#2022-02-09</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="d55c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在本文中，我将讨论使用数字签名来代替<a class="ae jo" href="https://ethereum.org/en/developers/tutorials/transfers-and-approval-of-erc-20-tokens-from-a-solidity-smart-contract/" rel="noopener ugc nofollow" target="_blank">批准</a>事务。批准与任何智能合同的数字资产交互相关的一般交易。例如，如果你想用一些ERC20代币支付费用，将你的NFT列入智能市场合同。您需要授权智能合约来执行此操作。或者你可以从你的外部拥有的账户手动地做这件事(<a class="ae jo" href="https://ethdocs.org/en/latest/contracts-and-transactions/account-types-gas-and-transactions.html#:~:text=Externally%20owned%20account%20(EOAs)%3A,and%20is%20controlled%20by%20code." rel="noopener ugc nofollow" target="_blank"> EOA </a>)可以调用<code class="eh jp jq jr js b">transfer</code>事务，因为它们依赖于<code class="eh jp jq jr js b">msg.sender</code>(如果你在契约内部调用它，<code class="eh jp jq jr js b">msg.sender</code>将返回契约地址并且<a class="ae jo" href="https://ethereum.stackexchange.com/questions/112644/approve-erc20-token-inside-a-contract-function" rel="noopener ugc nofollow" target="_blank">失败</a>)。这就是为什么我们有<code class="eh jp jq jr js b">approve</code>交易来授权智能合约使用您的令牌。总之，您有两个事务。第一个是用于智能合约授权的<code class="eh jp jq jr js b">approve</code>，第二个是你从智能合约中需要的任何东西，比如锁定资金、支付费用、在市场/拍卖中列出NFT等等。我们都知道交易费有多贵！这就是为什么<a class="ae jo" href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-712.md" rel="noopener ugc nofollow" target="_blank"> EIPS712 </a>提出，<code class="eh jp jq jr js b">permit</code>交易使用签名来批准令牌。</p><figure class="ju jv jw jx fq jy fe ff paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="fe ff jt"><img src="../Images/3749ad2e653f09208c2f9898866b5356.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NL94tTRilZsNRIgLu4w2gQ.png"/></div></div></figure><h1 id="288d" class="kf kg ht bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">数字签名</h1><p id="a21c" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">以太坊和区块链大多都使用<a class="ae jo" href="https://en.m.wikipedia.org/wiki/Elliptic_Curve_Digital_Signature_Algorithm" rel="noopener ugc nofollow" target="_blank">椭圆曲线数字签名</a>。我将涵盖从前端制作签名(反应)。但是我假设您使用的是OpenZeppelin库；我推荐它，因为它提供了一个方便的<a class="ae jo" href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/cryptography/ECDSA.sol" rel="noopener ugc nofollow" target="_blank">签名恢复库</a>，如果您对构建产品代码感兴趣的话，这个库已经被审计并且是安全的。</p><p id="1c26" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">数字签名类似于任何原始交易。您需要创建消息和数据对象，然后使用提供者对它们进行签名。</p><ol class=""><li id="6588" class="li lj ht is b it iu ix iy jb lk jf ll jj lm jn ln lo lp lq dt translated">创建<code class="eh jp jq jr js b">DOMAIN_SEPERATOR</code>常量。</li><li id="7a7a" class="li lj ht is b it lr ix ls jb lt jf lu jj lv jn ln lo lp lq dt translated">为ERC20/ERC721常量创建<code class="eh jp jq jr js b">PERMIT_INTERFACE</code>。</li><li id="925d" class="li lj ht is b it lr ix ls jb lt jf lu jj lv jn ln lo lp lq dt translated">创建事务处理<code class="eh jp jq jr js b">Message</code>对象。</li><li id="7ec5" class="li lj ht is b it lr ix ls jb lt jf lu jj lv jn ln lo lp lq dt translated">创建事务<code class="eh jp jq jr js b">Date</code>对象。</li><li id="8e72" class="li lj ht is b it lr ix ls jb lt jf lu jj lv jn ln lo lp lq dt translated">签署交易。</li></ol><h2 id="8a37" class="lw kg ht bd kh lx ly lz kl ma mb mc kp jb md me kt jf mf mg kx jj mh mi lb mj dt translated">域<code class="eh jp jq jr js b">Separator</code></h2><p id="e77c" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">域分隔符是协定名称、版本、链ID和智能协定地址。全部使用<code class="eh jp jq jr js b">keccak256</code>散列。当创建签名时，用户使用这个散列，并且在执行许可时必须匹配。这确保了签名仅对一份合同有效。</p><p id="0f4c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">域分隔符类型:</p><pre class="ju jv jw jx fq mk js ml mm aw mn dt"><span id="d86e" class="lw kg ht js b fv mo mp l mq mr">const EIP712Domain = [  <br/>    { name: "name", type: "string" },  <br/>    { name: "version", type: "string" },  <br/>    { name: "chainId", type: "uint256" },  <br/>    { name: "verifyingContract", type: "address" },<br/>];</span></pre><p id="23b1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">域分隔符值:</p><pre class="ju jv jw jx fq mk js ml mm aw mn dt"><span id="ca77" class="lw kg ht js b fv mo mp l mq mr">const contractName = await contract.name();  <br/>const { chainId } = library.network;</span><span id="3231" class="lw kg ht js b fv ms mp l mq mr">const domain = {    <br/>      name: contractName,    <br/>      version: "1",    <br/>      chainId,    <br/>      verifyingContract: contract.address <br/> };</span></pre><h2 id="847e" class="lw kg ht bd kh lx ly lz kl ma mb mc kp jb md me kt jf mf mg kx jj mh mi lb mj dt translated">许可界面</h2><p id="dfa0" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">permit接口是传递给事务的参数。(名称和类型)许可接口常量将像上面的域分隔符一样散列</p><pre class="ju jv jw jx fq mk js ml mm aw mn dt"><span id="6e93" class="lw kg ht js b fv mo mp l mq mr">const Permit = [  <br/>   { name: "owner", type: "address" },  <br/>   { name: "spender", type: "address" }, <br/>   // In case ERC20 `tokenId` will be `value` <br/>   { name: "tokenId", type: "uint256" }, <br/>   { name: "nonce", type: "uint256" },    <br/>   { name: "deadline", type: "uint256" },<br/>];</span></pre><p id="0ca1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在，我创建了制作事务消息所需的两个常量。</p><h2 id="3337" class="lw kg ht bd kh lx ly lz kl ma mb mc kp jb md me kt jf mf mg kx jj mh mi lb mj dt translated">创建交易<code class="eh jp jq jr js b">Message</code>对象</h2><p id="933c" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">交易消息需要帐户地址、account <a class="ae jo" rel="noopener" href="/coinmonks/the-account-nonce-in-ethereum-explained-c087bd4a3c29"> nonce </a>、My account、spender和我想授权使用我的资产的智能合同地址。令牌ID是我想要使用的ERC721的ID。(市场/拍卖智能合同上的列表)。如果我允许一些ERC20代币支付费用。我将用我想支付的值(ERC20)更改令牌ID。</p><pre class="ju jv jw jx fq mk js ml mm aw mn dt"><span id="100f" class="lw kg ht js b fv mo mp l mq mr">const [account] = await provider.listAccounts();<br/>const nonce = await contract.nonces(account);<br/>const transactionDeadline = <!-- -->Date.now() + 20 * 60;</span><span id="0479" class="lw kg ht js b fv ms mp l mq mr">const message = {    <br/>    owner: account,    <br/>    spender,// address of the smart contract that I want to allow    <br/>    tokenId: tokenId.toString(),// value in case of ERC20 <br/>    nonce: nonce.toHexString(),    <br/>    deadline: transactionDeadline , //permit for 20 minutes only<br/>};</span></pre><h2 id="75d1" class="lw kg ht bd kh lx ly lz kl ma mb mc kp jb md me kt jf mf mg kx jj mh mi lb mj dt translated">创建交易<code class="eh jp jq jr js b">Data</code>对象</h2><p id="5f06" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">智能合约交易需要数据属性，因为它们包含您希望执行的智能功能以及任何参数。我将把事务消息、类型、接口和域添加到要由提供者签名的字符串中。</p><pre class="ju jv jw jx fq mk js ml mm aw mn dt"><span id="8940" class="lw kg ht js b fv mo mp l mq mr">const data = JSON.stringify({    <br/>        types: {      <br/>        EIP712Domain,      <br/>        Permit: ERC721PermitInterface,    <br/>        },    <br/>       domain,    <br/>       primaryType: "Permit",    <br/>       message, <br/>  });</span></pre><h2 id="6183" class="lw kg ht bd kh lx ly lz kl ma mb mc kp jb md me kt jf mf mg kx jj mh mi lb mj dt translated">签署交易</h2><p id="5cd9" class="pw-post-body-paragraph iq ir ht is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hm dt translated">要验证交易的来源，您必须签署数据。为了对交易进行签名，我将使用<code class="eh jp jq jr js b">eth_signTypedData_v4</code>最新版本的签名方法。你可以在这里阅读更多关于他们的信息<a class="ae jo" href="https://docs.metamask.io/guide/signing-data.html#sign-typed-data-v1" rel="noopener ugc nofollow" target="_blank">。</a></p><pre class="ju jv jw jx fq mk js ml mm aw mn dt"><span id="2702" class="lw kg ht js b fv mo mp l mq mr">const signature = await library.send("eth_signTypedData_v4", [account, data]);<br/>const signData = ethers.utils.splitSignature(signature);  <br/>const { v,r,s} = signData;</span></pre><p id="5d8a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">就是这样！现在您需要做的就是返回签名参数<code class="eh jp jq jr js b">deadline,v,r,s</code>并将其传递给您的事务</p><pre class="ju jv jw jx fq mk js ml mm aw mn dt"><span id="c7a4" class="lw kg ht js b fv mo mp l mq mr">return{<br/> deadline,<br/> v,<br/> r,<br/> s<br/>}<br/>// inside you transaction file<br/>contract.interface.transactionNeedSignature(...params,deadline,     v,r,s)</span></pre><p id="029d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">你可以在这个<a class="ae jo" href="https://gist.github.com/yehia67/352984028a7955a7bc3e6f991eb6c2a0" rel="noopener ugc nofollow" target="_blank">要点</a>上看到所有的erc721许可功能。erc20 <a class="ae jo" href="https://gist.github.com/yehia67/06b43c3280b9e35eda89a784c4b753b1" rel="noopener ugc nofollow" target="_blank">许可功能</a>也是如此。我希望我说清楚了。如果你有任何问题，不要犹豫问我。</p><h1 id="86cc" class="kf kg ht bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">资源</h1><div class="mt mu fm fo mv mw"><a href="https://hackernoon.com/how-to-code-gas-less-tokens-on-ethereum-43u3ew4" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab ej"><div class="my ab mz cl cj na"><h2 class="bd hu fv z el nb eo ep nc er et hs dt translated">如何在以太坊上编码无气代币|黑客正午</h2><div class="nd l"><h3 class="bd b fv z el nb eo ep nc er et ek translated">每个人都在谈论“无气”以太坊交易，因为没有人喜欢为气付钱。但是以太坊网络…</h3></div><div class="ne l"><p class="bd b gc z el nb eo ep nc er et ek translated">hackernoon.com</p></div></div><div class="nf l"><div class="ng l nh ni nj nf nk kd mw"/></div></div></a></div><div class="mt mu fm fo mv mw"><a href="https://github.com/makerdao/developerguides/blob/master/dai/how-to-use-permit-function/how-to-use-permit-function.md" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab ej"><div class="my ab mz cl cj na"><h2 class="bd hu fv z el nb eo ep nc er et hs dt translated">主makerdao/developerguides上的developer guides/how-to-use-permit-function . MD</h2><div class="nd l"><h3 class="bd b fv z el nb eo ep nc er et ek translated">如何在Dai中使用许可证功能和继电器为Dai交易支付天然气费用了解Dai许可证功能…</h3></div><div class="ne l"><p class="bd b gc z el nb eo ep nc er et ek translated">github.com</p></div></div><div class="nf l"><div class="nl l nh ni nj nf nk kd mw"/></div></div></a></div><div class="mt mu fm fo mv mw"><a href="https://soliditydeveloper.com/erc20-permit" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab ej"><div class="my ab mz cl cj na"><h2 class="bd hu fv z el nb eo ep nc er et hs dt translated">路漫漫其修远兮:论无气代币和ERC20-Permit</h2><div class="nd l"><h3 class="bd b fv z el nb eo ep nc er et ek translated">现在是2019年4月的悉尼。在这里，我正在寻找悉尼大学建筑群内的Edcon黑客马拉松。它…</h3></div><div class="ne l"><p class="bd b gc z el nb eo ep nc er et ek translated">soliditydeveloper.com</p></div></div><div class="nf l"><div class="nm l nh ni nj nf nk kd mw"/></div></div></a></div><div class="mt mu fm fo mv mw"><a rel="noopener follow" target="_blank" href="/coinmonks/eip712-a-full-stack-example-e12185b03d54"><div class="mx ab ej"><div class="my ab mz cl cj na"><h2 class="bd hu fv z el nb eo ep nc er et hs dt translated">EIP712，全栈示例</h2><div class="nd l"><h3 class="bd b fv z el nb eo ep nc er et ek translated">我当时正在做一个需要使用EIP712的项目。GitHub中有很多文章和例子解释了…</h3></div><div class="ne l"><p class="bd b gc z el nb eo ep nc er et ek translated">medium.com</p></div></div><div class="nf l"><div class="nn l nh ni nj nf nk kd mw"/></div></div></a></div><blockquote class="no"><p id="14a2" class="np nq ht bd nr ns nt nu nv nw nx jn ek translated">加入Coinmonks <a class="ae jo" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae jo" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h2 id="594f" class="lw kg ht bd kh lx ny lz kl ma nz mc kp jb oa me kt jf ob mg kx jj oc mi lb mj dt translated">也阅读</h2><div class="mt mu fm fo mv mw"><a rel="noopener follow" target="_blank" href="/coinmonks/leveraged-token-3f5257808b22"><div class="mx ab ej"><div class="my ab mz cl cj na"><h2 class="bd hu fv z el nb eo ep nc er et hs dt translated">杠杆代币[多头代币]终极指南</h2><div class="nd l"><h3 class="bd b fv z el nb eo ep nc er et ek translated">杠杆化令牌是具有杠杆化风险敞口的ERC20令牌，不考虑保证金、要求、管理…</h3></div><div class="ne l"><p class="bd b gc z el nb eo ep nc er et ek translated">medium.com</p></div></div><div class="nf l"><div class="od l nh ni nj nf nk kd mw"/></div></div></a></div><div class="mt mu fm fo mv mw"><a href="https://coincodecap.com/crypto-exchange" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab ej"><div class="my ab mz cl cj na"><h2 class="bd hu fv z el nb eo ep nc er et hs dt translated">最佳加密交易所| 2022年十大加密货币交易所| CoinCodeCap</h2><div class="nd l"><h3 class="bd b fv z el nb eo ep nc er et ek translated">哪一个是最好的加密交换？在本文中，我们将根据多种加密货币列出10大加密货币交易所</h3></div><div class="ne l"><p class="bd b gc z el nb eo ep nc er et ek translated">coincodecap.com</p></div></div><div class="nf l"><div class="oe l nh ni nj nf nk kd mw"/></div></div></a></div><div class="mt mu fm fo mv mw"><a href="https://coincodecap.com/top-3-gaming-tokens-to-look-out-for-in-february-2022" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab ej"><div class="my ab mz cl cj na"><h2 class="bd hu fv z el nb eo ep nc er et hs dt translated">2022年2月值得关注的三大游戏代币| CoinCodeCap</h2><div class="nd l"><h3 class="bd b fv z el nb eo ep nc er et ek translated">排名前3位的游戏也占交易总量的85%以上。Defi王国、Axie Infinity和Pegaxy…</h3></div><div class="ne l"><p class="bd b gc z el nb eo ep nc er et ek translated">coincodecap.com</p></div></div><div class="nf l"><div class="of l nh ni nj nf nk kd mw"/></div></div></a></div><div class="mt mu fm fo mv mw"><a href="https://coincodecap.com/best-swap-platforms" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab ej"><div class="my ab mz cl cj na"><h2 class="bd hu fv z el nb eo ep nc er et hs dt translated">2022年最佳加密交换平台| CoinCodeCap</h2><div class="nd l"><h3 class="bd b fv z el nb eo ep nc er et ek translated">随着时间的推移，我们大多数人将转向dex以获得更好的安全性和隐私。因此。在这里，我们将讨论…</h3></div><div class="ne l"><p class="bd b gc z el nb eo ep nc er et ek translated">coincodecap.com</p></div></div><div class="nf l"><div class="og l nh ni nj nf nk kd mw"/></div></div></a></div><div class="mt mu fm fo mv mw"><a href="https://coincodecap.com/best-online-casinos" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab ej"><div class="my ab mz cl cj na"><h2 class="bd hu fv z el nb eo ep nc er et hs dt translated">10大最佳在线赌场|赢得并赢取免费BTC 2022 | CoinCodeCap</h2><div class="nd l"><h3 class="bd b fv z el nb eo ep nc er et ek translated">接收、支付和赚取加密货币| |有各种各样的最佳在线赌场可供选择，有可能…</h3></div><div class="ne l"><p class="bd b gc z el nb eo ep nc er et ek translated">coincodecap.com</p></div></div><div class="nf l"><div class="oh l nh ni nj nf nk kd mw"/></div></div></a></div><div class="mt mu fm fo mv mw"><a rel="noopener follow" target="_blank" href="/coinmonks/top-5-crypto-lending-platforms-in-2020-that-you-need-to-know-a1b675cec3fa"><div class="mx ab ej"><div class="my ab mz cl cj na"><h2 class="bd hu fv z el nb eo ep nc er et hs dt translated">2021年最佳加密借贷平台| 6大比特币借贷平台</h2><div class="nd l"><h3 class="bd b fv z el nb eo ep nc er et ek translated">获得比特币和其他加密货币的最佳贷款利率</h3></div><div class="ne l"><p class="bd b gc z el nb eo ep nc er et ek translated">medium.com</p></div></div><div class="nf l"><div class="oi l nh ni nj nf nk kd mw"/></div></div></a></div><div class="mt mu fm fo mv mw"><a rel="noopener follow" target="_blank" href="/coinmonks/the-best-cryptocurrency-hardware-wallets-of-2020-e28b1c124069"><div class="mx ab ej"><div class="my ab mz cl cj na"><h2 class="bd hu fv z el nb eo ep nc er et hs dt translated">2021年6大最佳硬件钱包|顶级加密硬件钱包[更新]</h2><div class="nd l"><h3 class="bd b fv z el nb eo ep nc er et ek translated">最好的加密货币硬件钱包是绝对必要的。我们将在NGRAVE、Ledger Nano X和…</h3></div><div class="ne l"><p class="bd b gc z el nb eo ep nc er et ek translated">medium.com</p></div></div><div class="nf l"><div class="oj l nh ni nj nf nk kd mw"/></div></div></a></div><div class="mt mu fm fo mv mw"><a rel="noopener follow" target="_blank" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a"><div class="mx ab ej"><div class="my ab mz cl cj na"><h2 class="bd hu fv z el nb eo ep nc er et hs dt translated">加密交易机器人——19款最佳免费加密交易机器人</h2><div class="nd l"><h3 class="bd b fv z el nb eo ep nc er et ek translated">2022年币安、比特币基地、库币和其他密码交易所的最佳密码交易机器人。四进制，位间隙…</h3></div><div class="ne l"><p class="bd b gc z el nb eo ep nc er et ek translated">medium.com</p></div></div><div class="nf l"><div class="ok l nh ni nj nf nk kd mw"/></div></div></a></div></div></div>    
</body>
</html>