<html>
<head>
<title>Upgrading Smart Contracts using OpenZeppelin Upgrade Plugin</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用OpenZeppelin升级插件升级智能合同</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/upgrading-smart-contracts-using-openzeppelin-upgrade-plugin-d0213fb5ab53?source=collection_archive---------4-----------------------#2022-05-23">https://medium.com/coinmonks/upgrading-smart-contracts-using-openzeppelin-upgrade-plugin-d0213fb5ab53?source=collection_archive---------4-----------------------#2022-05-23</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/937b739c43431fbb844c71a56375fc23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1qX9nK5nN4FIo4DZjRNhrw.jpeg"/></div></div></figure><h1 id="4fab" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">一点介绍</h1><p id="3815" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw hm dt translated">当我看到可升级合同时，我有点吃惊。<em class="kx">升级</em>？当智能合约被设计为默认不可变时，为什么升级是一个话题？<em class="kx">一旦在区块链上签订了合同，就无法更改了</em>。你可能和我有同样的问题/想法，甚至更多。在研究如何编写可升级合约时，我在理解和找到一个解释清楚的指南方面遇到了一点挑战，这就是为什么我将在本文中讨论一些基础知识，并向您展示如何使用openzepplin插件编写一个简单的可升级智能合约。</p><h1 id="0c8d" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">为什么</h1><p id="02b3" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw hm dt translated">有些情况需要修改合同。与日常生活相关，签订合同的双方可以决定更改协议，也许他们必须删除一些条款或增加一些条款或修正错误。只要他们双方都同意，就可以改变。在以太坊这样的区块链上，可能在已经部署到生产中的智能合约中发现了一个bug，或者只是需要更多的功能。可能是任何事。它绝对需要升级。</p><h1 id="3ea6" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">OpenZepplin</h1><figure class="kz la lb lc fq iu fe ff paragraph-image"><div class="fe ff ky"><img src="../Images/d1f9604b12c57274e814fde3e261401e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*71Xbl3PN7_pHTc6BLFgd7Q.png"/></div><figcaption class="ld le fg fe ff lf lg bd b be z ek">OpenZeppelin</figcaption></figure><p id="6b2a" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">在保护产品、自动化和操作分散应用方面，OpenZeppelin是领先的公司。他们通过对系统和产品进行安全审计来保护领先的组织。他们有一个以太坊网络的模块化、可重用、安全的智能合同库，用Solidity编写。多亏了<a class="ae lm" href="https://docs.openzeppelin.com/upgrades-plugins/1.x/" rel="noopener ugc nofollow" target="_blank"> OpenZeppelin升级插件</a>，在保留地址、状态和余额等重要信息的同时，修改合同非常容易。</p><h1 id="7c05" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">怎么做</h1><p id="859d" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw hm dt translated">智能合约可以使用代理进行升级。基本上，有两个合同:</p><ol class=""><li id="72d2" class="ln lo ht kb b kc lh kg li kk lp ko lq ks lr kw ls lt lu lv dt translated">契约1(代理/访问点):这个契约是一个将直接交互的代理或包装器。它还负责在我接下来要谈到的第二个合同中来回发送事务</li><li id="4868" class="ln lo ht kb b kc lw kg lx kk ly ko lz ks ma kw ls lt lu lv dt translated">契约2(逻辑契约):这个契约包含逻辑。</li></ol><p id="6b88" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated"><strong class="kb hu"> <em class="kx">需要注意的一点是，代理从不改变，但是，您可以将逻辑契约换成另一个契约，这意味着接入点/代理可以指向不同的逻辑契约(换句话说，它得到了升级)。这在下面的</em>和</strong>中有说明</p><figure class="kz la lb lc fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mb"><img src="../Images/83d07bdb784e8e482aed94c58f9a1b67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*APuGO6Qf5172QD4d.png"/></div></div></figure><p id="2a7e" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated"><em class="kx">来源:</em><a class="ae lm" href="https://docs.openzeppelin.com/upgrades-plugins/1.x/proxies#upgrading-via-the-proxy-pattern" rel="noopener ugc nofollow" target="_blank"><em class="kx">https://docs . open zeppelin . com/upgrades-plugins/1 . x/proxy # upgrading-via-the-proxy-pattern</em></a></p><p id="29e8" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">要了解有关代理概念的更多信息，请访问<a class="ae lm" href="https://docs.openzeppelin.com/upgrades-plugins/1.x/proxies" rel="noopener ugc nofollow" target="_blank">openzeplin代理升级模式文档页面</a>和<a class="ae lm" href="https://docs.openzeppelin.com/contracts/4.x/api/proxy" rel="noopener ugc nofollow" target="_blank">openzeplin代理页面</a></p><h1 id="84aa" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">可升级性模式</h1><p id="dbc3" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw hm dt translated">我们有几种可升级模式。下面列出了四种模式</p><ul class=""><li id="87fa" class="ln lo ht kb b kc lh kg li kk lp ko lq ks lr kw mc lt lu lv dt translated">UUPS代理:EIP1822</li><li id="b3e0" class="ln lo ht kb b kc lw kg lx kk ly ko lz ks ma kw mc lt lu lv dt translated">透明代理:EIP1967(我们将在本文中重点关注这一点)</li><li id="3196" class="ln lo ht kb b kc lw kg lx kk ly ko lz ks ma kw mc lt lu lv dt translated">钻石储存:EIP2355</li><li id="d207" class="ln lo ht kb b kc lw kg lx kk ly ko lz ks ma kw mc lt lu lv dt translated">永恒存储:ERC930</li></ul><h1 id="43dd" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">透明代理(EIP1967)</h1><p id="32a1" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw hm dt translated">透明代理包括代理本身的升级和管理逻辑。我认为管理员是启动第一次升级的合同的所有者。</p><p id="f37f" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">使用透明代理，除了调用代理的管理员之外的任何帐户都将把他们的调用转发到实现。同样，如果管理员调用代理，它可以访问管理功能，但是管理调用永远不会被转发到实现。</p><p id="88a4" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">总之，对于管理员来说，最好是一个专用帐户，只用于其目的，这显然是管理员<em class="kx"/>。</p><h1 id="6966" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">实际步骤</h1><p id="c9b9" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw hm dt translated">先决条件:如何设置开发环境和如何编写智能合同的知识。更多信息<a class="ae lm" href="https://docs.openzeppelin.com/learn/developing-smart-contracts" rel="noopener ugc nofollow" target="_blank">点击此处</a></p><p id="ab18" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">让我们写一份可升级的合同吧！我们将开放zeplin的安全帽升级插件。要安装，只需运行</p><pre class="kz la lb lc fq md me mf mg aw mh dt"><span id="e1b4" class="mi jc ht me b fv mj mk l ml mm">npm install --save-dev @openzeppelin/hardhat-upgrades @nomiclabs/hardhat-ethers ethers</span></pre><p id="5389" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">在您的<code class="eh mn mo mp me b">hardhat.config</code>文件中，您需要加载它</p><pre class="kz la lb lc fq md me mf mg aw mh dt"><span id="3bd1" class="mi jc ht me b fv mj mk l ml mm">// js<br/>require('@openzeppelin/hardhat-upgrades');</span><span id="1d8b" class="mi jc ht me b fv mq mk l ml mm">// ts<br/>import '@openzeppelin/hardhat-upgrades';</span></pre><p id="b921" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated"><em class="kx">我将在这篇文章中使用js</em></p><p id="83b9" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">您的<code class="eh mn mo mp me b">hardhat.config.js</code>文件应该与此类似</p><pre class="kz la lb lc fq md me mf mg aw mh dt"><span id="d4d8" class="mi jc ht me b fv mj mk l ml mm">require("@nomiclabs/hardhat-ethers");<br/>require("@openzeppelin/hardhat-upgrades");<br/>require("@nomiclabs/hardhat-etherscan");</span><span id="0bcd" class="mi jc ht me b fv mq mk l ml mm">//Using alchemy because I intend to deploy on goerli testnet, an apikey is required<br/>//The mnemonic is your account's mnemonic<br/>//if you intend to verify your contracts, you need to open an account on etherscan and copy the apikey<br/>//all important keys should not be exposed, it can be kept in a secret.json file and added to gitignore</span><span id="0ccb" class="mi jc ht me b fv mq mk l ml mm">const { alchemyApiKey, mnemonic } = require("./secrets.json");</span><span id="c027" class="mi jc ht me b fv mq mk l ml mm">module.exports = {<br/>  networks: {<br/>    goerli: {<br/>      url: `https://eth-goerli.alchemyapi.io/v2/${alchemyApiKey}`,<br/>      accounts: { mnemonic: mnemonic },<br/>    },<br/>  },<br/>  etherscan: {<br/>    apiKey: "YOUR_API_KEY",<br/>  },<br/>  solidity: "0.8.4",<br/>};</span></pre><p id="2186" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated"><strong class="kb hu">合同一(</strong> <code class="eh mn mo mp me b"><strong class="kb hu">contracts/Atm.sol</strong></code> <strong class="kb hu">)(代理合同)</strong></p><p id="2090" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">在您的contracts文件夹中，创建一个新的<code class="eh mn mo mp me b">.sol</code>文件。在本文中，我将模拟一个自动取款机/银行。于是，创造了<code class="eh mn mo mp me b">Atm.sol</code>。代码应该如下所示</p><pre class="kz la lb lc fq md me mf mg aw mh dt"><span id="a9a5" class="mi jc ht me b fv mj mk l ml mm">// SPDX-License-Identifier: MIT<br/>pragma solidity ^0.8.0;<br/>contract Atm {</span><span id="582d" class="mi jc ht me b fv mq mk l ml mm">    // Declare state variables of the contract<br/>    uint256 bankBalances;</span><span id="813f" class="mi jc ht me b fv mq mk l ml mm">    // Allow the owner to deposit money into the account<br/>    function deposit(uint256 amount) public {<br/>        bankBalances += amount;<br/>    }<br/>    function getBalance() public view returns (uint256) {<br/>        return bankBalances;<br/>    }<br/>}</span></pre><p id="2d0e" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated"><strong class="kb hu">测试合同</strong></p><p id="02fc" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">如下图所示，在<code class="eh mn mo mp me b">test/Atm-test.js</code>中测试您的合同</p><pre class="kz la lb lc fq md me mf mg aw mh dt"><span id="a4e8" class="mi jc ht me b fv mj mk l ml mm">const { expect } = require("chai");<br/>const { ethers } = require("hardhat");</span><span id="d0aa" class="mi jc ht me b fv mq mk l ml mm">describe("Atm", function () {<br/>  before(async function () {<br/>    this.Atm = await ethers.getContractFactory("Atm");<br/>  });</span><span id="6b8e" class="mi jc ht me b fv mq mk l ml mm">  beforeEach(async function () {<br/>    this.atm = await this.Atm.deploy();<br/>    await this.atm.deployed();</span><span id="80e7" class="mi jc ht me b fv mq mk l ml mm">    it("", async function () {});<br/>    await this.atm.deposit(1000);<br/>    expect((await this.atm.getBalance()).toString()).to.equal("1000");<br/>  });<br/>});</span></pre><p id="c90a" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">要进行测试，请运行以下命令</p><pre class="kz la lb lc fq md me mf mg aw mh dt"><span id="49ce" class="mi jc ht me b fv mj mk l ml mm">npx hardhat test</span></pre><p id="bf6e" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated"><strong class="kb hu">部署合同</strong></p><p id="066d" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated"><em class="kx">！重要提示:</em>为了能够升级自动柜员机合同，我们需要首先将其部署为可升级合同。这与我们习惯的部署程序不同。我们正在初始化开始余额为0。该脚本使用来自插件的<code class="eh mn mo mp me b">deployProxy</code>方法。</p><p id="16fa" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">创建一个<code class="eh mn mo mp me b">deploy-atm.js</code>脚本</p><pre class="kz la lb lc fq md me mf mg aw mh dt"><span id="c6a2" class="mi jc ht me b fv mj mk l ml mm">const { ethers, upgrades } = require("hardhat");</span><span id="82d0" class="mi jc ht me b fv mq mk l ml mm">async function main() {<br/>  const Atm = await ethers.getContractFactory("Atm");<br/>  console.log("Deploying Atm...");<br/>  const atm = await upgrades.deployProxy(Atm, [0], {<br/>    initializer: "deposit",<br/>  });</span><span id="4ab3" class="mi jc ht me b fv mq mk l ml mm">  console.log(atm.address, " atm(proxy) address");<br/>}</span><span id="3837" class="mi jc ht me b fv mq mk l ml mm">main().catch((error) =&gt; {<br/>  console.error(error);<br/>  process.exitCode = 1;<br/>});</span></pre><p id="5a17" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">您也可以决定对此进行测试。如果您希望测试，您的测试文件应该类似于以下内容</p><p id="56aa" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated"><strong class="kb hu">测试脚本</strong></p><pre class="kz la lb lc fq md me mf mg aw mh dt"><span id="0e0c" class="mi jc ht me b fv mj mk l ml mm">const { expect } = require("chai");<br/>const { ethers, upgrades } = require("hardhat");<br/>const { Contract, BigNumber } = "ethers";</span><span id="91b8" class="mi jc ht me b fv mq mk l ml mm">describe("Atm (proxy)", function () {<br/>  let box = Contract;</span><span id="9d7c" class="mi jc ht me b fv mq mk l ml mm">  beforeEach(async function () {<br/>    const Atm = await ethers.getContractFactory("Atm");<br/>    //initilize with 0<br/>    atm = await upgrades.deployProxy(Atm, [0], { initializer: "deposit" });<br/>  });</span><span id="9d41" class="mi jc ht me b fv mq mk l ml mm">  it("should return available balance", async function () {</span><span id="730b" class="mi jc ht me b fv mq mk l ml mm">    expect((await atm.getBalance()).toString()).to.equal("0");</span><span id="f61a" class="mi jc ht me b fv mq mk l ml mm">    await atm.deposit(1000);<br/>    expect((await atm.getBalance()).toString()).to.equal("1000");<br/>  });<br/>});</span></pre><p id="1739" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">确认测试后，</p><p id="dd64" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">让我们先部署到本地，我们使用run命令并将Atm合同部署到dev network。</p><pre class="kz la lb lc fq md me mf mg aw mh dt"><span id="5992" class="mi jc ht me b fv mj mk l ml mm">$ npx hardhat run --network localhost scripts/deploy-atm.js<br/>Deploying Atm...<br/>0xDc64a140Aa3E981100a9becA4E685f962f0cF6C9  atm(proxy) address</span></pre><p id="f70b" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">至此，我们已经成功部署并拥有了我们的代理和管理地址。</p><p id="20ea" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated"><strong class="kb hu">合同二</strong></p><p id="f500" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">我们想添加一个新的功能到我们的合同，一个简单的功能是包括一个添加功能，增加500到我们的平衡。</p><p id="0be9" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">创建<code class="eh mn mo mp me b">contracts/AtmV2.sol</code></p><pre class="kz la lb lc fq md me mf mg aw mh dt"><span id="b131" class="mi jc ht me b fv mj mk l ml mm">// SPDX-License-Identifier: MIT<br/>pragma solidity ^0.8.0;</span><span id="6dfa" class="mi jc ht me b fv mq mk l ml mm">import "./Atm.sol";</span><span id="78ce" class="mi jc ht me b fv mq mk l ml mm">contract AtmV2 is Atm{<br/>    // adds to the balance by 500<br/>    function add() public {<br/>        deposit(getBalance()+500);<br/>    }<br/>}</span></pre><p id="6562" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated"><strong class="kb hu">测试合同</strong></p><p id="3082" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">参考我们如何测试合同1，基本上遵循相同的逻辑。</p><p id="e3ed" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated"><strong class="kb hu">升级合同</strong></p><p id="9f4f" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">现在是使用我们的代理/接入点地址的时候了。我们将使用插件中的<code class="eh mn mo mp me b">upgradeProxy and 'getAdmin'</code>方法。从上面的部署控制台调用我们的代理地址，因为我们在这里需要它。</p><p id="7887" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">创造<code class="eh mn mo mp me b">scripts/upgrade-atmV2.js</code>。您的脚本应该类似于以下内容</p><pre class="kz la lb lc fq md me mf mg aw mh dt"><span id="31bd" class="mi jc ht me b fv mj mk l ml mm">const { ethers, upgrades } = require("hardhat");</span><span id="caef" class="mi jc ht me b fv mq mk l ml mm">const proxyAddress = "YOUR_PROXY_ADDRESS_FROM_DEPLOYMENT";</span><span id="82da" class="mi jc ht me b fv mq mk l ml mm">async function main() {<br/>  console.log(proxyAddress, " original Atm(proxy) address");<br/>  const AtmV2 = await ethers.getContractFactory("AtmV2");<br/>  console.log("upgrade to AtmV2...");<br/>  const atmV2 = await upgrades.upgradeProxy(proxyAddress, AtmV2);<br/>  console.log(atmV2.address, " AtmV2 address(should be the same)");<br/>  console.log(<br/>    await upgrades.erc1967.getAdminAddress(atmV2.address),<br/>    "Proxy Admin"<br/>  );<br/>console.log('Atm upgraded');<br/>}</span><span id="13ea" class="mi jc ht me b fv mq mk l ml mm">main().catch((error) =&gt; {<br/>  console.error(error);<br/>  process.exitCode = 1;<br/>});</span></pre><p id="e944" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated"><strong class="kb hu">测试脚本</strong></p><p id="58d3" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">创建一个<code class="eh mn mo mp me b">scripts/AtmProxyV2-test.js</code>。它应该看起来像这样</p><pre class="kz la lb lc fq md me mf mg aw mh dt"><span id="a035" class="mi jc ht me b fv mj mk l ml mm">const { expect } = require("chai");<br/>const { ethers, upgrades } = require("hardhat");<br/>const { Contract, BigNumber } = "ethers";</span><span id="164d" class="mi jc ht me b fv mq mk l ml mm">describe("Atm (proxy) V2", function () {<br/>  let atm = Contract;<br/>  let atmV2 = Contract;</span><span id="3715" class="mi jc ht me b fv mq mk l ml mm">  beforeEach(async function () {<br/>    const Atm = await ethers.getContractFactory("Atm");<br/>    const AtmV2 = await ethers.getContractFactory("AtmV2");</span><span id="264c" class="mi jc ht me b fv mq mk l ml mm">    //initilize with 0<br/>    atm = await upgrades.deployProxy(Atm, [0], { initializer: "deposit" });</span><span id="aa7e" class="mi jc ht me b fv mq mk l ml mm">    atmV2 = await upgrades.upgradeProxy(atm.address, AtmV2);<br/>  });</span><span id="781a" class="mi jc ht me b fv mq mk l ml mm">  it("should get balance and addition correctly", async function () {<br/>    expect((await atmV2.getBalance()).toString()).to.equal("0");</span><span id="6110" class="mi jc ht me b fv mq mk l ml mm">    await atmV2.add();<br/>    //result = 0 + 500 = 500<br/>    expect((await atmV2.getBalance()).toString()).to.equal("500");<br/>    //balance is now 500, so add 100;<br/>    await atmV2.deposit(100);<br/>    //result = 500 + 100 = 600<br/>    expect((await atmV2.getBalance()).toString()).to.equal("600");<br/>  });<br/>});</span></pre><p id="c814" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">确认测试后，</p><p id="7057" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">让我们部署我们新添加的具有附加功能的合同，我们使用run命令并将AtmV2合同部署到dev network。</p><pre class="kz la lb lc fq md me mf mg aw mh dt"><span id="de9b" class="mi jc ht me b fv mj mk l ml mm">npx hardhat run --network localhost scripts/upgrade-atmV2.js<br/>Compilation finished successfully<br/>upgrade to AtmV2...<br/>0xDc64a140Aa3E981100a9becA4E685f962f0cF6C9  AtmV2 address(should be the same)<br/>0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512  Proxy Admin</span></pre><p id="34e9" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">部署在格利上，只需更换</p><pre class="kz la lb lc fq md me mf mg aw mh dt"><span id="609e" class="mi jc ht me b fv mj mk l ml mm">npx hardhat run --network localhost</span></pre><p id="872a" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">随着</p><pre class="kz la lb lc fq md me mf mg aw mh dt"><span id="e734" class="mi jc ht me b fv mj mk l ml mm">npx hardhat run --network goerli</span></pre><p id="102f" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">现在你有了它，在<a class="ae lm" href="https://goerli.etherscan.io/" rel="noopener ugc nofollow" target="_blank"> Goerli Explorer </a>上检查你的地址并验证它。</p><p id="873b" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">要查看所有合同，您可以访问查看我的合同</p><ul class=""><li id="efe6" class="ln lo ht kb b kc lh kg li kk lp ko lq ks lr kw mc lt lu lv dt translated"><a class="ae lm" href="https://goerli.etherscan.io/address/0xB8E702904efb9D0DCC3601135922e870F9a10fF4" rel="noopener ugc nofollow" target="_blank">委托书(合同一)</a></li><li id="de8d" class="ln lo ht kb b kc lw kg lx kk ly ko lz ks ma kw mc lt lu lv dt translated"><a class="ae lm" href="https://goerli.etherscan.io/address/0xdA10DF35A73984de06d0B70870A98650a4316982" rel="noopener ugc nofollow" target="_blank">逻辑实现(合同二)</a></li><li id="ce6a" class="ln lo ht kb b kc lw kg lx kk ly ko lz ks ma kw mc lt lu lv dt translated">代理管理员</li></ul><h1 id="1272" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">摘要</h1><p id="eb19" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw hm dt translated">虽然这是一种使用openzeplin插件的快速方法，并且它因团队而异，但理解和进行升级的更好方法是将<a class="ae lm" href="https://github.com/OpenZeppelin/openzeppelin-contracts/tree/master/contracts/proxy/transparent" rel="noopener ugc nofollow" target="_blank">透明代理sol </a>文件和相关sol文件从openzeplin复制到您的项目中。这可以保护您免受上游攻击。</p><p id="1c1e" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">这就到了本文的结尾。希望你学到了一些东西。我也希望得到反馈！请留言评论。快乐大厦！</p><p id="7eb9" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated">参考资料:<br/><a class="ae lm" href="https://docs.openzeppelin.com/upgrades-plugins/1.x/writing-upgradeable" rel="noopener ugc nofollow" target="_blank">https://docs . open zeppelin . com/upgrades-plugins/1 . x/writing-upgradable</a></p><p id="302c" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated"><a class="ae lm" href="https://github.com/OpenZeppelin/openzeppelin-contracts/tree/master/contracts/proxy" rel="noopener ugc nofollow" target="_blank">https://github . com/open zeppelin/open zeppelin-contracts/tree/master/contracts/proxy</a></p><p id="3e26" class="pw-post-body-paragraph jz ka ht kb b kc lh ke kf kg li ki kj kk lj km kn ko lk kq kr ks ll ku kv kw hm dt translated"><a class="ae lm" href="https://dev.to/yakult/tutorial-write-upgradeable-smart-contract-proxy-contract-with-openzeppelin-1916" rel="noopener ugc nofollow" target="_blank">https://dev . to/yakult/tutorial-write-upgradable-smart-contract-proxy-contract-with-open zeppelin-1916</a></p><blockquote class="mr"><p id="49ed" class="ms mt ht bd mu mv mw mx my mz na kw ek translated">加入Coinmonks <a class="ae lm" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae lm" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h1 id="06cb" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm nb jo jp jq nc js jt ju nd jw jx jy dt translated">另外，阅读</h1><ul class=""><li id="9c66" class="ln lo ht kb b kc kd kg kh kk ne ko nf ks ng kw mc lt lu lv dt translated"><a class="ae lm" rel="noopener" href="/coinmonks/3commas-review-an-excellent-crypto-trading-bot-2020-1313a58bec92">3商业评论</a> | <a class="ae lm" href="https://coincodecap.com/pionex-review-exchange-with-crypto-trading-bot" rel="noopener ugc nofollow" target="_blank"> Pionex评论</a> | <a class="ae lm" rel="noopener" href="/coinmonks/coinrule-review-2021-a-beginner-friendly-crypto-trading-bot-daf0504848ba"> Coinrule评论</a></li><li id="9367" class="ln lo ht kb b kc lw kg lx kk ly ko lz ks ma kw mc lt lu lv dt translated"><a class="ae lm" rel="noopener" href="/coinmonks/ledger-vs-ngrave-zero-7e40f0c1d694">莱杰vs n rave</a>|<a class="ae lm" rel="noopener" href="/coinmonks/ledger-nano-s-vs-x-battery-hardware-price-storage-59a6663fe3b0">莱杰nano s vs x </a> | <a class="ae lm" rel="noopener" href="/coinmonks/binance-review-ee10d3bf3b6e">币安评论</a></li><li id="c0c4" class="ln lo ht kb b kc lw kg lx kk ly ko lz ks ma kw mc lt lu lv dt translated"><a class="ae lm" rel="noopener" href="/coinmonks/bybit-exchange-review-dbd570019b71"> Bybit Exchange评论</a> | <a class="ae lm" href="https://coincodecap.com/bityard-reivew" rel="noopener ugc nofollow" target="_blank"> Bityard评论</a> | <a class="ae lm" href="https://coincodecap.com/jet-bot-review" rel="noopener ugc nofollow" target="_blank"> Jet-Bot评论</a></li><li id="1585" class="ln lo ht kb b kc lw kg lx kk ly ko lz ks ma kw mc lt lu lv dt translated"><a class="ae lm" rel="noopener" href="/coinmonks/3commas-vs-pionex-vs-cryptohopper-best-crypto-bot-6a98d2baa203">3 commas vs crypto hopper</a>|<a class="ae lm" rel="noopener" href="/coinmonks/earn-crypto-interest-b10b810fdda3">赚取秘密利息</a></li><li id="2fdb" class="ln lo ht kb b kc lw kg lx kk ly ko lz ks ma kw mc lt lu lv dt translated">最好的比特币<a class="ae lm" rel="noopener" href="/coinmonks/hardware-wallets-dfa1211730c6">硬件钱包</a> | <a class="ae lm" rel="noopener" href="/coinmonks/bitbox02-review-your-swiss-bitcoin-hardware-wallet-c36c88fff29"> BitBox02回顾</a></li><li id="8947" class="ln lo ht kb b kc lw kg lx kk ly ko lz ks ma kw mc lt lu lv dt translated"><a class="ae lm" rel="noopener" href="/coinmonks/blockfi-vs-celsius-vs-hodlnaut-8a1cc8c26630"> BlockFi vs摄氏度</a> | <a class="ae lm" rel="noopener" href="/coinmonks/hodlnaut-review-best-way-to-hodl-is-to-earn-interest-on-your-bitcoin-6658a8c19edf"> Hodlnaut审核</a> | <a class="ae lm" href="https://coincodecap.com/kucoin-review" rel="noopener ugc nofollow" target="_blank"> KuCoin审核</a></li><li id="8230" class="ln lo ht kb b kc lw kg lx kk ly ko lz ks ma kw mc lt lu lv dt translated"><a class="ae lm" rel="noopener" href="/coinmonks/bitsgap-review-a-crypto-trading-bot-that-makes-easy-money-a5d88a336df2"> Bitsgap评审</a> | <a class="ae lm" rel="noopener" href="/coinmonks/quadency-review-a-crypto-trading-automation-platform-3068eaa374e1"> Quadency评审</a> | <a class="ae lm" rel="noopener" href="/coinmonks/bitbns-review-38256a07e161"> Bitbns评审</a></li></ul></div></div>    
</body>
</html>