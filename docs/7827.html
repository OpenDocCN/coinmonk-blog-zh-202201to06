<html>
<head>
<title>Lottery Dapp —Solidity Smart Contract Breakdown</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">彩票Dapp——可靠性智能合同分解</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/lottery-dapp-solidity-smart-contract-breakdown-6f67e50739a3?source=collection_archive---------3-----------------------#2022-06-01">https://medium.com/coinmonks/lottery-dapp-solidity-smart-contract-breakdown-6f67e50739a3?source=collection_archive---------3-----------------------#2022-06-01</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/1dfbaf8ca49034627dd4ec7198996bb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9uanrTuogjpRmN6ULkW09Q.jpeg"/></div></div><figcaption class="jb jc fg fe ff jd je bd b be z ek">Photo by <a class="ae jf" href="https://unsplash.com/@chinitogaray?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Alejandro Garay</a> on <a class="ae jf" href="https://unsplash.com/s/photos/lottery?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="9807" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">你可以在早先的文章<a class="ae jf" rel="noopener" href="/coinmonks/lottery-dapp-motivation-and-mechanics-36aba14f9034">这里</a>中读到更多关于彩票机制如何运作以及创造分散型彩票背后的动机。</p><p id="29a4" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">这篇文章将探讨管理分散型彩票dApp ( <a class="ae jf" href="https://github.com/yan-man/lottery-dapp" rel="noopener ugc nofollow" target="_blank">去分散型彩票</a>——因其目标受众而得名)的智能合约，包括一些实现细节。</p><p id="2174" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">这里假设你已经有一些关于Solidity、Javascript、单元测试(Chai断言和Waffle)的背景知识，以及智能契约在以太坊中如何工作的一般知识。</p><p id="dee0" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">源代码可以在这里找到<a class="ae jf" href="https://github.com/yan-man/lottery-dapp" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="d1ad" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">您可以在根目录下的<code class="eh ke kf kg kh b">./contracts</code>文件夹中找到<code class="eh ke kf kg kh b">Lottery.sol</code>智能契约，以及一个<code class="eh ke kf kg kh b">Random.sol</code>库来帮助实现基于块号的简单随机数生成。测试可以在<code class="eh ke kf kg kh b">./test</code>文件夹中找到。</p></div><div class="ab cl ki kj hb kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="hm hn ho hp hq"><h2 id="88ce" class="kp kq ht bd kr ks kt ku kv kw kx ky kz jr la lb lc jv ld le lf jz lg lh li lj dt translated">典型例子</h2><p id="5610" class="pw-post-body-paragraph jg jh ht ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hm dt translated">将参考以下示例彩票场景来解释该合同:</p><ul class=""><li id="bc15" class="lp lq ht ji b jj jk jn jo jr lr jv ls jz lt kd lu lv lw lx dt translated">a)彩票由<code class="eh ke kf kg kh b"><strong class="ji hu">Owner</strong></code> <strong class="ji hu"> </strong>初始化。造币期开放，允许购买彩票。在任何给定的时间，只允许一个有效的彩票。</li><li id="d1e1" class="lp lq ht ji b jj ly jn lz jr ma jv mb jz mc kd lu lv lw lx dt translated">B) (1) <code class="eh ke kf kg kh b"><strong class="ji hu">Player1</strong></code>买20张票；②<code class="eh ke kf kg kh b"><strong class="ji hu">Player2</strong></code>购买70张门票；(3) <code class="eh ke kf kg kh b"><strong class="ji hu">Player1</strong></code>再购买10张彩票(该彩票共购买100张彩票)。因此<code class="eh ke kf kg kh b"><strong class="ji hu">Player1</strong></code>有30%的机会获胜(通过持有30/100的未兑现门票)，而<code class="eh ke kf kg kh b"><strong class="ji hu">Player2</strong></code>有70%的机会获胜(通过持有70/100的未兑现门票)。</li><li id="334d" class="lp lq ht ji b jj ly jn lz jr ma jv mb jz mc kd lu lv lw lx dt translated">c)铸造窗口结束——通过来自<code class="eh ke kf kg kh b"><strong class="ji hu">Owner</strong></code>的紧急调用或自行决定。不能再买票了。</li><li id="2d70" class="lp lq ht ji b jj ly jn lz jr ma jv mb jz mc kd lu lv lw lx dt translated">d)运行抽奖。A <code class="eh ke kf kg kh b"><strong class="ji hu">Winner</strong></code>是根据已购买的未兑现彩票的比例随机选择的。中奖资金被存入待提取账户(只有中奖者才能使用)</li><li id="faf5" class="lp lq ht ji b jj ly jn lz jr ma jv mb jz mc kd lu lv lw lx dt translated">E) <code class="eh ke kf kg kh b"><strong class="ji hu">Winner</strong></code>从待处理的提款中提取奖金。</li></ul><figure class="me mf mg mh fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff md"><img src="../Images/5e7d85bb5f43f366e19863783488a5d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FhG9nc1BwBWq4MQOadyjuA.png"/></div></div><figcaption class="jb jc fg fe ff jd je bd b be z ek">a degenerate’s rendering</figcaption></figure><h1 id="07c8" class="mi kq ht bd kr mj mk ml kv mm mn mo kz mp mq mr lc ms mt mu lf mv mw mx li my dt translated"><code class="eh ke kf kg kh b">Lottery.sol</code>智能合同</h1><h2 id="a3cd" class="kp kq ht bd kr ks kt ku kv kw kx ky kz jr la lb lc jv ld le lf jz lg lh li lj dt translated">页眉</h2><p id="5a58" class="pw-post-body-paragraph jg jh ht ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hm dt translated">在初始Pragma和<a class="ae jf" href="https://docs.openzeppelin.com/" rel="noopener ugc nofollow" target="_blank"> OpenZeppelin </a>导入之后，首先要注意的是控制台导入。这个项目是用<a class="ae jf" href="https://hardhat.org/" rel="noopener ugc nofollow" target="_blank"> Hardhat </a>创建的——一个方便的用于测试和前端集成的Solidity开发环境。</p><pre class="me mf mg mh fq mz kh na nb aw nc dt"><span id="ecd3" class="kp kq ht kh b fv nd ne l nf ng">import "hardhat/console.sol";</span></pre><p id="1470" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">Solidity中的<code class="eh ke kf kg kh b">console.log</code>类型特性非常有用——使用<a class="ae jf" href="https://trufflesuite.com/" rel="noopener ugc nofollow" target="_blank"> Truffle套件</a>，您几乎需要创建自定义事件来进行测试和日志记录，以打印数据和进行调试。有了Hardhat，这就简化了—您可以在合同内的任何地方记录数据。</p><p id="c901" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">Hardhat也有使用ethers.js而不是web3.js的web3智能合约集成，我觉得web 3 . js更容易使用。</p><p id="8172" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">这个合同也是<code class="eh ke kf kg kh b">Ownable</code> —用特权初始化合同所有者。在这份合同中，<code class="eh ke kf kg kh b"><strong class="ji hu">Owner</strong></code>有权创造新的彩票，强制关闭造币期，或者在紧急情况下取消彩票。</p><p id="6f0d" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><code class="eh ke kf kg kh b">Random.sol</code>库契约也被导入，通过自定义的<code class="eh ke kf kg kh b">naiveRandInt</code>函数帮助实现简单的随机性。</p><h2 id="9cb8" class="kp kq ht bd kr ks kt ku kv kw kx ky kz jr la lb lc jv ld le lf jz lg lh li lj dt translated">状态变量</h2><p id="c315" class="pw-post-body-paragraph jg jh ht ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hm dt translated">首先，定义<code class="eh ke kf kg kh b">Structs</code>。</p><p id="8a79" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><code class="eh ke kf kg kh b">LotteryStruct</code>代表每个单独的彩票实例——跨越一个在<code class="eh ke kf kg kh b">startTime</code>和<code class="eh ke kf kg kh b">endTime</code>之间定义的铸造周期(默认为7天)。<code class="eh ke kf kg kh b">bool</code>用于跟踪特定彩票抽奖的状态:</p><ul class=""><li id="0ebd" class="lp lq ht ji b jj jk jn jo jr lr jv ls jz lt kd lu lv lw lx dt translated"><code class="eh ke kf kg kh b">inActive</code>:彩票有效(即<code class="eh ke kf kg kh b">inActive=false</code>)表示造币周期开放，无效(即<code class="eh ke kf kg kh b">inActive=true</code>)时由<code class="eh ke kf kg kh b"><strong class="ji hu">Owner</strong></code>强制设定或自然结束(即当前时间戳大于<code class="eh ke kf kg kh b">endTime</code>)。</li><li id="971e" class="lp lq ht ji b jj ly jn lz jr ma jv mb jz mc kd lu lv lw lx dt translated"><code class="eh ke kf kg kh b">isCompleted</code>:默认为<code class="eh ke kf kg kh b">false</code>。在一次成功的抽奖运行后，中奖奖金作为待提取的奖金被存入并可供中奖者取回，它被设置为<code class="eh ke kf kg kh b">true</code>。</li><li id="02f7" class="lp lq ht ji b jj ly jn lz jr ma jv mb jz mc kd lu lv lw lx dt translated"><code class="eh ke kf kg kh b">isCreated</code>:彩票创建的显式标志，方便在前端用户界面内检查彩票是否已创建。这特别有帮助，因为<code class="eh ke kf kg kh b">lotteries</code>(<code class="eh ke kf kg kh b">LotteryStruct</code>结构的集合)是一个映射，<a class="ae jf" href="https://ethereum.stackexchange.com/questions/13021/how-can-you-figure-out-if-a-certain-key-exists-in-a-mapping-struct-defined-insi" rel="noopener ugc nofollow" target="_blank">意味着您不能直接确定映射键索引</a>是否存在——它们在技术上是存在的，并且被初始化为默认值。</li></ul><figure class="me mf mg mh fq iu"><div class="bz el l di"><div class="nh ni l"/></div></figure><p id="7f3f" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><code class="eh ke kf kg kh b">TicketDistributionStruct</code>用于表示根据每个彩票抽奖的参与者的彩票分配的指数。它仅在抽奖过程中调用，并帮助为每个玩家分配彩票指数(按玩家第一次购买彩票的顺序连续排列，1-indexed ),这决定了他们的中奖几率。</p><figure class="me mf mg mh fq iu"><div class="bz el l di"><div class="nh ni l"/></div></figure><p id="29d8" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><code class="eh ke kf kg kh b">WinningTicketStruct</code>用于表示每张彩票选中的中奖者(由账户地址标识)及其对应的中奖票索引。</p><figure class="me mf mg mh fq iu"><div class="bz el l di"><div class="nh ni l"/></div></figure><blockquote class="nj nk nl"><p id="10d4" class="jg jh nm ji b jj jk jl jm jn jo jp jq nn js jt ju no jw jx jy np ka kb kc kd hm dt translated">*注意:在这个最初的v0.1实现中，变量通常被默认设置为public，以简化在前端读取它们的值(使用<a class="ae jf" href="https://docs.soliditylang.org/en/v0.8.13/contracts.html#state-variable-visibility" rel="noopener ugc nofollow" target="_blank"> Solidity内置的用于公共变量</a>的getters)。</p></blockquote><p id="172d" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><code class="eh ke kf kg kh b">MIN_DRAWING_INCREMENT</code>是设置彩票底价的常量。</p><p id="97df" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><code class="eh ke kf kg kh b">NUMBER_OF_HOURS</code>是一个常量，如果在部署期间没有设置，则定义默认的制造周期(到168小时，一个简单计算的星期)。</p><p id="0dbd" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><code class="eh ke kf kg kh b">numTotalTickets</code>和<code class="eh ke kf kg kh b">numActivePlayers</code>可能看起来没有必要，但它们有助于以有效的方式分别跟踪已购买的未完成彩票和当前彩票的活跃参与者数量:</p><ul class=""><li id="9ef6" class="lp lq ht ji b jj jk jn jo jr lr jv ls jz lt kd lu lv lw lx dt translated"><code class="eh ke kf kg kh b">tickets</code>是用户地址和他们为给定彩票购买的彩票数量之间的映射。可以通过对活动用户地址上的票据求和来找到票据的总数，但是持续执行该操作的成本很高。</li><li id="d99b" class="lp lq ht ji b jj ly jn lz jr ma jv mb jz mc kd lu lv lw lx dt translated"><code class="eh ke kf kg kh b">listOfPlayers</code>是一个玩家数组，但是为了节省汽油，它的值在后续的抽奖中被覆盖而不是被删除。因此，它的长度不是确定玩家数量的可靠来源。想象一个场景，其中5个玩家在彩票1中是活跃的，但是在彩票2中只有3个玩家是活跃的。确定玩家4(位于索引3)和5(位于索引4)在彩票2中无效的唯一方法是使用<code class="eh ke kf kg kh b">numActivePlayers</code>来标识该数组的最后一个有效索引(即<code class="eh ke kf kg kh b">numActivePlayers-1</code>是最后一个索引，在我们当前的示例中<code class="eh ke kf kg kh b">2</code>对应于玩家3)。仅仅搜索给定索引的存在性是不够的。</li></ul><p id="19e6" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><code class="eh ke kf kg kh b">prizes</code>是一个映射，记录每张彩票的奖金数额(其关键字为lotteryId)。</p><p id="6154" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><code class="eh ke kf kg kh b">winningTickets</code>是一个映射，记录每一次彩票的中奖者(其关键字为lotteryId)。</p><p id="3c6f" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><code class="eh ke kf kg kh b">players</code>是标记用户是否是当前彩票的活跃玩家的映射。使用这种映射比每次搜索<code class="eh ke kf kg kh b">listOfPlayers</code>数组来检查一个地址是否有效更方便。</p><p id="75aa" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><code class="eh ke kf kg kh b">lotteries</code>是一个映射，记录了已经部署的彩票列表。</p><p id="30f6" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><code class="eh ke kf kg kh b">pendingWithdrawals</code>是一个映射的映射，允许赢家提取他们的奖金。</p><h1 id="2f0c" class="mi kq ht bd kr mj mk ml kv mm mn mo kz mp mq mr lc ms mt mu lf mv mw mx li my dt translated">执行</h1><h2 id="a2ec" class="kp kq ht bd kr ks kt ku kv kw kx ky kz jr la lb lc jv ld le lf jz lg lh li lj dt translated">合同部署</h2><p id="bdd4" class="pw-post-body-paragraph jg jh ht ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hm dt translated">合同可以通过Hardhat部署。没有显式定义构造函数，因为不需要初始契约参数。使用以下命令部署到本地Hardhat节点:</p><pre class="me mf mg mh fq mz kh na nb aw nc dt"><span id="175d" class="kp kq ht kh b fv nd ne l nf ng">$ npx hardhat run scripts/deploy.js --network localhost</span></pre><p id="c034" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">将运行<code class="eh ke kf kg kh b">deploy.js</code>脚本(在<code class="eh ke kf kg kh b">/scripts</code>目录中)，在控制台上打印一些部署信息，并保存合同地址以及ABI文件供前端访问。</p><h2 id="860e" class="kp kq ht bd kr ks kt ku kv kw kx ky kz jr la lb lc jv ld le lf jz lg lh li lj dt translated">a)彩票初始化</h2><p id="a506" class="pw-post-body-paragraph jg jh ht ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hm dt translated">彩票通过<code class="eh ke kf kg kh b">initLottery</code>函数初始化，该函数允许任何用户帐户启动彩票，指定造币时间段的开始时间(作为一个unixtime int，<code class="eh ke kf kg kh b">startTime_</code>)和造币窗口允许打开的小时数(<code class="eh ke kf kg kh b">numHours_</code>)。修饰符(<code class="eh ke kf kg kh b">isNewLotteryValid</code>)首先检查当前彩票是否处于非活动状态——任何时候只允许一次活动彩票。</p><p id="6c0b" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">一个<code class="eh ke kf kg kh b">LotteryStruct</code>类型被创建并保存到<code class="eh ke kf kg kh b">lotteries</code>映射中，默认值被初始化。还会发出一个事件(<code class="eh ke kf kg kh b">LogNewLottery</code>)。</p><figure class="me mf mg mh fq iu"><div class="bz el l di"><div class="nh ni l"/></div></figure><h2 id="8c6a" class="kp kq ht bd kr ks kt ku kv kw kx ky kz jr la lb lc jv ld le lf jz lg lh li lj dt translated">b)票据铸造</h2><p id="1ecb" class="pw-post-body-paragraph jg jh ht ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hm dt translated">开奖期开始后，任何账户都可以通过<code class="eh ke kf kg kh b">mintLotteryTickets</code>功能购买彩票。一个修饰符<code class="eh ke kf kg kh b">isNewPlayerValid</code>首先检查用户包含的Eth数量是否大于底价(即他们至少能买1张票)。</p><p id="1205" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">然后，我们需要检查用户是当前彩票的回头客还是新玩家。<code class="eh ke kf kg kh b"><strong class="ji hu">Player1</strong></code>在我们的典型例子中是步骤(3)中的返回玩家，因为他们已经在步骤(1)中购买了一些门票。</p><p id="34b7" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">如果他们是新玩家，则需要管理更多的细节——比如检查是否达到玩家限制，或者覆盖旧值或者追加到<code class="eh ke kf kg kh b">listOfPlayers</code>数组。</p><p id="a139" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">然后更新跟踪变量，并发出另一个事件(<code class="eh ke kf kg kh b">LogTicketsMinted</code>)。</p><figure class="me mf mg mh fq iu"><div class="bz el l di"><div class="nh ni l"/></div></figure><h2 id="7cf1" class="kp kq ht bd kr ks kt ku kv kw kx ky kz jr la lb lc jv ld le lf jz lg lh li lj dt translated">c)铸造期结束</h2><p id="3013" class="pw-post-body-paragraph jg jh ht ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hm dt translated">铸造期可以自行结束，即<code class="eh ke kf kg kh b">endTime</code>已到达，也可以通过紧急功能<code class="eh ke kf kg kh b">setLotteryInactive</code>手动结束，该功能只能由合同<code class="eh ke kf kg kh b"><strong class="ji hu">Owner</strong></code>调用。</p><h2 id="cd83" class="kp kq ht bd kr ks kt ku kv kw kx ky kz jr la lb lc jv ld le lf jz lg lh li lj dt translated">d)执行抽奖</h2><p id="a1bc" class="pw-post-body-paragraph jg jh ht ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hm dt translated">在铸造期结束后，不能再为该彩票购买更多的彩票。为了开始抽奖，<code class="eh ke kf kg kh b"><strong class="ji hu">Owner</strong></code>调用函数<code class="eh ke kf kg kh b">triggerLotteryDrawing</code>，它执行一些动作。</p><p id="bf80" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">首先，它通过<code class="eh ke kf kg kh b">_playerTicketDistribution</code>私有函数将门票分配给活跃的玩家，该函数循环遍历玩家列表，将他们购买的门票合并在一起。根据每位玩家购买的门票数量，他们会被分配一个开始和结束索引。那么他们的简档将为下一次抽奖重置。</p><p id="9dfa" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">在典型的例子中，<code class="eh ke kf kg kh b"><strong class="ji hu">Player1</strong></code> <strong class="ji hu"> </strong>将有一个<code class="eh ke kf kg kh b">startIndex = 1</code>和一个<code class="eh ke kf kg kh b">endIndex = 30</code>，因为它们是第一个购买地址，并且在整个铸造期间总共购买了30张票(尽管这30张票不是一次购买的)。<code class="eh ke kf kg kh b"><strong class="ji hu">Player2</strong></code>会有一个<code class="eh ke kf kg kh b">startIndex = 31</code>和一个<code class="eh ke kf kg kh b">endIndex = 100</code>，因为他们已经购买了70张票。</p><p id="53aa" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">接下来，调用<code class="eh ke kf kg kh b">_performRandomizedDrawing</code>，它使用<code class="eh ke kf kg kh b">Random.sol</code>库函数在所有玩家票券索引的集合中生成一个随机整数。</p><p id="1409" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">然后，基于这个生成的中奖投注单索引，它通过<code class="eh ke kf kg kh b">findWinningAddress</code>函数搜索相应的用户地址。在这个函数中，它首先简化了1个活动玩家的琐碎情况。否则，调用递归二分搜索法函数(<code class="eh ke kf kg kh b">_binarySearch</code>)来查找其票单分布中的开始和结束索引封装了获胜票单索引的用户。</p><p id="299a" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><code class="eh ke kf kg kh b">_binarySearch</code>还利用<code class="eh ke kf kg kh b">_loopCount</code>变量作为另一项检查——它限制了递归搜索操作的执行次数。</p><p id="4d17" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">发出另一个事件(<code class="eh ke kf kg kh b">LogWinnerFound</code>)。</p><h2 id="850f" class="kp kq ht bd kr ks kt ku kv kw kx ky kz jr la lb lc jv ld le lf jz lg lh li lj dt translated">e)赢家提取奖金</h2><p id="d74d" class="pw-post-body-paragraph jg jh ht ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hm dt translated">最后，在中奖者被识别之后，彩票中奖被存入<code class="eh ke kf kg kh b">pendingWithdrawals</code>变量，并且可以根据<a class="ae jf" href="https://docs.soliditylang.org/en/v0.8.14/common-patterns.html#withdrawal-from-contracts" rel="noopener ugc nofollow" target="_blank">防止重入攻击的合同撤销模式</a>被分配到中奖账户(发出另一个事件)。</p><h1 id="8d73" class="mi kq ht bd kr mj mk ml kv mm mn mo kz mp mq mr lc ms mt mu lf mv mw mx li my dt translated">随机性</h1><p id="83bc" class="pw-post-body-paragraph jg jh ht ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hm dt translated">随机性是通过<code class="eh ke kf kg kh b">Random.sol</code>库实现的，该库通过块号的blockhash创建简单的随机数，然后在期望的范围内归一化值。这是一个常见的实现，尽管不是完全安全的，因为它不是可验证的随机的——但只是作为一个基本的简单示例来帮助执行v0.1的抽奖。</p><p id="48e6" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">这种形式的随机性也被用于著名的合同，如<a class="ae jf" href="https://etherscan.io/address/0xbc4ca0eda7647a8ab7c2061c2e118a18a936f13d#code" rel="noopener ugc nofollow" target="_blank">Bored Apes Yacht Club(BAYC)</a>token，目的是“重新索引”其NFT的顺序。</p><h1 id="e8c4" class="mi kq ht bd kr mj mk ml kv mm mn mo kz mp mq mr lc ms mt mu lf mv mw mx li my dt translated">单元测试</h1><p id="56a3" class="pw-post-body-paragraph jg jh ht ji b jj lk jl jm jn ll jp jq jr lm jt ju jv ln jx jy jz lo kb kc kd hm dt translated">单元测试可以在<code class="eh ke kf kg kh b">./test</code>目录中找到。在Hardhat中使用<a class="ae jf" href="https://hardhat.org/guides/waffle-testing" rel="noopener ugc nofollow" target="_blank"> Waffle </a>测试，它部署彩票合同，并在一个类似风格的规范示例的整个生命周期中执行各种检查。</p><p id="a0ab" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">需要进行更多的单元测试，以涵盖所有潜在的故障场景(尤其是访问控制)以及随后的实施<a class="ae jf" href="https://docs.chain.link/docs/chainlink-vrf/" rel="noopener ugc nofollow" target="_blank"> Chainlink的VRF(可验证随机函数)</a>以在绘图期间创建可验证的随机性。</p></div><div class="ab cl ki kj hb kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="hm hn ho hp hq"><p id="8396" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">就是这样！像你这样的德根斯的v0.1彩票dApp。享受，并感谢阅读。</p></div></div>    
</body>
</html>