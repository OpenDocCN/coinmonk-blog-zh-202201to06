<html>
<head>
<title>Handling events of a smart contract part 2/2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">处理智能合约的事件第2/2部分</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/handling-events-of-a-smart-contract-part-2-2-81d22c995eba?source=collection_archive---------13-----------------------#2022-04-25">https://medium.com/coinmonks/handling-events-of-a-smart-contract-part-2-2-81d22c995eba?source=collection_archive---------13-----------------------#2022-04-25</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/0afd2affe73487931c9ae687b9136a81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mDX5xjhh4MBE25acKCP1qA.jpeg"/></div></div><figcaption class="jb jc fg fe ff jd je bd b be z ek">Photo by <a class="ae jf" href="https://unsplash.com/@juanjodev02?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Juanjo Jaramillo</a> on <a class="ae jf" href="https://unsplash.com/s/photos/programming?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="d918" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">在本文中，我们将继续研究如何检索智能合约发出的事件。我们的第一个目标是了解如何使用过滤器按主题搜索事件。为此，我们将离开第一部分的测试环境，我们将连接一个真实的区块链。</p><p id="36ff" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我将使用我用于测试目的的帐户(0x27e 0155021 e 63842 AFB 79 f 99 da 8 b 9592 f 429 f 614)并获取币安智能链测试网络上记录的事件。作为一个节点，我将使用官方文档中指明的一个公共节点，它可以在<a class="ae jf" href="http://docs.binance.org/smart-chain/developer/rpc.html" rel="noopener ugc nofollow" target="_blank">docs.binance.org/smart-chain/developer/rpc.html</a>找到。</p><p id="7e00" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">提醒一下，我们使用的是<strong class="ji hu"> web3.js </strong>库，更具体地说是方法<strong class="ji hu"> web3.eth.getPastLogs() </strong>。下面的列表中列出了检索一些事件的javascript代码:</p><pre class="ke kf kg kh fq ki kj kk kl aw km dt"><span id="85b6" class="kn ko ht kj b fv kp kq l kr ks">const Web3 = require("web3");  </span><span id="fde0" class="kn ko ht kj b fv kt kq l kr ks">async function run() {     </span><span id="5901" class="kn ko ht kj b fv kt kq l kr ks">   const web3 = await new Web3("https://data-seed-prebsc-1-s1.binance.org:8545/")         <br/>   let response = await web3.eth.getPastLogs({<br/>      fromBlock:15519519,       <br/>      topics:  [,'0x00000000000000000000000027e0155021e63842afb79f99da8b9592f429f614']    <br/>   })    </span><span id="6171" class="kn ko ht kj b fv kt kq l kr ks">console.log(response);  <br/>}  </span><span id="82da" class="kn ko ht kj b fv kt kq l kr ks">run()</span></pre><p id="98cf" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">在您测试这段代码之前，我应该警告您它将返回一个错误。脚本本身不包含错误，但是每个端点通常会限制用于搜索事件的过滤器。目的可能是为了避免在区块链进行深入搜查。例如，当试图运行上面的代码时，我得到错误:</p><figure class="ke kf kg kh fq iu fe ff paragraph-image"><div class="fe ff ku"><img src="../Images/dac82a080bcd129dac172ef51cff0e13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1092/format:webp/1*9UXF4BgEOmvu-6dKOxDW2A.png"/></div></figure><p id="c549" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">请注意，该错误表明端点将事件搜索限制为5，000个数据块。在上面的例程中，我试图搜索在块15，519，519和当前块18，628，131之间发出的事件。这远远超过5000个街区。</p><p id="db0c" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">很可能其他端点有其他限制。我尝试了Moralis端点，限制甚至更低，2000个块。更改上面的代码以适应允许的限制，我们有:</p><pre class="ke kf kg kh fq ki kj kk kl aw km dt"><span id="6df4" class="kn ko ht kj b fv kp kq l kr ks">...<br/>fromBlock:16576824,    <br/>toBlock:16576925,<br/>...</span></pre><p id="5b7e" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">这次我得到一个回报，如下图所示:</p><figure class="ke kf kg kh fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kv"><img src="../Images/5af170448800f9d4152dd0e0d1ca210e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HkM7Zx8MJpqDnuD9S1L63g.png"/></div></div></figure><p id="fcac" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">现在让我们简单了解一下话题的问题。事件的第一个主题总是事件的散列。在我们的例子中，这是一个ERC20令牌的<em class="kw">传输</em>事件。事件哈希是0x ddf 252 ad 1 be 2c 89 b 69 C2 b 068 fc 378 DAA 952 ba 7 f 163 C4 a 11628 f 55 a4 df 523 B3 ef，如下图所示:</p><figure class="ke kf kg kh fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff kx"><img src="../Images/d7ea8bdc34516e7d5ce5a4b5e7f89b99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P6H4b65qHJ-RuLNYcrDuoA.png"/></div></div></figure><p id="0954" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">你可以在emn178.github.io/online-tools/keccak_256.html亲自检查一下。现在检查我在方法<strong class="ji hu">web 3 . eth . getpastlogs():</strong>中使用的过滤器</p><pre class="ke kf kg kh fq ki kj kk kl aw km dt"><span id="bda2" class="kn ko ht kj b fv kp kq l kr ks">let response = await web3.eth.getPastLogs({    <br/>   fromBlock:16576824,    <br/>   toBlock:16576925,    <br/>   topics:[,'0x00000000000000000000000027e0155021e63842afb79f99da8b9592f429f614'] <br/>})</span></pre><p id="03c0" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我只搜索了一个话题，第二个话题，用了一个地址:0x 27e 0155021 e 63842 AFB 79 f 99 da 8 b 9592 f 429 f 614。因为主题有32个字节，地址有20个字节，所以有必要将地址转换成32个字节。我想，我也可以搜索第一个主题(发出的事件)，或者第三个主题(在本例中，是传输事件的_to字段)。</p><p id="861f" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">主题的顺序很重要，它们需要被排序。例如，让我们尝试下面的代码:</p><pre class="ke kf kg kh fq ki kj kk kl aw km dt"><span id="f346" class="kn ko ht kj b fv kp kq l kr ks">let response = await web3.eth.getPastLogs({    <br/>   fromBlock:16576824,    <br/>   toBlock:16576925,    <br/>   topics:[,,'0x00000000000000000000000027e0155021e63842afb79f99da8b9592f429f614'] <br/>})</span></pre><p id="3a41" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">它返回一个空数组。注意我现在搜索的是第三个话题(我们从[，<address> ]到[，，<address> ])，结果自然会和我在第二个话题搜索我的地址时不一样。必须注意题目的顺序。</address></address></p><p id="64bf" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我们可以在过滤器中使用的另一个字段是发出事件的智能协定的地址。我将修改搜索以包含地址，并从搜索中删除主题。您可以尝试以下代码:</p><pre class="ke kf kg kh fq ki kj kk kl aw km dt"><span id="a7ce" class="kn ko ht kj b fv kp kq l kr ks">const web3 = await new Web3("https://bsc-dataseed.binance.org/")      </span><span id="b25e" class="kn ko ht kj b fv kt kq l kr ks">let response = await web3.eth.getPastLogs({    <br/>   fromBlock:17124122,    <br/>   toBlock: 17124922,    <br/>   address: '0xaf44400a99a9693bf3c2e89b02652babacc5cdb9' <br/>}) </span><span id="1c23" class="kn ko ht kj b fv kt kq l kr ks">console.log(response.length);</span></pre><p id="7047" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">现在，我正在币安智能链上搜索NFT项目智能合同的事件。我只记录返回数组的大小。它返回148项，如下图所示:</p><figure class="ke kf kg kh fq iu fe ff paragraph-image"><div class="fe ff ky"><img src="../Images/ced37645968208b6ab05df10e3599cc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/format:webp/1*U0JxYSe94A7ftPAmvoTo0w.png"/></div></figure><p id="e371" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">您可以使用这些过滤器的任意组合:地址、主题和阻止范围，来检索您想要的事件。在下一节中，我们将了解如何订阅来实时监控事件的发射。</p><h1 id="dab2" class="kz ko ht bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv dt translated">订阅事件</h1><p id="e6e5" class="pw-post-body-paragraph jg jh ht ji b jj lw jl jm jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd hm dt translated">我们还可以实时监控事件的发射。为此，我们使用websockets连接到一个节点并订阅事件。让我们继续使用node和web3.js。这个过程非常简单，在web3.js文档页面上有很好的记录。</p><pre class="ke kf kg kh fq ki kj kk kl aw km dt"><span id="9e2b" class="kn ko ht kj b fv kp kq l kr ks">var subscription = web3.eth.subscribe('logs', {     <br/>   address: '0x123456..',     <br/>   topics: ['0x12345...'] <br/>}, function(error, result){     <br/>   if (!error) console.log(result); <br/>})</span></pre><p id="69f6" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我们已经知道如何使用过滤器来过滤事件，所以在这个例子中，我将只使用合同地址作为过滤器。唯一相关的细节是通过websockets连接，所以你保持连接。最初，我尝试了币安智能链页面上的websocket端点。请参见下面的端点地址:</p><figure class="ke kf kg kh fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mb"><img src="../Images/058e7c5d699b506db6a9ee36981bd5b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OXz4SwdX-zI-gp_aTdouIg.png"/></div></div></figure><p id="791f" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">然而，仅仅一分钟不活动之后，我就被自动断开了。在第二次尝试中，我使用了一个由Moralis帐户提供的websocket(参见moralis.io/)，如下图所示:</p><figure class="ke kf kg kh fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mc"><img src="../Images/0583c6920fce033e7fef29fcd3d89bf2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OJytPQUFwSllI8Sq9IXlkA.jpeg"/></div></div></figure><p id="18f8" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">这一次，事件开始一个接一个地出现在提示符中。使用方法<strong class="ji hu"> web3.eth.subscribe() </strong>和websockets，订阅接收事件非常容易。如果您想按主题订阅事件，只需像我们之前所做的那样更改过滤器。</p><p id="2b5d" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="ji hu">免责声明:</strong>我与道德或任何其他公司没有任何关系。我鼓励您尝试提供相同服务的其他公司的终端。</p><p id="992d" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="ji hu">感谢您的阅读！</strong></p><blockquote class="md"><p id="3d8a" class="me mf ht bd mg mh mi mj mk ml mm kd ek translated">加入Coinmonks <a class="ae jf" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae jf" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h1 id="1fcb" class="kz ko ht bd la lb lc ld le lf lg lh li lj mn ll lm ln mo lp lq lr mp lt lu lv dt translated">另外，阅读</h1><ul class=""><li id="84f0" class="mq mr ht ji b jj lw jn lx jr ms jv mt jz mu kd mv mw mx my dt translated"><a class="ae jf" href="https://coincodecap.com/trading-signal" rel="noopener ugc nofollow" target="_blank">有哪些交易信号？</a> | <a class="ae jf" href="https://coincodecap.com/bitstamp-coinbase" rel="noopener ugc nofollow" target="_blank">比特斯坦普vs比特币基地</a></li><li id="5de2" class="mq mr ht ji b jj mz jn na jr nb jv nc jz nd kd mv mw mx my dt translated"><a class="ae jf" href="https://coincodecap.com/best-crypto-books" rel="noopener ugc nofollow" target="_blank"> 10本关于加密的最佳书籍</a> | <a class="ae jf" href="https://coincodecap.com/uk-trading-bots" rel="noopener ugc nofollow" target="_blank">英国5个最佳加密机器人</a></li><li id="e584" class="mq mr ht ji b jj mz jn na jr nb jv nc jz nd kd mv mw mx my dt translated"><a class="ae jf" href="https://coincodecap.com/koinly-review" rel="noopener ugc nofollow" target="_blank"> Koinly点评</a> | <a class="ae jf" href="https://coincodecap.com/binaryx-review" rel="noopener ugc nofollow" target="_blank"> Binaryx点评</a> | <a class="ae jf" href="https://coincodecap.com/hodlnaut-vs-cakedefi-vs-celsius" rel="noopener ugc nofollow" target="_blank"> Hodlnaut vs CakeDefi </a></li><li id="7404" class="mq mr ht ji b jj mz jn na jr nb jv nc jz nd kd mv mw mx my dt translated"><a class="ae jf" href="https://coincodecap.com/best-telegram-channels" rel="noopener ugc nofollow" target="_blank"> 40个最佳电报频道</a> | <a class="ae jf" href="https://coincodecap.com/1xbit-review" rel="noopener ugc nofollow" target="_blank"> 1xBit回顾</a> | <a class="ae jf" href="https://coincodecap.com/keevo-wallet-review" rel="noopener ugc nofollow" target="_blank"> Keevo钱包回顾</a></li><li id="6791" class="mq mr ht ji b jj mz jn na jr nb jv nc jz nd kd mv mw mx my dt translated"><a class="ae jf" href="https://coincodecap.com/buy-ethereum-in-india" rel="noopener ugc nofollow" target="_blank">如何在印度购买以太坊？</a> | <a class="ae jf" href="https://coincodecap.com/buy-bitcoin-binance" rel="noopener ugc nofollow" target="_blank">如何在币安购买比特币</a></li></ul></div></div>    
</body>
</html>