<html>
<head>
<title>Building an application specific blockchain using Cosmos SDK Part-5</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Cosmos SDK第5部分构建特定于应用程序的区块链</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/building-an-application-specific-blockchain-using-cosmos-sdk-part-5-e22c9a6debe3?source=collection_archive---------7-----------------------#2022-04-07">https://medium.com/coinmonks/building-an-application-specific-blockchain-using-cosmos-sdk-part-5-e22c9a6debe3?source=collection_archive---------7-----------------------#2022-04-07</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/f19e3823d8d934d82e0773690e2b7474.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hnc8dqfWohEPLouJPeFKmw.jpeg"/></div></div><figcaption class="jb jc fg fe ff jd je bd b be z ek">Photo by <a class="ae jf" href="https://unsplash.com/@markusspiske?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Markus Spiske</a> on <a class="ae jf" href="https://unsplash.com/s/photos/data-migration?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="6fae" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">在上一部分中，我们讨论了如何处理msg事务。希望您已经在本地测试了处理程序:)。在当前部分，我们将学习如何索引自定义事件&amp;用户如何通过tendermint rpc websocket订阅它们。我们还将看到，如何在链升级期间处理状态迁移。</p><h2 id="059c" class="ke kf ht bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">索引和订阅自定义事件:</h2><p id="e211" class="pw-post-body-paragraph jg jh ht ji b jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz ld kb kc kd hm dt translated">Tendermint允许我们索引事务和块，然后查询或订阅它们的结果。默认情况下，tendermint使用KV存储器进行索引，默认情况下，<code class="eh le lf lg lh b">tx.height</code>、<code class="eh le lf lg lh b">tx.hash</code>始终被索引。让我们看看自定义事件索引的运行情况。</p><p id="83b7" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">可以根据组合键对自定义事件进行索引。假设，我们在创建交易时发出一个自定义事件-</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="1c98" class="ke kf ht lh b fv lq lr l ls lt">ctx.EventManager().EmitEvent(<br/> sdk.NewEvent(sdk.EventTypeMessage,<br/> sdk.NewAttribute(sdk.AttributeKeyModule, types.ModuleName),<br/> sdk.NewAttribute(types.IDVALUE, dealId),<br/> sdk.NewAttribute(types.OWNER, newDeal.Owner),<br/> sdk.NewAttribute(types.VENDOR, newDeal.Vendor),<br/> ),<br/>)</span></pre><p id="4591" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">这里，上述自定义事件的组合键是-</p><ul class=""><li id="29c7" class="lu lv ht ji b jj jk jn jo jr lw jv lx jz ly kd lz ma mb mc dt translated">message.module='deal '</li><li id="4196" class="lu lv ht ji b jj md jn me jr mf jv mg jz mh kd lz ma mb mc dt translated">message.action='create_deal '</li><li id="4484" class="lu lv ht ji b jj md jn me jr mf jv mg jz mh kd lz ma mb mc dt translated">message.idvalue={dealId}</li></ul><p id="6a97" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">等等…</p><p id="7afa" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">让我们索引组合键<code class="eh le lf lg lh b">message.action=’create_deal’</code></p><blockquote class="mi mj mk"><p id="52d1" class="jg jh ml ji b jj jk jl jm jn jo jp jq mm js jt ju mn jw jx jy mo ka kb kc kd hm dt translated">配置、genesis、私钥和存储文件一般存储在home目录下的一个隐藏文件夹中(<code class="eh le lf lg lh b">.appName</code>)。在我们的例子中，隐藏文件夹的名字是<code class="eh le lf lg lh b">.deal</code>，你可以在你的本地机器上找到相同的名字。在各种配置文件中，<code class="eh le lf lg lh b"><em class="ht">config.toml</em></code>是包含与tendermint共识引擎相关的不同参数的文件，而<code class="eh le lf lg lh b"><em class="ht">app.toml</em></code>包含特定于app的参数。json包含每个模块的起源状态。</p></blockquote><p id="6be2" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">打开<code class="eh le lf lg lh b">config.toml</code>文件，在索引器=kv下添加以下<code class="eh le lf lg lh b">tags</code>字段。</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="9ec6" class="ke kf ht lh b fv lq lr l ls lt">tags="message.action='create_deal'"</span></pre><p id="30db" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">保存文件并重新启动链。在创建任何交易之前，让我们通过web socket订阅组合键<code class="eh le lf lg lh b">“message.action=’create_deal’”</code>。您可以使用任何web socket cli客户端或安装one- <code class="eh le lf lg lh b"><a class="ae jf" href="https://github.com/oliver006/ws-client" rel="noopener ugc nofollow" target="_blank">https://github.com/oliver006/ws-client</a></code>进行测试。</p><p id="a856" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">打开另一个终端并运行命令-</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="513e" class="ke kf ht lh b fv lq lr l ls lt">ws-client ws://localhost:26657/websocket<br/>&gt; { "jsonrpc": "2.0", "method": "subscribe", "params": ["message.action='create_deal'"], "id": 1 }</span></pre><p id="31f0" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">现在我们订阅了定制事件类型<code class="eh le lf lg lh b">create_deal</code>的<code class="eh le lf lg lh b">/subscribe</code> tendermint RPC端点。让我们打开一个新的终端实例来发出create deal tx -</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="390f" class="ke kf ht lh b fv lq lr l ls lt">deald tx deal create-deal cosmos19aurpre8j3zd5gkngupz830vz5ta8ye8deuyzh 50 --from owner</span></pre><p id="f62c" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">一旦执行完成，tendermint将对事件进行索引，我们将通过web-socket获得响应。例如，我得到的回复如下:</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="3fce" class="ke kf ht lh b fv lq lr l ls lt">{<br/>  "jsonrpc": "2.0",<br/>  "id": 1,<br/>  "result": {<br/>    "query": "message.action='create_deal'",<br/>    "data": {<br/>      "type": "tendermint/event/Tx",<br/>      "value": {<br/>        "TxResult": {<br/>          "height": "38235",<br/>          "tx": "CogBCoUBCiEvSGFycnkwMjcuZGVhbC5kZWFsLk1zZ0NyZWF0ZURlYWwSYAotY29zbW9zMXh5cG4zZWw4bW1wOHA4Y3YyanR2ZXE1ODdwaHZ5eHl6OThsaHNnEi1jb3Ntb3MxOWF1cnByZThqM3pkNWdrbmd1cHo4MzB2ejV0YTh5ZThkZXV5emgYMhJYClAKRgofL2Nvc21vcy5jcnlwdG8uc2VjcDI1NmsxLlB1YktleRIjCiEDKxIThp2LiM3qZnARSu1Ve1E+mRsEks2ebAJYI+AvgskSBAoCCAEYEBIEEMCaDBpAdbvWanujmmFUVf8Nm0IM8V/8q5nxqykEHINi20tzRP8rd+x0SAu04yjW93LOldF1zvAqxISDL/fA9ytE+didFA==",<br/>          "result": {<br/>            "data": "CigKIS9IYXJyeTAyNy5kZWFsLmRlYWwuTXNnQ3JlYXRlRGVhbBIDCgE3",<br/>            "log": "[{\"events\":[{\"type\":\"message\",\"attributes\":[{\"key\":\"action\",\"value\":\"create_deal\"},{\"key\":\"module\",\"value\":\"deal\"},{\"key\":\"IdValue\",\"value\":\"7\"},{\"key\":\"Owner\",\"value\":\"cosmos1xypn3el8mmp8p8cv2jtveq587phvyxyz98lhsg\"},{\"key\":\"Vendor\",\"value\":\"cosmos19aurpre8j3zd5gkngupz830vz5ta8ye8deuyzh\"}]}]}]",<br/>            "gas_wanted": "200000",<br/>            "gas_used": "48707",<br/>            "events": [<br/>              {<br/>                "type": "tx",<br/>                "attributes": [<br/>                  {<br/>                    "key": "ZmVl",<br/>                    "value": "",<br/>                    "index": true<br/>                  }<br/>                ]<br/>              },<br/>              {<br/>                "type": "tx",<br/>                "attributes": [<br/>                  {<br/>                    "key": "YWNjX3NlcQ==",<br/>                    "value": "Y29zbW9zMXh5cG4zZWw4bW1wOHA4Y3YyanR2ZXE1ODdwaHZ5eHl6OThsaHNnLzE2",<br/>                    "index": true<br/>                  }<br/>                ]<br/>              },<br/>              {<br/>                "type": "tx",<br/>                "attributes": [<br/>                  {<br/>                    "key": "c2lnbmF0dXJl",<br/>                    "value": "ZGJ2V2FudWptbUZVVmY4Tm0wSU04Vi84cTVueHF5a0VISU5pMjB0elJQOHJkK3gwU0F1MDR5alc5M0xPbGRGMXp2QXF4SVNETC9mQTl5dEUrZGlkRkE9PQ==",<br/>                    "index": true<br/>                  }<br/>                ]<br/>              },<br/>              {<br/>                "type": "message",<br/>                "attributes": [<br/>                  {<br/>                    "key": "YWN0aW9u",<br/>                    "value": "Y3JlYXRlX2RlYWw=",<br/>                    "index": true<br/>                  }<br/>                ]<br/>              },<br/>              {<br/>                "type": "message",<br/>                "attributes": [<br/>                  {<br/>                    "key": "bW9kdWxl",<br/>                    "value": "ZGVhbA==",<br/>                    "index": true<br/>                  },<br/>                  {<br/>                    "key": "SWRWYWx1ZQ==",<br/>                    "value": "Nw==",<br/>                    "index": true<br/>                  },<br/>                  {<br/>                    "key": "T3duZXI=",<br/>                    "value": "Y29zbW9zMXh5cG4zZWw4bW1wOHA4Y3YyanR2ZXE1ODdwaHZ5eHl6OThsaHNn",<br/>                    "index": true<br/>                  },<br/>                  {<br/>                    "key": "VmVuZG9y",<br/>                    "value": "Y29zbW9zMTlhdXJwcmU4ajN6ZDVna25ndXB6ODMwdno1dGE4eWU4ZGV1eXpo",<br/>                    "index": true<br/>                  }<br/>                ]<br/>              }<br/>            ]<br/>          }<br/>        }<br/>      }<br/>    },<br/>    "events": {<br/>      "message.Owner": [<br/>        "cosmos1xypn3el8mmp8p8cv2jtveq587phvyxyz98lhsg"<br/>      ],<br/>      "tx.hash": [<br/>        "84264CAE7C5A99A495BDA5DECD2CC40562EFC524BF2CF6128522C1362D8254A9"<br/>      ],<br/>      "tx.acc_seq": [<br/>        "cosmos1xypn3el8mmp8p8cv2jtveq587phvyxyz98lhsg/16"<br/>      ],<br/>      "tx.signature": [<br/>        "dbvWanujmmFUVf8Nm0IM8V/8q5nxqykEHINi20tzRP8rd+x0SAu04yjW93LOldF1zvAqxISDL/fA9ytE+didFA=="<br/>      ],<br/>      "message.IdValue": [<br/>        "7"<br/>      ],<br/>      "message.Vendor": [<br/>        "cosmos19aurpre8j3zd5gkngupz830vz5ta8ye8deuyzh"<br/>      ],<br/>      "tm.event": [<br/>        "Tx"<br/>      ],<br/>      "tx.height": [<br/>        "38235"<br/>      ],<br/>      "tx.fee": [<br/>        ""<br/>      ],<br/>      "message.action": [<br/>        "create_deal"<br/>      ],<br/>      "message.module": [<br/>        "deal"<br/>      ]<br/>    }<br/>  }<br/>}</span></pre><p id="ff09" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">您还可以使用config.toml-中的<code class="eh le lf lg lh b">tags</code>字段索引多个事件</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="7915" class="ke kf ht lh b fv lq lr l ls lt">tags="message.action='create_deal',message.action='create_contract'"</span></pre><p id="ded1" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">请注意，tendermint将实现<code class="eh le lf lg lh b">psql</code>索引器&amp; <code class="eh le lf lg lh b">kv</code>将来将被弃用，因为查询语法仅限于<code class="eh le lf lg lh b">kv</code>索引器类型，而<code class="eh le lf lg lh b">psql</code>索引器将能够将事件代理到外部配置的Postgresql实例。这将利用SQL来执行一系列丰富而复杂的查询，这些查询不受<code class="eh le lf lg lh b">kv</code>索引器类型的支持。很高兴很快看到更多有趣的功能:)</p><h2 id="870b" class="ke kf ht bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">通过就地商店迁移处理连锁升级:</h2><p id="c30b" class="pw-post-body-paragraph jg jh ht ji b jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz ld kb kc kd hm dt translated">假设我们的产品链已经投入使用，我们希望对其进行升级。例如，为了增加新的特性，我们可能需要改变状态结构。或者让我们考虑一个简单的任务，从商店中删除过期的合同。我们确实有一个<strong class="ji hu">升级链指南</strong>，作为cosmos sdk文档的一部分-<em class="ml"/><a class="ae jf" href="https://docs.cosmos.network/v0.44/building-modules/upgrade.html" rel="noopener ugc nofollow" target="_blank"><em class="ml">doc</em></a>。对于我们的迁移示例，我们将引用相同的内容。</p><p id="af7c" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">让我们在keeper包中创建一个migrator具体类型。</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="4565" class="ke kf ht lh b fv lq lr l ls lt">//migrator.go<br/>package keeper</span><span id="08a4" class="ke kf ht lh b fv mp lr l ls lt">type Migrator struct {<br/> keeper Keeper<br/>}</span><span id="3fd0" class="ke kf ht lh b fv mp lr l ls lt"><em class="ml">// NewMigrator returns a new Migrator.</em></span><span id="8a65" class="ke kf ht lh b fv mp lr l ls lt">func NewMigrator(keeper Keeper) Migrator {<br/> return Migrator{keeper: keeper}<br/>}</span></pre><p id="cff3" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">迁移器环绕保持器，这对迁移脚本中的状态转换很有用。我们将按照指南中的建议，把我们的迁移脚本放在<code class="eh le lf lg lh b">v01</code>包下的遗留文件夹中。</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="1c3f" class="ke kf ht lh b fv lq lr l ls lt">//v01.go<br/>package v01</span><span id="c86e" class="ke kf ht lh b fv mp lr l ls lt">import (<br/> "fmt"<br/> "github.com/Harry-027/deal/x/deal/types"<br/> "github.com/cosmos/cosmos-sdk/codec"<br/> "github.com/cosmos/cosmos-sdk/store/prefix"<br/> sdk "github.com/cosmos/cosmos-sdk/types"<br/>)</span><span id="2cda" class="ke kf ht lh b fv mp lr l ls lt">func MigrateDealStore(ctx sdk.Context, storeKey sdk.StoreKey, cdc codec.BinaryCodec) error {<br/> store := ctx.KVStore(storeKey)<br/>  return pruneOldContracts(store, cdc)<br/>}</span><span id="b3cd" class="ke kf ht lh b fv mp lr l ls lt">func pruneOldContracts(store sdk.KVStore, cdc codec.BinaryCodec) error {<br/>  dealStore := prefix.NewStore(store, []byte(types.NewDealKeyPrefix))<br/>  dealStoreIter := dealStore.Iterator(nil, nil)</span><span id="da68" class="ke kf ht lh b fv mp lr l ls lt">  defer dealStoreIter.Close()<br/>  <br/>  var deals []types.NewDeal<br/>  for ; dealStoreIter.Valid(); dealStoreIter.Next() {<br/>   var val types.NewDeal<br/>   cdc.MustUnmarshal(dealStoreIter.Value(), &amp;val)<br/>   deals = append(deals, val)<br/>  }</span><span id="676c" class="ke kf ht lh b fv mp lr l ls lt">for _, deal := range deals {<br/>  contractStorePrefixKey := fmt.Sprintf("%s%s/",    types.NewContractKeyPrefix, deal.DealId)<br/>  contractStore := prefix.NewStore(store,  []byte(contractStorePrefixKey))<br/>  iterator := sdk.KVStorePrefixIterator(contractStore, []byte{})<br/>  defer iterator.Close()</span><span id="7f9f" class="ke kf ht lh b fv mp lr l ls lt">for ; iterator.Valid(); iterator.Next() {<br/>  var val types.NewContract<br/>  cdc.MustUnmarshal(iterator.Value(), &amp;val)<br/>  if val.Status == "DELIVERED" {<br/>   contractKey := fmt.Sprintf("%s%s/", types.NewContractKeyPrefix,    val.ContractId)<br/>   contractStore.Delete([]byte(contractKey))<br/> }<br/>}<br/>}<br/> return nil<br/>}</span></pre><p id="66a9" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我们对每笔交易的合同进行迭代，以识别和删除过期的合同。我们将通过迁移对象上的方法调用此脚本-</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="8349" class="ke kf ht lh b fv lq lr l ls lt">// migrations.go</span><span id="a33a" class="ke kf ht lh b fv mp lr l ls lt">package keeper</span><span id="72c4" class="ke kf ht lh b fv mp lr l ls lt">import (<br/>v01 "github.com/Harry-027/deal/x/deal/legacy/v01"<br/>sdk "github.com/cosmos/cosmos-sdk/types"<br/>)</span><span id="24ef" class="ke kf ht lh b fv mp lr l ls lt"><em class="ml">// Migrate2to3 - Migrating deal module from version 2 to 3</em></span><span id="5dd8" class="ke kf ht lh b fv mp lr l ls lt">func (m Migrator) Migrate2to3(ctx sdk.Context) error {<br/> return v01.MigrateDealStore(ctx, m.keeper.storeKey, m.keeper.cdc) <em class="ml">// v01 is package `x/deal/legacy/v01`.<br/></em>}</span></pre><p id="972a" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我们现在将通过<code class="eh le lf lg lh b">registerMigration</code>方法为一致版本<code class="eh le lf lg lh b">3</code>注册配置器下的<code class="eh le lf lg lh b">Migrate2to3</code>方法。注:可通过模块方法- <code class="eh le lf lg lh b">RegisterServices</code>访问配置器</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="10e6" class="ke kf ht lh b fv lq lr l ls lt">// module.go</span><span id="f724" class="ke kf ht lh b fv mp lr l ls lt">func (am AppModule) RegisterServices(cfg module.Configurator) {<br/>types.RegisterQueryServer(cfg.QueryServer(), am.keeper)<br/> m := keeper.NewMigrator(am.keeper)<br/> if err := cfg.RegisterMigration(types.ModuleName, 3, m.Migrate2to3); err != nil {<br/>   panic(fmt.Sprintf("failed to migrate x/deal from version 2 to 3:<br/>%v", err))<br/> }<br/>}</span></pre><p id="de2c" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">用户可以在configurator上注册多个迁移。</p><p id="f254" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">x/upgrade模块跟踪<code class="eh le lf lg lh b">VersionMap</code>存储中的所有模块共识版本。为了在升级期间触发迁移，我们还需要更新模块的一致版本。让我们把它从2改成3-</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="b730" class="ke kf ht lh b fv lq lr l ls lt"><em class="ml">// ConsensusVersion implements ConsensusVersion.</em></span><span id="38ca" class="ke kf ht lh b fv mp lr l ls lt">func (AppModule) ConsensusVersion() uint64 { return 3 }</span></pre><p id="ff78" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">在从模块共识版本2的链升级期间，将触发在版本3的配置器上注册的任意数量的迁移。</p><p id="b642" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">连锁升级通常通过对提案进行投票来实现。提案通常由利益相关方通过对应于<code class="eh le lf lg lh b">gov</code>模块的tx提交。一旦验证人和授权人参与并投票支持提交的提案，投票期结束后，升级将通过升级管理员处理程序在某个区块高度进行。因此，我们需要设置升级处理程序来执行迁移。</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="b979" class="ke kf ht lh b fv lq lr l ls lt">// app.go</span><span id="5aa2" class="ke kf ht lh b fv mp lr l ls lt">app.UpgradeKeeper.SetUpgradeHandler("migrateOldContracts", func(ctx sdk.Context, plan upgradetypes.Plan, fromVM module.VersionMap) (module.VersionMap, error) {<br/><em class="ml">// Register the consensus version in the version map<br/> </em>fromVM["deal"] = dealmodule.AppModule{}.ConsensusVersion()<br/> return app.mm.RunMigrations(ctx, cfg, fromVM)<br/>})</span></pre><p id="814f" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><code class="eh le lf lg lh b">upgradeHandler</code>将调用模块管理器上的<code class="eh le lf lg lh b">RunMigrations</code>方法，该方法将在内部调用我们的模块迁移脚本。<code class="eh le lf lg lh b">RunMigrations</code>也将返回新的一致版本，该版本将保存在<code class="eh le lf lg lh b">x/upgrade</code>模块的<code class="eh le lf lg lh b">VersionMap</code>商店中。从而确认模块的稳定升级和最新一致版本。</p><p id="ce7b" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">可以将提案提交到治理模块-</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="5d6e" class="ke kf ht lh b fv lq lr l ls lt">deald tx gov submit-proposal software-upgrade migrateOldContracts --title migrateOldContracts --description migrateOldContracts --upgrade-height 100 --from validator --yes</span></pre><p id="5d07" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">并投票支持它</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="6a3f" class="ke kf ht lh b fv lq lr l ls lt">deald tx gov deposit 1 10000000stake --from validator --yes<br/>deald tx gov vote 1 yes --from validator --yes</span></pre><p id="f5bd" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">升级将在块高度为100时自动进行。</p><p id="0f3f" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">作为本地开发的一部分，可能需要在本地测试迁移脚本，而不需要通过提议的方式。为了实现这一点，其中一个方法是调用模块<code class="eh le lf lg lh b">EndBlock</code>方法中的迁移脚本(由于<code class="eh le lf lg lh b">EndBlock</code>在每个块之后自动执行，我们将能够在本地测试我们的迁移脚本，但是这种方法不适合大量的迁移数据)</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="9168" class="ke kf ht lh b fv lq lr l ls lt">//module.go</span><span id="5134" class="ke kf ht lh b fv mp lr l ls lt">func (am AppModule) EndBlock(ctx sdk.Context, _ abci.RequestEndBlock) []abci.ValidatorUpdate {<br/><em class="ml">// for testing if migration scripts run properly<br/>   m := keeper.NewMigrator(am.keeper)<br/>   m.Migrate2to3(ctx)<br/></em>return []abci.ValidatorUpdate{}</span><span id="20b7" class="ke kf ht lh b fv mp lr l ls lt">}</span></pre></div><div class="ab cl mq mr hb ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="hm hn ho hp hq"><p id="3141" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">今天的学习足够了:)将在下一部分介绍区块链测试模拟。</p></div><div class="ab cl mq mr hb ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="hm hn ho hp hq"><p id="35bc" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">参考这里的源代码- <a class="ae jf" href="https://github.com/Harry-027/deal" rel="noopener ugc nofollow" target="_blank"> <em class="ml">源代码</em> </a></p><p id="d828" class="pw-post-body-paragraph jg jh ht ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">系列<br/>*<a class="ae jf" rel="noopener" href="/coinmonks/building-an-application-specific-blockchain-using-cosmos-sdk-part-1-1f8388902fc8"><em class="ml">Part-1</em></a><em class="ml"><br/>*</em><a class="ae jf" rel="noopener" href="/@harish0y2j/building-an-application-specific-blockchain-using-cosmos-sdk-part-2-3da0b727cd9b"><em class="ml">Part-2</em></a><br/>*<a class="ae jf" rel="noopener" href="/@harish0y2j/building-an-application-specific-blockchain-using-cosmos-sdk-part-3-8ab623f35c74"><em class="ml">Part-3</em></a><em class="ml"><br/>*</em><a class="ae jf" rel="noopener" href="/@harish0y2j/building-an-application-specific-blockchain-using-cosmos-sdk-part-4-bf0c609ecacc"><em class="ml">Part-4</em></a><br/>*<a class="ae jf" rel="noopener" href="/@harish0y2j/building-an-application-specific-blockchain-using-cosmos-sdk-part-5-e22c9a6debe3"><em class="ml">Part-5</em></a><em class="ml"/></p><blockquote class="mx"><p id="5526" class="my mz ht bd na nb nc nd ne nf ng kd ek translated">加入Coinmonks <a class="ae jf" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae jf" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h1 id="7f3f" class="nh kf ht bd kg ni nj nk kk nl nm nn ko no np nq kr nr ns nt ku nu nv nw kx nx dt translated">另外，阅读</h1><ul class=""><li id="b298" class="lu lv ht ji b jj kz jn la jr ny jv nz jz oa kd lz ma mb mc dt translated"><a class="ae jf" rel="noopener" href="/coinmonks/cryptocurrency-savings-accounts-be3bc0feffbf">加密货币储蓄账户</a> | <a class="ae jf" href="https://coincodecap.com/best-crypto-trading-bots" rel="noopener ugc nofollow" target="_blank">加密交易机器人</a></li><li id="223f" class="lu lv ht ji b jj md jn me jr mf jv mg jz mh kd lz ma mb mc dt translated"><a class="ae jf" rel="noopener" href="/coinmonks/bigone-exchange-review-64705d85a1d4"> BigONE交易所评论</a> | <a class="ae jf" href="https://coincodecap.com/cex-io-review" rel="noopener ugc nofollow" target="_blank"> CEX。IO审查</a> | <a class="ae jf" rel="noopener" href="/coinmonks/swapzone-review-crypto-exchange-data-aggregator-e0ad78e55ed7">交换区审查</a></li><li id="f0a0" class="lu lv ht ji b jj md jn me jr mf jv mg jz mh kd lz ma mb mc dt translated"><a class="ae jf" rel="noopener" href="/coinmonks/bitcoin-margin-trading-exchange-bcbfcbf7b8e3">最佳比特币保证金交易</a> | <a class="ae jf" href="https://coincodecap.com/bityard-margin-trading" rel="noopener ugc nofollow" target="_blank">比特币保证金交易</a></li><li id="2fa2" class="lu lv ht ji b jj md jn me jr mf jv mg jz mh kd lz ma mb mc dt translated"><a class="ae jf" rel="noopener" href="/coinmonks/crypto-margin-trading-exchanges-428b1f7ad108">加密保证金交易交易所</a> | <a class="ae jf" rel="noopener" href="/coinmonks/earn-bitcoin-6e8bd3c592d9">赚取比特币</a></li><li id="5932" class="lu lv ht ji b jj md jn me jr mf jv mg jz mh kd lz ma mb mc dt translated"><a class="ae jf" rel="noopener" href="/coinmonks/wazirx-vs-coindcx-vs-bitbns-149f4f19a2f1">WazirX vs coin dcx vs bit bns</a>|<a class="ae jf" rel="noopener" href="/coinmonks/blockfi-vs-coinloan-vs-nexo-cb624635230d">block fi vs coin loan vs Nexo</a></li></ul></div></div>    
</body>
</html>