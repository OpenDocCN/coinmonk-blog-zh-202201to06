<html>
<head>
<title>TreasureDAO Hackers Have Started Returning Stolen NFTs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">宝岛黑客已经开始归还被盗的NFT</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/treasuredao-hackers-have-started-returning-stolen-nfts-fecac32cdb10?source=collection_archive---------40-----------------------#2022-03-04">https://medium.com/coinmonks/treasuredao-hackers-have-started-returning-stolen-nfts-fecac32cdb10?source=collection_archive---------40-----------------------#2022-03-04</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/f82e9b1477bd5485389714d367fdb7e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mqbv6d6E9tm1kftOV89NCQ.png"/></div></div></figure><blockquote class="jb jc jd"><p id="b7ae" class="je jf jg jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">本文将解释和分析宝岛黑客是如何开始归还被盗的NFT的</p><p id="cbdd" class="je jf jg jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">欢迎关注并与我们讨论</p><p id="3724" class="je jf jg jh b ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc hm dt translated">作者:<a class="ae kd" href="mailto:support@lunaray.co" rel="noopener ugc nofollow" target="_blank">support@lunaray.co</a></p></blockquote><h2 id="7ab7" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">0x01事件背景</h2><p id="8ddd" class="pw-post-body-paragraph je jf ht jh b ji lc jk jl jm ld jo jp kp le js jt kt lf jw jx kx lg ka kb kc hm dt translated">Treasure通过开放和可组合的方式将NFTs、DeFi和游戏结合在一起，为元宇宙的发展搭建了桥梁。宝岛被黑，100多枚NFT代币被盗，价值约140万美元。</p><h2 id="7580" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">0x02事件分析</h2><p id="7f8e" class="pw-post-body-paragraph je jf ht jh b ji lc jk jl jm ld jo jp kp le js jt kt lf jw jx kx lg ka kb kc hm dt translated">通过初步跟踪分析，攻击者的钱包地址:</p><div class="lh li fm fo lj lk"><a href="https://arbiscan.io/address/0x9b1acd4336ebf7656f49224d14a892566fd48e68" rel="noopener  ugc nofollow" target="_blank"><div class="ll ab ej"><div class="lm ab ln cl cj lo"><h2 class="bd hu fv z el lp eo ep lq er et hs dt translated">地址0x 9 B1 ACD 4336 ebf 7656 f 49224d 14 a 892566 FD 48 e 68 | Arbiscan</h2><div class="lr l"><h3 class="bd b fv z el lp eo ep lq er et ek translated">地址0x 9 B1 ACD 4336 ebf 7656 f 49224d 14 a 892566 FD 48 e 68页面允许用户查看交易、余额、代币持有量…</h3></div><div class="ls l"><p class="bd b gc z el lp eo ep lq er et ek translated">arbiscan.io</p></div></div><div class="lt l"><div class="lu l lv lw lx lt ly iz lk"/></div></div></a></div><p id="e5f0" class="pw-post-body-paragraph je jf ht jh b ji jj jk jl jm jn jo jp kp jr js jt kt jv jw jx kx jz ka kb kc hm dt translated">攻击交易:</p><div class="lh li fm fo lj lk"><a href="https://arbiscan.io/tx/0xb169e20b45c6a5b7e5726c812af73c0b48996a4db04b076d6ef484ca5a300d36" rel="noopener  ugc nofollow" target="_blank"><div class="ll ab ej"><div class="lm ab ln cl cj lo"><h2 class="bd hu fv z el lp eo ep lq er et hs dt translated">Arbitrum事务哈希(Txhash)详细信息| Arbiscan</h2><div class="lr l"><h3 class="bd b fv z el lp eo ep lq er et ek translated">0xb 169 e 20 b 45 c 6 a5 b 7 e 5726 c 812 af 73 c0b 48996 a4 db 04 b 076d 6 ef 484 ca 5a 300d 36 1天前2小时(2022年3月3日12:40:51 AM +UTC)…</h3></div><div class="ls l"><p class="bd b gc z el lp eo ep lq er et ek translated">arbiscan.io</p></div></div><div class="lt l"><div class="lz l lv lw lx lt ly iz lk"/></div></div></a></div><p id="5d2c" class="pw-post-body-paragraph je jf ht jh b ji jj jk jl jm jn jo jp kp jr js jt kt jv jw jx kx jz ka kb kc hm dt translated">出现漏洞的官方合同地址:</p><p id="dd89" class="pw-post-body-paragraph je jf ht jh b ji jj jk jl jm jn jo jp kp jr js jt kt jv jw jx kx jz ka kb kc hm dt translated"><strong class="jh hu"> TreasureMarketplaceBuyer </strong></p><p id="8719" class="pw-post-body-paragraph je jf ht jh b ji jj jk jl jm jn jo jp kp jr js jt kt jv jw jx kx jz ka kb kc hm dt translated"><a class="ae kd" href="https://arbiscan.io/address/0x812cda2181ed7c45a35a691e0c85e231d218e273#code" rel="noopener ugc nofollow" target="_blank">https://arbiscan . io/address/0x 812 CDA 2181 ed7 c 45 a 35 a 691 E0 c 85 e 231d 218 e 273 # code</a></p><p id="0fea" class="pw-post-body-paragraph je jf ht jh b ji jj jk jl jm jn jo jp kp jr js jt kt jv jw jx kx jz ka kb kc hm dt translated"><strong class="jh hu">财资市场</strong></p><div class="lh li fm fo lj lk"><a href="https://arbiscan.io/address/0x2e3b85f85628301a0bce300dee3a6b04195a15ee#code" rel="noopener  ugc nofollow" target="_blank"><div class="ll ab ej"><div class="lm ab ln cl cj lo"><h2 class="bd hu fv z el lp eo ep lq er et hs dt translated">合同地址0x 2 E3 b 85 f 85628301 A0 BCE 300 dee 3 a6b 04195 a 15 ee | Arbiscan</h2><div class="lr l"><h3 class="bd b fv z el lp eo ep lq er et ek translated">spdx-license-identifier:MIT pragma solidity ^0.8.0；导入"../utils/context . sol "；/* * * * @开发合同模块…</h3></div><div class="ls l"><p class="bd b gc z el lp eo ep lq er et ek translated">arbiscan.io</p></div></div><div class="lt l"><div class="ma l lv lw lx lt ly iz lk"/></div></div></a></div><h2 id="f8ff" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">0x03攻击详细信息</h2><figure class="mc md me mf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mb"><img src="../Images/9e79934307eae5a7f9e29961a566b15b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G9DVjTSW-nBZMYPTywhqUA.png"/></div></div></figure><p id="077a" class="pw-post-body-paragraph je jf ht jh b ji jj jk jl jm jn jo jp kp jr js jt kt jv jw jx kx jz ka kb kc hm dt translated">从攻击交易中可以清楚地看到，攻击者调用<strong class="jh hu">TreasureMarketplaceBuyer</strong>契约中的<strong class="jh hu"> buyItem </strong>方法获取NFT，攻击者提供的购买资金为0。这里需要注意的是，<strong class="jh hu"> buyItem </strong>方法中的第四个parameter _quantity是作为0传递的。</p><figure class="mc md me mf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mg"><img src="../Images/52e425a042a4a34f78e555a62f5c195e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RVjgffmb4U0nt6p6a-XBZg.png"/></div></div></figure><p id="17e5" class="pw-post-body-paragraph je jf ht jh b ji jj jk jl jm jn jo jp kp jr js jt kt jv jw jx kx jz ka kb kc hm dt translated">分析<strong class="jh hu"> buyItem </strong>方法可以明确，这里的_quantity参数，也就是购买数量，是用户输入的，但是在第37行的计算中，价格和购买数量都乘以零，最后的价格也是零。用户已完成零资金购买。让我们继续分析攻击者如何将零资金购买的NFT转移到他的账户。转账后，这里调用市场契约中的<strong class="jh hu"> buyItem </strong>方法。</p><figure class="mc md me mf fq iu fe ff paragraph-image"><div class="fe ff mh"><img src="../Images/e7cd8ff1a1d93c56e1b4070ea7bb722d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*yfKA1UPnWkMFNQ68wgpz_Q.png"/></div></figure><p id="432e" class="pw-post-body-paragraph je jf ht jh b ji jj jk jl jm jn jo jp kp jr js jt kt jv jw jx kx jz ka kb kc hm dt translated">上图中buyItem方法中的两个判断条件，首先是判断NFT所有者的异同，然后是判断NFT的数量。由于攻击者传递零参数，所以很容易绕过这里的判断。NFT的收购是零成本成功的。攻击者利用该漏洞多次调用buyItem方法，以零成本获得大量NFT令牌。<br/>目前，财宝已经发布公告，称交易已经被冻结，攻击者也正在归还NFT。</p><figure class="mc md me mf fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mi"><img src="../Images/fbd0998859cbcea78709d8a5f781aa2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w2qHpz1ts7Q3ulspwmztpw.png"/></div></div></figure><h2 id="d840" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">0x04总结</h2><p id="55b4" class="pw-post-body-paragraph je jf ht jh b ji lc jk jl jm ld jo jp kp le js jt kt lf jw jx kx lg ka kb kc hm dt translated">虽然攻击者通过合同用0资金购买NFT，但随后逐渐归还所获得的NFT令牌。暂时不确定是不是测试人员做的，希望用户和官方不要有什么大的经济损失。从本次攻击事件来看，攻击者抓住了0资金购买NFT的合同缺乏限制，导致通过该漏洞获得大量NFT代币。因此，针对上述合同漏洞，我们的技术安全团队给出以下建议:</p><h2 id="fc3d" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">0x05安全建议</h2><p id="22c0" class="pw-post-body-paragraph je jf ht jh b ji lc jk jl jm ld jo jp kp le js jt kt lf jw jx kx lg ka kb kc hm dt translated">建议合同应严格判断用户输入的采购数量的合理性</p><p id="c32b" class="pw-post-body-paragraph je jf ht jh b ji jj jk jl jm jn jo jp kp jr js jt kt jv jw jx kx jz ka kb kc hm dt translated">提议的合同限制了零资金购买非功能性交易的可能性</p><ul class=""><li id="9b89" class="mj mk ht jh b ji jj jm jn kp ml kt mm kx mn kc mo mp mq mr dt translated">建议严格区分ERC721和ERC1155协议的NFT令牌，以避免混淆。</li></ul><blockquote class="ms"><p id="6080" class="mt mu ht bd mv mw mx my mz na nb kc ek translated"><em class="nc">加入Coinmonks </em> <a class="ae kd" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank"> <em class="nc">电报频道</em> </a> <em class="nc">和</em> <a class="ae kd" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> <em class="nc"> Youtube频道</em> </a> <em class="nc">了解加密交易和投资</em></p></blockquote><h1 id="fa30" class="nd kf ht bd kg ne nf ng kk nh ni nj ko nk nl nm ks nn no np kw nq nr ns la nt dt translated">另外，阅读</h1><ul class=""><li id="2284" class="mj mk ht jh b ji lc jm ld kp nu kt nv kx nw kc mo mp mq mr dt translated"><a class="ae kd" href="https://coincodecap.com/swap-crypto-on-uniswap" rel="noopener ugc nofollow" target="_blank">如何在Uniswap上交换加密？</a> | <a class="ae kd" href="https://coincodecap.com/a-ads-review" rel="noopener ugc nofollow" target="_blank"> A-Ads审查</a></li><li id="9d15" class="mj mk ht jh b ji nx jm ny kp nz kt oa kx ob kc mo mp mq mr dt translated"><a class="ae kd" rel="noopener" href="/coinmonks/cryptocurrency-savings-accounts-be3bc0feffbf">加密货币储蓄账户</a> | <a class="ae kd" rel="noopener" href="/coinmonks/yobit-review-175464162c62"> YoBit评论</a></li><li id="392b" class="mj mk ht jh b ji nx jm ny kp nz kt oa kx ob kc mo mp mq mr dt translated"><a class="ae kd" rel="noopener" href="/coinmonks/botsfolio-vs-napbots-vs-mudrex-c81344970c02">Botsfolio vs nap bots vs Mudrex</a>|<a class="ae kd" rel="noopener" href="/coinmonks/gate-io-exchange-review-61bf87b7078f">gate . io交流回顾</a></li><li id="1697" class="mj mk ht jh b ji nx jm ny kp nz kt oa kx ob kc mo mp mq mr dt translated"><a class="ae kd" href="https://coincodecap.com/coinflex-review" rel="noopener ugc nofollow" target="_blank"> CoinFLEX评论</a> | <a class="ae kd" href="https://coincodecap.com/aex-exchange-review" rel="noopener ugc nofollow" target="_blank"> AEX交易所评论</a> | <a class="ae kd" href="https://coincodecap.com/upbit-review" rel="noopener ugc nofollow" target="_blank"> UPbit评论</a></li><li id="2175" class="mj mk ht jh b ji nx jm ny kp nz kt oa kx ob kc mo mp mq mr dt translated"><a class="ae kd" href="https://coincodecap.com/ascendex-margin-trading" rel="noopener ugc nofollow" target="_blank"> AscendEx保证金交易</a> | <a class="ae kd" href="https://coincodecap.com/bitfinex-staking" rel="noopener ugc nofollow" target="_blank"> Bitfinex赌注</a> | <a class="ae kd" href="https://coincodecap.com/bitflyer-review" rel="noopener ugc nofollow" target="_blank"> bitFlyer评论</a></li><li id="dba1" class="mj mk ht jh b ji nx jm ny kp nz kt oa kx ob kc mo mp mq mr dt translated"><a class="ae kd" href="https://coincodecap.com/bitget-review" rel="noopener ugc nofollow" target="_blank"> Bitget回顾</a>|<a class="ae kd" href="https://coincodecap.com/gemini-vs-blockfi" rel="noopener ugc nofollow" target="_blank">Gemini vs block fi</a>cmd |<a class="ae kd" href="https://coincodecap.com/okex-futures-trading" rel="noopener ugc nofollow" target="_blank">OKEx期货交易</a></li><li id="9c08" class="mj mk ht jh b ji nx jm ny kp nz kt oa kx ob kc mo mp mq mr dt translated"><a class="ae kd" href="https://coincodecap.com/ascendex-staking" rel="noopener ugc nofollow" target="_blank">AscendEx Staking</a>|<a class="ae kd" href="https://coincodecap.com/bot-ocean-review" rel="noopener ugc nofollow" target="_blank">Bot Ocean Review</a>|<a class="ae kd" href="https://coincodecap.com/bitcoin-wallets-india" rel="noopener ugc nofollow" target="_blank">最佳比特币钱包</a></li><li id="2c84" class="mj mk ht jh b ji nx jm ny kp nz kt oa kx ob kc mo mp mq mr dt translated"><a class="ae kd" href="https://coincodecap.com/huobi-review" rel="noopener ugc nofollow" target="_blank">霍比评论</a> | <a class="ae kd" href="https://coincodecap.com/okex-margin-trading" rel="noopener ugc nofollow" target="_blank"> OKEx保证金交易</a> | <a class="ae kd" href="https://coincodecap.com/futures-trading" rel="noopener ugc nofollow" target="_blank">期货交易</a></li></ul></div></div>    
</body>
</html>