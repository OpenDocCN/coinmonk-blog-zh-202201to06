<html>
<head>
<title>Building an application specific blockchain using Cosmos SDK Part-3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Cosmos SDK第3部分构建特定于应用程序的区块链</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/building-an-application-specific-blockchain-using-cosmos-sdk-part-3-8ab623f35c74?source=collection_archive---------4-----------------------#2022-04-07">https://medium.com/coinmonks/building-an-application-specific-blockchain-using-cosmos-sdk-part-3-8ab623f35c74?source=collection_archive---------4-----------------------#2022-04-07</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div class="fe ff iq"><img src="../Images/6384c98e8e2d54f523a65ba23cd15b98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*uYActGxwj1AqzPLwOFFQCg.jpeg"/></div><figcaption class="ix iy fg fe ff iz ja bd b be z ek">Photo by <a class="ae jb" href="https://unsplash.com/@lucabravo?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Luca Bravo</a> on <a class="ae jb" href="https://unsplash.com/s/photos/technology?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="ff4f" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">到目前为止，在第2部分中，我们讨论了有关Tendermint、Cosmos sdk的技术细节，并安装了starport来搭建和运行链。我们还浏览了定制模块<code class="eh ka kb kc kd b">deal</code>的业务流程。现在我们将首先从定义我们的数据类型开始。我们将使用starport来生成类型。注意，starport将自动生成查询和消息处理程序以及类型。使用标志<code class="eh ka kb kc kd b">--no-message</code>，这样starport就不会为我们的数据类型创建<code class="eh ka kb kc kd b">sdk.Msg</code>和msg服务。如果给定类型不需要查询处理程序，可以随意删除。</p><p id="7bbe" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">让我们从一个<code class="eh ka kb kc kd b">dealCounter</code>类型开始，它将负责在创建新交易时生成交易id。</p><pre class="ke kf kg kh fq ki kd kj kk aw kl dt"><span id="711b" class="km kn ht kd b fv ko kp l kq kr">starport scaffold single dealCounter idValue:uint --module deal --no-message</span></pre><p id="8c0f" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated"><code class="eh ka kb kc kd b">--no-message</code>标志帮助我们在没有<code class="eh ka kb kc kd b">sdk.Msg</code>类型和消息处理程序的情况下生成类型。我们将使用<code class="eh ka kb kc kd b">dealCounter</code>类型下的<code class="eh ka kb kc kd b">idValue</code>字段作为增量计数器，在创建交易时生成交易id。上面的<code class="eh ka kb kc kd b">scaffold</code>命令执行以下操作-</p><ul class=""><li id="3d48" class="ks kt ht je b jf jg jj jk jn ku jr kv jv kw jz kx ky kz la dt translated">为<code class="eh ka kb kc kd b">dealCounter</code> ( <code class="eh ka kb kc kd b">deal_counter.proto</code>)生成原型类型定义。</li><li id="429a" class="ks kt ht je b jf lb jj lc jn ld jr le jv lf jz kx ky kz la dt translated">更新<code class="eh ka kb kc kd b">genesis.proto</code>文件，使其包含起源状态下的<code class="eh ka kb kc kd b">dealCounter</code>。</li><li id="9593" class="ks kt ht je b jf lb jj lc jn ld jr le jv lf jz kx ky kz la dt translated">生成查询消息定义(<code class="eh ka kb kc kd b">query.proto</code>)。</li><li id="b5ce" class="ks kt ht je b jf lb jj lc jn ld jr le jv lf jz kx ky kz la dt translated">查询消息处理程序(在<code class="eh ka kb kc kd b">keepers</code>目录下)。</li><li id="00c4" class="ks kt ht je b jf lb jj lc jn ld jr le jv lf jz kx ky kz la dt translated">query proto和query proto grpc网关文件(<code class="eh ka kb kc kd b">query.pb.go, query.pb.gw.go</code>)。</li><li id="65ab" class="ks kt ht je b jf lb jj lc jn ld jr le jv lf jz kx ky kz la dt translated">生成cli命令来调用查询处理程序(<code class="eh ka kb kc kd b">query_new_deal.go</code>)。</li><li id="cf01" class="ks kt ht je b jf lb jj lc jn ld jr le jv lf jz kx ky kz la dt translated">测试文件和测试模拟参数(<em class="lg">用于模拟测试</em>)。</li></ul><pre class="ke kf kg kh fq ki kd kj kk aw kl dt"><span id="1a32" class="km kn ht kd b fv ko kp l kq kr">// deal_counter.proto</span><span id="60f8" class="km kn ht kd b fv lh kp l kq kr">syntax = "proto3";<br/>package Harry027.deal.deal;</span><span id="1da7" class="km kn ht kd b fv lh kp l kq kr">option go_package = "github.com/Harry-027/deal/x/deal/types";</span><span id="b168" class="km kn ht kd b fv lh kp l kq kr">message DealCounter {<br/>uint64 idValue = 1;<br/>}</span></pre></div><div class="ab cl li lj hb lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hm hn ho hp hq"><pre class="ki kd kj kk aw kl dt"><span id="86f4" class="km kn ht kd b fv lp lq lr ls lt kp l kq kr">// genesis.proto<br/>option go_package = "github.com/Harry-027/deal/x/deal/types";</span><span id="e522" class="km kn ht kd b fv lh kp l kq kr"><em class="lg">// GenesisState defines the deal module's genesis state.</em></span><span id="0eeb" class="km kn ht kd b fv lh kp l kq kr">message GenesisState {<br/>Params params = 1 [(gogoproto.nullable) = false];<br/>DealCounter dealCounter = 2;<br/>}</span></pre><p id="7c99" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">注意，我们不要求用户查询计数器细节。因此我们应该从<code class="eh ka kb kc kd b">query.proto</code>文件中删除与<code class="eh ka kb kc kd b">dealCounter</code>相关的查询消息。同时删除<code class="eh ka kb kc kd b">keepers</code>文件夹中搭建的<code class="eh ka kb kc kd b">dealCounter</code>查询处理程序文件和<code class="eh ka kb kc kd b">cli</code>文件夹中的<code class="eh ka kb kc kd b">dealCounter</code>特定cli命令。并运行以下命令来重新生成原型定义(<code class="eh ka kb kc kd b">*.pb.go</code>和<code class="eh ka kb kc kd b">*.pb.gw.go</code>)。</p><pre class="ke kf kg kh fq ki kd kj kk aw kl dt"><span id="cc94" class="km kn ht kd b fv ko kp l kq kr">starport generate proto-go</span></pre><p id="f19d" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">注意，我们不应该接触<code class="eh ka kb kc kd b">*.pb.go</code>和<code class="eh ka kb kc kd b">*.pb.gw.go</code>生成的文件，因为这些文件每次都会基于原型定义自动生成。此外，您会发现命令(在不同的文件中)类似于下面给出的命令</p><p id="b5f2" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated"><code class="eh ka kb kc kd b"><em class="lg">// this line is used by starport scaffolding # genesis/proto/state</em></code></p><p id="c31c" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">不要删除此类命令，因为starport每次都会使用这些命令来确定代码生成的正确位置。</p><p id="3f96" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">让我们生成newDeal映射类型-</p><pre class="ke kf kg kh fq ki kd kj kk aw kl dt"><span id="5657" class="km kn ht kd b fv ko kp l kq kr">starport scaffold map newDeal dealId owner vendor commission:uint --module deal --no-message</span></pre><p id="a7df" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">该命令执行以下操作-</p><ul class=""><li id="24cd" class="ks kt ht je b jf jg jj jk jn ku jr kv jv kw jz kx ky kz la dt translated">为<code class="eh ka kb kc kd b">newDeal</code> ( <code class="eh ka kb kc kd b">new_deal.proto</code>)生成原型定义。</li><li id="cf38" class="ks kt ht je b jf lb jj lc jn ld jr le jv lf jz kx ky kz la dt translated">更新<code class="eh ka kb kc kd b">genesis.proto</code>文件。</li><li id="26f4" class="ks kt ht je b jf lb jj lc jn ld jr le jv lf jz kx ky kz la dt translated">生成查询消息(<code class="eh ka kb kc kd b">query.proto</code>)。</li><li id="4990" class="ks kt ht je b jf lb jj lc jn ld jr le jv lf jz kx ky kz la dt translated">查询消息处理程序。(<code class="eh ka kb kc kd b">grpc_query_new_deal.go</code>)。</li><li id="a867" class="ks kt ht je b jf lb jj lc jn ld jr le jv lf jz kx ky kz la dt translated">query proto和query proto grpc网关文件。(<code class="eh ka kb kc kd b">query.pb.go, query.pb.gw.go</code>)。</li><li id="b336" class="ks kt ht je b jf lb jj lc jn ld jr le jv lf jz kx ky kz la dt translated">生成cli命令来调用查询处理程序(<code class="eh ka kb kc kd b">query_new_deal.go</code>)。</li><li id="dcfd" class="ks kt ht je b jf lb jj lc jn ld jr le jv lf jz kx ky kz la dt translated">Keeper方法来序列化/反序列化存储区上的数据和crud操作。(<code class="eh ka kb kc kd b">new_deal.go</code>)。</li><li id="0bd6" class="ks kt ht je b jf lb jj lc jn ld jr le jv lf jz kx ky kz la dt translated">测试文件和测试模拟参数。</li></ul><pre class="ke kf kg kh fq ki kd kj kk aw kl dt"><span id="1ea1" class="km kn ht kd b fv ko kp l kq kr">// new_deal.proto</span><span id="b1bd" class="km kn ht kd b fv lh kp l kq kr">syntax = "proto3";<br/>package Harry027.deal.deal;<br/>option go_package = "github.com/Harry-027/deal/x/deal/types";</span><span id="55fc" class="km kn ht kd b fv lh kp l kq kr">message NewDeal {<br/>string dealId = 1;<br/>string owner = 2;<br/>string vendor = 3;<br/>uint64 commission = 4;<br/>}</span></pre></div><div class="ab cl li lj hb lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hm hn ho hp hq"><pre class="ki kd kj kk aw kl dt"><span id="23ba" class="km kn ht kd b fv lp lq lr ls lt kp l kq kr">// query.proto</span><span id="9d1a" class="km kn ht kd b fv lh kp l kq kr">message QueryGetNewDealRequest {<br/>string index = 1;<br/>}</span><span id="f69c" class="km kn ht kd b fv lh kp l kq kr">message QueryGetNewDealResponse {<br/>NewDeal newDeal = 1 [(gogoproto.nullable) = false];<br/>}</span><span id="8af3" class="km kn ht kd b fv lh kp l kq kr">message QueryAllNewDealRequest {<br/>cosmos.base.query.v1beta1.PageRequest pagination = 1;<br/>}</span><span id="9b29" class="km kn ht kd b fv lh kp l kq kr">message QueryAllNewDealResponse {<br/>repeated NewDeal newDeal = 1 [(gogoproto.nullable) = false];<br/>cosmos.base.query.v1beta1.PageResponse pagination = 2;<br/>}</span></pre></div><div class="ab cl li lj hb lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hm hn ho hp hq"><pre class="ki kd kj kk aw kl dt"><span id="733a" class="km kn ht kd b fv lp lq lr ls lt kp l kq kr">// new_deal.go</span><span id="0c91" class="km kn ht kd b fv lh kp l kq kr">package keeper</span><span id="add7" class="km kn ht kd b fv lh kp l kq kr">import (<br/>"github.com/Harry-027/deal/x/deal/types"<br/>"github.com/cosmos/cosmos-sdk/store/prefix"<br/>sdk "github.com/cosmos/cosmos-sdk/types"<br/>)</span><span id="4449" class="km kn ht kd b fv lh kp l kq kr"><em class="lg">// SetNewDeal sets a specific newDeal in the store from its index<br/></em>func (k Keeper) SetNewDeal(ctx sdk.Context, newDeal types.NewDeal) {</span><span id="15f3" class="km kn ht kd b fv lh kp l kq kr">store := prefix.NewStore(ctx.KVStore(k.storeKey), types.KeyPrefix(types.NewDealKeyPrefix))<br/>b := k.cdc.MustMarshal(&amp;newDeal)<br/>store.Set(types.NewDealKey(<br/>newDeal.DealId,<br/>), b)<br/>}</span><span id="77a9" class="km kn ht kd b fv lh kp l kq kr"><em class="lg">// GetNewDeal returns a newDeal from its index</em></span><span id="2721" class="km kn ht kd b fv lh kp l kq kr">func (k Keeper) GetNewDeal(<br/>ctx sdk.Context,<br/>index string,<br/>) (val types.NewDeal, found bool) {</span><span id="fe9f" class="km kn ht kd b fv lh kp l kq kr">store := prefix.NewStore(ctx.KVStore(k.storeKey), types.KeyPrefix(types.NewDealKeyPrefix))<br/>b := store.Get(types.NewDealKey(<br/>index,<br/>))</span><span id="d102" class="km kn ht kd b fv lh kp l kq kr">if b == nil {<br/>return val, false<br/>}<br/>k.cdc.MustUnmarshal(b, &amp;val)<br/>return val, true<br/>}</span><span id="d1c1" class="km kn ht kd b fv lh kp l kq kr"><em class="lg">// RemoveNewDeal removes a newDeal from the store<br/></em>func (k Keeper) RemoveNewDeal(<br/>ctx sdk.Context,<br/>index string,<br/>) {</span><span id="cbc3" class="km kn ht kd b fv lh kp l kq kr">store := prefix.NewStore(ctx.KVStore(k.storeKey), types.KeyPrefix(types.NewDealKeyPrefix))<br/>store.Delete(types.NewDealKey(<br/>index,<br/>))<br/>}</span><span id="3119" class="km kn ht kd b fv lh kp l kq kr"><em class="lg">// GetAllNewDeal returns all newDeal</em></span><span id="8b20" class="km kn ht kd b fv lh kp l kq kr">func (k Keeper) GetAllNewDeal(ctx sdk.Context) (list []types.NewDeal) {</span><span id="8583" class="km kn ht kd b fv lh kp l kq kr"> store := prefix.NewStore(ctx.KVStore(k.storeKey),  types.KeyPrefix(types.NewDealKeyPrefix))<br/> iterator := sdk.KVStorePrefixIterator(store, []byte{})</span><span id="3de0" class="km kn ht kd b fv lh kp l kq kr"> defer iterator.Close()</span><span id="68b7" class="km kn ht kd b fv lh kp l kq kr"> for ; iterator.Valid(); iterator.Next() {<br/>  var val types.NewDeal<br/>  k.cdc.MustUnmarshal(iterator.Value(), &amp;val)<br/>  list = append(list, val)<br/> }<br/>return<br/>}</span></pre><p id="8a26" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">交易的获取、设置和删除操作已在keeper对象上定义(如上所示)。注意，我们使用前缀存储来存储带有前缀关键字<code class="eh ka kb kc kd b">NewDeal/value/</code> ( <code class="eh ka kb kc kd b">key_new_deal.go</code>)的交易。</p><p id="48ef" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">让我们修改<code class="eh ka kb kc kd b">grpc_query_new_deal.go</code>文件来处理交易查询。</p><p id="edff" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated"><code class="eh ka kb kc kd b">NewDeal</code>将根据给定的dealId( <code class="eh ka kb kc kd b">req.Index</code>)获取交易详情。我们将根据dealId保存交易对象。因此，根据给定的<code class="eh ka kb kc kd b">req.index</code>获取交易，在我们的例子中是<code class="eh ka kb kc kd b">dealId</code>。</p><pre class="ke kf kg kh fq ki kd kj kk aw kl dt"><span id="399f" class="km kn ht kd b fv ko kp l kq kr"><em class="lg">// NewDeal is the query handler to fetch the deal details for a given dealId</em></span><span id="d9a3" class="km kn ht kd b fv lh kp l kq kr">func (k Keeper) NewDeal(c context.Context, req *types.QueryGetNewDealRequest) (*types.QueryGetNewDealResponse, error) {<br/>if req == nil {<br/>return nil, status.Error(codes.InvalidArgument, "invalid request")<br/>}</span><span id="0fa0" class="km kn ht kd b fv lh kp l kq kr">ctx := sdk.UnwrapSDKContext(c)<br/>val, found := k.GetNewDeal(<br/>  ctx,<br/>  req.Index,<br/>)</span><span id="aed1" class="km kn ht kd b fv lh kp l kq kr">if !found {<br/>return nil, status.Error(codes.InvalidArgument, "not found")<br/>}<br/>return &amp;types.QueryGetNewDealResponse{NewDeal: val}, nil<br/>}</span></pre><p id="44e3" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated"><code class="eh ka kb kc kd b">NewDealAll</code>将遍历keyStore，从Store中获取所有保存的交易。它还包括分页功能，可以对响应进行分页。</p><pre class="ke kf kg kh fq ki kd kj kk aw kl dt"><span id="63f5" class="km kn ht kd b fv ko kp l kq kr"><em class="lg">// NewDealAll is the query handler to fetch all the new deals</em></span><span id="cdd6" class="km kn ht kd b fv lh kp l kq kr">func (k Keeper) NewDealAll(c context.Context, req *types.QueryAllNewDealRequest) (*types.QueryAllNewDealResponse, error) {</span><span id="4614" class="km kn ht kd b fv lh kp l kq kr">if req == nil {<br/>  return nil, status.Error(codes.InvalidArgument, "invalid request")<br/>}</span><span id="6347" class="km kn ht kd b fv lh kp l kq kr">var newDeals []types.NewDeal<br/>ctx := sdk.UnwrapSDKContext(c)<br/>store := ctx.KVStore(k.storeKey)</span><span id="65d5" class="km kn ht kd b fv lh kp l kq kr">newDealStore := prefix.NewStore(store, types.KeyPrefix(types.NewDealKeyPrefix))</span><span id="90e9" class="km kn ht kd b fv lh kp l kq kr">pageRes, err := query.Paginate(newDealStore, req.Pagination,  func(key []byte, value []byte) error {<br/> var newDeal types.NewDeal<br/> if err := k.cdc.Unmarshal(value, &amp;newDeal); err != nil {<br/>  return err<br/> }<br/> newDeals = append(newDeals, newDeal)<br/> return nil<br/>})</span><span id="b082" class="km kn ht kd b fv lh kp l kq kr">if err != nil {<br/>  return nil, status.Error(codes.Internal, err.Error())<br/>}</span><span id="15c9" class="km kn ht kd b fv lh kp l kq kr">return &amp;types.QueryAllNewDealResponse{NewDeal: newDeals,    Pagination: pageRes}, nil<br/>}</span></pre><p id="26b6" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">现在类似于<code class="eh ka kb kc kd b">dealCounter</code>和<code class="eh ka kb kc kd b">newDeal</code>类型，让我们借助starport scaffold命令生成<code class="eh ka kb kc kd b">contractCounter</code>和<code class="eh ka kb kc kd b">newContract</code>类型。我们的contractCounter和newContract proto定义应该如下所示</p><pre class="ke kf kg kh fq ki kd kj kk aw kl dt"><span id="9618" class="km kn ht kd b fv ko kp l kq kr">// contract_counter.proto</span><span id="89f3" class="km kn ht kd b fv lh kp l kq kr">message ContractCounter {<br/>string dealId = 1; // id of the deal to which contract belongs to<br/>uint64 idValue = 2; // counter to generate the contract id<br/>}</span></pre></div><div class="ab cl li lj hb lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hm hn ho hp hq"><pre class="ki kd kj kk aw kl dt"><span id="036c" class="km kn ht kd b fv lp lq lr ls lt kp l kq kr">// new_contract.proto</span><span id="b3f6" class="km kn ht kd b fv lh kp l kq kr">message NewContract {<br/>string dealId = 1; // Id of the deal to which contract belongs to<br/>string contractId = 2; // contractId<br/>string consumer = 3; // consumer address<br/>string desc = 4; // order description<br/>uint32 ownerETA = 5; // estimated time of order delivery in mins<br/>uint32 vendorETA = 6; // estimated time of order shipping in mins<br/>string status = 7; // contract current status<br/>uint64 fees = 8; // order payment figure<br/>string expiry = 9; //expiry time before which it should get approved <br/>uint32 shippingDelay = 10; // shipping delay in mins <br/>string startTime = 11; // start time of order<br/>uint32 deliveryDelay = 12; // // delivery delay in mins<br/>}</span></pre><p id="efa7" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">我们将在这里使用带有前缀关键字<code class="eh ka kb kc kd b">NewContract/value/{dealId}/</code>的前缀存储来存储合同。请注意，<code class="eh ka kb kc kd b">dealId</code>这里是启动合同的交易id。</p><p id="1fca" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">让我们修改<code class="eh ka kb kc kd b">new_contract.go</code>(处理契约的getter、setter)和<code class="eh ka kb kc kd b">grpc_query_new_contract.go</code>(查询处理器)，如下所示</p><pre class="ke kf kg kh fq ki kd kj kk aw kl dt"><span id="d6e1" class="km kn ht kd b fv ko kp l kq kr">// new_contract.go<br/> <br/>package keeper</span><span id="4e9d" class="km kn ht kd b fv lh kp l kq kr">import (<br/>"github.com/Harry-027/deal/x/deal/types"<br/>"github.com/cosmos/cosmos-sdk/store/prefix"<br/>sdk "github.com/cosmos/cosmos-sdk/types"<br/>)</span><span id="9e2d" class="km kn ht kd b fv lh kp l kq kr"><em class="lg">// SetNewContract set a specific newContract in the store -"NewContract/value/{dealId}"</em></span><span id="9d41" class="km kn ht kd b fv lh kp l kq kr">func (k Keeper) SetNewContract(ctx sdk.Context, newContract types.NewContract) {</span><span id="c936" class="km kn ht kd b fv lh kp l kq kr">key := types.NewContractKey(newContract.DealId)<br/>store := prefix.NewStore(ctx.KVStore(k.storeKey), key)<br/>b := k.cdc.MustMarshal(&amp;newContract)</span><span id="f9b8" class="km kn ht kd b fv lh kp l kq kr">store.Set(types.NewContractKey(<br/>newContract.ContractId,<br/>), b)<br/>}</span><span id="757f" class="km kn ht kd b fv lh kp l kq kr"><em class="lg">// GetNewContract returns a newContract from its index</em></span><span id="6ea3" class="km kn ht kd b fv lh kp l kq kr">func (k Keeper) GetNewContract(<br/>ctx sdk.Context,<br/>dealId string,<br/>contractId string,<br/>) (val types.NewContract, found bool) {<br/>  storeKey := types.NewContractKey(dealId)<br/>  store := prefix.NewStore(ctx.KVStore(k.storeKey), storeKey)<br/>  b := store.Get(types.NewContractKey(<br/>  contractId,<br/> ))</span><span id="56ae" class="km kn ht kd b fv lh kp l kq kr">if b == nil {<br/> return val, false<br/>}</span><span id="9720" class="km kn ht kd b fv lh kp l kq kr">k.cdc.MustUnmarshal(b, &amp;val)<br/>  return val, true<br/>}</span><span id="64fa" class="km kn ht kd b fv lh kp l kq kr"><em class="lg">// RemoveNewContract removes a newContract from the store<br/></em>func (k Keeper) RemoveNewContract(<br/>ctx sdk.Context,<br/>dealId string,<br/>contractId string,<br/>) {<br/>  storeKey := types.NewContractKey(dealId)<br/>  store := prefix.NewStore(ctx.KVStore(k.storeKey), storeKey)<br/>  store.Delete(types.NewContractKey(<br/>  contractId,<br/>))<br/>}</span><span id="0098" class="km kn ht kd b fv lh kp l kq kr"><em class="lg">// GetAllNewContract returns all newContract</em></span><span id="3ddb" class="km kn ht kd b fv lh kp l kq kr">func (k Keeper) GetAllNewContract(ctx sdk.Context, dealId string) (list []types.NewContract) {</span><span id="b139" class="km kn ht kd b fv lh kp l kq kr">  storeKey := types.NewContractKey(dealId)<br/>  store := prefix.NewStore(ctx.KVStore(k.storeKey), storeKey)<br/>  iterator := sdk.KVStorePrefixIterator(store, []byte{})</span><span id="c8b5" class="km kn ht kd b fv lh kp l kq kr">  defer iterator.Close()</span><span id="984e" class="km kn ht kd b fv lh kp l kq kr">for ; iterator.Valid(); iterator.Next() {<br/>  var val types.NewContract<br/>  k.cdc.MustUnmarshal(iterator.Value(), &amp;val)<br/>  list = append(list, val)<br/>}<br/>  return<br/>}</span></pre></div><div class="ab cl li lj hb lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hm hn ho hp hq"><pre class="ki kd kj kk aw kl dt"><span id="e77f" class="km kn ht kd b fv lp lq lr ls lt kp l kq kr">// grpc_query_new_contract.go</span><span id="902c" class="km kn ht kd b fv lh kp l kq kr">package keeper</span><span id="ff50" class="km kn ht kd b fv lh kp l kq kr">import (<br/>"context"<br/>"github.com/Harry-027/deal/x/deal/types"<br/>"github.com/cosmos/cosmos-sdk/store/prefix"<br/>sdk "github.com/cosmos/cosmos-sdk/types"<br/>"github.com/cosmos/cosmos-sdk/types/query"<br/>"google.golang.org/grpc/codes"<br/>"google.golang.org/grpc/status"<br/>)</span><span id="e49b" class="km kn ht kd b fv lh kp l kq kr"><em class="lg">// NewContractAll is the query handler to fetch all the contracts under given dealId</em></span><span id="25df" class="km kn ht kd b fv lh kp l kq kr">func (k Keeper) NewContractAll(c context.Context, req *types.QueryAllNewContractRequest) (*types.QueryAllNewContractResponse, error) {<br/> if req == nil {<br/>  return nil, status.Error(codes.InvalidArgument, "invalid request")<br/> }</span><span id="399d" class="km kn ht kd b fv lh kp l kq kr"> var newContracts []types.NewContract<br/> ctx := sdk.UnwrapSDKContext(c)</span><span id="b653" class="km kn ht kd b fv lh kp l kq kr"> prefixStoreKey := types.NewContractKey(req.DealId)<br/> store := ctx.KVStore(k.storeKey)<br/> newContractStore := prefix.NewStore(store, prefixStoreKey)</span><span id="6c0e" class="km kn ht kd b fv lh kp l kq kr"> pageRes, err := query.Paginate(newContractStore, req.Pagination,  func(key []byte, value []byte) error {<br/> var newContract types.NewContract<br/> if err := k.cdc.Unmarshal(value, &amp;newContract); err != nil {<br/> return err<br/>}<br/> newContracts = append(newContracts, newContract)<br/> return nil<br/>})</span><span id="ddf8" class="km kn ht kd b fv lh kp l kq kr">if err != nil {<br/> return nil, status.Error(codes.Internal, err.Error())<br/>}</span><span id="8fb1" class="km kn ht kd b fv lh kp l kq kr"> return &amp;types.QueryAllNewContractResponse{NewContract: newContracts, Pagination: pageRes}, nil<br/>}</span><span id="467a" class="km kn ht kd b fv lh kp l kq kr"><em class="lg">// NewContract is the query handler to fetch the contract for a given specific dealId and contractId</em></span><span id="0b95" class="km kn ht kd b fv lh kp l kq kr">func (k Keeper) NewContract(c context.Context, req *types.QueryGetNewContractRequest) (*types.QueryGetNewContractResponse, error) {<br/> if req == nil {<br/>  return nil, status.Error(codes.InvalidArgument, "invalid request")<br/> }<br/>  ctx := sdk.UnwrapSDKContext(c)<br/>  val, found := k.GetNewContract(</span><span id="1dd8" class="km kn ht kd b fv lh kp l kq kr">  ctx,<br/>  req.DealId,<br/>  req.ContractId,<br/>)</span><span id="7695" class="km kn ht kd b fv lh kp l kq kr">if !found {<br/>  return nil, status.Error(codes.InvalidArgument, "not found")<br/>}</span><span id="9729" class="km kn ht kd b fv lh kp l kq kr">  return &amp;types.QueryGetNewContractResponse{NewContract: val}, nil<br/>}</span></pre><p id="7cbe" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">让我们在模块- ( <code class="eh ka kb kc kd b">module.go</code>)上注册查询服务器</p><pre class="ke kf kg kh fq ki kd kj kk aw kl dt"><span id="2522" class="km kn ht kd b fv ko kp l kq kr"><em class="lg">// RegisterGRPCGatewayRoutes registers the gRPC Gateway routes for the module.</em></span><span id="2d2d" class="km kn ht kd b fv lh kp l kq kr">func (AppModuleBasic) RegisterGRPCGatewayRoutes(clientCtx client.Context, mux *runtime.ServeMux) {<br/>types.RegisterQueryHandlerClient(context.Background(), mux, types.NewQueryClient(clientCtx))<br/>}</span></pre><p id="ae58" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">这将确保模块管理器注册我们定制的<code class="eh ka kb kc kd b">deal</code>模块的查询服务器。</p><p id="887b" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">最后，我们完成了交易和合同的查询部分！在下一部分中，我们将负责处理事务和状态变化的消息服务。</p></div><div class="ab cl li lj hb lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hm hn ho hp hq"><p id="1a62" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">参考这里的源代码- <a class="ae jb" href="https://github.com/Harry-027/deal" rel="noopener ugc nofollow" target="_blank"> <em class="lg">源代码</em> </a></p><p id="8f10" class="pw-post-body-paragraph jc jd ht je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hm dt translated">系列<br/> * <a class="ae jb" rel="noopener" href="/coinmonks/building-an-application-specific-blockchain-using-cosmos-sdk-part-1-1f8388902fc8"> <em class="lg">第一部分</em></a><em class="lg"><br/>*</em><a class="ae jb" rel="noopener" href="/@harish0y2j/building-an-application-specific-blockchain-using-cosmos-sdk-part-2-3da0b727cd9b"><em class="lg">第二部分</em> </a> <br/> * <a class="ae jb" rel="noopener" href="/@harish0y2j/building-an-application-specific-blockchain-using-cosmos-sdk-part-3-8ab623f35c74"> <em class="lg">第三部分</em></a><em class="lg"><br/>*</em><a class="ae jb" rel="noopener" href="/@harish0y2j/building-an-application-specific-blockchain-using-cosmos-sdk-part-4-bf0c609ecacc"><em class="lg">第四部分</em></a><br/>*<a class="ae jb" rel="noopener" href="/@harish0y2j/building-an-application-specific-blockchain-using-cosmos-sdk-part-5-e22c9a6debe3"><em class="lg">第五部分</em> </a> <em class="lg"/></p><blockquote class="lu"><p id="845a" class="lv lw ht bd lx ly lz ma mb mc md jz ek translated">加入Coinmonks <a class="ae jb" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae jb" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h1 id="61ce" class="me kn ht bd mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na dt translated">另外，阅读</h1><ul class=""><li id="db36" class="ks kt ht je b jf nb jj nc jn nd jr ne jv nf jz kx ky kz la dt translated"><a class="ae jb" rel="noopener" href="/coinmonks/3commas-review-an-excellent-crypto-trading-bot-2020-1313a58bec92">3 commas Review</a>|<a class="ae jb" href="https://coincodecap.com/pionex-review-exchange-with-crypto-trading-bot" rel="noopener ugc nofollow" target="_blank">Pionex Review</a>|<a class="ae jb" rel="noopener" href="/coinmonks/coinrule-review-2021-a-beginner-friendly-crypto-trading-bot-daf0504848ba">coin rule Review</a></li><li id="0f29" class="ks kt ht je b jf lb jj lc jn ld jr le jv lf jz kx ky kz la dt translated"><a class="ae jb" rel="noopener" href="/coinmonks/ledger-vs-ngrave-zero-7e40f0c1d694">莱杰vs Ngrave </a> | <a class="ae jb" rel="noopener" href="/coinmonks/ledger-nano-s-vs-x-battery-hardware-price-storage-59a6663fe3b0">莱杰nano s vs x </a> | <a class="ae jb" rel="noopener" href="/coinmonks/binance-review-ee10d3bf3b6e">币安评论</a></li><li id="ebda" class="ks kt ht je b jf lb jj lc jn ld jr le jv lf jz kx ky kz la dt translated"><a class="ae jb" rel="noopener" href="/coinmonks/bybit-exchange-review-dbd570019b71"> Bybit交易所评论</a> | <a class="ae jb" href="https://coincodecap.com/bityard-reivew" rel="noopener ugc nofollow" target="_blank"> Bityard评论</a> | <a class="ae jb" href="https://coincodecap.com/jet-bot-review" rel="noopener ugc nofollow" target="_blank"> Jet-Bot评论</a></li><li id="5a00" class="ks kt ht je b jf lb jj lc jn ld jr le jv lf jz kx ky kz la dt translated"><a class="ae jb" rel="noopener" href="/coinmonks/3commas-vs-pionex-vs-cryptohopper-best-crypto-bot-6a98d2baa203">3 commas vs crypto hopper</a>|<a class="ae jb" rel="noopener" href="/coinmonks/earn-crypto-interest-b10b810fdda3">赚取加密利息</a></li><li id="61b3" class="ks kt ht je b jf lb jj lc jn ld jr le jv lf jz kx ky kz la dt translated">最好的比特币<a class="ae jb" rel="noopener" href="/coinmonks/hardware-wallets-dfa1211730c6">硬件钱包</a> | <a class="ae jb" rel="noopener" href="/coinmonks/bitbox02-review-your-swiss-bitcoin-hardware-wallet-c36c88fff29"> BitBox02回顾</a></li></ul></div></div>    
</body>
</html>