<html>
<head>
<title>How to spot Reentrancy bugs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何发现可重入性错误</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/how-to-spot-reentrancy-bugs-9da1079d5c83?source=collection_archive---------17-----------------------#2022-04-08">https://medium.com/coinmonks/how-to-spot-reentrancy-bugs-9da1079d5c83?source=collection_archive---------17-----------------------#2022-04-08</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="3e24" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">可重入可能是solidity智能契约中最常见和最著名的利用。</p><figure class="jp jq jr js fq jt fe ff paragraph-image"><div role="button" tabindex="0" class="ju jv di jw bf jx"><div class="fe ff jo"><img src="../Images/f464e7c7c2474f2068bb166a07e3229c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PY9nByRuVnhXsCvYeiZ9LQ.jpeg"/></div></div><figcaption class="ka kb fg fe ff kc kd bd b be z ek">Photo by <a class="ae ke" href="https://unsplash.com/@flyd2069?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">FLY:D</a> on <a class="ae ke" href="https://unsplash.com/s/photos/cyber-attack?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="d2d2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">首先，如果您不熟悉这个漏洞，让我解释一下在这个代码示例中可重入攻击是如何发生的。</p><blockquote class="kf kg kh"><p id="22c4" class="iq ir ki is b it iu iv iw ix iy iz ja kj jc jd je kk jg jh ji kl jk jl jm jn hm dt translated">调用外部契约的主要危险之一是它们可以接管控制流。在重入攻击(也称为递归调用攻击)中，恶意契约在函数的第一次调用完成之前回调调用契约。这可能导致函数的不同调用以不期望的方式交互。</p></blockquote><p id="6f64" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><em class="ki">&lt;</em><a class="ae ke" href="https://swcregistry.io/docs/SWC-107" rel="noopener ugc nofollow" target="_blank"><em class="ki">【https://swcregistry.io/docs/SWC-107】</em></a><em class="ki">&gt;</em></p><p id="0f60" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">已经有很多关于可重入性的教程和文章，但是大多数都非常简单，只展示了一个特定的例子或者它的变体。</p><figure class="jp jq jr js fq jt"><div class="bz el l di"><div class="km kn l"/></div></figure><p id="bab3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果你看这段代码，你可以看到，如果有人在那里有一个余额，它读取余额并发送它。但是接收以太转发的过程将允许攻击者两次或更多次重新进入该功能并收回他们的余额。</p><p id="522d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">对我来说，像这样的例子限制了可重入的范围。大多数人认为这是一个问题，当你发送以太。</p><p id="7e3c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">长期以来的最佳实践是，停止发送乙醚使用<em class="ki">调用</em>函数，因为你转发你所有的气体，开始使用<em class="ki"> transfer()、send() </em>函数。</p><p id="b608" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">自2019年12月起，随着天然气成本的降低，<em class="ki">调用</em>功能再次成为最佳选择。</p><p id="7f8b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">但是可重入性呢？</strong></p><p id="b505" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">消除可重入性错误的最简单的方法是使用<strong class="is hu"> <em class="ki">检查-效果-交互模式。<br/> </em> </strong>还记得我们上面的代码有一个可重入的bug吗？现在让我们用这个模式来修复它。</p><figure class="jp jq jr js fq jt"><div class="bz el l di"><div class="km kn l"/></div></figure><p id="696a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">注意，现在余额在转移之前被修改了<strong class="is hu">，所以试图重入这个函数没有任何好处。</strong></p><p id="1776" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在这种情况下，防止这种攻击的另一种方法是使用<strong class="is hu">重入防护。<br/> </strong> <em class="ki"> (Openzeppelin对此有一个气体高效的实现，值得一查)。</em></p><p id="deff" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">可重入性现在成为一个更重要的主题，因为如果越来越多的人开始再次采用<em class="ki"> call </em>函数，这些攻击可能会变得更有可能。</p><p id="55be" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在，让我们回到本文的目的，如何在比我上面展示的代码更优雅、更复杂的代码中发现和防范重入攻击。</p><p id="fb5f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们应该注意代码中的三个标志:</p><ul class=""><li id="b337" class="ko kp ht is b it iu ix iy jb kq jf kr jj ks jn kt ku kv kw dt translated"><strong class="is hu">在</strong>之前:控制流程</li><li id="4594" class="ko kp ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw dt translated"><strong class="is hu">在</strong>之前:创建并在之后使用的内存变量</li><li id="5a76" class="ko kp ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw dt translated"><strong class="is hu">在</strong>之后:存储写入</li></ul><p id="c906" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">为了帮助您理解这些迹象，让我们使用一个著名的可重入性bug的例子，DAO hack。</p><figure class="jp jq jr js fq jt"><div class="bz el l di"><div class="km kn l"/></div></figure><p id="38db" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">第6行实际上是以太发送。</p><p id="d97d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们看看在这段代码中可以发现哪些迹象。</p><ol class=""><li id="1d1f" class="ko kp ht is b it iu ix iy jb kq jf kr jj ks jn lc ku kv kw dt translated">在第3行，我们有一个基于存储值的控制流<strong class="is hu">。</strong></li><li id="d57a" class="ko kp ht is b it kx ix ky jb kz jf la jj lb jn lc ku kv kw dt translated">在第5行，我们在第8行的之前创建了一个变量<strong class="is hu">，并在之后使用。</strong></li><li id="5df1" class="ko kp ht is b it kx ix ky jb kz jf la jj lb jn lc ku kv kw dt translated">在第8行，我们在存储写之后有一个<strong class="is hu"/></li></ol><p id="c97b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如您所见，在这段代码中，我们可以发现可重入性错误的所有三个迹象。</p><p id="2992" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu"> Uniswap &amp; ERC777 </strong></p><p id="c409" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">另一个非常著名的例子是Uniswap &amp; ERC777。</p><p id="44d8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">基本上，如果您将ERC777令牌放在Uniswap上，它们可以通过重入攻击被窃取。</p><p id="bded" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们看看代码。</p><figure class="jp jq jr js fq jt"><div class="bz el l di"><div class="km kn l"/></div></figure><p id="a7c9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这个问题非常有趣，因为它没有显示出您之前提到的三个迹象中的任何一个，但是可重入性错误的真正原因是什么呢？</p><p id="c9f4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu"> <em class="ki">剧透</em> </strong>，漏洞来自第9行。</p><p id="b448" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果你不知道ERC777，没关系，对于这个例子你只需要知道这个契约的一个特性，<strong class="is hu">钩子</strong>。</p><p id="1a00" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在任何ERC777传输中，都是这样的:</p><ol class=""><li id="54d9" class="ko kp ht is b it iu ix iy jb kq jf kr jj ks jn lc ku kv kw dt translated">打电话给代币的发送者</li><li id="3a96" class="ko kp ht is b it kx ix ky jb kz jf la jj lb jn lc ku kv kw dt translated">执行转移</li><li id="8bb5" class="ko kp ht is b it kx ix ky jb kz jf la jj lb jn lc ku kv kw dt translated">打电话给代币的接收者</li></ol><p id="4d52" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">所以，由于ERC777钩子是在 实际传输之前<strong class="is hu"> <em class="ki">执行的，所以发送方被调用并可以执行代码。</em></strong></p><p id="6c5d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在Uniswap的例子中，当发送者被呼叫时，我们有这样的情况:</p><ul class=""><li id="6d0f" class="ko kp ht is b it iu ix iy jb kq jf kr jj ks jn kt ku kv kw dt translated">ETH储备已经减少了。</li><li id="a31d" class="ko kp ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw dt translated">令牌储备尚未增加。</li><li id="f8ce" class="ko kp ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw dt translated">发送方契约可以决定现在做什么。</li></ul><p id="1e95" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">当发送方契约被调用时，它可以通过再次调用<strong class="is hu"> tokenToEthOutput </strong>函数来重新进入Uniswap契约。</p><p id="eaa7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在第二次调用中，ETH预留将会更低，但是令牌预留将会相同，并且使用Uniswap的公式来确定价格，ETH价格将会更便宜。</p><p id="8e5f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">攻击者可以重新进入契约，次数与以太网储备持续的次数一样多，或者直到你的令牌供应用完。</p><p id="8c85" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu">结论</strong></p><p id="67cf" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这是对如何在更优雅和复杂的代码中发现可重入性错误的快速解释。</p><p id="0e61" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我希望每个人都喜欢。</p><blockquote class="ld"><p id="95f7" class="le lf ht bd lg lh li lj lk ll lm jn ek translated">加入Coinmonks <a class="ae ke" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae ke" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h1 id="d40b" class="ln lo ht bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk dt translated">另外，阅读</h1><ul class=""><li id="3480" class="ko kp ht is b it ml ix mm jb mn jf mo jj mp jn kt ku kv kw dt translated"><a class="ae ke" href="https://coincodecap.com/ftx-futures-trading" rel="noopener ugc nofollow" target="_blank">如何在FTX交易所交易期货</a> | <a class="ae ke" href="https://coincodecap.com/okex-vs-binance" rel="noopener ugc nofollow" target="_blank"> OKEx vs币安</a></li><li id="5215" class="ko kp ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw dt translated"><a class="ae ke" href="https://coincodecap.com/okex-kucoin" rel="noopener ugc nofollow" target="_blank"> OKEx vs KuCoin </a> | <a class="ae ke" href="https://coincodecap.com/celsius-alternatives" rel="noopener ugc nofollow" target="_blank">摄氏替代度</a> | <a class="ae ke" href="https://coincodecap.com/buy-vechain" rel="noopener ugc nofollow" target="_blank">如何购买VeChain </a></li><li id="53ec" class="ko kp ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw dt translated"><a class="ae ke" href="https://coincodecap.com/profitfarmers-review" rel="noopener ugc nofollow" target="_blank"> ProfitFarmers回顾</a> | <a class="ae ke" href="https://coincodecap.com/cornix-trading-bot" rel="noopener ugc nofollow" target="_blank">如何使用Cornix交易机器人</a></li><li id="e4fa" class="ko kp ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw dt translated"><a class="ae ke" href="https://coincodecap.com/buy-bitcoin-anonymously" rel="noopener ugc nofollow" target="_blank">如何匿名购买比特币</a> | <a class="ae ke" href="https://coincodecap.com/bitcoin-cash-wallets" rel="noopener ugc nofollow" target="_blank">比特币现金钱包</a></li><li id="730b" class="ko kp ht is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw dt translated"><a class="ae ke" href="https://coincodecap.com/wazirx-nft-review" rel="noopener ugc nofollow" target="_blank">瓦济里克斯NFT评论</a>|<a class="ae ke" href="https://coincodecap.com/bitsgap-vs-pionex" rel="noopener ugc nofollow" target="_blank">Bitsgap vs Pionex</a>|<a class="ae ke" href="https://coincodecap.com/tangem-wallet-review" rel="noopener ugc nofollow" target="_blank">Tangem评论</a></li></ul></div></div>    
</body>
</html>