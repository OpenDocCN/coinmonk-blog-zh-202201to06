# ä¿¡æ‰˜åŸºé‡‘

> åŸæ–‡ï¼š<https://medium.com/coinmonks/trust-fund-2b2f6620bfb8?source=collection_archive---------32----------------------->

## å®‰å…¨åˆ›æ–°åŒºå—é“¾ CTF æŠ¥é“(è‹±æ–‡ç‰ˆ)

å¤§å®¶å¥½ï¼è¿™ç¯‡æ–‡ç« ä¹Ÿæœ‰æ³°æ–‡ç‰ˆï¼Œä¾›é‚£äº›å–œæ¬¢çš„äººé˜…è¯»ï¼›[è¯·ç‚¹å‡»è¿™é‡Œ](/@teerasak.r/trust-fund-cb1f9739603e)ã€‚

à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¸£à¸±à¸šà¸šà¸—à¸„à¸§à¸²à¸¡à¸™à¸µà¹‰à¸¡à¸µà¹€à¸§à¸­à¸£à¹Œà¸Šà¸±à¸™à¸ à¸²à¸©à¸²à¹„à¸—à¸¢à¹€à¸«à¸¡à¸·à¸­à¸™à¸à¸±à¸™à¸™à¸°à¸ªà¸³à¸«à¸£à¸±à¸šà¸„à¸™à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¹à¸šà¸šà¸ à¸²à¸©à¸²à¹„à¸—à¸¢à¸ªà¸²à¸¡à¸²à¸£à¸–[à¸„à¸¥à¸´à¸à¸—à¸µà¹ˆà¸™à¸µà¹ˆ](/@teerasak.r/trust-fund-cb1f9739603e)

# åˆåŒä»£ç 

# è§£å†³åŠæ³•

é¦–å…ˆï¼Œæˆ‘å»ºè®®å°è¯•å­¦ä¹ åˆåŒçš„ç›®çš„ã€å·¥ä½œæµç¨‹å’ŒåŠŸèƒ½ã€‚è¿™å¯ä»¥æä¾›å¥‘çº¦çš„æ¦‚è¦ï¼Œå¹¶æç¤ºæ‚¨åº”è¯¥æ£€æŸ¥å“ªä¸ªåŠŸèƒ½ã€‚

è¿™ä¸ªæŒ‘æˆ˜çš„ç›®æ ‡æ˜¯ä»åˆåŒä¸­æŠ½å¹²æ‰€æœ‰çš„ ETHã€‚ç”±äºåªæœ‰ä¸€ä¸ªä¸ä¼ è¾“ ETH ç›¸å…³çš„åŠŸèƒ½ï¼Œå¾ˆå®¹æ˜“æ³¨æ„åˆ°ï¼Œ`withdraw()`ã€‚

å› æ­¤ï¼Œæ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨`withdraw()`å‡½æ•°ï¼Œå¹¶è€ƒè™‘å¦‚ä½•åœ¨ä¸æ¢å¤çš„æƒ…å†µä¸‹è°ƒç”¨å®ƒã€‚å®ƒæœ‰ä¸¤ä¸ª`require()`è¯­å¥ï¼Œä½ å¿…é¡»è®©å®ƒåœ¨è°ƒç”¨æ—¶äº§ç”Ÿ`true`ï¼Œä½†æ˜¯æ€ä¹ˆåšå‘¢ï¼Ÿ

æˆ‘æƒ³ç¼©å°ä¸€ç‚¹ï¼Œè§£é‡Šä¸€ä¸‹è¿™ä¸ªæŒ‘æˆ˜æ˜¯å…³äºä»€ä¹ˆçš„ã€‚å®ƒæ—¨åœ¨é”å®šå·²éƒ¨ç½²çš„ ETHï¼Œå¹¶å…è®¸æ‚¨æ¯å¹´ä»…æ’¤å› 1/10(`allowancePerYear = msg.value.div(10);`)ï¼Œå› æ­¤ï¼Œ**æ‚¨å°†éœ€è¦ 10 å¹´æ—¶é—´æ¥è§£å†³è¿™ä¸€æŒ‘æˆ˜ï¼**ç­‰ä¸€ä¸‹â€¦ï¼Œå¦‚æœè¿™ä¹ˆç›´ï¼Œè¿™å°±ä¸æ˜¯æŒ‘æˆ˜äº†ï¼Œä¸æ˜¯å—ï¼Ÿæ‰€ä»¥ï¼Œæˆ‘ä»¬æ¥æ·±å…¥æ¢è®¨ä¸€ä¸‹æ€ä¹ˆç ´å§ï¼

ç¬¬ä¸€ä¸ªæ˜¯`allowancePerYear > 0`ï¼Œå®Œå…¨ä¸ç”¨æ‹…å¿ƒï¼Œå®ƒå°†å§‹ç»ˆå¤§äºé›¶ï¼Œå› ä¸ºå®ƒå°†è¢«è®¾ç½®ä¸º ETH éƒ¨ç½²é‡é™¤ä»¥ 10ï¼Œè¯¥å€¼å§‹ç»ˆå¤§äºé›¶ã€‚

ç¬¬äºŒä¸ªï¼Œ`withdrewThisYear`ï¼Œæ‰“ç”µè¯æ—¶å¿…é¡»æ˜¯`false`ï¼Œè¡¨ç¤ºä½ ä»Šå¹´ä¸€å®šæ²¡æœ‰ææ¬¾ã€‚åœ¨è°ƒç”¨`withdraw()`ä¹‹åï¼Œå®ƒå°†è¢«è®¾ç½®ä¸ºçœŸï¼Œå¦‚æœä½ å·²ç»è°ƒç”¨äº†å®ƒï¼Œä½ å¯ä»¥é€šè¿‡è°ƒç”¨`returnFund()`å°†å®ƒè®¾ç½®å›å‡ï¼Œå…¶é‡‘é¢ä¸ä½ æå–çš„é‡‘é¢ç›¸åŒã€‚

è€Œä¸”â€¦â€¦ç ´ç»½å°±åœ¨è¿™é‡Œï¼å¦‚æœæ‚¨ä»”ç»†æŸ¥çœ‹ç¬¬ 34â€“36 è¡Œï¼Œæ‚¨ä¼šæ³¨æ„åˆ°åœ¨`withdrewThisYear`è¢«è®¾ç½®ä¸º`true`ä¹‹å‰ï¼Œèµ„é‡‘è¢«å‘é€ç»™è°ƒç”¨è€…(`msg.sender.call.value(allowancePerYear)()`)ï¼Œè¿™ç§æ¨¡å¼å¼•å…¥äº†å¯é‡å…¥æ”»å‡»ã€‚æˆ‘ä¸æ‰“ç®—è§£é‡Šè¿™ç§æ”»å‡»æ˜¯ä»€ä¹ˆï¼Œä½†æ˜¯å¦‚æœæ‚¨ä»¥å‰æ²¡æœ‰å¬è¯´è¿‡å®ƒæˆ–è€…å¯¹å®ƒä¸ç†Ÿæ‚‰ï¼Œè¯·ä½¿ç”¨ä¸‹é¢çš„æ¥æºä½œä¸ºèµ·ç‚¹æ¥äº†è§£å®ƒçš„æ›´å¤šä¿¡æ¯:

*   [https://swcregistry.io/docs/SWC-107](https://swcregistry.io/docs/SWC-107)
*   [https://hackernoon.com/hack-solidity-reentrancy-attack](https://hackernoon.com/hack-solidity-reentrancy-attack)

å¥‘çº¦åœ¨è®¾ç½®å€¼ä¹‹å‰è¿›è¡Œå¤–éƒ¨è°ƒç”¨ï¼Œåœ¨å¤„ç†ç¬¬ 35 è¡Œä¹‹å‰ï¼Œå®ƒå°†æ§åˆ¶æƒäº¤ç»™è¢«è°ƒç”¨è€…ã€‚æ‰€ä»¥ï¼Œä½ å¯ä»¥åœ¨`withdrawThisYear`ä»ç„¶æ˜¯`false`çš„æ—¶å€™å†æ¬¡è°ƒç”¨`withdraw()`ã€‚è¦åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­æ‰§è¡Œå¤šä¸ªè°ƒç”¨ï¼Œæ™ºèƒ½åˆçº¦æ˜¯ä¸å¯é¿å…çš„ï¼›æ²¡æœ‰æ™ºèƒ½åˆåŒå°±æ— æ³•åšåˆ°è¿™ä¸€ç‚¹ã€‚æ™ºèƒ½åˆçº¦é€»è¾‘å¯ä»¥å¦‚ä¸‹æ‰€ç¤º:

1.  è°ƒç”¨`withdraw()`å‡½æ•°ã€‚
2.  å®ç°`fallback()/receiver()`å‡½æ•°æ¥é€’å½’è°ƒç”¨`withdraw()`å‡½æ•°ã€‚è¯¥åŠŸèƒ½å°†ç”±æ¯æ¬¡å‘¼å«çš„ç¬¬ 34 è¡Œè§¦å‘ã€‚è€Œä¸”ï¼Œæ‚¨å¿…é¡»åŒ…æ‹¬å‰©ä½™ä½™é¢æ£€æŸ¥ï¼Œä»¥åœ¨æ‰€æœ‰èµ„é‡‘è€—å°½ååœæ­¢é€’å½’ã€‚
3.  å°†ä½ çš„æ™ºèƒ½åˆçº¦ä¸­æ‰€æœ‰è€—å°½çš„ ETH è½¬ç§»å›ç»™ä½ (å¦‚æœä½ æ„¿æ„ï¼Œä½ å¯ä»¥ç•™ä¸‹å®ƒ)ã€‚

ä¸‹é¢æ˜¯æˆ‘æ ¹æ®ä¸Šè¿°é€»è¾‘å®ç°çš„æ™ºèƒ½å¥‘çº¦ã€‚

æ‚¨å¯ä»¥ç”¨æ‚¨å–œæ¬¢çš„ä»»ä½•æ–¹æ³•æ¥ç¼–è¯‘ã€éƒ¨ç½²å’Œè¿è¡Œå®ƒã€‚æ‚¨åªéœ€åœ¨éƒ¨ç½²æ—¶è¾“å…¥æŒ‘æˆ˜åœ°å€(TrustFund.sol)å³å¯è®¾å®šç›®æ ‡ã€‚

å¦‚æœä½ åœ¨ [SecurityInnovation](https://blockchain-ctf.securityinnovation.com/#/) ç½‘ç«™ä¸Šç©ï¼Œåˆ«å¿˜äº†æŒ‘æˆ˜æ˜¯ç»§æ‰¿è‡ª`CtfFramework.sol`çš„ã€‚æ‚¨å¿…é¡»é€šè¿‡è°ƒç”¨`ctf_challenge_add_authorized_sender()`å°†æ‚¨éƒ¨ç½²çš„æ™ºèƒ½åˆçº¦åœ°å€ä½œä¸ºå…è®¸çš„è°ƒç”¨æ–¹ã€‚

ä¸€åˆ‡å°±ç»ªåï¼Œåªéœ€è°ƒç”¨`pwn()`å³å¯å®ŒæˆğŸ˜ã€‚

![](img/eefa6c13b352f156ead281e012b4b08b.png)

# å¸å–çš„æ•™è®­

è¿™ä¸ªæŒ‘æˆ˜æ˜¾ç„¶æ˜¯æœ‰é‡å…¥æ”»å‡»æ¼æ´çš„ï¼Œå› æ­¤ï¼Œ[è¿™é‡Œå¯ä»¥æ‰¾åˆ°å¾ˆå¥½çš„ç¼“è§£æ–¹æ³•](https://swcregistry.io/docs/SWC-107)ã€‚æˆ‘å°†æ€»ç»“å¦‚ä¸‹:

*   æœ€å¥½ä¸è¦åœ¨æ›´æ”¹å†…éƒ¨çŠ¶æ€ä¹‹å‰è¿›è¡Œå¤–éƒ¨è°ƒç”¨ï¼Œä½†å¦‚æœéœ€è¦ï¼Œè¯·ç¡®ä¿å¤–éƒ¨è¢«è°ƒç”¨æ–¹æ˜¯å¯ä¿¡çš„ã€‚
*   Openzeppelin çš„ [ReentrancyGuard](https://docs.openzeppelin.com/contracts/4.x/api/security#ReentrancyGuard) éå¸¸æœ‰å¸®åŠ©ï¼Œæ˜¯ä¸ºæ­¤è€Œç”Ÿçš„ã€‚ç„¶è€Œï¼Œåªå¯¹éœ€è¦ä¸å¯é‡å…¥çš„å‡½æ•°ä½¿ç”¨å®ƒï¼Œè€Œä¸æ˜¯å¯¹æ‰€æœ‰çš„å‡½æ•°ï¼Œå› ä¸ºè¿™åŒ…æ‹¬æ›´å¤šçš„æ£€æŸ¥ï¼Œæ‰€ä»¥ï¼ŒèŠ±è´¹æ›´å¤šçš„æ±½æ²¹ã€‚
*   ä½ ä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨ [Rari-Capital solmate çš„ ReentrancyGuard](https://github.com/Rari-Capital/solmate/blob/main/src/utils/ReentrancyGuard.sol) æ¥è·å¾—æ¯” Openzeppelin æ›´å¤šçš„æ°”ä½“ä¼˜åŒ–ï¼Œå¦‚æœä½ æ‰“ç®—ä½¿ç”¨çš„è¯ã€‚

> *åŠ å…¥ Coinmonks* [*ç”µæŠ¥é¢‘é“*](https://t.me/coincodecap) *å’Œ* [*Youtube é¢‘é“*](https://www.youtube.com/c/coinmonks/videos) *äº†è§£åŠ å¯†äº¤æ˜“å’ŒæŠ•èµ„*

# å¦å¤–ï¼Œé˜…è¯»

*   [3 å•†ä¸šè¯„è®º](/coinmonks/3commas-review-an-excellent-crypto-trading-bot-2020-1313a58bec92) | [Pionex è¯„è®º](https://coincodecap.com/pionex-review-exchange-with-crypto-trading-bot) | [Coinrule è¯„è®º](/coinmonks/coinrule-review-2021-a-beginner-friendly-crypto-trading-bot-daf0504848ba)
*   [è±æ° vs n æ ¼æ‹‰å¤«](/coinmonks/ledger-vs-ngrave-zero-7e40f0c1d694) | [è±æ°çº³è¯º s vs x](/coinmonks/ledger-nano-s-vs-x-battery-hardware-price-storage-59a6663fe3b0) | [å¸å®‰è¯„è®º](/coinmonks/binance-review-ee10d3bf3b6e)
*   [åŠ å¯†äº¤æ˜“æœºå™¨äºº](/coinmonks/crypto-trading-bot-c2ffce8acb2a) | [Bingbon è¯„è®º](https://coincodecap.com/bingbon-review)
*   [Bybit Exchange å®¡æŸ¥](/coinmonks/bybit-exchange-review-dbd570019b71) | [Bityard å®¡æŸ¥](https://coincodecap.com/bityard-reivew) | [Jet-Bot å®¡æŸ¥](https://coincodecap.com/jet-bot-review)
*   [3 commas vs crypto hopper](/coinmonks/3commas-vs-pionex-vs-cryptohopper-best-crypto-bot-6a98d2baa203)|[èµšå–åŠ å¯†åˆ©æ¯](/coinmonks/earn-crypto-interest-b10b810fdda3)
*   æœ€å¥½çš„æ¯”ç‰¹å¸[ç¡¬ä»¶é’±åŒ…](/coinmonks/hardware-wallets-dfa1211730c6) | [BitBox02 å›é¡¾](/coinmonks/bitbox02-review-your-swiss-bitcoin-hardware-wallet-c36c88fff29)