<html>
<head>
<title>Uniswap Smart Contract Breakdown</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Uniswap智能合同细分</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/uniswap-smart-contract-breakdown-1f4b787b7f0e?source=collection_archive---------0-----------------------#2022-02-25">https://medium.com/coinmonks/uniswap-smart-contract-breakdown-1f4b787b7f0e?source=collection_archive---------0-----------------------#2022-02-25</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="00c3" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">通过对代码行进行分组来解释其功能</h2></div><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff ji"><img src="../Images/ccf51387714b7b96ebce4cf1eb6af7c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yv9v_XSvpbxZStKS.png"/></div></div></figure><p id="fd82" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">您可能知道Uniswap的常数乘积公式(x*y=k)。但是Uniswap智能合同是如何在幕后真正发挥作用的呢？</p><p id="f075" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">在本文中，我们将通过分解其智能合约来了解Uniswap是如何实现的。我们将检查数百行每天产生12.8亿美元收入的可靠性代码。</p><p id="1e82" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">剧透提示:你将会看到一个非常高效、优雅、安全的Solidity代码。</p><p id="613e" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">下面是这篇文章的提纲:</p><ul class=""><li id="820f" class="kq kr ht jw b jx jy ka kb kd ks kh kt kl ku kp kv kw kx ky dt translated">Uniswap如何在高层次上工作</li><li id="412c" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated">Uniswap代码的组织方式</li><li id="dd2b" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated">Uniswap功能</li><li id="49ca" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated">核心合同:配对(硬)</li><li id="8167" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated">核心合同:工厂(简单)</li><li id="ed23" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated">外围合同:路由器(易)</li><li id="7146" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated">完全注释的代码</li></ul><h1 id="2643" class="le lf ht bd lg lh li lj lk ll lm ln lo iz lp ja lq jc lr jd ls jf lt jg lu lv dt translated">Uniswap如何在高层次上工作</h1><p id="732e" class="pw-post-body-paragraph ju jv ht jw b jx lw iu jz ka lx ix kc kd ly kf kg kh lz kj kk kl ma kn ko kp hm dt translated">Uniswap的全部目的是允许您将一个ERC20令牌换成另一个。例如，你需要Dogecoin，但你只有柴犬硬币。Uniswap允许你卖掉你的狗币，并得到柴犬作为回报。这都是以自动和分散的方式完成的。<strong class="jw hu"> Uniswap只是一个去中心化的交换。</strong></p><p id="56a6" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">交换可以通过两种方式实现。</p><ol class=""><li id="c28f" class="kq kr ht jw b jx jy ka kb kd ks kh kt kl ku kp mb kw kx ky dt translated"><strong class="jw hu">订单簿模式:</strong>买家和卖家提交订单。并且中央系统将买入订单与卖出订单进行匹配。这就是传统证券交易所的运作方式。</li><li id="40e1" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp mb kw kx ky dt translated"><strong class="jw hu">自动做市商(AMM): </strong>没有集中的媒人。有人同时提供这两种代币(Dogecoin和柴犬)。他们被称为流动性提供者。这些流动性提供者创造了一个Dogecoin和柴犬代币池。现在，商人可以来存放金币，并得到柴犬作为回报。这是自动完成的，没有集中的实体。交易者为交易支付一小部分费用，这些费用由流动性提供者提供服务。</li></ol><p id="cdd5" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">Uniswap使用AMM技术。它是如何决定一个池子里的汇率的？也就是说，1个金币值多少柴犬代币？这是由常数乘积公式<code class="eh mc md me mf b">(Dogecoin amount)*(Shiba amount)=k</code>决定的。在交易期间，这个产品必须保持不变。</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff mg"><img src="../Images/d9e68fec202acd1f8cc225a02b56bfcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EucZjfDWegKG4Lmo.png"/></div></div></figure><p id="486c" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">来自"<a class="ae mh" rel="noopener" href="/scalar-capital/uniswap-a-unique-exchange-f4ef44f807bf"> Uniswap —一个独特的交易所</a>"</p><p id="d554" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">如果这个不完全清楚，也不用担心。在本文的其余部分，我们将学习更多关于这个公式和市场动态的知识。</p><h1 id="7c49" class="le lf ht bd lg lh li lj lk ll lm ln lo iz lp ja lq jc lr jd ls jf lt jg lu lv dt translated">关于Uniswap版本的说明</h1><p id="6759" class="pw-post-body-paragraph ju jv ht jw b jx lw iu jz ka lx ix kc kd ly kf kg kh lz kj kk kl ma kn ko kp hm dt translated">Uniswap有3个版本。</p><ul class=""><li id="1ab2" class="kq kr ht jw b jx jy ka kb kd ks kh kt kl ku kp kv kw kx ky dt translated">我们将使用v2。</li><li id="3e3e" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated">v1太简单，不具备所有现代特征。</li><li id="5684" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated">v3本质上是v2，但经过了改进和优化——它的代码比v2复杂得多。</li></ul><h1 id="4997" class="le lf ht bd lg lh li lj lk ll lm ln lo iz lp ja lq jc lr jd ls jf lt jg lu lv dt translated">Uniswap代码的组织方式</h1><p id="ed88" class="pw-post-body-paragraph ju jv ht jw b jx lw iu jz ka lx ix kc kd ly kf kg kh lz kj kk kl ma kn ko kp hm dt translated">Uniswap总共有4份智能合同。分为<strong class="jw hu">核心</strong>和<strong class="jw hu">外围</strong>。</p><ol class=""><li id="0e76" class="kq kr ht jw b jx jy ka kb kd ks kh kt kl ku kp mb kw kx ky dt translated"><strong class="jw hu">核心</strong>用于存储资金(代币)和暴露用于交换代币、添加资金、获得奖励等的功能。</li><li id="813e" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp mb kw kx ky dt translated"><strong class="jw hu">外围</strong>用于与<strong class="jw hu">核心</strong>交互。</li></ol><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff ji"><img src="../Images/66c8783a48276b7db26aaac29ea02fc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sXsKxIS7OxEn_RXd.png"/></div></div></figure><p id="0e62" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated"><strong class="jw hu">核心</strong>由以下智能合约组成:</p><ol class=""><li id="a32f" class="kq kr ht jw b jx jy ka kb kd ks kh kt kl ku kp mb kw kx ky dt translated"><strong class="jw hu"> Pair </strong> —一个智能合约，实现交换、铸造、刻录令牌的功能。这个合约是为每一个像<em class="mi"> Dogecoin ↔十八</em>这样的交易所对创建的。</li><li id="653c" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp mb kw kx ky dt translated"><strong class="jw hu">工厂</strong> —创建并跟踪所有配对合同</li><li id="4e17" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp mb kw kx ky dt translated"><strong class="jw hu"> ERC20 </strong> —用于跟踪池的所有权。把游泳池想象成一种财产。当流动性提供者向资金池提供资金时，他们会得到“资金池所有权代币”作为回报。这些所有权代币获得奖励(交易者为每笔交易支付一小部分)。当流动性提供者想要回他们的资金时，他们只需提交所有权令牌，然后获得他们的资金+累积的奖励。ERC20契约跟踪所有权令牌。</li></ol><p id="ec04" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated"><strong class="jw hu">外围</strong>只包含一个智能合约:</p><ol class=""><li id="bdd5" class="kq kr ht jw b jx jy ka kb kd ks kh kt kl ku kp mb kw kx ky dt translated"><strong class="jw hu">路由器</strong>用于与核心交互。提供<code class="eh mc md me mf b">swapExactETHForTokens</code>、<code class="eh mc md me mf b">swapETHForExactTokens</code>等功能。</li></ol><h1 id="a003" class="le lf ht bd lg lh li lj lk ll lm ln lo iz lp ja lq jc lr jd ls jf lt jg lu lv dt translated">Uniswap功能</h1><p id="7f52" class="pw-post-body-paragraph ju jv ht jw b jx lw iu jz ka lx ix kc kd ly kf kg kh lz kj kk kl ma kn ko kp hm dt translated">我们讨论了Uniswap的4个智能合同以及它们是如何组织的。但是这些契约实现的主要功能是什么？主要功能如下:</p><ol class=""><li id="6deb" class="kq kr ht jw b jx jy ka kb kd ks kh kt kl ku kp mb kw kx ky dt translated"><strong class="jw hu">管理资金</strong>(如何在池中管理Dogecoin和柴犬等代币)</li><li id="7a36" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp mb kw kx ky dt translated"><strong class="jw hu">流动性提供者的功能— </strong>存入更多资金，并随奖励一起提取资金</li><li id="974c" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp mb kw kx ky dt translated"><strong class="jw hu">交易者</strong>的功能——交换</li><li id="5635" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp mb kw kx ky dt translated"><strong class="jw hu">管理池所有权令牌</strong></li><li id="8cd6" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp mb kw kx ky dt translated"><strong class="jw hu">协议费用</strong> — Uniswap v2引入了可切换的协议费用。这一礼宾费是付给Uniswap小组的，感谢他们维护Uniswap的努力。目前，此协议费用已关闭，但将来可以打开。当交易开始时，交易者仍将支付相同的交易费用，但这笔费用的1/6将归Uniswap团队所有，其余的5/6将归流动性提供者所有，作为他们提供资金的报酬。</li></ol><p id="5366" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">除了上面描述的主要功能，Uniswap还有一个不是Uniswap的核心功能，但它是以太坊生态系统中其他合同的有用助手:</p><ol class=""><li id="24e1" class="kq kr ht jw b jx jy ka kb kd ks kh kt kl ku kp mb kw kx ky dt translated"><strong class="jw hu">价格预测</strong> — Uniswap跟踪代币相对于彼此的价格，并可用作以太坊生态系统中其他智能合约的价格预测。由于套利(我们将在本文后面了解)，Uniswap的价格往往会紧跟代币的实际市场价格。所以Uniswap价格oracle是真实市场价格的一个非常好的近似值。</li></ol><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff ji"><img src="../Images/dd7cfb681b529d9ec3b7981b9dab9089.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*FTMCY8iVDsFKz9li.png"/></div></div></figure><h1 id="e8fb" class="le lf ht bd lg lh li lj lk ll lm ln lo iz lp ja lq jc lr jd ls jf lt jg lu lv dt translated">核心合同:配对(硬)</h1><p id="03f5" class="pw-post-body-paragraph ju jv ht jw b jx lw iu jz ka lx ix kc kd ly kf kg kh lz kj kk kl ma kn ko kp hm dt translated">现在让我们深入研究Uniswap智能合约的实际可靠性代码。我们将从结对合同开始。这是4个智能合同中最复杂的一个。剩下的会变得更容易。</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff ji"><img src="../Images/dc841c7471eee6dd0ee189a2dad1722a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*A7ASuLORb-K9wzFg.png"/></div></div></figure><p id="e075" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">Pair契约实现了一对令牌(如Dogecoin和柴犬)之间的交换。Pair智能合约的完整代码可以在Github上的<a class="ae mh" href="https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Pair.sol" rel="noopener ugc nofollow" target="_blank">v2-core/contracts/uniswapv 2 Pair . sol</a>下找到</p><p id="1007" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated"><strong class="jw hu">让我们逐行分解一下。</strong></p><p id="c33d" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">一、导入报表:</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff ji"><img src="../Images/c5609767fb57a2cb5bf97fe5f19babf0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ICzz_f04PE0KiaAs.png"/></div></div></figure><p id="6716" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">接下来，合同声明:</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff ji"><img src="../Images/f278bb2a4df4fd0f26a833d46952b0a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*21j49Z2Y9riZDIp-.png"/></div></div></figure><ul class=""><li id="34c2" class="kq kr ht jw b jx jy ka kb kd ks kh kt kl ku kp kv kw kx ky dt translated">合同名称为<code class="eh mc md me mf b">UniswapV2Pair</code></li><li id="d7a2" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated">它实现了<code class="eh mc md me mf b">IUniswapV2Pair</code>接口，这只是这个契约的一个接口(这里可以找到<a class="ae mh" href="https://github.com/Uniswap/v2-core/blob/master/contracts/interfaces/IUniswapV2Pair.sol" rel="noopener ugc nofollow" target="_blank"/>)。它也延长了<code class="eh mc md me mf b">UniswapV2ERC20</code>合同。为什么？用于管理池所有权令牌。稍后我们将了解更多相关信息。</li><li id="935a" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated"><code class="eh mc md me mf b">SafeMath</code>是一个处理上溢/下溢的库。<code class="eh mc md me mf b">UQ112x112</code>是一个支持浮点数的库。Solidity默认不支持浮动。这个库使用224位来表示浮点数。前112位是整数，后112位是小数。</li></ul><p id="7cd4" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">接下来，我们将根据代码实现的功能对其进行分组。</p><h1 id="3c5e" class="le lf ht bd lg lh li lj lk ll lm ln lo iz lp ja lq jc lr jd ls jf lt jg lu lv dt translated">管理资金</h1><p id="35d6" class="pw-post-body-paragraph ju jv ht jw b jx lw iu jz ka lx ix kc kd ly kf kg kh lz kj kk kl ma kn ko kp hm dt translated">Uniswap对是一对令牌(如Dogecoin和柴犬)之间的交换。这些令牌在契约中表示为<code class="eh mc md me mf b">token0</code>和<code class="eh mc md me mf b">token1</code>。它们是实现它们的ERC20智能合约的地址。</p><p id="160d" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">变量存储我们在这个对中有多少令牌。</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff ji"><img src="../Images/7f374323e9110c48baa06715c340d621.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*V52KKFoeO883x7lQ.png"/></div></div></figure><p id="90ad" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">您可能想知道，实际的令牌存储在哪里？这是在令牌本身的ERC20契约中完成的。在结对合同中没有这样做。配对合约只是记录储备。从ERC20的角度来看，配对合同只是一个可以转移和接收令牌的普通用户，它有自己的余额，等等。</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff ji"><img src="../Images/21366a0b7ab20bb043f73f7328c0def7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lMumGqmLd3DXTVMO.png"/></div></div></figure><p id="5e5d" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">这就是3个智能合同的资金管理方式</p><p id="636e" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">Pair contract调用ERC20的函数如<code class="eh mc md me mf b">balanceOf</code>(用<code class="eh mc md me mf b">owner=Pair contract’s address</code>)和<code class="eh mc md me mf b">transfer</code>来管理令牌(如果你感到困惑，请参见我的<a class="ae mh" href="https://ilamanov.medium.com/erc20-smart-contract-breakdown-9dab65cec671" rel="noopener"> ERC20智能合约分解</a>)。这里有一个例子，说明ERC20的<code class="eh mc md me mf b">transfer</code>函数是如何在Pair contract中使用的。</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff ji"><img src="../Images/f1f1c38a0d7ff7bf0e110a6792c4eb8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8DgGHoTPXO0UCdlN.png"/></div></div></figure><p id="8b60" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated"><code class="eh mc md me mf b">_update</code>每当流动性提供者存入或提取新资金，或者交易者交换代币时，就会调用下面的函数。</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff ji"><img src="../Images/6fe49f9a59005a1f3c8f117c821c2321.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SG5inEPNHn_juz2G.png"/></div></div></figure><p id="cad6" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">这个函数中发生了一些事情:</p><ul class=""><li id="ffe6" class="kq kr ht jw b jx jy ka kb kd ks kh kt kl ku kp kv kw kx ky dt translated"><code class="eh mc md me mf b">balance0</code>和<code class="eh mc md me mf b">balance1</code>是ERC20中的代币余额。它们是ERC20的<code class="eh mc md me mf b">balanceOf</code>函数的返回值。</li><li id="0ea2" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated"><code class="eh mc md me mf b">_reserve0</code>和<code class="eh mc md me mf b">_reserve1</code>是Uniswap之前已知的余额(上次检查<code class="eh mc md me mf b">balanceOf</code>)。</li><li id="0112" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated">我们在这个函数中所做的就是检查溢出(第74行)，更新价格oracle(这将在后面的部分中解释)，更新储备，以及更新一个<code class="eh mc md me mf b">Sync</code>事件。</li></ul><p id="9eca" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">参数<code class="eh mc md me mf b">_reserve0, _reserve1</code>和存储变量<code class="eh mc md me mf b">reserve0, reserve1</code>有什么区别(如下所示)？它们本质上是一样的。<code class="eh mc md me mf b">_update</code>函数的调用者已经从存储器中读取了<code class="eh mc md me mf b">reserve</code>变量，并将它们作为参数传递给<code class="eh mc md me mf b">_update</code>函数。这只是节省汽油的一种方法。从存储中读取比从内存中读取更昂贵</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff ji"><img src="../Images/986e7561c4a378646d76142adc29ce40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AI1E1MJfKUbNH42o.png"/></div></div></figure><blockquote class="mj mk ml"><p id="ca34" class="ju jv mi jw b jx jy iu jz ka kb ix kc mm ke kf kg mn ki kj kk mo km kn ko kp hm dt translated"><em class="ht">你会一再注意到这一点:</em> <strong class="jw hu"> <em class="ht"> Uniswap绝对热爱效率和省油。</em> </strong> <em class="ht">他们从扎实中挤出每一个他们能挤出的单个表现点。</em> <code class="eh mc md me mf b"><em class="ht">_reserve0</em></code> <em class="ht">和</em> <code class="eh mc md me mf b"><em class="ht">_reserve1</em></code> <em class="ht">就是其中的一个例子。</em></p></blockquote><h1 id="680c" class="le lf ht bd lg lh li lj lk ll lm ln lo iz lp ja lq jc lr jd ls jf lt jg lu lv dt translated">铸造和燃烧</h1><p id="143f" class="pw-post-body-paragraph ju jv ht jw b jx lw iu jz ka lx ix kc kd ly kf kg kh lz kj kk kl ma kn ko kp hm dt translated">现在来看下一个功能——铸造和烧制。铸造是指流动性提供者向资金池中添加资金，并因此为流动性提供者铸造(凭空创造)新的资金池所有权令牌。燃烧是相反的——流动性提供者提取资金(和累积的回报),他的池所有权令牌被燃烧(销毁)。</p><p id="6d2c" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">我们来看看<code class="eh mc md me mf b">mint</code>函数。</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff ji"><img src="../Images/ebec324e8631db92b6f86cc4ab1dc118.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rikuPsPsvot2udD2.png"/></div></div></figure><ul class=""><li id="7dd9" class="kq kr ht jw b jx jy ka kb kd ks kh kt kl ku kp kv kw kx ky dt translated">您可能会立即再次注意到节省的气体:<code class="eh mc md me mf b">reserve0</code>、<code class="eh mc md me mf b">reserve1</code>和<code class="eh mc md me mf b">totalSupply</code>从存储器转移到内存(第111行和第118行)，这样读取这些值就更便宜了。</li><li id="7961" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated">我们读取第112行和第113行的合约(配对合约)余额，然后计算每个代币的存款金额。</li><li id="706c" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated">代码的粉色部分是任择议定书费用。我们稍后将对此进行研究。</li><li id="a8d9" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated"><code class="eh mc md me mf b">totalSupply</code>表示池所有权令牌的总供应量，并且是<code class="eh mc md me mf b">UniswapV2ERC20</code>合同中的存储变量(参见我在此处对其的分解<a class="ae mh" href="https://ilamanov.medium.com/erc20-smart-contract-breakdown-9dab65cec671" rel="noopener">)。Pair contract扩展了<code class="eh mc md me mf b">UniswapV2ERC20</code>,这就是它能够访问<code class="eh mc md me mf b">totalSupply</code>变量的原因。</a></li><li id="f49d" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated">如果<code class="eh mc md me mf b">totalSupply</code>为0，这意味着这个池是全新的，我们需要锁定<code class="eh mc md me mf b">MINIMIUM_LIQUIDITY</code>池所有权令牌的数量，以避免在流动性计算中被零除。锁定它的方法是将它发送到地址零。(没有人知道通向地址零的私钥，因此通过向地址零发送资金，您实际上永远锁定了资金)。</li><li id="431b" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated"><code class="eh mc md me mf b"><strong class="jw hu">liquidity</strong></code> <strong class="jw hu">变量是需要向流动性提供者创造的新池所有权令牌的数量</strong>。流动性提供者根据他提供的新资金的数量获得一定比例的池所有权令牌(第123行)</li><li id="dbed" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated">我们最后将新的池所有权令牌添加到<code class="eh mc md me mf b">to</code>地址(第126行)。<code class="eh mc md me mf b">to</code>是流动性提供者的地址(这将由调用<code class="eh mc md me mf b">mint</code>函数的称为路由器的外围契约提供)</li></ul><p id="af97" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated"><strong class="jw hu">添加资金的工作方式是:</strong>它们只是存放到ERC20合约中(通过为每个令牌调用<code class="eh mc md me mf b">transfer(from: liquidity provider’s address, to: Pair contract’s address, amount)</code>)。然后，配对合同将读取余额(第112和113行)，并将它们与最后已知的余额(第114和115行)进行比较。这就是配对合同如何可以减少存款的数额。</p><p id="39c5" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated"><code class="eh mc md me mf b">burn</code>功能是<code class="eh mc md me mf b">mint</code>功能的镜像:</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="fe ff ji"><img src="../Images/2c73dbe19682758f2713702d2b862e43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6J6vnUkTcKJi9Z2S.png"/></div></div></figure><ul class=""><li id="3d2b" class="kq kr ht jw b jx jy ka kb kd ks kh kt kl ku kp kv kw kx ky dt translated">我们再次在135、136、137和143行看到了气体节省</li><li id="5394" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated"><code class="eh mc md me mf b">balance0</code>和<code class="eh mc md me mf b">balance1</code>是该池中代币的总余额。<code class="eh mc md me mf b">liquidity</code>是流动性提供者(希望套现)拥有的池所有权令牌数量。为什么把流动资金作为<code class="eh mc md me mf b">address(this)</code>的余额？因为流动性是在调用<code class="eh mc md me mf b">burn</code>函数之前由外围契约转移到配对契约的。</li><li id="fd65" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated">我们根据流动性提供者拥有的流动性(池所有权令牌)的多少，按比例计算提取给流动性提供者的令牌数量(第144和145行)</li><li id="44e8" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated">然后我们烧掉他的流动资金，把代币转给他。</li><li id="c6ec" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated">对流动性提供者的奖励会随着他的资金自动提取。这种数学方法可以确保奖励合理累积，并且你得到的比你存入的多。</li></ul><p id="7979" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">这就是第1部分！我把这篇文章分成两部分，因为它太长了。我希望这有所帮助。如果你有任何问题，请在评论中告诉我。</p><p id="68a6" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated"><strong class="jw hu">在第2部分</strong>中，我们将介绍:</p><ul class=""><li id="5883" class="kq kr ht jw b jx jy ka kb kd ks kh kt kl ku kp kv kw kx ky dt translated">该对合同的其余部分:交换、池所有权令牌、协议费和价格甲骨文。</li><li id="e785" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated">还有Uniswap的工厂、ERC20和路由器合同</li></ul><p id="0430" class="pw-post-body-paragraph ju jv ht jw b jx jy iu jz ka kb ix kc kd ke kf kg kh ki kj kk kl km kn ko kp hm dt translated">你也可以在我的媒体简介上查看我的其他文章。</p><pre class="jj jk jl jm fq mp mf mq mr aw ms dt"><span id="e52a" class="mt lf ht mf b fv mu mv l mw mx"><strong class="mf hu">Want to Connect? </strong>Follow me on <a class="ae mh" href="https://twitter.com/LakshayMaini_" rel="noopener ugc nofollow" target="_blank">Twitter</a>.</span></pre><blockquote class="my"><p id="be6b" class="mz na ht bd nb nc nd ne nf ng nh kp ek translated"><em class="ni">加入Coinmonks </em> <a class="ae mh" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank"> <em class="ni">电报频道</em> </a> <em class="ni">和</em> <a class="ae mh" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> <em class="ni"> Youtube频道</em> </a> <em class="ni">了解加密交易和投资</em></p></blockquote><h1 id="cfba" class="le lf ht bd lg lh li lj lk ll lm ln lo iz nj ja lq jc nk jd ls jf nl jg lu lv dt translated">另外，阅读</h1><ul class=""><li id="487e" class="kq kr ht jw b jx lw ka lx kd nm kh nn kl no kp kv kw kx ky dt translated"><a class="ae mh" href="https://coincodecap.com/trading-signal" rel="noopener ugc nofollow" target="_blank">交易信号是什么？</a> | <a class="ae mh" href="https://coincodecap.com/bitstamp-coinbase" rel="noopener ugc nofollow" target="_blank"> Bitstamp vs比特币基地</a> | <a class="ae mh" href="https://coincodecap.com/buy-solana" rel="noopener ugc nofollow" target="_blank">买索拉纳</a></li><li id="f638" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated"><a class="ae mh" href="https://coincodecap.com/profitfarmers-review" rel="noopener ugc nofollow" target="_blank"> ProfitFarmers回顾</a> | <a class="ae mh" href="https://coincodecap.com/cornix-trading-bot" rel="noopener ugc nofollow" target="_blank">如何使用Cornix Trading Bot </a></li><li id="5942" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated"><a class="ae mh" href="https://coincodecap.com/best-cryptocurrency-blogs" rel="noopener ugc nofollow" target="_blank">十大最佳加密货币博客</a> | <a class="ae mh" href="https://coincodecap.com/youhodler-review" rel="noopener ugc nofollow" target="_blank"> YouHodler评论</a></li><li id="c155" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated"><a class="ae mh" href="https://coincodecap.com/myconstant-review" rel="noopener ugc nofollow" target="_blank"> MyConstant Review </a> | <a class="ae mh" href="https://coincodecap.com/best-swing-trading-bots" rel="noopener ugc nofollow" target="_blank"> 8款最佳摇摆交易机器人</a></li><li id="b1e3" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated"><a class="ae mh" rel="noopener" href="/coinmonks/mxc-exchange-review-3af0ec1cba8c"> MXC交易所评论</a> | <a class="ae mh" href="https://coincodecap.com/pionex-vs-binance" rel="noopener ugc nofollow" target="_blank"> Pionex vs币安</a> | <a class="ae mh" href="https://coincodecap.com/pionex-arbitrage-bot" rel="noopener ugc nofollow" target="_blank"> Pionex套利机器人</a></li><li id="41fc" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated"><a class="ae mh" rel="noopener" href="/coinmonks/my-experience-with-crypto-copy-trading-d6feb2ce3ac5">我的加密副本交易经历</a> | <a class="ae mh" rel="noopener" href="/coinmonks/coinbase-review-6ef4e0f56064">比特币基地评论</a></li><li id="49d4" class="kq kr ht jw b jx kz ka la kd lb kh lc kl ld kp kv kw kx ky dt translated"><a class="ae mh" href="https://coincodecap.com/coinflex-review" rel="noopener ugc nofollow" target="_blank"> CoinFLEX评论</a> | <a class="ae mh" href="https://coincodecap.com/aex-exchange-review" rel="noopener ugc nofollow" target="_blank"> AEX交易所评论</a> | <a class="ae mh" href="https://coincodecap.com/upbit-review" rel="noopener ugc nofollow" target="_blank"> UPbit评论</a></li></ul></div></div>    
</body>
</html>