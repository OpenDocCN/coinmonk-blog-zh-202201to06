<html>
<head>
<title>Build a Flash Loan Arbitrage bot on Uniswap</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Uniswap上构建一个闪贷套利机器人</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/build-a-flash-loan-arbitrage-bot-on-uniswap-9f749ee20ab9?source=collection_archive---------0-----------------------#2022-06-23">https://medium.com/coinmonks/build-a-flash-loan-arbitrage-bot-on-uniswap-9f749ee20ab9?source=collection_archive---------0-----------------------#2022-06-23</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/37df9fa7d530107789742bce2ff1f1d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NuBfdtPERp9fdEdXvU1R6A.jpeg"/></div></div></figure><h2 id="096a" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated"><strong class="ak"> 0x01什么是套利？</strong></h2><p id="cd30" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated">套利交易与闪贷或区块链毫无关系。当同样的两种资产在两个不同的交易所有不同的交易价格时，就存在这样的套利交易。</p><p id="f565" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">例如，让我们看两个交易所:<a class="ae kz" href="https://coincodecap.com/uniswap" rel="noopener ugc nofollow" target="_blank"> Uniswap </a>、<a class="ae kz" href="https://coincodecap.com/how-to-swap-on-sushiswap" rel="noopener ugc nofollow" target="_blank"> Sushiswap </a>，它们运行相同的合同代码。虽然它们是两个不同的交易所，但是我们可以使用相同的代码来执行相同的交易。此外，由于Sushiswap是一个较新的交换平台，因此为其编写的机器人可能较少。</p><p id="6b43" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">套利的工作原理是这样的:一个乙醚在Unisawp中值80Dai，在Sushiswap中值100Dai。我们在Unisawp上购买1套，然后立即在Sushiswap上卖出，获利20天(减去汽油和费用)，这是典型的利润套利交易。</p><h2 id="958e" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated"><strong class="ak"> 0x02闪贷vs闪换</strong></h2><figure class="lb lc ld le fq iu fe ff paragraph-image"><div class="fe ff la"><img src="../Images/e813450ab4d4b65e7efd0f450708d443.png" data-original-src="https://miro.medium.com/v2/resize:fit:1272/0*7IbH1QOTqA6cTUtr"/></div></figure><p id="72c8" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">Aave协议上的闪贷收取0.09%的手续费，并且需要至少三次操作。1向Aave借钱；2.在Dex 3上交易。对另一个指数进行套利交易以实现利润，并偿还相同的资产。如果你借给戴，你需要偿还戴</p><p id="9036" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">快速掉期交易允许交易者在为所用资产付款之前，接收资产并在其他地方使用。Uniswap上的Flash掉期没有固定费用，但收取0.3%的掉期费。与快速贷款相比，这可以被视为“免费”贷款，</p><p id="9712" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">因为交易费是从交易订单中扣除的，不必单独支付。最后一个区别是:我们可以偿还flashswap中的任何资产。如果我们用这个来赎回ETH买戴，我们可以用戴或者ETH来偿还。都是用“乐观转移”。</p><blockquote class="lf lg lh"><p id="bd71" class="jz ka li kb b kc ku ke kf kg kv ki kj lj kw kl km lk kx ko kp ll ky kr ks kt hm dt translated"><em class="ht">交易新手？试试</em> <a class="ae kz" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a"> <em class="ht">密码交易机器人</em> </a> <em class="ht">或</em> <a class="ae kz" rel="noopener" href="/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c"> <em class="ht">复制交易</em> </a></p></blockquote><h2 id="f4b9" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated"><strong class="ak"> 0x03闪贷及合同</strong></h2><p id="a9c6" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated">要了解闪贷，你需要了解以太坊交易的本质。所有以太坊交易都源自一个外部拥有的账户(EOA)，这是一个人工操作的以太坊地址。</p><figure class="lb lc ld le fq iu fe ff paragraph-image"><div class="fe ff lm"><img src="../Images/b7b5b75cf3918e59fd72e9d7462b8de5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1378/0*fmmKeFX4DMBKsjbI"/></div></figure><p id="0cc8" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">以太坊交易可以从一个EOA转移到另一个，就像你向朋友付款一样。以太坊交易也可以从EOA到执行合同中的代码。那个合约可以调用另一个合约，以此类推，直到你用完交易费(气)。</p><h2 id="cbea" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">以太坊交易结构</h2><p id="72c0" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated"><strong class="kb hu"> From </strong>:交易发送方。它是一个20字节的地址，代表发起该交易的账户。</p><p id="6af3" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated"><strong class="kb hu">至</strong>:该笔交易的接收方。它也是一个20字节的地址。根据用途的不同，它可以是另一个EOA，一个合同帐户，或者只是空着。</p><p id="734f" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated"><strong class="kb hu"> Value </strong>:卫(1乙醚= 1⁰ ⁸卫)从“from”转入“to”的资金金额。如果“到”是一个EOA，它只是一个资金转移。如果“To”是合同地址，则它是传递给已部署合同的资金金额。合同被编码以便它能接受资金。</p><p id="e92c" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated"><strong class="kb hu">数据/输入</strong>:该数据字段主要用于与合同相关的活动。对于契约的新部署，它是字节码和编码的参数。对于契约函数的执行，它包含函数签名和编码的参数。在资金转移中为空。</p><p id="a274" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated"><strong class="kb hu">气价</strong>和<strong class="kb hu">气限</strong>:两者都与处理该交易的成本有关。矿工执行的交易的每个处理步骤都有一个预定义的气体单位(例如，从永久存储器获取数据的“sload”花费20个气体单位)。天然气价格是每单位天然气的价格(单位为魏)。这是交易发送者愿意支付的单价。燃气限额是本次交易中消耗的最大燃气单位。您的交易花费的最大气体单位不会超过气体限制，作为在交易处理中出现任何差异时的保护措施。</p><h2 id="c5d7" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated">三种类型的交易</h2><ul class=""><li id="ccea" class="ln lo ht kb b kc kd kg kh jm lp jq lq ju lr kt ls lt lu lv dt translated">EOA之间的资金转移</li><li id="6b00" class="ln lo ht kb b kc lw kg lx jm ly jq lz ju ma kt ls lt lu lv dt translated">在以太网上部署合同</li><li id="75d5" class="ln lo ht kb b kc lw kg lx jm ly jq lz ju ma kt ls lt lu lv dt translated">对已部署的合同执行功能</li></ul><p id="e1ec" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">快速贷款在执行过程中需要多次函数调用，这在EOA是不可能的。相反，我们将使用多步骤流程部署合同。我们发起从EOA到Aave合约的交易以进行套利，但我们提供了部署合约的地址，还需要提供足够的ETH来覆盖交易的天然气成本，由于交易的复杂性，这可能非常昂贵(记住，交易取决于需要多少计算)。</p><h2 id="d2d4" class="jb jc ht bd jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy dt translated"><strong class="ak"> 0x04 OP传输</strong></h2><p id="85d9" class="pw-post-body-paragraph jz ka ht kb b kc kd ke kf kg kh ki kj jm kk kl km jq kn ko kp ju kq kr ks kt hm dt translated">闪贷和闪换都使用“OP转移”技术，可用于无担保贷款或交换。只要用户在交易结束前偿还所需资金。</p><figure class="lb lc ld le fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mb"><img src="../Images/c80f1080bf4050441c56d2fb46293315.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9MbKai7OH1YTBPswocb1jw.png"/></div></div></figure><p id="0ed0" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">在第884行，用户契约已经执行完它的代码，现在事务流返回到Aave契约，它在代码中有一个<strong class="kb hu"> <em class="li"> require </em> </strong>语句，从支票中提取用户契约的费用。乐观转移到此结束。如果用户合约确实完成了这个套利交易，那么Aave合约就能够扣除费用。如果没有完成，这条<strong class="kb hu"> <em class="li">要求</em> </strong>语句将会失败，这意味着整个交易将会失败。</p><figure class="lb lc ld le fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff mb"><img src="../Images/b5145a5da32424d82a71cd0364c41e91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CNL8f6ROE2t1lUt8RU4n1A.png"/></div></div></figure><p id="8379" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">乐观传输发生在第170–171行，由<strong class="kb hu"> _safeTransfer函数</strong>完成。下一行是Uniswap合约，使用转账余额调用用户合约(即Flash Swap)</p><p id="a085" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">同样，交易流将在Uniswap合同上暂时挂起，并转移到用户合同上执行。一旦在用户合同上执行，交易流将返回到Uniswap合同。然后，Uniswap合同检查新的余额，并试图获得掉期费用(180–181)</p><p id="1702" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">如果用户套利合约未能转账相应金额，182行的<strong class="kb hu"> <em class="li">要求</em> </strong>语句失败，整个交易恢复。这是OP转移的关键。全靠用户合约套利交易在交易前转移相应资金。如果不成功，则交易无效，将恢复到令牌转移前的状态。但是，如果成功，乐观转移仍然存在，用户获得他们的利润。</p><p id="c0dd" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated">ref:<a class="ae kz" href="https://docs.uniswap.org/" rel="noopener ugc nofollow" target="_blank"><strong class="kb hu">https://docs.uniswap.org/</strong></a></p><p id="11ee" class="pw-post-body-paragraph jz ka ht kb b kc ku ke kf kg kv ki kj jm kw kl km jq kx ko kp ju ky kr ks kt hm dt translated"><a class="ae kz" href="https://aave.com/flash-loans/" rel="noopener ugc nofollow" target="_blank"><strong class="kb hu">https://aave.com/flash-loans/</strong></a></p><div class="mc md fm fo me mf"><a href="https://github.com/aave/aave-protocol/blob/master/contracts/lendingpool/LendingPool.sol#L843" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab ej"><div class="mh ab mi cl cj mj"><h2 class="bd hu fv z el mk eo ep ml er et hs dt translated">aave-protocol/lending pool . sol at master aave/aave-protocol</h2><div class="mm l"><h3 class="bd b fv z el mk eo ep ml er et ek translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="mn l"><p class="bd b gc z el mk eo ep ml er et ek translated">github.com</p></div></div><div class="mo l"><div class="mp l mq mr ms mo mt iz mf"/></div></div></a></div><blockquote class="mu"><p id="4e3f" class="mv mw ht bd mx my mz na nb nc nd kt ek translated">加入Coinmonks <a class="ae kz" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae kz" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h1 id="5a28" class="ne jc ht bd jd nf ng nh jh ni nj nk jl nl nm nn jp no np nq jt nr ns nt jx nu dt translated">另外，阅读</h1><ul class=""><li id="ae51" class="ln lo ht kb b kc kd kg kh jm lp jq lq ju lr kt ls lt lu lv dt translated"><a class="ae kz" rel="noopener" href="/coinmonks/wazirx-vs-coindcx-vs-bitbns-149f4f19a2f1">WazirX vs coin dcx vs bit bns</a>|<a class="ae kz" rel="noopener" href="/coinmonks/blockfi-vs-coinloan-vs-nexo-cb624635230d">block fi vs coin loan vs Nexo</a></li><li id="23ed" class="ln lo ht kb b kc lw kg lx jm ly jq lz ju ma kt ls lt lu lv dt translated"><a class="ae kz" rel="noopener" href="/coinmonks/localbitcoins-review-6cc001c6ed56">本地比特币评论</a> | <a class="ae kz" href="https://coincodecap.com/cryptocurrency-savings-accounts" rel="noopener ugc nofollow" target="_blank">加密货币储蓄账户</a></li><li id="e688" class="ln lo ht kb b kc lw kg lx jm ly jq lz ju ma kt ls lt lu lv dt translated">什么是融资融券交易</li><li id="f4e3" class="ln lo ht kb b kc lw kg lx jm ly jq lz ju ma kt ls lt lu lv dt translated"><a class="ae kz" href="https://coincodecap.com/uphold-card-review" rel="noopener ugc nofollow" target="_blank">维护卡审核</a> | <a class="ae kz" href="https://coincodecap.com/trust-wallet-vs-metamask" rel="noopener ugc nofollow" target="_blank">信任钱包vs元掩码</a></li><li id="4504" class="ln lo ht kb b kc lw kg lx jm ly jq lz ju ma kt ls lt lu lv dt translated"><a class="ae kz" href="https://coincodecap.com/exness-review" rel="noopener ugc nofollow" target="_blank"> Exness回顾</a>|<a class="ae kz" href="https://coincodecap.com/bingbon-vs-bitget-vs-moonxbt" rel="noopener ugc nofollow" target="_blank">moon xbt Vs bit get Vs Bingbon</a></li><li id="8787" class="ln lo ht kb b kc lw kg lx jm ly jq lz ju ma kt ls lt lu lv dt translated"><a class="ae kz" href="https://coincodecap.com/passive-income-crypto-lending" rel="noopener ugc nofollow" target="_blank">如何开始用加密贷款赚取被动收入</a></li></ul></div></div>    
</body>
</html>