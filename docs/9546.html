<html>
<head>
<title>XCarnival Attack Analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">XCarnival攻击分析</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/xcarnival-attack-analysis-1e5722f03a09?source=collection_archive---------6-----------------------#2022-06-29">https://medium.com/coinmonks/xcarnival-attack-analysis-1e5722f03a09?source=collection_archive---------6-----------------------#2022-06-29</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div class="fe ff iq"><img src="../Images/d980cf07f23e7e7661268b9cef935480.png" data-original-src="https://miro.medium.com/v2/resize:fit:1188/format:webp/1*igTcBsO-TL9sRuyQpNFnHQ.png"/></div></figure><p id="c1fb" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">2022年6月26日，NFT借贷协议XCarnival被黑，黑客获利3087 ETH。</p><p id="ecca" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated"><strong class="iz hu"> 0x01攻击信息</strong></p><p id="a6b6" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">攻击者地址</p><p id="053d" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">0 xb7 CB B4 d 43 f1 e 08327 a 90 b 32 a 8417688 c 9 d0b 800 a</p><p id="2b4e" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">攻击者合同</p><p id="979c" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">0 xf 70 f 691d 30 ce 23786 CFB 3a 1522 CFD 76d 159 ACA 8d</p><p id="2b2d" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">0x 3 EDF 976 df 38 f7d 6273884 b 4066 e 3689 ef 547d 816</p><p id="0741" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">0x7b 5a 2f 7 CD 1c C4 ee f1 a 75d 473 e 1210509 c 55265d 8</p><p id="254a" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">0x 234 E4 b5 FEC 50646 D1 d 4868331 f 29368 fa 9286238</p><p id="d459" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">正式合同</p><p id="a3ae" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">xto ken 0x 5417 da 20 AC 8157 DD 5c 07230 CFC C2 b 226 FD CFC 5663</p><p id="66bc" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">XNFT 0x 39360 AC 1239 a0b 98 CB 8076d 4135 d0f 72 b 7 FD 9909</p><p id="3d45" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">P2Controller 0x 34 ca 24 ddcdaf 00105 a3 BF 10 ba 5a AE 67953178 b 85</p><p id="1c8d" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated"><strong class="iz hu"> 0x02攻击步骤</strong></p><p id="28e7" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">1)通过混币平台Tornado.Cash共获得120 ETH。</p><figure class="jw jx jy jz fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="fe ff jv"><img src="../Images/99064380bd608731987a90dc64106c83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n6cljpYv7BB5heT8chtyPg.png"/></div></div></figure><p id="a6c7" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">2)使用87 ETH购买ID为5110的BAYC。</p><figure class="jw jx jy jz fq iu fe ff paragraph-image"><div class="fe ff ke"><img src="../Images/b353a6ff5839bd73aa8279ccdd9d4d15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/1*iR2lwL64G3OLUCJFz16wnA.png"/></div></figure><p id="0cfd" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">3)部署攻击契约，将5110 BAYC转移到攻击契约。这里我们以攻击契约<strong class="iz hu">0x7b 5a 2f 7 CD 1 C4 ee f1 a 75d 473 e 1210509 c 55265d 8</strong>为例:</p><figure class="jw jx jy jz fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="fe ff kf"><img src="../Images/d0898b0c67bb3a90b3eee0d4244fdfcd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2pG506oiSuQGTynHG9ojWA.png"/></div></div></figure><p id="befc" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">4)进行NFT入股和贷款，调用<strong class="iz hu">xnft . graceandborrow</strong>方法。</p><figure class="jw jx jy jz fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="fe ff kg"><img src="../Images/0ec0d0b4ca9b881853c85b8f8415044e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wZ4ZJJMcq3DDz1_90zIJyA.png"/></div></div></figure><figure class="jw jx jy jz fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="fe ff kh"><img src="../Images/4d8279acb25a70e5330fcb99365119f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h5XuNgAqUdyGLJ-6YD5M0Q.png"/></div></div></figure><p id="5aa7" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">攻击者在下注NFT后没有借到资金，然后通过<strong class="iz hu"> XNFT.withdrawNFT </strong>取出NFT。</p><p id="f9af" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">在一次交易中，为了增加与攻击者控制的地址相对应的<strong class="iz hu"> orderId </strong>的数量，执行多次赌注、贷款和NFT提款操作。</p><figure class="jw jx jy jz fq iu fe ff paragraph-image"><div class="fe ff ki"><img src="../Images/eb6896baac6cd4dcf938127b8d706b62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3tuOUWw7t1bJBfpji8zF9Q.png"/></div></figure><p id="8650" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">5)攻击者借用之前已经被staked的orderId，逐个借用上一步生成的orderId。</p><figure class="jw jx jy jz fq iu fe ff paragraph-image"><div class="fe ff kj"><img src="../Images/71a3f3f8e4aa910c91048505a428791e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/format:webp/1*yagWOyP1tpuDrsbYwu3IdA.png"/></div></figure><p id="b9a4" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">6)攻击者将获利资金转移到钱包地址。</p><p id="1e3a" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated"><strong class="iz hu"> 0x03主要漏洞</strong></p><p id="e410" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">攻击者通过多次股权借贷和NFT提款操作增加攻击者相关地址和orderId的对应关系，然后调用Xtoken契约进行借贷。由于借款人检查的是攻击者staked的订单id地址，因此攻击者可以使用多次调用借款，并传入之前的订单id来获得大量借款。</p><figure class="jw jx jy jz fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="fe ff kk"><img src="../Images/ce790a5f75df4ff287925e1f66a9d24c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8hE2TAeYmbMwWnDUXTII-w.png"/></div></div></figure><p id="73ce" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated"><strong class="iz hu">攻击流程如下</strong></p><figure class="jw jx jy jz fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="fe ff kl"><img src="../Images/6c6db7b08be61aa6fad3713891439fdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O6Y8j6eWhcdRusc8Wl2ADg.png"/></div></div></figure><p id="60e5" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated"><strong class="iz hu"> 0x04总结和建议</strong></p><p id="b28b" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">根据这种攻击，攻击者主要通过多次跑马圈地贷款和提取NFT获得大量与自己地址对应的订单id，然后通过多次调用借款方法提取大量资金。时间受到严格限制，因此攻击者可以多次<strong class="iz hu">点击farming </strong>来增加下注订单的数量。之后，在Xtoken契约中，只使用订单id来确定是否可以借款，这样攻击者就可以在完成跑马圈地订单后进行多次借款操作。</p><p id="260d" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated"><strong class="iz hu"> 0x05安全建议</strong></p><p id="e523" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">建议严格限制NFT跑马圈地时间，确保不能瞬间撤回；</p><p id="3574" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">建议严格限制NFT跑马时间对领取奖励的影响；</p><p id="b18a" class="pw-post-body-paragraph ix iy ht iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hm dt translated">建议在跑马圈地后借款时检查是否满足多个条件</p><blockquote class="km"><p id="03d2" class="kn ko ht bd kp kq kr ks kt ku kv ju ek translated">加入Coinmonks <a class="ae kw" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae kw" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h1 id="5db3" class="kx ky ht bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu dt translated">另外，阅读</h1><ul class=""><li id="2d31" class="lv lw ht iz b ja lx je ly ji lz jm ma jq mb ju mc md me mf dt translated"><a class="ae kw" href="https://coincodecap.com/what-are-decentralized-exchanges" rel="noopener ugc nofollow" target="_blank">分散交易所</a> | <a class="ae kw" href="https://coincodecap.com/bitbns-fip" rel="noopener ugc nofollow" target="_blank">比特FIP </a> | <a class="ae kw" href="https://coincodecap.com/pionex-review-exchange-with-crypto-trading-bot" rel="noopener ugc nofollow" target="_blank"> Pionex评论</a></li><li id="ec79" class="lv lw ht iz b ja mg je mh ji mi jm mj jq mk ju mc md me mf dt translated"><a class="ae kw" href="https://coincodecap.com/buy-crypto-with-credit-card" rel="noopener ugc nofollow" target="_blank">用信用卡购买密码的10个最佳地点</a></li><li id="b830" class="lv lw ht iz b ja mg je mh ji mi jm mj jq mk ju mc md me mf dt translated"><a class="ae kw" href="https://coincodecap.com/best-cardano-wallets" rel="noopener ugc nofollow" target="_blank">最佳卡达诺钱包</a> | <a class="ae kw" href="https://coincodecap.com/bingbon-copy-trading" rel="noopener ugc nofollow" target="_blank"> Bingbon副本交易</a></li><li id="74c6" class="lv lw ht iz b ja mg je mh ji mi jm mj jq mk ju mc md me mf dt translated"><a class="ae kw" href="https://coincodecap.com/how-to-add-arbitrum-to-metamask-wallet" rel="noopener ugc nofollow" target="_blank">如何给MetaMask钱包添加Arbitrum？</a></li><li id="5c84" class="lv lw ht iz b ja mg je mh ji mi jm mj jq mk ju mc md me mf dt translated"><a class="ae kw" href="https://coincodecap.com/kucoin-vs-kraken-vs-bityard" rel="noopener ugc nofollow" target="_blank"> KuCoin vs北海巨妖vs BitYard </a></li><li id="1a51" class="lv lw ht iz b ja mg je mh ji mi jm mj jq mk ju mc md me mf dt translated"><a class="ae kw" href="https://coincodecap.com/best-vpns-for-crypto-trading" rel="noopener ugc nofollow" target="_blank">加密交易的最佳VPN</a></li></ul></div></div>    
</body>
</html>