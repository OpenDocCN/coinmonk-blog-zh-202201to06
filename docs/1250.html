<html>
<head>
<title>Split Contracts Using P2CH</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用P2CH拆分合同</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/split-contracts-using-p2ch-84b44199bdab?source=collection_archive---------11-----------------------#2022-02-26">https://medium.com/coinmonks/split-contracts-using-p2ch-84b44199bdab?source=collection_archive---------11-----------------------#2022-02-26</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="9e6d" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">如何停止担心sCrypt中的大循环</h2></div><p id="d847" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我们提出了一种优化技术，将一个大合同分割成多个较小的合同，以在保持正确性的同时大幅减少其大小。我们演示了它如何在具有大型循环和许多公共函数的契约中工作。</p><h1 id="9edc" class="ke kf ht bd kg kh ki kj kk kl km kn ko iz kp ja kq jc kr jd ks jf kt jg ku kv dt translated">环</h1><p id="0a36" class="pw-post-body-paragraph ji jj ht jk b jl kw iu jn jo kx ix jq jr ky jt ju jv kz jx jy jz la kb kc kd hm dt translated"><a class="ae lb" href="https://scryptdoc.readthedocs.io/en/latest/loop.html" rel="noopener ugc nofollow" target="_blank">循环</a>在sCrypt中采用以下格式:</p><figure class="lc ld le lf fq lg"><div class="bz el l di"><div class="lh li l"/></div></figure><p id="3a26" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">因为循环是静态展开的，所以最大循环计数<strong class="jk hu"> maxLoopCount </strong>必须在编译时知道。如果设置过小，合约可能无法解锁成功，资金被永久烧毁。因此，它是为最坏的情况保守设置的，当最常用的循环数明显小于最坏的情况时，通常会导致脚本过度膨胀。</p><p id="e79c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我们在最后一篇文章的<a class="ae lb" rel="noopener" href="/coinmonks/the-partial-preimage-technique-b60498c47ba">中展示了如何使用契约支付哈希(P2CH)来减少契约<strong class="jk hu">中的循环数<em class="lj">increment locktime</em>T7】在最普遍的情况下，同时在需要最大循环数时保持契约工作。</strong></a></p><p id="bbca" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">如下图所示，我们将函数<strong class="jk hu"><em class="lj">partialsha 256()</em></strong>移动到一个单独的契约<strong class="jk hu"><em class="lj">partialsha 256</em></strong>。循环中的每次迭代处理SHA256的原映像中的一个块。我们使用P2CH <em class="lj">从主契约<strong class="jk hu"><em class="lj">IncrementLocktimeSplit</em></strong><em class="lj"/>中调用该函数。</em></p><figure class="lc ld le lf fq lg fe ff paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="fe ff lk"><img src="../Images/0945162c28887bdc423b6a8cf777d90b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*70n0tXeGPzuX0GS4Ireoyg.png"/></div></div><figcaption class="lr ls fg fe ff lt lu bd b be z ek">Inter-Contract Call using P2CH</figcaption></figure><figure class="lc ld le lf fq lg"><div class="bz el l di"><div class="lh li l"/></div><figcaption class="lr ls fg fe ff lt lu bd b be z ek">Contract <a class="ae lb" href="https://github.com/sCrypt-Inc/boilerplate/blob/master/contracts/incrementLocktimeSplit.scrypt" rel="noopener ugc nofollow" target="_blank"><em class="lv">IncrementLocktimeSplit</em></a></figcaption></figure><p id="be82" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated"><strong class="jk hu"><em class="lj">IncrementLocktimeSplit</em></strong>与契约<a class="ae lb" href="https://github.com/sCrypt-Inc/boilerplate/blob/master/contracts/incrementLocktime.scrypt" rel="noopener ugc nofollow" target="_blank"><strong class="jk hu"><em class="lj">IncrementLocktime</em></strong></a>相同，只是从第15行到第30行删除了<strong class="jk hu"><em class="lj">partialsha 256()</em></strong>并使用P2CH间接调用。</p><p id="c928" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">数组<strong class="jk hu"> <em class="lj">中的每个元素calleecontracthasses</em></strong>都是契约<strong class="jk hu"><em class="lj">partialsha 256</em></strong>的散列，具有不同的<em class="lj"> MAX_CHUNKS </em>。因此，该数组包含主契约支持的所有<em class="lj"> MAX_CHUNKS </em>。</p><p id="4ea8" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">Contract<em class="lj"/><strong class="jk hu"><em class="lj">partialsha 256</em></strong><em class="lj"/>computes<em class="lj"/><strong class="jk hu"><em class="lj">partialsha 256()</em></strong>(与原Contract<strong class="jk hu"><em class="lj">IncrementLocktime</em></strong>中的函数相同)并将函数调用参数和结果值存储在输出中，该输出由Contract<strong class="jk hu"><em class="lj">IncrementLocktimeSplit</em></strong><em class="lj"/>访问</p><figure class="lc ld le lf fq lg"><div class="bz el l di"><div class="lh li l"/></div><figcaption class="lr ls fg fe ff lt lu bd b be z ek"><a class="ae lb" href="https://github.com/sCrypt-Inc/boilerplate/blob/master/contracts/partialSha256.scrypt" rel="noopener ugc nofollow" target="_blank">Contract <em class="lv">PartialSha256</em></a></figcaption></figure><p id="d395" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">相比<strong class="jk hu"><em class="lj">IncrementLocktime</em></strong><em class="lj"/><strong class="jk hu"><em class="lj">IncrementLocktimeSplit</em></strong>要小很多。它可以根据待哈希数据的长度动态调用<strong class="jk hu"><em class="lj">partialsha 256()</em></strong>，即<em class="lj"> MAX_CHUNKS </em>。在大多数情况下，我们只需要<em class="lj"> MAX_CHUNKS </em>为1。在极少数情况下，锁时间被分割到最后两个块，我们使用2的MAX_CHUNKS。这带来了显著的节约，因为每个额外的块都会给最终的脚本增加<strong class="jk hu"> ~60KB </strong>。</p><h1 id="666c" class="ke kf ht bd kg kh ki kj kk kl km kn ko iz kp ja kq jc kr jd ks jf kt jg ku kv dt translated">多重公共功能</h1><figure class="lc ld le lf fq lg"><div class="bz el l di"><div class="lh li l"/></div><figcaption class="lr ls fg fe ff lt lu bd b be z ek">Original Contract</figcaption></figure><p id="3e2f" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">我们可以将一个包含多个公共函数的契约分解成多个更小的契约，每个契约只包含一个公共函数。我们用一个新的主契约替换原来的契约，这个新的主契约可以使用上一节中的相同技术调用任何较小的契约。</p><figure class="lc ld le lf fq lg"><div class="bz el l di"><div class="lh li l"/></div><figcaption class="lr ls fg fe ff lt lu bd b be z ek">Main Contract after Splitting</figcaption></figure><figure class="lc ld le lf fq lg fe ff paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="fe ff lw"><img src="../Images/ba48d6ac91e729b50dba0f516a6c5928.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HiBNuHWGxIplAm9pXobdsg.png"/></div></div><figcaption class="lr ls fg fe ff lt lu bd b be z ek">Main Contract Calling BranchA</figcaption></figure><p id="f832" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">当每个公共函数都很大并且有很多公共函数时，这种规模缩减最为突出。</p><p id="3e35" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">除了减小大小之外，这种优化还允许同一契约的其他输入中的契约识别在当前主契约中调用了哪个公共函数，否则由于无法访问OP_PUSH_TX中的解锁脚本而无法识别该公共函数。这可以通过注入较小的合同事务来访问，例如<em class="lj"> tx1 </em>。</p><h1 id="1370" class="ke kf ht bd kg kh ki kj kk kl km kn ko iz kp ja kq jc kr jd ks jf kt jg ku kv dt translated">讨论</h1><p id="e394" class="pw-post-body-paragraph ji jj ht jk b jl kw iu jn jo kx ix jq jr ky jt ju jv kz jx jy jz la kb kc kd hm dt translated">我们已经说明了如何通过将大型合同分解成多个较小的合同来减少其规模。示例合同是一次性的、无状态的。对于有状态契约来说，减少会更显著，因为有状态契约会被连续调用，并且节省会被累积。</p><p id="7b13" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">使用许多公共函数优化契约的另一种方法是使用<a class="ae lb" href="https://xiaohuiliu.medium.com/merkelized-abstract-syntax-tree-6a49b2008435" rel="noopener"> Merklized抽象语法树</a>。</p><h1 id="34b1" class="ke kf ht bd kg kh ki kj kk kl km kn ko iz kp ja kq jc kr jd ks jf kt jg ku kv dt translated">承认</h1><p id="37d5" class="pw-post-body-paragraph ji jj ht jk b jl kw iu jn jo kx ix jq jr ky jt ju jv kz jx jy jz la kb kc kd hm dt translated">这个想法源于<a class="ae lb" href="https://sensiblecontract.org/" rel="noopener ugc nofollow" target="_blank">感性契约</a>，在生产中广泛使用。</p><blockquote class="lx"><p id="1b50" class="ly lz ht bd ma mb mc md me mf mg kd ek translated">加入Coinmonks <a class="ae lb" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae lb" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h1 id="307b" class="ke kf ht bd kg kh ki kj kk kl km kn ko iz mh ja kq jc mi jd ks jf mj jg ku kv dt translated">另外，阅读</h1><ul class=""><li id="e952" class="mk ml ht jk b jl kw jo kx jr mm jv mn jz mo kd mp mq mr ms dt translated"><a class="ae lb" rel="noopener" href="/coinmonks/botsfolio-vs-napbots-vs-mudrex-c81344970c02">Botsfolio vs nap bots vs Mudrex</a>|<a class="ae lb" rel="noopener" href="/coinmonks/gate-io-exchange-review-61bf87b7078f">gate . io交流回顾</a></li><li id="23fb" class="mk ml ht jk b jl mt jo mu jr mv jv mw jz mx kd mp mq mr ms dt translated"><a class="ae lb" href="https://coincodecap.com/coinflex-review" rel="noopener ugc nofollow" target="_blank"> CoinFLEX评论</a> | <a class="ae lb" href="https://coincodecap.com/aex-exchange-review" rel="noopener ugc nofollow" target="_blank"> AEX交易所评论</a> | <a class="ae lb" href="https://coincodecap.com/upbit-review" rel="noopener ugc nofollow" target="_blank"> UPbit评论</a></li><li id="0e0a" class="mk ml ht jk b jl mt jo mu jr mv jv mw jz mx kd mp mq mr ms dt translated"><a class="ae lb" href="https://coincodecap.com/ascendex-margin-trading" rel="noopener ugc nofollow" target="_blank"> AscendEx保证金交易</a> | <a class="ae lb" href="https://coincodecap.com/bitfinex-staking" rel="noopener ugc nofollow" target="_blank"> Bitfinex赌注</a> | <a class="ae lb" href="https://coincodecap.com/bitflyer-review" rel="noopener ugc nofollow" target="_blank"> bitFlyer审核</a></li><li id="6e4b" class="mk ml ht jk b jl mt jo mu jr mv jv mw jz mx kd mp mq mr ms dt translated"><a class="ae lb" href="https://coincodecap.com/bitget-review" rel="noopener ugc nofollow" target="_blank"> Bitget评论</a> | <a class="ae lb" href="https://coincodecap.com/gemini-vs-blockfi" rel="noopener ugc nofollow" target="_blank">双子星vs BlockFi </a> cmd| <a class="ae lb" href="https://coincodecap.com/okex-futures-trading" rel="noopener ugc nofollow" target="_blank"> OKEx期货交易</a></li><li id="ec6a" class="mk ml ht jk b jl mt jo mu jr mv jv mw jz mx kd mp mq mr ms dt translated"><a class="ae lb" href="https://coincodecap.com/ascendex-staking" rel="noopener ugc nofollow" target="_blank">AscendEx Staking</a>|<a class="ae lb" href="https://coincodecap.com/bot-ocean-review" rel="noopener ugc nofollow" target="_blank">Bot Ocean Review</a>|<a class="ae lb" href="https://coincodecap.com/bitcoin-wallets-india" rel="noopener ugc nofollow" target="_blank">最佳比特币钱包</a></li><li id="72b0" class="mk ml ht jk b jl mt jo mu jr mv jv mw jz mx kd mp mq mr ms dt translated"><a class="ae lb" href="https://coincodecap.com/huobi-review" rel="noopener ugc nofollow" target="_blank">霍比审核</a> | <a class="ae lb" href="https://coincodecap.com/okex-margin-trading" rel="noopener ugc nofollow" target="_blank"> OKEx保证金交易</a> | <a class="ae lb" href="https://coincodecap.com/futures-trading" rel="noopener ugc nofollow" target="_blank">期货交易</a></li><li id="6b0f" class="mk ml ht jk b jl mt jo mu jr mv jv mw jz mx kd mp mq mr ms dt translated"><a class="ae lb" href="https://coincodecap.com/grid-trading" rel="noopener ugc nofollow" target="_blank">网格交易机器人</a> | <a class="ae lb" rel="noopener" href="/coinmonks/cryptohopper-review-a388ff5bae88"> Cryptohopper审查</a> | <a class="ae lb" href="https://coincodecap.com/bexplus-review" rel="noopener ugc nofollow" target="_blank"> Bexplus审查</a></li><li id="cf82" class="mk ml ht jk b jl mt jo mu jr mv jv mw jz mx kd mp mq mr ms dt translated"><a class="ae lb" href="https://coincodecap.com/zero-fee-crypto-exchanges" rel="noopener ugc nofollow" target="_blank"> 7个最佳零费用加密交换平台</a></li><li id="e71d" class="mk ml ht jk b jl mt jo mu jr mv jv mw jz mx kd mp mq mr ms dt translated"><a class="ae lb" href="https://coincodecap.com/anny-trade-review" rel="noopener ugc nofollow" target="_blank">氹欞侊贸易评论</a> | <a class="ae lb" rel="noopener" href="/coinmonks/huobi-margin-trading-b3b06cdc1519">火币保证金交易</a></li></ul></div></div>    
</body>
</html>