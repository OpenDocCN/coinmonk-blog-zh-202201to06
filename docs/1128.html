<html>
<head>
<title>Mystery Camp Lab #1: Smart contract deployment &amp; mint fees</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">神秘营地实验室#1:智能合同部署和造币费</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/mystery-camp-lab-1-smart-contract-deployment-mint-fees-526dcc12904?source=collection_archive---------19-----------------------#2022-02-24">https://medium.com/coinmonks/mystery-camp-lab-1-smart-contract-deployment-mint-fees-526dcc12904?source=collection_archive---------19-----------------------#2022-02-24</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="a66f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">神秘营地是一个涉及区块链技术的新项目。我们正在发布我们的第一个NFT系列，我们计划做得更多，特别是支持动物收容所和分享我们的技术研究。欢迎阅读本系列的第一篇文章！</p><p id="de82" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在设计我们的dApp所依赖的智能合同时，节约成本绝对是我们关心的事情。首先，部署是我们希望降低的一项重要成本。与我们合同的交互(尤其是NFT薄荷糖)也应该尽可能便宜，这样我们的用户就不会在汽油上花太多钱。</p><p id="e697" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">从构思<a class="ae jo" href="https://mystery.camp" rel="noopener ugc nofollow" target="_blank">神秘营地</a>的第一天起，我们发现分析交易所需的气体并尽可能优化它是绝对重要的。这篇文章是这一分析的顶级亮点。</p><h1 id="75fc" class="jp jq ht bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">气体优化通常</h1><p id="cf4f" class="pw-post-body-paragraph iq ir ht is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hm dt translated">任何以太坊交易的费用(ETH)都是<em class="ks">气</em>和<em class="ks">气价格</em>的乘积。第一个因素是交易发生所需的“气体单位”数量。这是我们可以很容易预测的——在开发期间，我们可以在测试网或本地链上运行我们的事务，以查看我们需要多少个单元来实现特定的功能。</p><p id="109e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">汽油价格是更不可预测的因素。例如，2021年8月23日的价格约为67千兆瓦，15天后约为213千兆瓦。它也在一天内波动。自ERC1559以来，<em class="ks"> gasPrice </em>由“基本费用”(链条上可用的价值)和“优先费用”(给矿工的小费)组成。</p><p id="a115" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">因此，一般来说，为了优化合同部署/交互的成本，我们需要考虑:</p><ul class=""><li id="649f" class="kt ku ht is b it iu ix iy jb kv jf kw jj kx jn ky kz la lb dt translated">通过消除昂贵的操作(尤其是写入存储)，降低部署/交互所需的gas单元。</li><li id="5a81" class="kt ku ht is b it lc ix ld jb le jf lf jj lg jn ky kz la lb dt translated">观察<em class="ks">油价</em>并在足够低时执行交易。</li><li id="bdec" class="kt ku ht is b it lc ix ld jb le jf lf jj lg jn ky kz la lb dt translated">如果你用美元思考——ETH/USD汇率可能也会让你感兴趣。</li></ul><p id="580c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">当然，这是一个简单的方法。还有许多更复杂的减少气体的技术(例如<a class="ae jo" rel="noopener" href="/coinmonks/on-efficient-ethereum-storage-c76869591add">这个</a>真的很有趣)。</p><h1 id="22d4" class="jp jq ht bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">东帝汶的网络域名代号</h1><p id="7708" class="pw-post-body-paragraph iq ir ht is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hm dt translated">让我们定义一个有用的单位，我们称之为<strong class="is hu"> TP(转移价格)。</strong>且让它只是21000单位气体的价格(常规乙醚转移所需)。在<strong class="is hu"> TP </strong>中思考极其得心应手。它的美元价值可以在的交易所找到。此外，当写这篇文章时，它在10美元以下，这也便于阅读数字。</p><p id="2ddb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">看看从2022年1月30日左右开始的7天内的TP美元价格图(21000 *<em class="ks">gas price</em>* eth/USD rate ):</p><figure class="li lj lk ll fq lm fe ff paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="fe ff lh"><img src="../Images/34b6b4ad1d68c9221ca40ec458b93c54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fhR9JG3s3K7IWB5oD2rwbQ.png"/></div></div><figcaption class="lt lu fg fe ff lv lw bd b be z ek">Source: lab.mystery.camp</figcaption></figure><p id="330a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们已经可以看到一些模式，可以作为进一步分析的良好起点！</p><h1 id="7ecc" class="jp jq ht bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">部署价格</h1><p id="63fa" class="pw-post-body-paragraph iq ir ht is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hm dt translated">在<a class="ae jo" href="https://ethereum.github.io/yellowpaper/paper.pdf" rel="noopener ugc nofollow" target="_blank">以太坊黄皮书</a>中描述了每件作品的确切价格(以气体单位计算)。从那里提取每一个细节有点挑战性，这就是为什么我只展示几个实验的结果。</p><p id="1ff2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">请注意，我所列出的数字只是在测试网上运行事务的结果，它们应该被当作例子。如果您想知道在不同的用例中您的交易将花费多少，请记住仔细测试您的智能合约。这里我将列出几笔交易的气单位、TP和以美元为单位的价格(在撰写本文时，TP仅为<strong class="is hu">【4.17美元</strong> ) <strong class="is hu"> </strong>。</p><p id="991f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">合同部署总是需要至少53000单位的气体(在<a class="ae jo" href="https://ethereum.github.io/yellowpaper/paper.pdf" rel="noopener ugc nofollow" target="_blank">以太坊黄皮书</a>中的<em class="ks">交易费&amp; Ccreate — </em>详情)。此外，你为每一个编码数据支付200英镑，还有一些很难列出的小费用。</p><ul class=""><li id="9c0b" class="kt ku ht is b it iu ix iy jb kv jf kw jj kx jn ky kz la lb dt translated">空合约(空交易数据)— 53000 <strong class="is hu"> (2.52 TP)，10.50美元</strong></li><li id="104c" class="kt ku ht is b it lc ix ld jb le jf lf jj lg jn ky kz la lb dt translated"><a class="ae jo" href="https://rinkeby.etherscan.io/address/0xCbc7156Cf2b329209C5671e16987393482E5b7FC#code" rel="noopener ugc nofollow" target="_blank">最低合约</a> — 67054 <strong class="is hu"> (3.19 TP)，13.30美元</strong></li><li id="6b6a" class="kt ku ht is b it lc ix ld jb le jf lf jj lg jn ky kz la lb dt translated"><a class="ae jo" href="https://rinkeby.etherscan.io/address/0x67B229ee6193397A14aa30E931B8CB2ef3ec15C6#code" rel="noopener ugc nofollow" target="_blank">基础模板</a> — 144819 <strong class="is hu"> (6.89 TP)，28.73美元</strong></li><li id="afb0" class="kt ku ht is b it lc ix ld jb le jf lf jj lg jn ky kz la lb dt translated"><a class="ae jo" href="https://rinkeby.etherscan.io/address/0xE3d21B6c84A7B8E167991e527493671d862cB48d" rel="noopener ugc nofollow" target="_blank"> OpenZeppelin 4.3.2 ERC20模板</a> —547467 <strong class="is hu"> (26.06TP)，108.71美元</strong></li><li id="18ef" class="kt ku ht is b it lc ix ld jb le jf lf jj lg jn ky kz la lb dt translated"><a class="ae jo" href="https://rinkeby.etherscan.io/address/0xc6dc9E625bB114C34983A51Be37DaB19eE6aF02f" rel="noopener ugc nofollow" target="_blank"> OpenZeppelin 4.3.2 ERC721模板</a> —1069805 <strong class="is hu"> (50.94TP)，212.41美元</strong></li><li id="91a2" class="kt ku ht is b it lc ix ld jb le jf lf jj lg jn ky kz la lb dt translated"><a class="ae jo" href="https://rinkeby.etherscan.io/address/0xD513a3e908fB952cD9E69bdBa73aeBbd82F8295E" rel="noopener ugc nofollow" target="_blank"> OpenZeppelin 4.3.2 ERC1155模板</a> —1146547 <strong class="is hu"> (54.59TP)，227，67美元</strong></li></ul><h1 id="e96a" class="jp jq ht bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">互动价格</h1><p id="20d7" class="pw-post-body-paragraph iq ir ht is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hm dt translated">功能价格代表了用户需要花多少钱来和你的dApp互动。最基本的例子是:</p><ul class=""><li id="6c2c" class="kt ku ht is b it iu ix iy jb kv jf kw jj kx jn ky kz la lb dt translated">向个人账户发送乙醚— 21000 <strong class="is hu"> (1 TP) </strong></li><li id="6a95" class="kt ku ht is b it lc ix ld jb le jf lf jj lg jn ky kz la lb dt translated">向ERC1155合同— 21048 <strong class="is hu"> ( &gt; 1 TP) </strong>发送乙醚</li></ul><p id="81d6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">您肯定希望在映射中保存一些东西(例如，资产的所有者或用户权限)。让我们来看看几种情况下<a class="ae jo" href="https://rinkeby.etherscan.io/address/0x67B229ee6193397A14aa30E931B8CB2ef3ec15C6#code" rel="noopener ugc nofollow" target="_blank">基本模板</a>中<code class="eh lx ly lz ma b">saveToMapping</code>函数的不同天然气价格:</p><ul class=""><li id="1306" class="kt ku ht is b it iu ix iy jb kv jf kw jj kx jn ky kz la lb dt translated"><a class="ae jo" href="https://rinkeby.etherscan.io/tx/0x4c23beedc6321ad2b353f30718d6c0b2cb5458b48d1e34c7c87b3170309bdcbd" rel="noopener ugc nofollow" target="_blank">首次写入映射</a>—48048<strong class="is hu">(2.28 TP)，9.54美元</strong></li><li id="c3e3" class="kt ku ht is b it lc ix ld jb le jf lf jj lg jn ky kz la lb dt translated"><a class="ae jo" href="https://rinkeby.etherscan.io/tx/0x0ebe75f6ab83dd35e90fd809e0897217c1ba6883363a186e1843bcb83e3b917d" rel="noopener ugc nofollow" target="_blank">密钥的第一次写入</a>—65520<strong class="is hu">(3.12 TP)，13.01美元</strong></li><li id="e0f0" class="kt ku ht is b it lc ix ld jb le jf lf jj lg jn ky kz la lb dt translated"><a class="ae jo" href="https://rinkeby.etherscan.io/tx/0xb8ac56f037c63a7e28c60aae190a74f6a3cc79a58ca75bd2fdcc4b96081717d7" rel="noopener ugc nofollow" target="_blank">钥匙的另一次写入</a>—38958<strong class="is hu">(1.85 TP)，7.73美元</strong></li></ul><p id="625e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这些差异来自于存储操作的不同价格——将零值替换为零值，将零值替换为非零值，将非零值替换为非零值(又是黄纸)。许多dApps在存储中保存大量数据，这导致交易费用有时甚至在10TP左右。这总是关于在存储链和交易费用之间寻找平衡。</p><p id="7ec5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">“铸造”本身就是保存资产的第一个所有者(初始转移—从0到所有者)。这是一个单一的存储操作(增加了资产所有者映射的价值),因此相对便宜。</p><p id="8289" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">疯狂奇瓦瓦神秘营地收购只依赖薄荷，使其气体效率。我们计划进一步部署的合同(例如yield token)将检查初始合同的余额以确认所有权。CCMC是ERC1155兼容的(我们使用<a class="ae jo" href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC1155/ERC1155.sol" rel="noopener ugc nofollow" target="_blank"> OpenZeppelin模板</a>，因为它们被广泛使用)，我们使用<code class="eh lx ly lz ma b">_mint()</code>来创建单个资产，使用<code class="eh lx ly lz ma b">_mint()</code>循环来创建多个资产。为了气体优化，我们区分这两种情况(跳过循环节省470个气体单位)。值得一提的是，ERC1155比ERC721更节能(后者在链中冗余存储了大量自有资产)。</p><p id="bf30" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">还有一个小的优化，我们最终没有添加。它使用了<code class="eh lx ly lz ma b">_mintBatch()</code>而不是循环<code class="eh lx ly lz ma b">_mint()</code>。这两者之间的唯一区别是发出的事件数量。不幸的是，OpenSea没有那么快解析<code class="eh lx ly lz ma b">TransferBatch</code>事件，所以我们决定坚持<code class="eh lx ly lz ma b">TransferSingle</code>为OpenSea用户提供最好的用户体验。</p><p id="4cba" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">疯狂吉娃娃薄荷糖的费用如下:</p><ul class=""><li id="1c92" class="kt ku ht is b it iu ix iy jb kv jf kw jj kx jn ky kz la lb dt translated">1 CCMC —54637 <strong class="is hu"> (2.60泰铢/10.86美元)</strong></li><li id="078c" class="kt ku ht is b it lc ix ld jb le jf lf jj lg jn ky kz la lb dt translated">2个CCMCs—82568<strong class="is hu">(3.93 TP/$ 16.26)[每项资产1.97 TP/$ 8.13]</strong></li><li id="0d78" class="kt ku ht is b it lc ix ld jb le jf lf jj lg jn ky kz la lb dt translated">3 CCMCs—110029<strong class="is hu">(5.24 TP/$ 21.19)【1.75</strong><strong class="is hu">TP/$ 7.06每项资产】</strong></li><li id="54f8" class="kt ku ht is b it lc ix ld jb le jf lf jj lg jn ky kz la lb dt translated">4 CCMCs —137491 <strong class="is hu"> (6.55泰铢/26.12美元)[每项资产1.64泰铢/6.53美元] </strong></li><li id="337b" class="kt ku ht is b it lc ix ld jb le jf lf jj lg jn ky kz la lb dt translated">5 CCMCs—164952<strong class="is hu">(7.85 TP/$ 31.05)[每项资产1.57 TP/$ 6.21]</strong></li></ul><h1 id="0148" class="jp jq ht bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">下一步是什么？</h1><p id="3396" class="pw-post-body-paragraph iq ir ht is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hm dt translated">随着独特的疯狂吉娃娃神秘营地NFTs的首次发布，我们推出了<a class="ae jo" href="https://lab.mystery.camp" rel="noopener ugc nofollow" target="_blank">实验室</a>——目前它只是一个有几个数字和图表的地方，欢迎你来查看！我们想把以太坊发展的知识传播的好很多！</p><p id="6b70" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">加入我们的社区，让我们知道你对这个问题的看法，我们欢迎所有的建议。CCMC的主人有优先权！</p></div></div>    
</body>
</html>