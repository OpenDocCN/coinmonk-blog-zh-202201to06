<html>
<head>
<title>External Call Security in Your Solidity Smart Contract</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">您的Solidity Smart合约中的外部呼叫安全性</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/external-call-security-in-your-solidity-smart-contract-2d7c0be5e20?source=collection_archive---------7-----------------------#2022-06-22">https://medium.com/coinmonks/external-call-security-in-your-solidity-smart-contract-2d7c0be5e20?source=collection_archive---------7-----------------------#2022-06-22</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="86e8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">以太坊是世界上使用最多的区块链之一。它用于开发Dapps，最重要的用例是Defi。目前，Defi处理超过780亿美元的资金，因此在开发智能合同时，安全性是最重要的考虑因素。</p><figure class="jp jq jr js fq jt fe ff paragraph-image"><div class="fe ff jo"><img src="../Images/65b3830e7bf7179875aa31bdb9e2bca5.png" data-original-src="https://miro.medium.com/v2/resize:fit:550/format:webp/1*I9x8UoMSE0HhuEQ4Mjh07Q.jpeg"/></div></figure><p id="ee94" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">由于区块链开发的基本性质，开发智能合同的理念与普通的Web2开发非常不同。</p><p id="fb86" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">处理一大笔钱需要更多的预防措施，所以人们应该随时做好失败的准备必须有一个出路，比如断路器，或者可以减少整体损害的最大使用限制。</p><p id="9ab8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">无论是软件还是技术，不断升级是关键。由于Web3社区是如此之大和多样化，总会有人面临威胁并有解决方案，所以请保持警惕。总是建议进行回归测试，发布审计报告，并为潜在的bug设置bug奖金。开发Dapps时最重要的考虑之一是将所需的代码仅放在区块链上，并使其尽可能简单</p><p id="72e3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在开发智能合约时，可以考虑外部调用期间的某些安全问题:</p><p id="c57f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">外部呼叫是您从智能合同向另一个智能合同发出的呼叫。(永远不要相信外部的智能合约！！).</p><p id="7208" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">将它们标记为不可信是表明它们正在访问外部合同的一种方式。</p><pre class="jp jq jr js fq jw jx jy jz aw ka dt"><span id="d68e" class="kb kc ht jx b fv kd ke l kf kg">// Bad practise<br/>function withdrawMoney(){<br/>		Contract2.withdraw()<br/>}<br/>// Good practise<br/>function UntrustedWithdrawMoney(){<br/>		UntrustedContract2.withdraw()<br/>}</span></pre><p id="c5dc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">避免外部调用发生后的任何状态变化，因为他们可能没有恶意代码，但他们能够调用一个。它会导致控制劫持和有史以来最重要的攻击之一——重入。该模式用于避免这种检查-效果-交互模式。因此，首先使用require、revert、assert进行检查，一旦检查通过，就必须完成对状态更改的影响，然后在与外部契约的交互之后</p><p id="8b5d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">什么是可重入攻击？</p><p id="3b83" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">基本思想是契约A调用契约B，契约B可以在第一次调用执行之前调用契约A</p><pre class="jp jq jr js fq jw jx jy jz aw ka dt"><span id="1a5e" class="kb kc ht jx b fv kd ke l kf kg">// Contract A has a withdraw function where users can withdraw ether if have<br/>//balance in the Contract</span><span id="896d" class="kb kc ht jx b fv kh ke l kf kg">Contract A{<br/>	mapping (address =&gt; uint256) userBalance;<br/>	function withdraw() public {<br/>        uint bal = balances[msg.sender];<br/>        require(bal &gt; 0);</span><span id="2b69" class="kb kc ht jx b fv kh ke l kf kg">        (bool sent, ) = msg.sender.call{value: bal}("");<br/>        require(sent, "Failed to send Ether");</span><span id="5d63" class="kb kc ht jx b fv kh ke l kf kg">        balances[msg.sender] = 0;<br/>    }<br/>}</span><span id="392c" class="kb kc ht jx b fv kh ke l kf kg">// Contract B will have two functions first is attack function which will call<br/>// the Contract A for withdrawal and a fallback function to withdraw money and a loop<br/>// will be created to drain all the ether before updating of balance</span><span id="5403" class="kb kc ht jx b fv kh ke l kf kg">Contract B{<br/>	fallback(){<br/>	A.withdraw()<br/>		}<br/>	function attack(){<br/>		A.withdraw()<br/>		}<br/>}</span></pre><p id="2839" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">避免transfer()和send()这些方法用于阻止重入攻击，因为它们可以向调用者发送高达2300 gas，但是由于gas成本不能恒定为2300 gas(查看<a class="ae ki" href="https://eips.ethereum.org/EIPS/eip-1884" rel="noopener ugc nofollow" target="_blank"> EIP 1884 </a>伊斯坦堡fork以了解更多信息), call()是首选方法，但是易于重入。</p><p id="8f01" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在address.call()之类的外部低级调用中处理错误它们不会抛出错误，但会为失败的事务返回一个布尔值，这些值需要进行处理</p><pre class="jp jq jr js fq jw jx jy jz aw ka dt"><span id="0f48" class="kb kc ht jx b fv kd ke l kf kg">(bool success, ) = someAddress.call.value(_value)("");<br/>require(success,"transaction failed!!");</span></pre><p id="339f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">总是让用户从合同中提取资金，而不是合同发送资金给用户，特别是付款，因为如果交易不成功，它将对特定用户失败，而不是所有用户。</p><p id="f699" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">避免对不受信任的代码进行委托调用。delegatecall函数是调用另一个协定函数并更改该协定的状态的函数。如果目标地址是由用户提供的，开发者需要检查地址是否在白名单中。</p><p id="9745" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">外部呼叫可能是危险的2016年以太坊上名为Dao Hack的可重入攻击可能导致价值7000万美元的以太损失，并导致以太坊的分叉，即以太坊经典。所以在打任何外部电话之前都要非常小心</p><blockquote class="kj"><p id="0a20" class="kk kl ht bd km kn ko kp kq kr ks jn ek translated">加入Coinmonks <a class="ae ki" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae ki" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h1 id="f88e" class="kt kc ht bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp dt translated">另外，阅读</h1><ul class=""><li id="b958" class="lq lr ht is b it ls ix lt jb lu jf lv jj lw jn lx ly lz ma dt translated"><a class="ae ki" href="https://coincodecap.com/smithbot-review" rel="noopener ugc nofollow" target="_blank"> SmithBot评论</a> | <a class="ae ki" href="https://coincodecap.com/free-open-source-trading-bots" rel="noopener ugc nofollow" target="_blank"> 4款最佳免费开源交易机器人</a></li><li id="13f1" class="lq lr ht is b it mb ix mc jb md jf me jj mf jn lx ly lz ma dt translated"><a class="ae ki" rel="noopener" href="/coinmonks/coinbase-bots-ac6359e897f3">比特币基地僵尸程序</a> | <a class="ae ki" rel="noopener" href="/coinmonks/ascendex-review-53e829cf75fa"> AscendEX审查</a> | <a class="ae ki" rel="noopener" href="/coinmonks/okex-trading-bots-234920f61e60"> OKEx交易僵尸程序</a></li><li id="76b5" class="lq lr ht is b it mb ix mc jb md jf me jj mf jn lx ly lz ma dt translated"><a class="ae ki" rel="noopener" href="/coinmonks/buy-bitcoin-in-india-feb50ddfef94">如何在印度购买比特币？</a> | <a class="ae ki" rel="noopener" href="/coinmonks/wazirx-review-5c811b074f5b">瓦济克斯审查</a></li><li id="1bdc" class="lq lr ht is b it mb ix mc jb md jf me jj mf jn lx ly lz ma dt translated"><a class="ae ki" rel="noopener" href="/coinmonks/crypto-trading-bot-c2ffce8acb2a">加密交易机器人</a> | <a class="ae ki" href="https://coincodecap.com/probit-review" rel="noopener ugc nofollow" target="_blank">普罗比特评论</a></li><li id="f6c8" class="lq lr ht is b it mb ix mc jb md jf me jj mf jn lx ly lz ma dt translated"><a class="ae ki" rel="noopener" href="/coinmonks/cryptohopper-alternatives-d67287b16d27">隐翅虫替代品</a> | <a class="ae ki" rel="noopener" href="/coinmonks/hitbtc-review-c5143c5d53c2"> HitBTC审查</a></li><li id="af09" class="lq lr ht is b it mb ix mc jb md jf me jj mf jn lx ly lz ma dt translated"><a class="ae ki" href="https://coincodecap.com/cbet-casino-review" rel="noopener ugc nofollow" target="_blank"> CBET评论</a> | <a class="ae ki" href="https://coincodecap.com/kucoin-vs-coinbase" rel="noopener ugc nofollow" target="_blank">库科恩vs比特币基地</a></li><li id="3e86" class="lq lr ht is b it mb ix mc jb md jf me jj mf jn lx ly lz ma dt translated"><a class="ae ki" href="https://coincodecap.com/fold-app-review" rel="noopener ugc nofollow" target="_blank">折叠App回顾</a> | <a class="ae ki" rel="noopener" href="/coinmonks/kucoin-trading-bot-automate-your-trades-8cf0ca2138e0"> Kucoin交易机器人</a></li><li id="8945" class="lq lr ht is b it mb ix mc jb md jf me jj mf jn lx ly lz ma dt translated"><a class="ae ki" href="https://coincodecap.com/buy-bitcoin-anonymously" rel="noopener ugc nofollow" target="_blank">如何匿名购买比特币</a> | <a class="ae ki" href="https://coincodecap.com/bitcoin-cash-wallets" rel="noopener ugc nofollow" target="_blank">比特币现金钱包</a></li></ul></div></div>    
</body>
</html>