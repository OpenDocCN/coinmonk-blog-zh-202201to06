<html>
<head>
<title>BeanstalkFarms attack event analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BeanstalkFarms攻击事件分析</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/beanstalkfarms-attack-event-analysis-6980482a9b00?source=collection_archive---------9-----------------------#2022-04-19">https://medium.com/coinmonks/beanstalkfarms-attack-event-analysis-6980482a9b00?source=collection_archive---------9-----------------------#2022-04-19</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><div class=""><h2 id="045b" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ek translated">0x01事件背景</h2></div><p id="c50a" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">BeanstalkFarms是一个基于信用的分散式StableCoin协议，由于闪贷攻击，该协议损失了约1.82亿美元</p><h2 id="c89f" class="ke kf ht bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">豆茎游戏攻略</h2><p id="81a0" class="pw-post-body-paragraph ji jj ht jk b jl kz iu jn jo la ix jq jr lb jt ju jv lc jx jy jz ld kb kc kd hm dt translated">一个分散的基于信用的稳定币协议。运行在开源、无许可协议(如Bitcoin4和以太坊)上的去中心化计算机网络代表了下一个经济和技术前沿:无信任商品和服务。</p><p id="5f58" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">Beanstalk依赖于3个相互关联的部分:</p><ol class=""><li id="ab34" class="le lf ht jk b jl jm jo jp jr lg jv lh jz li kd lj lk ll lm dt translated">一个分散的价格先知，</li><li id="32be" class="le lf ht jk b jl ln jo lo jr lp jv lq jz lr kd lj lk ll lm dt translated">筒仓，一种分散的治理机制，以及</li><li id="ec59" class="le lf ht jk b jl ln jo lo jr lp jv lq jz lr kd lj lk ll lm dt translated">这是一个分散的信贷机构。</li></ol><p id="03be" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">豆茎发行了3个ERC-20标准代币:</p><ol class=""><li id="c245" class="le lf ht jk b jl jm jo jp jr lg jv lh jz li kd lj lk ll lm dt translated">豆子，豆茎稳定币，</li><li id="5ae0" class="le lf ht jk b jl ln jo lo jr lp jv lq jz lr kd lj lk ll lm dt translated">一个产生收益的治理令牌，以及</li><li id="73a6" class="le lf ht jk b jl ln jo lo jr lp jv lq jz lr kd lj lk ll lm dt translated">种子，每季产生万分之一的茎秆。</li></ol><p id="168b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">Beanstalk依赖于3个相互关联的部分:</p><ol class=""><li id="8854" class="le lf ht jk b jl jm jo jp jr lg jv lh jz li kd lj lk ll lm dt translated">一个分散的价格先知，</li><li id="06b1" class="le lf ht jk b jl ln jo lo jr lp jv lq jz lr kd lj lk ll lm dt translated">筒仓，一种分散的治理机制，以及</li><li id="dae4" class="le lf ht jk b jl ln jo lo jr lp jv lq jz lr kd lj lk ll lm dt translated">这是一个分散的信贷机构。</li></ol><h2 id="e905" class="ke kf ht bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">1.分散价格Oracle</h2><p id="b8f0" class="pw-post-body-paragraph ji jj ht jk b jl kz iu jn jo la ix jq jr lb jt ju jv lc jx jy jz ld kb kc kd hm dt translated">Beanstalk使用两个Uniswap流动性池——USDC:ETH和BEAN:ETH——来创建一个分散价格oracle。当两个池的比率相同时，1豆的价格被认为等于1美元。</p><p id="cdcd" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">Beanstalk计算每个季节1粒咖啡豆的时间加权平均价格(TWAP)。</p><h2 id="e67d" class="ke kf ht bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">2.筒仓:一种去中心化的治理机制</h2><p id="aebd" class="pw-post-body-paragraph ji jj ht jk b jl kz iu jn jo la ix jq jr lb jt ju jv lc jx jy jz ld kb kc kd hm dt translated">Beanstalk使用Silo(Beanstalk去中心化自治组织)来创建健壮的去中心化治理机制。</p><h2 id="0bfd" class="ke kf ht bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">0x02攻击者信息</h2><p id="b45b" class="pw-post-body-paragraph ji jj ht jk b jl kz iu jn jo la ix jq jr lb jt ju jv lc jx jy jz ld kb kc kd hm dt translated">攻击发生在以太坊链条上，主要攻击信息如下:</p><p id="b175" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">攻击者的钱包地址</p><p id="de98" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">0x 1 C5 dcdd 006 ea 78 a7e 4783 F9 e 6021 c 32935 a10fb 4</p><p id="5719" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">主要攻击交易</p><p id="4f6c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">0xcd 314668 AAA 9 bbfebaf 1 a 0 BD 2 b 6553d 01 DD 58899 c 508d 4729 fa 7311 DC 5d 33 ad 7</p><p id="904e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">攻击者创建的合同</p><p id="87c1" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">主要攻击逻辑契约:0x 79224 BC 0 BF 70 EC 34 f 0 ef 56 ed 8251619499 a 59 def</p><p id="cdcb" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">0x 728 ad 672409 da 288 ca 5b 9 aa 85 D1 a55b 803 ba 97d 7</p><p id="0ce9" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">0 xe 5 ECF 73603d 98 a 0128 f 05 ed 30506 AC 7a 663 dbb 69</p><p id="06d5" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">0x 259 a 2795624 b 8 a 17 BC 7 EB 312 a 94504 ad 0 f 615 D1 e</p><p id="e773" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">治理费合同</p><p id="1870" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">0 xf 480 ee 81 a 54 e 21 be 47 aa 02 d0f 9 e 29985 BC 7667 c 4</p><h2 id="35db" class="ke kf ht bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">0x03攻击分析</h2><p id="9b5d" class="pw-post-body-paragraph ji jj ht jk b jl kz iu jn jo la ix jq jr lb jt ju jv lc jx jy jz ld kb kc kd hm dt translated">在攻击交易之前</p><p id="c286" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">对攻击者合约地址的交易进行分析发现，在主要攻击交易0xcd3146发生的前一天，攻击者通过Uniswap分散式交换将73 eth兑换为BEAN，然后将BEAN资金存入Beanstalk合约(以获得提案权)</p><figure class="lt lu lv lw fq lx fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff ls"><img src="../Images/ea0a908d61271c0e6e83a5d2a9799a13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YZ3P0bLgmxWbikISC9u43g.png"/></div></div></figure><p id="25a3" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">然后创建了0x 259 a 2795624 b 8 a 17 BC 7 EB 312 a 94504 ad 0 f 615d 1 e契约，这里定义为建议契约。</p><p id="3cf4" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">然后攻击者连续两次调用0x956afd68方法，就是propose方法:propose((address，uint8，bytes4[])[]，address，bytes，uint8)，使用刚创建的契约(0x259a279)和一个未知的提议契约(0x e 5 ECF 73603d 98 a 0128 f 05 ed 30506 AC 7 a 663 dbb 69)作为参数，</p><figure class="lt lu lv lw fq lx fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff me"><img src="../Images/8918993ee0ea2933c10e40a9ce776fd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0T8BcDdyTxsYMFzI5PxCjg.png"/></div></div></figure><p id="a6b0" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">通过对项目的分析可知，如果提案通过，提案契约中指定的内容将立即执行<br/>继续分析交易，发现在攻击交易的同时，攻击者通过0x677660ce4交易(0x e 5 ECF 73603d 98 a 0128 f 05 ed 30506 AC 7a 663 dbb 69)创建了提案契约</p><figure class="lt lu lv lw fq lx fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff mf"><img src="../Images/f593d78d48151d3212c8890d1d2bceaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yaxeGsM1rg_3LXyjUTiO-Q.png"/></div></div></figure><p id="1f60" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">继续分析主要攻击交易:0xcd 314668 AAA 9 bbfebaf 1 a 0 BD 2 b 6553d 01 DD 58899 c 508d 4729 fa 7311 DC 5d 33 ad 7</p><h2 id="97b4" class="ke kf ht bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">攻击交易详细信息</h2><ul class=""><li id="5901" class="le lf ht jk b jl kz jo la jr mg jv mh jz mi kd mj lk ll lm dt translated">攻击者闪贷</li></ul><p id="a5be" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">攻击者通过闪贷分别从<strong class="jk hu"> Aave </strong>、<strong class="jk hu"> Uniswap V2 </strong>、<strong class="jk hu"> SushiSwap </strong>获得大量资金，作为后续攻击的准备。从下图可以看出，攻击者的闪贷总额:<strong class="jk hu">3.5亿戴</strong>，<strong class="jk hu"> 5亿</strong>，<strong class="jk hu">1.5亿</strong>，<strong class="jk hu">32100950豆</strong>，<strong class="jk hu">11643065。</strong></p><figure class="lt lu lv lw fq lx fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff mk"><img src="../Images/15ed22958e01159fb85da46612297267.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pr4dIWieCe1ItCQ6K3Ig2A.png"/></div></div></figure><ul class=""><li id="1623" class="le lf ht jk b jl jm jo jp jr lg jv lh jz li kd mj lk ll lm dt translated">攻击者转移闪贷资金</li></ul><p id="073c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">攻击者在Curve.fi: <strong class="jk hu">戴/USDC/USDT池</strong>中将上述资金中的戴、、资金兑换为<strong class="jk hu"> 979，691，328 3Crv </strong>流动性代币，并将<strong class="jk hu"> 15，000，000 3Crv </strong>兑换为<strong class="jk hu"> 15，251，318 LUSD </strong></p><figure class="lt lu lv lw fq lx fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff ml"><img src="../Images/e1ed17be2ff3065cbd5a4789719f04d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hJ7nmPu4wFUMxJpggtZ1Pw.png"/></div></div></figure><p id="24f9" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">接下来，攻击者用<strong class="jk hu"> 964，691，328个3Crv </strong>代币换取<strong class="jk hu"> 795，425，740</strong>BEAN 3 crv-f进行投票，将<strong class="jk hu"> 32，100，950 BEAN </strong>和<strong class="jk hu"> 26，894，383 LUSD </strong>加入流动性，得到<strong class="jk hu"> 58，924，887 BEAN lusd-f</strong></p><figure class="lt lu lv lw fq lx fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff mm"><img src="../Images/28af1a2aecfd6e3d713b9be6a69fcc01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W7mkrX3hU2D2n4dZ_epP1A.png"/></div></div></figure><ul class=""><li id="a14d" class="le lf ht jk b jl jm jo jp jr lg jv lh jz li kd mj lk ll lm dt translated">攻击者对恶意提案进行投票并撤回资金</li></ul><p id="f5e2" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">攻击者会交换<strong class="jk hu"> BEAN3CRV-f </strong>和<strong class="jk hu"> BEANLUSD-f </strong>对提案进行投票，导致提案通过。因此，Beanstalk协议契约向攻击契约转移了大量令牌。</p><figure class="lt lu lv lw fq lx fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff mn"><img src="../Images/a0d21fd6329c206b684a84de1493eec4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5pbw7qGzE1eWxleZhCFhxA.png"/></div></div></figure><ul class=""><li id="6038" class="le lf ht jk b jl jm jo jp jr lg jv lh jz li kd mj lk ll lm dt translated">攻击者转换资金并偿还闪贷</li></ul><p id="7525" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">攻击者用<strong class="jk hu">1007734729 3 crv</strong>获得的全部<strong class="jk hu">beans 3 crv-f</strong>和全部<strong class="jk hu">beans lusd-f</strong>换取<strong class="jk hu">28149504 LUSD</strong>。</p><figure class="lt lu lv lw fq lx fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff mo"><img src="../Images/5ebd183584ee9a73c0487045aecded8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*93L0hIDDOXcIPX2bATPbTQ.png"/></div></div></figure><p id="fcca" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">攻击者在SushiSwap和Uniswap V2返还闪付贷款</p><figure class="lt lu lv lw fq lx fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff mp"><img src="../Images/2fff5dcde13a88ce6777c621da2e77e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DT4efXq-kYKw7k10olIaag.png"/></div></div></figure><p id="c4fd" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">攻击者用<strong class="jk hu">16471404 LUSD</strong>兑换<strong class="jk hu">16184690 3 crv</strong>。随后，<strong class="jk hu"> 511，959，710 3车币</strong>换成<strong class="jk hu"> 522，487，380</strong>，<strong class="jk hu"> 358，371，797 3车币</strong>换成<strong class="jk hu"> 365，758，059戴</strong>，<strong class="jk hu"> 153，587，913 3 3 3车币</strong>换成<strong class="jk hu"> 156，732</strong></p><figure class="lt lu lv lw fq lx fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff mq"><img src="../Images/c235d05022595f613bf737d883c758bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LkG1u2rDapvnLHcpv6gBXg.png"/></div></div></figure><ul class=""><li id="8daa" class="le lf ht jk b jl jm jo jp jr lg jv lh jz li kd mj lk ll lm dt translated">攻击者偿还了一笔快速贷款</li></ul><figure class="lt lu lv lw fq lx fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff mr"><img src="../Images/f5b09348365224cdd5d0a6c3be4dac23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_73Rg8Gau-S_DJjvRRAcLg.png"/></div></div></figure><ul class=""><li id="b0bc" class="le lf ht jk b jl jm jo jp jr lg jv lh jz li kd mj lk ll lm dt translated">攻击者转移盈利资金</li></ul><p id="ba9a" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">攻击者摧毁<strong class="jk hu"> UNI-V2 LP </strong>后获得<strong class="jk hu">10883 wet</strong>和<strong class="jk hu">32511085 BEAN</strong></p><figure class="lt lu lv lw fq lx fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff ms"><img src="../Images/9dc0362e6a659ffd0a15b45f536a1cbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QueKAUVONhgKAez0_pnhgQ.png"/></div></div></figure><p id="0e28" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">攻击者向乌克兰加密货币捐赠了价值约25万美元的25万USDC。</p><figure class="lt lu lv lw fq lx fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff mt"><img src="../Images/8b78a37d5d00930db9329cf25626d056.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zOGyvqkAI8RG6BYfxfWoFg.png"/></div></div></figure><p id="185c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">攻击者将获利的加密货币兑换成<strong class="jk hu">13947 WETH</strong>并转入攻击者的合约。最终，攻击者共获得<strong class="jk hu">24820 WETH</strong>，价值约<strong class="jk hu">7208万美元</strong>。</p><figure class="lt lu lv lw fq lx fe ff paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="fe ff mu"><img src="../Images/6f3574976e43002a1ac19ff4a489e0e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lwmmfyJyNY7SiYwOpgL2sQ.png"/></div></div></figure><h2 id="0ef4" class="ke kf ht bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">0x04漏洞详细信息</h2><p id="f89e" class="pw-post-body-paragraph ji jj ht jk b jl kz iu jn jo la ix jq jr lb jt ju jv lc jx jy jz ld kb kc kd hm dt translated">通过分析攻击过程，发现攻击者明显进行了投票治理的关键操作，并成功获利。这里直接分析治理契约<strong class="jk hu"> GovernanceFacet </strong>。</p><figure class="lt lu lv lw fq lx fe ff paragraph-image"><div class="fe ff mv"><img src="../Images/219cae77af2c5e4b56ffcc6561d0fba6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1112/format:webp/1*KCz3OQX6xtqPpFgQTYV4og.png"/></div></figure><p id="c96a" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">攻击者通过<strong class="jk hu">governance facet</strong>contract propose方法发起提议，生成提议id，判断攻击者是否有资格发起提议以及判定提议数量的条件。由于攻击者已经通过之前的操作进行了资金质押，所以如果满足这个条件，就可以正常发起求婚。<br/>继续看攻击者如何满足提案通过的投票条件:</p><figure class="lt lu lv lw fq lx fe ff paragraph-image"><div class="fe ff mw"><img src="../Images/1ad3f1e4b474065e65247bd50d7720d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1220/format:webp/1*z3vSkjeqrcAVvNUij3sIsg.png"/></div></figure><p id="ceeb" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">在合同中，通常采用投票方式对提案进行投票。这里，调用<strong class="jk hu"> recordVote </strong>方法来记录投票。投票是通过<strong class="jk hu"> balanceOfRoots(account)方法</strong>计算的，这是用户的资金地址，攻击者通过闪贷资金交易所获得可投票的令牌，因此攻击者可以利用大量的投票权使其提案通过。<br/>但是为什么攻击者可以在投票后直接转移资金呢？合同没有提案时限吗？<br/>转到治理费契约的另一种方法，emergencyCommit紧急提交提案。</p><figure class="lt lu lv lw fq lx fe ff paragraph-image"><div class="fe ff mx"><img src="../Images/de7146954a5e7cb5b6b25f33e430dd91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1314/format:webp/1*uji2Db59mxljgPmEBJys6A.png"/></div></figure><p id="cd25" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">从契约代码中可以明确，<strong class="jk hu">getGovernanceEmergencyPeriod()</strong>方法的返回时间是1天，也就是说在<strong class="jk hu"> emergencyCommit </strong>方法中，只要提议时间大于一天，就可以成功调用该方法。由于攻击者通过flash loan基金投票支持恶意提案，因此这里emergencyCommit可以成功执行和伪造。</p><h2 id="2045" class="ke kf ht bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">0x05总结</h2><p id="0158" class="pw-post-body-paragraph ji jj ht jk b jl kz iu jn jo la ix jq jr lb jt ju jv lc jx jy jz ld kb kc kd hm dt translated">从这次攻击来看，安全风险在链上治理相关函数的契约逻辑中。由于用户投票的数量是基于用户持有的余额来确定的，并且没有向可投票资金添加时间锁定，所以攻击导致攻击。用户发起恶意提案，利用闪贷获取大量资金进行投票，导致最终恶意提案生效，正式项目合同的资金被转移。</p><h2 id="cada" class="ke kf ht bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">0x06安全建议</h2><ul class=""><li id="f4e2" class="le lf ht jk b jl kz jo la jr mg jv mh jz mi kd mj lk ll lm dt translated">建议在项目启动前严格审核合同风险。</li><li id="1993" class="le lf ht jk b jl ln jo lo jr lp jv lq jz lr kd mj lk ll lm dt translated">建议为与链上治理、提案发布和提案执行相关的重要功能添加时间锁。如果出现恶意提议，也可以缓冲；避免使用账户当前资金余额统计票数，避免重复投票，避免通过闪贷借款投票；</li><li id="c312" class="le lf ht jk b jl ln jo lo jr lp jv lq jz lr kd mj lk ll lm dt translated">项目方和社区应密切关注所有提案。如果存在恶意提案，建议禁止其在提案表决期间接受表决并执行；</li></ul><p id="50eb" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hm dt translated">参考:</p><div class="my mz fm fo na nb"><a rel="noopener follow" target="_blank" href="/beanstalkfarms/introducing-beanstalk-557c45cb8d80"><div class="nc ab ej"><div class="nd ab ne cl cj nf"><h2 class="bd hu fv z el ng eo ep nh er et hs dt translated">豆茎简介</h2><div class="ni l"><h3 class="bd b fv z el ng eo ep nh er et ek translated">一种基于分散信用的稳定币协议</h3></div><div class="nj l"><p class="bd b gc z el ng eo ep nh er et ek translated">medium.com</p></div></div><div class="nk l"><div class="nl l nm nn no nk np mc nb"/></div></div></a></div><blockquote class="nq"><p id="be7a" class="nr ns ht bd nt nu nv nw nx ny nz kd ek translated">加入Coinmonks <a class="ae oa" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae oa" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h1 id="7c22" class="ob kf ht bd kg oc od oe kk of og oh ko iz oi ja kr jc oj jd ku jf ok jg kx ol dt translated">另外，阅读</h1><ul class=""><li id="3c2d" class="le lf ht jk b jl kz jo la jr mg jv mh jz mi kd mj lk ll lm dt translated"><a class="ae oa" href="https://coincodecap.com/crypto-exchanges-in-germany" rel="noopener ugc nofollow" target="_blank">德国最佳加密交易所</a> | <a class="ae oa" href="https://coincodecap.com/arbitrum" rel="noopener ugc nofollow" target="_blank"> Arbitrum:第二层解决方案</a></li><li id="c096" class="le lf ht jk b jl ln jo lo jr lp jv lq jz lr kd mj lk ll lm dt translated"><a class="ae oa" rel="noopener" href="/coinmonks/binance-trading-bots-d0d57bb62c4c">币安交易机器人</a> | <a class="ae oa" rel="noopener" href="/coinmonks/okex-review-6b369304110f"> OKEx评论</a> | <a class="ae oa" href="https://coincodecap.com/atani-review" rel="noopener ugc nofollow" target="_blank"> Atani评论</a></li><li id="3f9f" class="le lf ht jk b jl ln jo lo jr lp jv lq jz lr kd mj lk ll lm dt translated"><a class="ae oa" rel="noopener" href="/coinmonks/best-crypto-signals-telegram-5785cdbc4b2b">最佳加密交易信号电报</a> | <a class="ae oa" rel="noopener" href="/coinmonks/moonxbt-review-6e4ab26d037"> MoonXBT评论</a></li><li id="4c0e" class="le lf ht jk b jl ln jo lo jr lp jv lq jz lr kd mj lk ll lm dt translated"><a class="ae oa" href="https://coincodecap.com/buy-shiba-bitbns" rel="noopener ugc nofollow" target="_blank">如何在Bitbns上购买柴犬(SHIB)币？</a> | <a class="ae oa" href="https://coincodecap.com/buy-floki-inu-token" rel="noopener ugc nofollow" target="_blank">买弗洛基</a></li><li id="1807" class="le lf ht jk b jl ln jo lo jr lp jv lq jz lr kd mj lk ll lm dt translated"><a class="ae oa" href="https://coincodecap.com/coinflex-review" rel="noopener ugc nofollow" target="_blank"> CoinFLEX评论</a> | <a class="ae oa" href="https://coincodecap.com/aex-exchange-review" rel="noopener ugc nofollow" target="_blank"> AEX交易所评论</a> | <a class="ae oa" href="https://coincodecap.com/upbit-review" rel="noopener ugc nofollow" target="_blank"> UPbit评论</a></li><li id="f895" class="le lf ht jk b jl ln jo lo jr lp jv lq jz lr kd mj lk ll lm dt translated"><a class="ae oa" href="https://coincodecap.com/best-cryptocurrency-blogs" rel="noopener ugc nofollow" target="_blank">十大最佳加密货币博客</a> | <a class="ae oa" href="https://coincodecap.com/youhodler-review" rel="noopener ugc nofollow" target="_blank"> YouHodler评论</a></li></ul></div></div>    
</body>
</html>