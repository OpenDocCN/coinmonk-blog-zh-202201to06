<html>
<head>
<title>Pre-compute contract deployment address using CREATE2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用CREATE2预先计算合同部署地址</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/pre-compute-contract-deployment-address-using-create2-8c01e80ab7da?source=collection_archive---------2-----------------------#2022-03-01">https://medium.com/coinmonks/pre-compute-contract-deployment-address-using-create2-8c01e80ab7da?source=collection_archive---------2-----------------------#2022-03-01</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="e200" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在本文中，让我们看看如何在部署之前计算我们的合同在EVM区块链的部署地址。这里我们使用EVM的CREATE2操作码，它类似于CREATE操作码。</p><p id="8bad" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们部署“TestContract ”,并将部署的地址与我们预先计算的地址相匹配。所以让我们切换到<a class="ae jo" href="http://remix.ethereum.org/" rel="noopener ugc nofollow" target="_blank">混音</a>……你可以在这里查阅Github <a class="ae jo" href="https://github.com/Vbhaskar125/DeploymentAddress-using-CREATE2" rel="noopener ugc nofollow" target="_blank">上的代码。</a></p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div class="fe ff jp"><img src="../Images/1952495b97f8ebc05ee725d7e584b567.png" data-original-src="https://miro.medium.com/v2/resize:fit:686/format:webp/1*NVLXQmmCKkVKNWcQFQ0ung.png"/></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek">TestContract</figcaption></figure><p id="a242" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">这是要部署的最简单的契约(注意，它没有任何构造函数参数…在本文的后面，我们将看到，如果它有构造函数参数，如何插入参数并获得字节码)</p><p id="76aa" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们创建一个名为“preComputeAddress”的契约，它预先计算地址并部署这个“TestContract”。</p><ol class=""><li id="f2c1" class="kb kc ht is b it iu ix iy jb kd jf ke jj kf jn kg kh ki kj dt translated">它有一个用下面的签名计算地址的功能。它接受需要用salt计算地址的契约的字节码(把它想象成一个随机数)。</li></ol><pre class="jq jr js jt fq kk kl km kn aw ko dt"><span id="847f" class="kp kq ht kl b fv kr ks l kt ku">function computeAddress(bytes memory _byteCode, uint256 _salt)public view returns (address )</span></pre><p id="ad25" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">2.为了计算契约的字节码，让我们用下面的函数签名添加另一个函数。在这个函数中，我们使用“.creationCode”(查看文章末尾runtimebytecode和initbytecode之间的区别。creationcode与initbytecode相同)</p><pre class="jq jr js jt fq kk kl km kn aw ko dt"><span id="361b" class="kp kq ht kl b fv kr ks l kt ku">function getBytecode() public pure returns (bytes memory)</span></pre><p id="f33c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">3.最后，我们将部署我们的契约，并用部署的地址发出一个事件</p><pre class="jq jr js jt fq kk kl km kn aw ko dt"><span id="fb10" class="kp kq ht kl b fv kr ks l kt ku">function deploy(bytes memory _byteCode, uint256 _salt)public payable</span></pre><p id="8c82" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">事件签名</p><pre class="jq jr js jt fq kk kl km kn aw ko dt"><span id="d402" class="kp kq ht kl b fv kr ks l kt ku"> event Deployed(address indexed preComputedAddress);</span></pre><p id="1a69" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们在remix中部署我们的预计算地址契约。检查这个<a class="ae jo" href="https://github.com/Vbhaskar125/DeploymentAddress-using-CREATE2" rel="noopener ugc nofollow" target="_blank"> Github repo </a>的代码。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff kv"><img src="../Images/39799d708f931104e3da46a9c2642635.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*itHYvQjYhFmtSWY9FgrWfQ.png"/></div></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek">preComputedAddress.sol deployed</figcaption></figure><p id="edf1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">我们可以看到我们契约的三个功能暴露出来了。让我们获得我们希望部署的“测试契约”的字节码。如果契约有任何构造函数参数，它们会被编码并附加到契约的字节码中。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div class="fe ff la"><img src="../Images/d446f10656bfc91e20eeb2b4a910d637.png" data-original-src="https://miro.medium.com/v2/resize:fit:730/format:webp/1*QrQBGTdOo8ZGSKSAq2MDlg.png"/></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek">Highlighted is the bytecode for “TestContract”</figcaption></figure><p id="2302" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在让我们使用“computeAddress”函数来计算部署地址。这里它采用了上面计算的字节码和一个salt。computeAddress()执行以下操作的keccak256:a)从其开始部署的合同地址，b)传递的salt(salt只是一个使用的随机数)，c)以及字节代码的keccak 256。这些参数以“0xff”为前缀，并按如下所示的顺序打包在一起。最后，地址是结果散列的最后20个字节。</p><pre class="jq jr js jt fq kk kl km kn aw ko dt"><span id="8b8d" class="kp kq ht kl b fv kr ks l kt ku">keccak256(abi.encodePacked(bytes1(0xff),address(this),_salt,keccak256(_byteCode)));</span></pre><p id="41be" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">remix中的计算地址(使用salt = 121)为“0x 578 e 2361 CFA 345158 e 4635 DFB 52484 db 60 c 37 cf 6”如下图所示。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div class="fe ff lb"><img src="../Images/2b4ec2990ad8febfc34ab041db7023e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:736/format:webp/1*TD0-UVm1X4MM5si-AOXp9A.png"/></div></figure><p id="c07f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">现在让我们部署TestContract并检查事件日志中的地址。部署函数使用EVM的CREATE2操作码来部署合同。这将使用EVM汇编语言(yul)。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff lc"><img src="../Images/825e8106ba1dd9405bfe041b840a8187.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BgIiYr9NxR6GVx0tfVvE1w.png"/></div></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek">Event fired after the deploy function execution</figcaption></figure><p id="a291" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">让我们深入研究事件日志并找到部署地址。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff ld"><img src="../Images/b634e6018019f750934fa28a4d0fd0ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NAphbT6kMHWrKjtBo9wjqA.png"/></div></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek">deployed address in the event</figcaption></figure><p id="4352" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">正如您在代码中看到的，event Deployed有一个名为preComputedAddress的索引参数。这可以在事件日志中看到。我们的预编译地址与部署的事件中的地址相同。</p><h2 id="5e92" class="kp kq ht bd le lf lg lh li lj lk ll lm jb ln lo lp jf lq lr ls jj lt lu lv lw dt translated">关于CREATE2的更多信息</h2><p id="275f" class="pw-post-body-paragraph iq ir ht is b it lx iv iw ix ly iz ja jb lz jd je jf ma jh ji jj mb jl jm jn hm dt translated">创建2是一个EVM操作码。可以用create2(v，p，n，s)调用。</p><p id="ae37" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">其中v是调用中传递的以太值，p是指向传递的字节码的起始指针，n是字节码的大小，即从p到p+n是字节码。s是通过的盐。这个函数返回部署的契约的地址(契约由字节码p到p+n定义)。</p><h2 id="f9d8" class="kp kq ht bd le lf lg lh li lj lk ll lm jb ln lo lp jf lq lr ls jj lt lu lv lw dt translated">关于initbytecode和runtimebytecode的更多信息</h2><p id="9448" class="pw-post-body-paragraph iq ir ht is b it lx iv iw ix ly iz ja jb lz jd je jf ma jh ji jj mb jl jm jn hm dt translated">存储在chain上的代码与我们在编译智能合同后得到的代码不同。</p><p id="69e1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">当我们将datapayload发送到EVM的一个null/0地址时，就会创建契约。我们发送的代码(字节码)是init代码，它运行并构造运行时代码。然后使用“sstore”操作码(没有构造器代码和私有变量)将该运行时代码存储在EVM上。因此，每当我们使用“extcodecopy”操作码获取契约代码时，都会返回runtimebytecode。</p><h2 id="6ccc" class="kp kq ht bd le lf lg lh li lj lk ll lm jb ln lo lp jf lq lr ls jj lt lu lv lw dt translated">进一步阅读</h2><div class="mc md fm fo me mf"><a href="https://blog.smartdec.net/how-to-define-smart-contract-address-before-the-deploy-create2-use-case-for-decentralized-exchange-52b7daa7873b" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab ej"><div class="mh ab mi cl cj mj"><h2 class="bd hu fv z el mk eo ep ml er et hs dt translated">如何在加密交换的Deploy: CREATE2用例之前定义智能协定地址</h2><div class="mm l"><h3 class="bd b fv z el mk eo ep ml er et ek translated">CREATE2操作码是今年2月28日在君士坦丁堡硬分叉中引入的。</h3></div><div class="mn l"><p class="bd b gc z el mk eo ep ml er et ek translated">blog.smartdec.net</p></div></div><div class="mo l"><div class="mp l mq mr ms mo mt jv mf"/></div></div></a></div><div class="mc md fm fo me mf"><a href="https://www.youtube.com/channel/UCJWh7F3AFyQ_x01VKzr9eyA" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab ej"><div class="mh ab mi cl cj mj"><h2 class="bd hu fv z el mk eo ep ml er et hs dt translated">智能合同程序员</h2><div class="mm l"><h3 class="bd b fv z el mk eo ep ml er et ek translated">这个频道在开放的分散的区块链提供关于智能合同的免费教育。加入我们的冒险吧…</h3></div><div class="mn l"><p class="bd b gc z el mk eo ep ml er et ek translated">www.youtube.com</p></div></div><div class="mo l"><div class="mu l mq mr ms mo mt jv mf"/></div></div></a></div><div class="mc md fm fo me mf"><a href="https://solidity-by-example.org/app/create2/" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab ej"><div class="mh ab mi cl cj mj"><h2 class="bd hu fv z el mk eo ep ml er et hs dt translated">使用create 2 | Solidity by Example | 0 . 8 . 10预计算合同地址</h2><div class="mm l"><h3 class="bd b fv z el mk eo ep ml er et ek translated">使用create2预计算合同地址</h3></div><div class="mn l"><p class="bd b gc z el mk eo ep ml er et ek translated">solidity-by-example.org</p></div></div><div class="mo l"><div class="mv l mq mr ms mo mt jv mf"/></div></div></a></div><div class="mc md fm fo me mf"><a href="https://docs.openzeppelin.com/cli/2.8/deploying-with-create2" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab ej"><div class="mh ab mi cl cj mj"><h2 class="bd hu fv z el mk eo ep ml er et hs dt translated">使用CREATE2 - OpenZeppelin文档部署智能合同</h2><div class="mm l"><h3 class="bd b fv z el mk eo ep ml er et ek translated">操作码使我们能够预测将要部署合同的地址，而不必这样做…</h3></div><div class="mn l"><p class="bd b gc z el mk eo ep ml er et ek translated">docs.openzeppelin.com</p></div></div><div class="mo l"><div class="mw l mq mr ms mo mt jv mf"/></div></div></a></div><blockquote class="mx"><p id="83e1" class="my mz ht bd na nb nc nd ne nf ng jn ek translated">加入Coinmonks <a class="ae jo" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae jo" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h1 id="e3a3" class="nh kq ht bd le ni nj nk li nl nm nn lm no np nq lp nr ns nt ls nu nv nw lv nx dt translated">另外，阅读</h1><ul class=""><li id="ab45" class="kb kc ht is b it lx ix ly jb ny jf nz jj oa jn ob kh ki kj dt translated"><a class="ae jo" href="https://coincodecap.com/bookmap-review-2021-best-trading-software" rel="noopener ugc nofollow" target="_blank"> Bookmap点评</a> | <a class="ae jo" href="https://coincodecap.com/crypto-exchange-usa" rel="noopener ugc nofollow" target="_blank">美国5大最佳加密交易所</a></li><li id="82bc" class="kb kc ht is b it oc ix od jb oe jf of jj og jn ob kh ki kj dt translated">最佳加密<a class="ae jo" rel="noopener" href="/coinmonks/hardware-wallets-dfa1211730c6">硬件钱包</a> | <a class="ae jo" rel="noopener" href="/coinmonks/bitbns-review-38256a07e161"> Bitbns评论</a></li><li id="3f73" class="kb kc ht is b it oc ix od jb oe jf of jj og jn ob kh ki kj dt translated"><a class="ae jo" href="https://coincodecap.com/crypto-exchange-in-singapore" rel="noopener ugc nofollow" target="_blank">新加坡十大最佳加密交易所</a> | <a class="ae jo" href="https://coincodecap.com/buy-axs-token" rel="noopener ugc nofollow" target="_blank">购买AXS </a></li><li id="e3ca" class="kb kc ht is b it oc ix od jb oe jf of jj og jn ob kh ki kj dt translated"><a class="ae jo" href="https://coincodecap.com/red-dog-casino-review" rel="noopener ugc nofollow" target="_blank">红狗赌场点评</a> | <a class="ae jo" href="https://coincodecap.com/swyftx-review" rel="noopener ugc nofollow" target="_blank"> Swyftx点评</a> | <a class="ae jo" href="https://coincodecap.com/coingate-review" rel="noopener ugc nofollow" target="_blank"> CoinGate点评</a></li><li id="6319" class="kb kc ht is b it oc ix od jb oe jf of jj og jn ob kh ki kj dt translated"><a class="ae jo" href="https://coincodecap.com/best-crypto-to-invest-in-india-in-2021" rel="noopener ugc nofollow" target="_blank">在印度投资的最佳密码</a>|<a class="ae jo" href="https://coincodecap.com/wazirx-p2p" rel="noopener ugc nofollow" target="_blank">waz rix P2P</a>|<a class="ae jo" href="https://coincodecap.com/hi-dollar-review" rel="noopener ugc nofollow" target="_blank">Hi Dollar Review</a></li><li id="41dd" class="kb kc ht is b it oc ix od jb oe jf of jj og jn ob kh ki kj dt translated"><a class="ae jo" href="https://coincodecap.com/5-best-crypto-trading-bots-in-canada" rel="noopener ugc nofollow" target="_blank">加拿大最佳密码交易机器人</a> | <a class="ae jo" href="https://coincodecap.com/kucoin-review" rel="noopener ugc nofollow" target="_blank">硬币评论</a></li><li id="c90b" class="kb kc ht is b it oc ix od jb oe jf of jj og jn ob kh ki kj dt translated"><a class="ae jo" href="https://coincodecap.com/huobi-crypto-trading-signals" rel="noopener ugc nofollow" target="_blank">火笔密码交易信号</a> | <a class="ae jo" rel="noopener" href="/coinmonks/hitbtc-review-c5143c5d53c2">点击查看</a></li></ul></div></div>    
</body>
</html>