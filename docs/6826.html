<html>
<head>
<title>Test Environment Demo of Hyperledger Fabric</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Hyperledger结构的测试环境演示</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/test-environment-demo-of-hyperledger-fabric-587905eedb16?source=collection_archive---------14-----------------------#2022-05-15">https://medium.com/coinmonks/test-environment-demo-of-hyperledger-fabric-587905eedb16?source=collection_archive---------14-----------------------#2022-05-15</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><p id="3d08" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在我之前的<a class="ae jo" href="https://iwasnothing.medium.com/hyperledger-fabric-privacy-illustration-1a275af403da" rel="noopener">帖子</a>中，我使用了我的简单应用程序来说明Hyperledger Fabric中的隐私控制。在这篇文章中，我将详细解释链码的发展。完整的代码可以从<a class="ae jo" href="https://github.com/iwasnothing/hlf_toy_app/blob/main/sharebook/sharebook.go" rel="noopener ugc nofollow" target="_blank">这里</a>下载。</p><h1 id="a1d5" class="jp jq ht bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">测试环境设置</h1><p id="dc09" class="pw-post-body-paragraph iq ir ht is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hm dt translated">Hyperledger Fabric为代码开发和测试提供了简单的测试环境。安装步骤总结如下:</p><ol class=""><li id="a01e" class="ks kt ht is b it iu ix iy jb ku jf kv jj kw jn kx ky kz la dt translated">下载<a class="ae jo" href="https://github.com/hyperledger/fabric-samples" rel="noopener ugc nofollow" target="_blank">hyperledger/fabric-samples</a>存储库。</li><li id="33b7" class="ks kt ht is b it lb ix lc jb ld jf le jj lf jn kx ky kz la dt translated">下载并执行安装脚本。该脚本将<code class="eh lg lh li lj b">cd</code>到<code class="eh lg lh li lj b">fabric-samples</code>文件夹，并将docker映像和可执行文件下载到/bin和/config目录中。</li></ol><pre class="lk ll lm ln fq lo lj lp lq aw lr dt"><span id="730c" class="ls jq ht lj b fv lt lu l lv lw">curl <strong class="lj hu">-</strong>sSL https:<strong class="lj hu">//</strong>bit<strong class="lj hu">.</strong>ly<strong class="lj hu">/</strong>2ysbOFE <strong class="lj hu">|</strong> bash <strong class="lj hu">-</strong>s</span></pre><p id="d52c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">3.通过运行以下命令启动测试网络，这将启动订购服务、两个对等节点:org1.example.com和org2.example.com，并创建默认通道:“mychannel”。两个成员节点将加入该通道。</p><pre class="lk ll lm ln fq lo lj lp lq aw lr dt"><span id="60dc" class="ls jq ht lj b fv lt lu l lv lw">cd fabric<strong class="lj hu">-</strong>samples<strong class="lj hu">/</strong>test<strong class="lj hu">-</strong>network<br/>./network.sh up createChannel</span></pre><p id="9e44" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">4.安装链码“<code class="eh lg lh li lj b">book</code>”。golang代码存储在文件夹:<code class="eh lg lh li lj b">hlf_toy_app/sharebook/</code></p><pre class="lk ll lm ln fq lo lj lp lq aw lr dt"><span id="c41f" class="ls jq ht lj b fv lt lu l lv lw">cd hlf_toy_app/sharebook/<br/>go mod tidy<br/>go mod vendor<br/>go build<br/>cd ../../fabric<strong class="lj hu">-</strong>samples<strong class="lj hu">/</strong>test<strong class="lj hu">-</strong>network<br/>./network.sh deployCC -ccn book -ccp ../../hlf_toy_app/sharebook/</span></pre><p id="9413" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">命令deployCC将go包部署到默认通道<code class="eh lg lh li lj b">mychannel</code>，然后从每个成员节点调用代码背书和提交。</p><p id="8212" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">对于链码的后续更新，您需要指定版本号和序列号。比如说。</p><pre class="lk ll lm ln fq lo lj lp lq aw lr dt"><span id="ceef" class="ls jq ht lj b fv lt lu l lv lw">./network.sh deployCC -ccn book -ccp ../../hlf_toy_app/sharebook/ -ccl go -ccv 2.0 -ccs 2-verbose</span></pre><h1 id="27a6" class="jp jq ht bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">共享图书图书馆演示</h1><ol class=""><li id="1cb7" class="ks kt ht is b it kn ix ko jb lx jf ly jj lz jn kx ky kz la dt translated">从org1创建一本书。在命令:<code class="eh lg lh li lj b">peer chaincode invoke</code>中，我们需要指定两个成员(ora1和org2)的端点和CA cert来签署事务，因为通道需要所有成员签名。否则，图书状态无法存储在渠道分类账中。</li></ol><pre class="lk ll lm ln fq lo lj lp lq aw lr dt"><span id="c663" class="ls jq ht lj b fv lt lu l lv lw">export PATH=${PWD}/../bin:$PATH<br/>export FABRIC_CFG_PATH=$PWD/../config/<br/>export CORE_PEER_TLS_ENABLED=true<br/>export CORE_PEER_LOCALMSPID="Org1MSP"<br/>export CORE_PEER_TLS_ROOTCERT_FILE=${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt<br/>export CORE_PEER_MSPCONFIGPATH=${PWD}/organizations/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp<br/>export CORE_PEER_ADDRESS=localhost:7051</span><span id="a19a" class="ls jq ht lj b fv ma lu l lv lw">peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile "${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem" -C mychannel -n book --peerAddresses localhost:7051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt" --peerAddresses localhost:9051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt" -c '{"function":"CreateBook","Args":["my book","matthew","123456"]}'</span></pre><p id="9374" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">命令<code class="eh lg lh li lj b">‘{“function”:”CreateBook”,”Args”:[“my book”,”matthew”,”123456"]}’ </code>将调用链码中定义的<a class="ae jo" href="https://github.com/iwasnothing/hlf_toy_app/blob/462b5adf8fe8df83b1e0cedc8a5409ca52e2d475/sharebook/sharebook.go#L144" rel="noopener ugc nofollow" target="_blank">功能</a>。</p><pre class="lk ll lm ln fq lo lj lp lq aw lr dt"><span id="a19d" class="ls jq ht lj b fv lt lu l lv lw">func (s *SmartContract) CreateBook(ctx contractapi.TransactionContextInterface, title string, author string, isbn string ) error {<br/>...<br/>...</span></pre><p id="94ef" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">命令结果将是:</p><pre class="lk ll lm ln fq lo lj lp lq aw lr dt"><span id="b8f3" class="ls jq ht lj b fv lt lu l lv lw">2022-05-15 12:02:31.887 HKT 0001 INFO [chaincodeCmd] chaincodeInvokeOrQuery -&gt; Chaincode invoke successful. result: status:200</span></pre><p id="03bb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">2.查询图书信息。Org1作为所有者可以查询图书信息，但是Org2还不在授权列表中，所以它不能查询图书。该查询将不会返回任何内容。</p><pre class="lk ll lm ln fq lo lj lp lq aw lr dt"><span id="f825" class="ls jq ht lj b fv lt lu l lv lw">test-network %peer chaincode query -C mychannel -n book -c '{"Args":["GetAllBooks"]}'</span><span id="e33b" class="ls jq ht lj b fv ma lu l lv lw">[{"ID":"book_2","Title":"my book","Author":"matthew","Isbn":"123456","Owner":"<a class="ae jo" href="mailto:Admin@org1.example.com" rel="noopener ugc nofollow" target="_blank">Admin@org1.example.com</a>","Holder":{"Org":"","StudentID":""},"IsBorrowed":false,"RequestQueue":[],"EntitleList":["<a class="ae jo" href="mailto:Admin@org1.example.com" rel="noopener ugc nofollow" target="_blank">Admin@org1.example.com</a>"],"ReaderList":[]}]</span></pre><p id="0fc7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu"> <em class="mb">吸取的额外教训:</em> </strong> <em class="mb">本来想用uuid作为图书id，但是发现交易会造成背书错误。这是因为chaincode将在所有成员节点中执行，每个成员执行返回的uuid将是随机的，并导致输出状态不匹配。交易将被拒绝。所以我需要使用图书数量作为ID中的序列号。</em></p><p id="27ac" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">3.在org2中注册学生。由于学生信息只会保存在Org2私有数据集合中，所以我们不需要添加org1来签署交易。此外，传递私有数据集合的参数应该用base64编码，并通过<code class="eh lg lh li lj b">--transient</code>传递。</p><pre class="lk ll lm ln fq lo lj lp lq aw lr dt"><span id="8d1a" class="ls jq ht lj b fv lt lu l lv lw">export STUDENT_PROPERTIES=$(echo -n "{\"Name\":\"kaka\",\"Phone\":\"94071234\",\"Email\":\"a@b.com\"}" | base64 | tr -d \\n)</span><span id="47fa" class="ls jq ht lj b fv ma lu l lv lw">peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile "${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem" -C mychannel -n book    -c '{"function":"RegStudent","Args":[]}' --transient "{\"student_properties\":\"$STUDENT_PROPERTIES\"}"</span><span id="0d4f" class="ls jq ht lj b fv ma lu l lv lw">peer chaincode query -C mychannel -n book -c '{"Args":["GetAllStudents"]}'</span><span id="aa9b" class="ls jq ht lj b fv ma lu l lv lw">[{"Org":"<a class="ae jo" href="mailto:Admin@org2.example.com" rel="noopener ugc nofollow" target="_blank">Admin@org2.example.com</a>","StudentID":"<a class="ae jo" href="mailto:student_1@org2.example.com" rel="noopener ugc nofollow" target="_blank">student_2@org2.example.com</a>","Name":"kaka","Phone":"94071234","Email":"<a class="ae jo" href="mailto:a@b.com" rel="noopener ugc nofollow" target="_blank">a@b.com</a>"}]</span></pre><p id="1b86" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">如果我们在org1中运行查询，它将不会显示学生信息，也不会返回任何内容。</p><p id="c712" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">函数RegStudent是在chaincode中定义的，这里展示了它如何使用<code class="eh lg lh li lj b">ctx.GetStub().GetTransient()</code>从瞬态输入中获取参数</p><pre class="lk ll lm ln fq lo lj lp lq aw lr dt"><span id="2221" class="ls jq ht lj b fv lt lu l lv lw">func (s *SmartContract) RegStudent(ctx contractapi.TransactionContextInterface) error {<br/>  // Get new asset from transient map<br/>  transientMap, err := ctx.GetStub().GetTransient()<br/>  if err != nil {<br/>        return fmt.Errorf("error getting transient: %v", err)<br/>  }</span><span id="ce25" class="ls jq ht lj b fv ma lu l lv lw">// Asset properties are private, therefore they get passed in transient field, instead of func args<br/>  transientStudentJSON, ok := transientMap["student_properties"]<br/>  if !ok {<br/>        return fmt.Errorf("asset not found in the transient map input")<br/>  }</span><span id="cf22" class="ls jq ht lj b fv ma lu l lv lw">type StudentTransientInput struct {<br/>                Name           string `json:"Name"`<br/>                Phone          string `json:"Phone"`<br/>                Email          string `json:"Email"`<br/>  }</span><span id="3166" class="ls jq ht lj b fv ma lu l lv lw">var studentInput StudentTransientInput<br/>err = json.Unmarshal(transientStudentJSON, &amp;studentInput)</span></pre><p id="b780" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated"><strong class="is hu"><em class="mb"/></strong><em class="mb">:在根据学生人数创建新的学生ID时，我发现不能通过查询所有学生来计算学生人数。是因为通过范围搜索查询所有学生后，不允许再次更新学生状态。</em></p><p id="7720" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">4.如果新注册的学生想要运行BorrowBook，将返回错误(500 ),因为我们还没有授予该学生和org2访问该书的权限。</p><pre class="lk ll lm ln fq lo lj lp lq aw lr dt"><span id="875d" class="ls jq ht lj b fv lt lu l lv lw">test-network % peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile "${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem" -C mychannel -n book --peerAddresses localhost:7051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt" --peerAddresses localhost:9051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt" -c '{"function":"BorrowBook","Args":["book_1","<a class="ae jo" href="mailto:student_2@org2.example.com" rel="noopener ugc nofollow" target="_blank">student_2@org2.example.com</a>"]}'</span><span id="5175" class="ls jq ht lj b fv ma lu l lv lw">Error: endorsement failure during invoke. response: status:500 message:"the book book_1 not entitled"</span></pre><p id="a204" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">5.授予学生和组织2访问该书的权限。</p><pre class="lk ll lm ln fq lo lj lp lq aw lr dt"><span id="56e5" class="ls jq ht lj b fv lt lu l lv lw">export PATH=${PWD}/../bin:$PATH<br/>export FABRIC_CFG_PATH=$PWD/../config/<br/>export CORE_PEER_TLS_ENABLED=true<br/>export CORE_PEER_LOCALMSPID="Org1MSP"<br/>export CORE_PEER_TLS_ROOTCERT_FILE=${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt<br/>export CORE_PEER_MSPCONFIGPATH=${PWD}/organizations/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp<br/>export CORE_PEER_ADDRESS=localhost:7051</span><span id="ac45" class="ls jq ht lj b fv ma lu l lv lw">peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile "${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem" -C mychannel -n book --peerAddresses localhost:7051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt" --peerAddresses localhost:9051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt" -c '{"function":"GrantBook","Args":["book_1","Admin@org2.example.com","student_2@org2.example.com"]}'</span><span id="1efe" class="ls jq ht lj b fv ma lu l lv lw">2022-05-15 12:21:26.415 HKT 0001 INFO [chaincodeCmd] chaincodeInvokeOrQuery -&gt; Chaincode invoke successful. result: status:200</span></pre><p id="836a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">6.如果我们再次运行之前的借书，就会成功。</p><p id="0f5a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hm dt translated">在下一篇文章中，我将尝试在AWS管理的区块链上运行相同的链代码。</p><blockquote class="mc"><p id="1cb1" class="md me ht bd mf mg mh mi mj mk ml jn ek translated">加入Coinmonks <a class="ae jo" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank">电报频道</a>和<a class="ae jo" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> Youtube频道</a>了解加密交易和投资</p></blockquote><h1 id="fba5" class="jp jq ht bd jr js jt ju jv jw jx jy jz ka mm kc kd ke mn kg kh ki mo kk kl km dt translated">另外，阅读</h1><ul class=""><li id="3d6d" class="ks kt ht is b it kn ix ko jb lx jf ly jj lz jn mp ky kz la dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/3commas-review-an-excellent-crypto-trading-bot-2020-1313a58bec92">3商业评论</a> | <a class="ae jo" href="https://coincodecap.com/pionex-review-exchange-with-crypto-trading-bot" rel="noopener ugc nofollow" target="_blank"> Pionex评论</a> | <a class="ae jo" rel="noopener" href="/coinmonks/coinrule-review-2021-a-beginner-friendly-crypto-trading-bot-daf0504848ba"> Coinrule评论</a></li><li id="ea84" class="ks kt ht is b it lb ix lc jb ld jf le jj lf jn mp ky kz la dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/ledger-vs-ngrave-zero-7e40f0c1d694">莱杰vs n rave</a>|<a class="ae jo" rel="noopener" href="/coinmonks/ledger-nano-s-vs-x-battery-hardware-price-storage-59a6663fe3b0">莱杰nano s vs x </a> | <a class="ae jo" rel="noopener" href="/coinmonks/binance-review-ee10d3bf3b6e">币安评论</a></li><li id="dfca" class="ks kt ht is b it lb ix lc jb ld jf le jj lf jn mp ky kz la dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/bybit-exchange-review-dbd570019b71"> Bybit交易所评论</a> | <a class="ae jo" href="https://coincodecap.com/bityard-reivew" rel="noopener ugc nofollow" target="_blank"> Bityard评论</a> | <a class="ae jo" href="https://coincodecap.com/jet-bot-review" rel="noopener ugc nofollow" target="_blank"> Jet-Bot评论</a></li><li id="ee89" class="ks kt ht is b it lb ix lc jb ld jf le jj lf jn mp ky kz la dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/3commas-vs-pionex-vs-cryptohopper-best-crypto-bot-6a98d2baa203">3 commas vs crypto hopper</a>|<a class="ae jo" rel="noopener" href="/coinmonks/earn-crypto-interest-b10b810fdda3">赚取加密利息</a></li><li id="45ba" class="ks kt ht is b it lb ix lc jb ld jf le jj lf jn mp ky kz la dt translated">最好的比特币<a class="ae jo" rel="noopener" href="/coinmonks/hardware-wallets-dfa1211730c6">硬件钱包</a> | <a class="ae jo" rel="noopener" href="/coinmonks/bitbox02-review-your-swiss-bitcoin-hardware-wallet-c36c88fff29"> BitBox02回顾</a></li><li id="ef0e" class="ks kt ht is b it lb ix lc jb ld jf le jj lf jn mp ky kz la dt translated"><a class="ae jo" rel="noopener" href="/coinmonks/blockfi-vs-celsius-vs-hodlnaut-8a1cc8c26630">block fi vs Celsius</a>|<a class="ae jo" rel="noopener" href="/coinmonks/hodlnaut-review-best-way-to-hodl-is-to-earn-interest-on-your-bitcoin-6658a8c19edf">Hodlnaut审核</a> | <a class="ae jo" href="https://coincodecap.com/kucoin-review" rel="noopener ugc nofollow" target="_blank"> KuCoin审核</a></li></ul></div></div>    
</body>
</html>