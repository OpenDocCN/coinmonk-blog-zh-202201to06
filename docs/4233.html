<html>
<head>
<title>Bitcoin transaction internals explained</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">比特币交易内部解释</h1>
<blockquote>原文：<a href="https://medium.com/coinmonks/bitcoin-transaction-internals-explained-8fd6d4e77eaa?source=collection_archive---------5-----------------------#2022-04-06">https://medium.com/coinmonks/bitcoin-transaction-internals-explained-8fd6d4e77eaa?source=collection_archive---------5-----------------------#2022-04-06</a></blockquote><div><div class="ef hh hi hj hk hl"/><div class="hm hn ho hp hq"><div class=""/><figure class="fi fk ir is it iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff iq"><img src="../Images/9587b03ff4a4397f29369d8f6fcd65f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_pNXcWPeHZvRpnQiLFYAHA.png"/></div></div><figcaption class="jb jc fg fe ff jd je bd b be z ek">Picture by my daughter, Polina ©</figcaption></figure><h1 id="4ad2" class="jf jg ht bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc dt translated">介绍</h1><p id="8628" class="pw-post-body-paragraph kd ke ht kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la hm dt translated">从工程的角度来看，所有的事务最初都有相同的单一结构。所有的比特币交易都有输入和输出。输入是指其他事务的输出。产出管理资金分配。就是这样。资金被分配给每个交易的一个或多个输出，下一个交易的输入花费前一个交易的资金。如果一个输出在另一个花费输出资金的交易中没有相应的输入，那么这就是<a class="ae lb" href="https://en.wikipedia.org/wiki/Unspent_transaction_output" rel="noopener ugc nofollow" target="_blank">未用交易输出(UTXO) </a>。UTXO是所谓的基于UTXO的电子货币区块链协议的基石。当创建下一个事务时，它总是有与前一个事务的一些未用完的输出相对应的输入。一个输入恰好对应于前一个事务的一个输出。交易输入所涉及的金额总和必须略大于交易输出的总和。两者之差构成了赢得区块的矿工的交易费。如果比特币接受了新的交易，那么之前交易的相应产出就失效了，资金现在对应于新的UTXO。因此，任何由共识协议负责的资产总是对应于UTXO集，比特币节点跟踪和枚举该集。</p><p id="eef7" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">为了接受交易并将资金分配给新的产出，比特币需要执行一个脚本。这个脚本在前一个事务的输出和下一个事务的输入之间进行分割。通常，它们被命名为scriptPubKey和scriptSig(或witness)。这就是诀窍:前一个事务的输出包含第一个脚本部分，该部分包含一些用于认证事务的值；并且下一个事务的输入包含第二脚本部分。只有当第二个脚本部分与第一个脚本部分匹配，并且脚本成功执行时，比特币才可以接受交易。简而言之，scriptPubKey包含带有公钥的脚本部分(可能还有一些逻辑)，scriptSig包含签名，签名由公钥验证。事实上，scriptPubKey和scriptSig要么根本不包含密钥或签名，要么通常包含一些更复杂的数据，如公钥散列、秘密散列及其相应的前图像。</p><p id="e900" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">现在让我们来看看最流行的事务类型，它们可以用所描述的方式来构造。</p><h1 id="3479" class="jf jg ht bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc dt translated">传统格式</h1><h2 id="b420" class="lh jg ht bd jh li lj lk jl ll lm ln jp ko lo lp jt ks lq lr jx kw ls lt kb lu dt translated">P2PKH —支付给公钥哈希</h2><p id="fa2f" class="pw-post-body-paragraph kd ke ht kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la hm dt translated">支付公钥哈希是比特币中最受欢迎的交易类型，其中scriptPubKey包含验证公钥哈希的说明。这种输出可用于提供对应于散列的公钥和匹配公钥的签名:</p><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="270e" class="lh jg ht ma b fv me mf l mg mh">scriptPubKey:<br/>OP_DUP OP_HASH160 &lt;pubKeyHash&gt; OP_EQUALVERIFY OP_CHECKSIG</span><span id="1381" class="lh jg ht ma b fv mi mf l mg mh">scriptSig:<br/>&lt;sig&gt; &lt;pubKey&gt;</span></pre><p id="949e" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">P2PKH交易取代“支付给公钥”交易，其中没有通过在scriptPubKey中散列的公钥盲化:</p><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="6f50" class="lh jg ht ma b fv me mf l mg mh">scriptPubKey:<br/>&lt;pubKey&gt; OP_CHECKSIG</span><span id="c667" class="lh jg ht ma b fv mi mf l mg mh">scriptSig:<br/>&lt;sig&gt;</span></pre><p id="10f0" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">比特币钱包支持使用标准比特币地址的支付到公钥哈希交易。该地址是由前缀为“1”的<a class="ae lb" href="https://en.bitcoin.it/wiki/Base58Check_encoding" rel="noopener ugc nofollow" target="_blank"> Base58Check </a>编码的160位公钥散列。这种交易是将资金从一只手转移到另一只手的常见方式。这种事务和地址目前已被弃用，取而代之的是SegWit事务和地址。</p><h2 id="7aa4" class="lh jg ht bd jh li lj lk jl ll lm ln jp ko lo lp jt ks lq lr jx kw ls lt kb lu dt translated">其他有用的交易类型</h2><p id="df55" class="pw-post-body-paragraph kd ke ht kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la hm dt translated">使用类似P2PKH的<a class="ae lb" href="https://en.bitcoin.it/wiki/Script" rel="noopener ugc nofollow" target="_blank">比特币脚本</a>操作码，可以构建更复杂的逻辑来控制比特币的转移。</p><p id="af55" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">例如，可以创建MultiSig输出，这需要两个或更多签名来花费资金。甚至可以利用阈值多重签名逻辑，如3选2签名:</p><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="9d94" class="lh jg ht ma b fv me mf l mg mh">scriptPubKey:<br/>OP_3 &lt;pubKey1&gt; &lt;pubKey2&gt; &lt;pubKey3&gt; OP_2 OP_CHECKMULTISIG</span><span id="c803" class="lh jg ht ma b fv mi mf l mg mh">scriptSig:<br/>0 &lt;sig1&gt; &lt;sig2&gt;</span></pre><p id="eff6" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">另一个广泛使用的例子是使用OP_RETURN 操作码的<a class="ae lb" href="https://en.bitcoin.it/wiki/OP_RETURN" rel="noopener ugc nofollow" target="_blank">非消耗性输出。使用这种scriptPubKey的交易创建了一个可证明不可描述的输出，任何比特币节点或钱包都会跳过添加到UTXO集。它有存储其他任意数据或焚烧比特币的特殊含义。这样的输出永远不会有相应的scriptSig，因为它永远不会被使用。</a></p><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="127c" class="lh jg ht ma b fv me mf l mg mh">scriptPubKey:<br/>OP_RETURN &lt;data&gt;</span></pre><h2 id="bfdf" class="lh jg ht bd jh li lj lk jl ll lm ln jp ko lo lp jt ks lq lr jx kw ls lt kb lu dt translated">P2SH —支付给脚本哈希</h2><p id="6c67" class="pw-post-body-paragraph kd ke ht kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la hm dt translated">尽管事实上比特币正是以这种方式允许创建复杂的智能合约，但它被弃用，取而代之的是<a class="ae lb" href="https://en.bitcoin.it/wiki/Pay_to_script_hash" rel="noopener ugc nofollow" target="_blank">支付给脚本哈希(P2SH)交易</a>，后者在消费前提供更多隐私。与常见的scriptPubKey/ScriptSig相比，比特币节点将这种类型的交易视为一种独特的形式，并分两个阶段执行:</p><ol class=""><li id="4120" class="mj mk ht kf b kg lc kk ld ko ml ks mm kw mn la mo mp mq mr dt translated">用scriptSig执行common scriptPubKey，实际上是对照作为最后一个scriptSig元素提供的redempte脚本来检查scriptPubKey中提供的脚本哈希；</li><li id="0bb8" class="mj mk ht kf b kg ms kk mt ko mu ks mv kw mw la mo mp mq mr dt translated">如果这些匹配，则执行兑换脚本</li></ol><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="a28d" class="lh jg ht ma b fv me mf l mg mh">scriptPubKey:<br/>OP_HASH160 &lt;scriptHash&gt; OP_EQUAL</span><span id="5914" class="lh jg ht ma b fv mi mf l mg mh">scriptSig:<br/>&lt;scriptParam&gt;… &lt;redeemScript&gt;</span></pre><p id="f4e8" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">例如，与先前的MultiSig相同将如下所示:</p><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="da9f" class="lh jg ht ma b fv me mf l mg mh">scriptPubKey:<br/>OP_HASH160 &lt;multisig_scriptHash&gt; OP_EQUAL</span><span id="1f52" class="lh jg ht ma b fv mi mf l mg mh">scriptSig:<br/>0 &lt;sig1&gt; &lt;sig2&gt;<br/>&lt;OP_3 &lt;pubKey1&gt; &lt;pubKey2&gt; &lt;pubKey3&gt; OP_2 OP_CHECKMULTISIG&gt;</span></pre><p id="5c4b" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">比特币钱包支持此类交易，使用类似P2PKH的带前缀“3”的地址，意味着该地址是由带前缀“3”的<a class="ae lb" href="https://en.bitcoin.it/wiki/Base58Check_encoding" rel="noopener ugc nofollow" target="_blank"> Base58Check </a>编码的脚本的160位哈希。</p><h1 id="0690" class="jf jg ht bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc dt translated">SegWit v0 —隔离证人</h1><p id="8335" class="pw-post-body-paragraph kd ke ht kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la hm dt translated"><a class="ae lb" href="https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki" rel="noopener ugc nofollow" target="_blank"> SegWit </a>是2017年激活的比特币软叉。它尤其旨在克服块大小问题和其他问题，如交易延展性，并降低交易费用。隔离见证的想法是将见证数据或简单见证(以前称为redeemScript)与普通比特币块数据分离。</p><p id="4852" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">由于SegWit是一个软分叉，遗留的前SegWit交易和SegWit交易可能会在比特币中同时共存。有两种方法可以告诉比特币节点在精确交易验证期间激活SegWit逻辑:</p><p id="b398" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">SegWit版本0定义了两种“本地”事务类型:</p><ul class=""><li id="0266" class="mj mk ht kf b kg lc kk ld ko ml ks mm kw mn la mx mp mq mr dt translated">向见证人支付公钥哈希(P2WPKH)</li><li id="97a4" class="mj mk ht kf b kg ms kk mt ko mu ks mv kw mw la mx mp mq mr dt translated">支付给见证脚本哈希(P2WSH)</li></ul><p id="2bbd" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">这些交易格式取代了前SegWit P2PKH和P2SH。此外，为了与比特币钱包兼容，定义了两种交易类型，目前尚不支持SegWit:</p><ul class=""><li id="8ced" class="mj mk ht kf b kg lc kk ld ko ml ks mm kw mn la mx mp mq mr dt translated">嵌套在P2SH中的pay-to-Witness-Public-Key-Hash(P2WPKH-P2SH)</li><li id="b256" class="mj mk ht kf b kg ms kk mt ko mu ks mv kw mw la mx mp mq mr dt translated">嵌套在P2SH中的pay-to-Witness-Script-Hash(P2WSH-P2SH)</li></ul><p id="9408" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">在新规范中，scriptPubKey中的本机SegWit输出包含两个元素:</p><ul class=""><li id="bcb3" class="mj mk ht kf b kg lc kk ld ko ml ks mm kw mn la mx mp mq mr dt translated">SegWit版本:0；</li><li id="1246" class="mj mk ht kf b kg ms kk mt ko mu ks mv kw mw la mx mp mq mr dt translated">见证程序:20字节的公钥散列或32字节的脚本散列。</li></ul><p id="b2ee" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">重要的是，见证程序的大小是区分比特币传输类型的唯一方式:公钥哈希或脚本哈希。同样的原理也适用于钱包使用的SegWit Bech32编码地址。</p><h2 id="9edb" class="lh jg ht bd jh li lj lk jl ll lm ln jp ko lo lp jt ks lq lr jx kw ls lt kb lu dt translated">P2WPKH —支付见证公钥哈希</h2><p id="c808" class="pw-post-body-paragraph kd ke ht kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la hm dt translated">P2WPKH见证程序的大小为20个字节，包含一个公钥哈希。</p><p id="efe9" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">对应的scriptSig为空，见证恰好包含两个元素:签名和公钥。</p><p id="8db8" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">见证元素放在执行堆栈上。然后，在堆栈上评估用于P2PKH事务的相同脚本，首先导致对照来自见证程序的公钥散列来验证公钥，然后对照公钥和事务来验证签名。</p><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="c79d" class="lh jg ht ma b fv me mf l mg mh">scriptPubKey:<br/>0 &lt;pubKeyHash&gt;</span><span id="bcea" class="lh jg ht ma b fv mi mf l mg mh">scriptSig:<br/>-empty-</span><span id="a55e" class="lh jg ht ma b fv mi mf l mg mh">Witness:<br/>&lt;sig&gt; &lt;pubKey&gt;</span></pre><p id="33b2" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">比特币钱包支持使用<a class="ae lb" href="https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki" rel="noopener ugc nofollow" target="_blank"> segwit地址</a>的P2WPKH交易，见证程序由Bech32编码，并以“BC”HRP前缀为前缀，与编码部分用“1”隔开。对于P2WPKH，它是</p><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="4cbb" class="lh jg ht ma b fv me mf l mg mh">bc1||&lt;Bech32(&lt;0&gt;||&lt;PubKeyHash&gt;)&gt;</span></pre><h2 id="71ab" class="lh jg ht bd jh li lj lk jl ll lm ln jp ko lo lp jt ks lq lr jx kw ls lt kb lu dt translated">P2WPKH-P2SH —向嵌套在P2SH中的见证公钥哈希付款</h2><p id="cc58" class="pw-post-body-paragraph kd ke ht kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la hm dt translated">与P2WPKH相同，但</p><ul class=""><li id="61ab" class="mj mk ht kf b kg lc kk ld ko ml ks mm kw mn la mx mp mq mr dt translated">scriptPubKey包含标准的P2SH脚本</li><li id="aab1" class="mj mk ht kf b kg ms kk mt ko mu ks mv kw mw la mx mp mq mr dt translated">scriptSig包含0和20字节的公钥哈希作为单个元素</li><li id="1547" class="mj mk ht kf b kg ms kk mt ko mu ks mv kw mw la mx mp mq mr dt translated">对应的见证元素与普通P2WPKH相同</li></ul><p id="015d" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">单个scriptSig元素由160位哈希进行哈希处理，应该等于scriptPubKey中的scriptHash。</p><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="66b7" class="lh jg ht ma b fv me mf l mg mh">scriptPubKey:<br/>OP_HASH160 &lt;scriptHash&gt; OP_EQUAL</span><span id="591f" class="lh jg ht ma b fv mi mf l mg mh">scriptSig:<br/>&lt;0 &lt;pubKeyHash&gt;&gt;</span><span id="4b30" class="lh jg ht ma b fv mi mf l mg mh">Witness:<br/>&lt;sig&gt; &lt;pubKey&gt;</span></pre><p id="ed29" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">这种见证事务(与P2WSH-P2SH一起)用于从不兼容SegWit的wallet发送SegWit事务。</p><h2 id="ee44" class="lh jg ht bd jh li lj lk jl ll lm ln jp ko lo lp jt ks lq lr jx kw ls lt kb lu dt translated">P2WSH —支付给见证脚本哈希</h2><p id="4f5a" class="pw-post-body-paragraph kd ke ht kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la hm dt translated">见证程序的大小为32字节，包含一个脚本哈希。哈希算法是double Sha256，而不是通常的比特币160位哈希。</p><p id="6905" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">对应的scriptSig为空，见证包含脚本和脚本本身的参数，就像P2SH的scriptSig一样。</p><p id="9d48" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">与P2SH交易处理类似，比特币节点首先加载一个通用P2SH脚本，以验证脚本哈希是否与来自最后一个见证元素的脚本相匹配。然后脚本本身执行，见证元素(除了最后一个元素)放在执行堆栈上。</p><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="58a1" class="lh jg ht ma b fv me mf l mg mh">scriptPubKey:<br/>0 &lt;scriptHash&gt;</span><span id="022a" class="lh jg ht ma b fv mi mf l mg mh">scriptSig:<br/>-empty-</span><span id="8643" class="lh jg ht ma b fv mi mf l mg mh">Witness:<br/>&lt;scriptParam&gt;… &lt;redeemScript&gt;</span></pre><p id="040c" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">让我们以MultiSig交易为例:</p><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="e107" class="lh jg ht ma b fv me mf l mg mh">scriptPubKey:<br/>0 &lt;multisig_scriptHash&gt;</span><span id="b955" class="lh jg ht ma b fv mi mf l mg mh">scriptSig:<br/>-empty-</span><span id="a74b" class="lh jg ht ma b fv mi mf l mg mh">Witness:<br/>0 &lt;sig1&gt; &lt;sig2&gt;<br/>&lt;OP_3 &lt;pubKey1&gt; &lt;pubKey2&gt; &lt;pubKey3&gt; OP_2 OP_CHECKMULTISIG&gt;</span></pre><p id="2c8e" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">由于P2WPKH比特币钱包支持使用SegWit地址的P2WSH交易:</p><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="8287" class="lh jg ht ma b fv me mf l mg mh">bc1||&lt;Bech32(&lt;0&gt;||&lt;scriptHash&gt;)&gt;.</span></pre><p id="d9d0" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">P2WPKH和P2WSH地址通过地址内编码的哈希长度来区分。</p><h2 id="d7a9" class="lh jg ht bd jh li lj lk jl ll lm ln jp ko lo lp jt ks lq lr jx kw ls lt kb lu dt translated">P2WSH -P2SH —向嵌套在P2SH中的见证脚本哈希付款</h2><p id="d547" class="pw-post-body-paragraph kd ke ht kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la hm dt translated">与P2WSH相同，但</p><ul class=""><li id="c028" class="mj mk ht kf b kg lc kk ld ko ml ks mm kw mn la mx mp mq mr dt translated">scriptPubKey包含标准的P2SH脚本和</li><li id="ac29" class="mj mk ht kf b kg ms kk mt ko mu ks mv kw mw la mx mp mq mr dt translated">scriptSig包含0和32字节的脚本哈希作为单个元素</li><li id="2cda" class="mj mk ht kf b kg ms kk mt ko mu ks mv kw mw la mx mp mq mr dt translated">对应的见证元素与普通P2WSH相同</li></ul><p id="7c70" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">单个scriptSig元素由160位哈希进行哈希处理，应该等于scriptPubKey中的scriptHash。</p><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="3fb1" class="lh jg ht ma b fv me mf l mg mh">scriptPubKey:<br/>OP_HASH160 &lt;scriptHash&gt; OP_EQUAL</span><span id="806b" class="lh jg ht ma b fv mi mf l mg mh">scriptSig:<br/>&lt;0 &lt;redeemScriptHash&gt;&gt;</span><span id="8149" class="lh jg ht ma b fv mi mf l mg mh">Witness:<br/>&lt;scriptParam&gt;… &lt;redeemScript&gt;</span></pre><p id="0f74" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">让我们再次以MultiSig交易为例:</p><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="9aed" class="lh jg ht ma b fv me mf l mg mh">scriptPubKey:<br/>OP_HASH160 &lt;scriptHash&gt; OP_EQUAL</span><span id="3660" class="lh jg ht ma b fv mi mf l mg mh">scriptSig:<br/>&lt;0 &lt;multisig_scriptHash&gt;&gt;</span><span id="35ba" class="lh jg ht ma b fv mi mf l mg mh">Witness:<br/>0 &lt;sig1&gt; &lt;sig2&gt;<br/>&lt;OP_3 &lt;pubKey1&gt; &lt;pubKey2&gt; &lt;pubKey3&gt; OP_2 OP_CHECKMULTISIG&gt;</span></pre><h1 id="4697" class="jf jg ht bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc dt translated">SegWit v1 —主根</h1><p id="b561" class="pw-post-body-paragraph kd ke ht kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la hm dt translated">TapRoot是2021年推出的比特币的最新更新。它包含一些针对比特币交易(但不仅限于交易)的重大改进，例如</p><ul class=""><li id="07a6" class="mj mk ht kf b kg lc kk ld ko ml ks mm kw mn la mx mp mq mr dt translated"><a class="ae lb" href="https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki" rel="noopener ugc nofollow" target="_blank">施诺尔签名</a></li><li id="0eae" class="mj mk ht kf b kg ms kk mt ko mu ks mv kw mw la mx mp mq mr dt translated"><a class="ae lb" href="https://github.com/bitcoin/bips/blob/master/bip-0342" rel="noopener ugc nofollow" target="_blank"> TapScript </a>，引入了比特币脚本操作码的一些变化</li><li id="b6e0" class="mj mk ht kf b kg ms kk mt ko mu ks mv kw mw la mx mp mq mr dt translated"><a class="ae lb" href="https://github.com/bitcoin/bips/blob/master/bip-0341.mediawiki" rel="noopener ugc nofollow" target="_blank">新的隔离见证格式和消费路径编码</a></li></ul><p id="3786" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">公开的关于Schnorr签名方案的信息很多。就本条而言，至关重要的是:</p><ul class=""><li id="1e8d" class="mj mk ht kf b kg lc kk ld ko ml ks mm kw mn la mx mp mq mr dt translated">Schorr签名允许将基于同一消息的多个公钥和签名聚合成单个公钥和签名。生成的公钥和签名与公共公钥和签名无法区分。换句话说，第三方观察者无法区分由单个签名人用单个密钥对创建的签名和由多个签名人用他们各自的密钥聚合和创建的签名。事实上，任何人都可以使用聚合公钥来验证聚合签名，聚合公钥在顺序上与普通公钥没有区别。TapRoot使用的MuSig签名方案利用了Schnorr签名的这一特性。</li><li id="2c06" class="mj mk ht kf b kg ms kk mt ko mu ks mv kw mw la mx mp mq mr dt translated">容易注入到Schnorr签名中的适配器或调整允许将附加信息编码到签名中。TapTweak作为TapRoot的核心机制之一，利用这一点来屏蔽由Merkle树中组织的脚本编码的高级事务逻辑的TapRoot公钥存在性。</li></ul><p id="55d6" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">与以前的比特币交易格式相反，Taproot输出不区分公钥花费路径和脚本花费路径。它总是像一个公钥路径:scriptPubKey包含一个由两个元素组成的见证程序:</p><ul class=""><li id="2440" class="mj mk ht kf b kg lc kk ld ko ml ks mm kw mn la mx mp mq mr dt translated">SegWit版本:1；</li><li id="8d3b" class="mj mk ht kf b kg ms kk mt ko mu ks mv kw mw la mx mp mq mr dt translated">32字节见证程序，根据<a class="ae lb" href="https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki#design" rel="noopener ugc nofollow" target="_blank"> BIP340 </a>规则编码的主根公钥。</li></ul><p id="7ac3" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">因此，任何直根交易都是支付到直根(P2TR)。比特币钱包支持P2TR交易，使用独立于消费路径的更新的SegWit地址:</p><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="5b55" class="lh jg ht ma b fv me mf l mg mh">bc1||&lt;Bech32m(&lt;1&gt;||&lt;PubKey&gt;)</span></pre><p id="a362" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">地址格式的更新是关于更新编码<a class="ae lb" href="https://github.com/bitcoin/bips/blob/master/bip-0350.mediawiki" rel="noopener ugc nofollow" target="_blank"> Bech32m </a>。</p><p id="6921" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">有许多合法的方式来使用直根产品，如下所述。</p><h2 id="527e" class="lh jg ht bd jh li lj lk jl ll lm ln jp ko lo lp jt ks lq lr jx kw ls lt kb lu dt translated">公钥路径开销</h2><p id="8356" class="pw-post-body-paragraph kd ke ht kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la hm dt translated">如果只有一方控制主根输出，则可以使用公钥花费路径。这是花费主根产出的最简单的方法。</p><p id="8272" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">公钥花费路径的另一个例子是所有控制方的相互协作协议。在这种情况下，所有各方使用他们的独立私钥协作创建事务聚合签名，这些私钥先前用于创建在输出的见证程序中定义的聚合公钥。</p><p id="754d" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">见证应该包含一个元素，它是对来自见证程序的公钥有效的事务签名</p><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="63d4" class="lh jg ht ma b fv me mf l mg mh">scriptPubKey:<br/>1 &lt;pubKey&gt;</span><span id="7ab5" class="lh jg ht ma b fv mi mf l mg mh">scriptSig:<br/>-empty-</span><span id="dc91" class="lh jg ht ma b fv mi mf l mg mh">Witness:<br/>&lt;sig&gt;</span></pre><h2 id="5722" class="lh jg ht bd jh li lj lk jl ll lm ln jp ko lo lp jt ks lq lr jx kw ls lt kb lu dt translated">脚本路径开销</h2><p id="80b8" class="pw-post-body-paragraph kd ke ht kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la hm dt translated">不考虑使用公钥路径花费P2TR输出的可能性，它可能有另一种花费方式:脚本路径。当合作消费是不可能的时候，它可以作为一个后备方案。Merkle树中组织的单个脚本或多个脚本可以用于涵盖许多不同的场景。</p><p id="5c87" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">使用相同的UTXO的scriptPubKey，见证看起来如下:</p><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="773b" class="lh jg ht ma b fv me mf l mg mh">scriptPubKey:<br/>1 &lt;pubKey&gt;</span><span id="0a88" class="lh jg ht ma b fv mi mf l mg mh">scriptSig:<br/>-empty-</span><span id="0432" class="lh jg ht ma b fv mi mf l mg mh">Witness:<br/>&lt;script&gt; &lt;controlBlock&gt;</span></pre><p id="ce56" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">控制块的结构如下:</p><ul class=""><li id="d3f5" class="mj mk ht kf b kg lc kk ld ko ml ks mm kw mn la mx mp mq mr dt translated">第一个字节编码一个叶版本(总是偶数)和抽头调整奇偶标志(见<a class="ae lb" href="https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki" rel="noopener ugc nofollow" target="_blank"> BIP-340 </a>的<code class="eh my mz na ma b">has_even_y(P)</code>函数定义):</li></ul><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="adc2" class="lh jg ht ma b fv me mf l mg mh">leafVersion = controlBlock[0] &amp; 0xfe<br/>tweakParity = controlBlock[0] &amp; 0x1</span></pre><blockquote class="nb nc nd"><p id="d430" class="kd ke ne kf b kg lc ki kj kk ld km kn nf le kq kr ng lf ku kv nh lg ky kz la hm dt translated">目前的比特币实现允许唯一唯一的叶子版本:<code class="eh my mz na ma b">0xc0</code>；</p></blockquote><ul class=""><li id="f7a8" class="mj mk ht kf b kg lc kk ld ko ml ks mm kw mn la mx mp mq mr dt translated">接下来的32个字节编码内部公钥<code class="eh my mz na ma b">P</code>；</li><li id="3115" class="mj mk ht kf b kg ms kk mt ko mu ks mv kw mw la mx mp mq mr dt translated">所有剩余的数据都是Merkle树中脚本的路径</li></ul><p id="741c" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">为了创建或解释控制块，TapRoot规范运行所谓的标记散列函数</p><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="b729" class="lh jg ht ma b fv me mf l mg mh">hash_{tag}(x) = Sha256(Sha256(tag)||Sha256(tag)||x)</span></pre><p id="b15b" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">下图显示了脚本Merkle树的示意性示例:</p><figure class="lv lw lx ly fq iu fe ff paragraph-image"><div role="button" tabindex="0" class="iv iw di ix bf iy"><div class="fe ff ni"><img src="../Images/cc801344e3270f40f01d7e4c62c791ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6ZbhsG7JVMDpof8PLMEtbg.png"/></div></div><figcaption class="jb jc fg fe ff jd je bd b be z ek">Taproot transaction script Merkle tree example</figcaption></figure><p id="fecd" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">让我们从图片上看一下<code class="eh my mz na ma b">Script B</code>的验证过程。</p><ol class=""><li id="321d" class="mj mk ht kf b kg lc kk ld ko ml ks mm kw mn la mo mp mq mr dt translated">计算<code class="eh my mz na ma b">Script B</code>的TapLeaf哈希:</li></ol><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="d28d" class="lh jg ht ma b fv me mf l mg mh">b = hash_{TapLeaf}(0xc0||compactSize(Script B)||Script B)</span></pre><p id="5319" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">2.遍历Merkle树从叶b到根的分支<code class="eh my mz na ma b">abcd</code>:Merkle树路径中每接下来的32个字节是先前计算的节点散列的邻居节点散列。</p><ul class=""><li id="26eb" class="mj mk ht kf b kg lc kk ld ko ml ks mm kw mn la mx mp mq mr dt translated">这里，前32个字节是<code class="eh my mz na ma b">hash a</code>的值，它是本例中<code class="eh my mz na ma b">Script B</code>或<code class="eh my mz na ma b">hash b</code>的散列的邻居。然后</li></ul><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="bc1f" class="lh jg ht ma b fv me mf l mg mh">ab = hash_{TapBranch}(a||b)</span></pre><p id="faf8" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">3.注意，每个<code class="eh my mz na ma b">hash_{TapBranch}(…)</code>下的连接顺序取决于<code class="eh my mz na ma b">hash a</code>和<code class="eh my mz na ma b">hash b</code>的词典比较。因此，它们必须按照词典的排序顺序连接起来。</p><ul class=""><li id="b904" class="mj mk ht kf b kg lc kk ld ko ml ks mm kw mn la mx mp mq mr dt translated">后面32个字节是ab的邻居，也就是<code class="eh my mz na ma b">hash cd</code>。然后散列</li></ul><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="bc12" class="lh jg ht ma b fv me mf l mg mh">abcd = hash_{TapBranch}(ab||cd)</span></pre><p id="1048" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">这是Merkle分支的根。不要忘记词典的顺序。</p><p id="3240" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">4.现在是计算TapTweak的时候了，该tap tweak用于根据前面输出的公钥<code class="eh my mz na ma b">Q</code>验证整个构造。</p><pre class="lv lw lx ly fq lz ma mb mc aw md dt"><span id="c819" class="lh jg ht ma b fv me mf l mg mh">t = hash_{TapTweak}(P||abcd)</span></pre><p id="9f55" class="pw-post-body-paragraph kd ke ht kf b kg lc ki kj kk ld km kn ko le kq kr ks lf ku kv kw lg ky kz la hm dt translated">5.最后一步是将TapTweak应用到内部公钥<code class="eh my mz na ma b">P</code>。结果应该是公钥<code class="eh my mz na ma b">Q = P + t·G</code>。如果不是这样，那么就会出错，并且TapRoot事务无效，并且<code class="eh my mz na ma b">Script B</code>永远不会执行。</p><blockquote class="nj"><p id="c1ab" class="nk nl ht bd nm nn no np nq nr ns la ek translated"><em class="nt">加入Coinmonks </em> <a class="ae lb" href="https://t.me/coincodecap" rel="noopener ugc nofollow" target="_blank"> <em class="nt">电报频道</em> </a> <em class="nt">和</em> <a class="ae lb" href="https://www.youtube.com/c/coinmonks/videos" rel="noopener ugc nofollow" target="_blank"> <em class="nt"> Youtube频道</em> </a> <em class="nt">了解加密交易和投资</em></p></blockquote><h1 id="0063" class="jf jg ht bd jh ji jj jk jl jm jn jo jp jq nu js jt ju nv jw jx jy nw ka kb kc dt translated">另外，阅读</h1><ul class=""><li id="8384" class="mj mk ht kf b kg kh kk kl ko nx ks ny kw nz la mx mp mq mr dt translated"><a class="ae lb" href="https://coincodecap.com/bookmap-review-2021-best-trading-software" rel="noopener ugc nofollow" target="_blank"> Bookmap评论</a> | <a class="ae lb" href="https://coincodecap.com/crypto-exchange-usa" rel="noopener ugc nofollow" target="_blank">美国5大最佳加密交易所</a></li><li id="1c5c" class="mj mk ht kf b kg ms kk mt ko mu ks mv kw mw la mx mp mq mr dt translated">最佳加密<a class="ae lb" rel="noopener" href="/coinmonks/hardware-wallets-dfa1211730c6">硬件钱包</a> | <a class="ae lb" rel="noopener" href="/coinmonks/bitbns-review-38256a07e161"> Bitbns评论</a></li><li id="f8c0" class="mj mk ht kf b kg ms kk mt ko mu ks mv kw mw la mx mp mq mr dt translated"><a class="ae lb" href="https://coincodecap.com/crypto-exchange-in-singapore" rel="noopener ugc nofollow" target="_blank">新加坡十大最佳加密交易所</a> | <a class="ae lb" href="https://coincodecap.com/buy-axs-token" rel="noopener ugc nofollow" target="_blank">收购AXS </a></li><li id="8132" class="mj mk ht kf b kg ms kk mt ko mu ks mv kw mw la mx mp mq mr dt translated"><a class="ae lb" href="https://coincodecap.com/red-dog-casino-review" rel="noopener ugc nofollow" target="_blank">红狗赌场评论</a> | <a class="ae lb" href="https://coincodecap.com/swyftx-review" rel="noopener ugc nofollow" target="_blank"> Swyftx评论</a> | <a class="ae lb" href="https://coincodecap.com/coingate-review" rel="noopener ugc nofollow" target="_blank"> CoinGate评论</a></li><li id="d904" class="mj mk ht kf b kg ms kk mt ko mu ks mv kw mw la mx mp mq mr dt translated"><a class="ae lb" href="https://coincodecap.com/best-crypto-to-invest-in-india-in-2021" rel="noopener ugc nofollow" target="_blank">投资印度的最佳加密软件</a>|<a class="ae lb" href="https://coincodecap.com/wazirx-p2p" rel="noopener ugc nofollow" target="_blank">WazirX P2P</a>|<a class="ae lb" href="https://coincodecap.com/hi-dollar-review" rel="noopener ugc nofollow" target="_blank">Hi Dollar Review</a></li></ul></div></div>    
</body>
</html>