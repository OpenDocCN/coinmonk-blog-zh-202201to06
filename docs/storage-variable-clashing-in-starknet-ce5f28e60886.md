# StarkNet ä¸­çš„å­˜å‚¨å˜é‡å†²çª

> åŸæ–‡ï¼š<https://medium.com/coinmonks/storage-variable-clashing-in-starknet-ce5f28e60886?source=collection_archive---------4----------------------->

## StarkNet æ™ºèƒ½åˆåŒå’Œæœ€ä½³é¢„é˜²å®è·µå¦‚ä½•å¯¼è‡´å­˜å‚¨å†²çª

![](img/7b6253f9ec60f45251110b09537d331c.png)

## ğŸ—„ï¸:ä»“åº“æ˜¯å¦‚ä½•å¤„ç†çš„ï¼Ÿ

StarkNet ä¸Šçš„åˆåŒå­˜å‚¨é€šè¿‡ç®€å•çš„é”®/å€¼å¯¹æ¥å¤„ç†ã€‚æ ¹æ® [StarkNet æ–‡æ¡£:](https://starknet.io/documentation/contracts/#contracts_storage)

> **å­˜å‚¨å¸ƒå±€**
> 
> åå®šå­˜å‚¨æ˜¯ä¸€ä¸ªæŒä¹…æ€§å­˜å‚¨ç©ºé—´ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­è¯»å–ã€å†™å…¥ã€ä¿®æ”¹å’Œä¿å­˜æ•°æ®ã€‚å­˜å‚¨æ˜¯ä¸€ä¸ªå…·æœ‰ 2 ä¸ªâµæ§½çš„æ˜ å°„ï¼Œå…¶ä¸­æ¯ä¸ªæ§½æ˜¯ä¸€ä¸ªæ¯›æ¯¡ï¼Œå¹¶è¢«åˆå§‹åŒ–ä¸º 0ã€‚
> 
> **å­˜å‚¨åŸºæœ¬åŠŸèƒ½**
> 
> è¯»å–å­˜å‚¨çš„åŸºæœ¬å‡½æ•°è¿”å›å­˜å‚¨åœ¨`key`ä¸­çš„`value`
> 
> `let (value) = storage_read(key)`
> 
> å†™å…¥å­˜å‚¨å™¨çš„åŸºæœ¬åŠŸèƒ½æ˜¯å°†`value`å†™å…¥`key`
> 
> `storage_write(key, value)`

ç”¨`@storage_var`ä¿®é¥°çš„å­˜å‚¨å˜é‡æœ‰ä¸€ç‚¹å¤æ‚ã€‚StarkNet ç¼–è¯‘å™¨å°†å®ƒä»¬çš„åç§°å’Œå€¼(ç”¨ Cairo ä»£ç )æ˜ å°„åˆ° StarkNet è‡ªå·±çš„`sn_keccak`æ–¹æ³•ç”Ÿæˆçš„åœ°å€(æŒ‰åŸæ ·æˆ–é€šè¿‡æ•£åˆ—é“¾è¿›è¡ŒåµŒå¥—æ˜ å°„)ã€‚ç„¶è€Œï¼Œè¿™é‡Œé‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œå­˜å‚¨å˜é‡è¢«ç®€å•åœ°è§†ä¸ºæ•£åˆ—çš„é”®/å€¼å¯¹ã€‚

## StarkNet ä¸­çš„åˆåŒå¯æ‰©å±•æ€§

OpenZeppelin å¼€åˆ›äº†[å¯æ‰©å±•æ€§æ¨¡å¼](https://github.com/OpenZeppelin/cairo-contracts/blob/main/docs/Extensibility.md)ï¼Œå®ƒåŒ…å«äº†ä»ä¹…ç»è€ƒéªŒçš„åº“ä¸­å®‰å…¨å¯¼å…¥åŠŸèƒ½å’ŒçŠ¶æ€çš„å¥‘çº¦æŒ‡å—ã€‚åŸºæœ¬æ€æƒ³æ˜¯å¥‘çº¦ä»åº“ä¸­å¯¼å…¥å’Œå…¬å¼€(ç”¨`@external`å’Œ`@view`decorator)å®ƒä»¬æƒ³è¦ä½¿ç”¨çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œè€ƒè™‘æµè¡Œçš„ ERC20 åº“ã€‚éƒ¨ç½² ERC20 ä»¤ç‰Œçš„æ‰€æœ‰æ–¹æ³•å’ŒçŠ¶æ€ç®¡ç†éƒ½å·²ç»å­˜åœ¨äºåº“ä¸­ã€‚ç”¨æˆ·åªéœ€è¦åœ¨åˆåŒä¸­å…¬å¼€å¿…è¦çš„æ–¹æ³•ï¼Œç§ï¼æ‚¨çš„åˆåŒå·²å‡†å¤‡å¥½éƒ¨ç½²ã€‚

> åº“ä¸å…¬å¼€å®ƒä»¬çš„æ–¹æ³•çš„åŸå› æ˜¯ Cairo ä¼šè‡ªåŠ¨å¯¼å‡ºå®ƒä»¬ï¼Œä¸ç®¡å®ƒä»¬æ˜¯å¦è¢«å¯¼å…¥ã€‚è¿™å¯èƒ½å¾ˆå±é™©ã€‚

è¿™ç§æ¨¡å¼çš„æœ‰è¶£é—®é¢˜æ˜¯:å¦‚æœåº“ç”¨å­˜å‚¨å˜é‡è®¾ç½®è‡ªå·±çš„çŠ¶æ€ï¼Œé‚£ä¹ˆå½“ä¸€ä¸ªå¥‘çº¦ä»å¤šä¸ªå…±äº«ç›¸åŒå­˜å‚¨å˜é‡åç§°çš„åº“å¯¼å…¥æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

## ğŸ’¥æ¥è‡ªä¸åŒåº“çš„å­˜å‚¨å†²çª

è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸¤ä¸ªåº“:

è™½ç„¶ç¤ºä¾‹æ–¹æ³•å…±äº«ç›¸åŒçš„åç§°ï¼Œä½†æ˜¯å®ƒä»¬å±äºå®ƒä»¬å„è‡ªçš„åç§°ç©ºé—´ï¼Œå³`LIBRARY_A.increase_balance`å’Œ`LIBRARY_B_increase_balance`ã€‚ç„¶è€Œï¼Œå­˜å‚¨å˜é‡`balance`ä¸åŒ…å«åœ¨ä»»ä½•ä¸€ä¸ªåç§°ç©ºé—´ä¸­ã€‚è®°ä½è¿™ä¸€ç‚¹å¾ˆé‡è¦ã€‚

ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸ªå°†ä»è¿™äº›åº“å¯¼å…¥å¹¶å…¬å¼€å®ƒä»¬çš„æ–¹æ³•çš„å¥‘çº¦ã€‚

æ³¨æ„ï¼Œä¸¤ä¸ªåº“çš„å­˜å‚¨éƒ½æ²¡æœ‰æ˜¾å¼åœ°å¯¼å…¥åˆ°å¥‘çº¦ä¸­â€”â€”åªæœ‰åç§°ç©ºé—´ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ *contract_c* çš„å…¬å¼€æ–¹æ³•ï¼Œçœ‹çœ‹åº“å„è‡ªçš„å­˜å‚¨å‘ç”Ÿäº†ä»€ä¹ˆã€‚

ç»“æœæ˜¯:

![](img/7d6ea0b76223162cfdda33f966f71bd8.png)

ç­‰ç­‰ï¼Œå‘ç”Ÿä»€ä¹ˆäº‹äº†ï¼ŸStarkNet ç¼–è¯‘å™¨æ²¡æœ‰*è€Œä¸æ˜¯*åŒºåˆ†è¿™ä¸¤ä¸ª`balance`å­˜å‚¨å˜é‡ï¼Œå°½ç®¡å®ƒä»¬ä¼¼ä¹â€œç§ä¸‹â€å±äºå„è‡ªçš„åº“ã€‚æ¢å¥è¯è¯´ï¼Œç¼–è¯‘å™¨å°†ä¸¤ä¸ª`balance`å­˜å‚¨å˜é‡è§†ä¸ºå¯¹åŒä¸€ä¸ªå˜é‡çš„å¼•ç”¨ã€‚

ç„¶è€Œï¼Œå¦‚æœåŒåå­˜å‚¨å˜é‡æœ‰ä»»ä½•ä¸åŒï¼ŒStarkNet ç¼–è¯‘å™¨*å°†*å¤±è´¥ã€‚è¿™äº›å·®å¼‚åŒ…æ‹¬å˜é‡åã€è¿”å›å€¼åå’Œé”®çš„æ•°é‡ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥è¯´æ˜:

```
# library_a
...@storage_var
func balance() -> (**res**: felt):
end
...
-----------------------------------------# library_b
...@storage_var
func balance() -> (**var**: felt):
end
...
```

å¦‚æœæˆ‘ä»¬å¦‚ä¸Šä¿®æ”¹ *library_b* ä¸­çš„è¿”å›å˜é‡åï¼Œå¹¶å°è¯•ç¼–è¯‘ *contract_c* ï¼Œç¼–è¯‘å°†ä¼šå¤±è´¥ã€‚ä»»ä½•æ­¤ç±»å·®å¼‚éƒ½å°†è¿”å›æ­¤ AssertionError:

```
f'Found two versions of auto-generated file "{input_file.filename}":\n'
AssertionError: Found two versions of auto-generated file "autogen/starknet/storage_var/balance/impl.cairo":
...
```

è¦ç‚¹:å¦‚æœä¸€ä¸ªå¥‘çº¦ä»å¤šä¸ªåº“å¯¼å…¥ï¼Œè€Œè¿™äº›åº“æ°å¥½å…±äº«ä¸€ä¸ªå­˜å‚¨å˜é‡å(å³`balance`)ï¼Œé‚£ä¹ˆå¦‚æœç¼–è¯‘å™¨æ²¡æœ‰æ•æ‰åˆ°è¿™äº›å˜é‡ï¼Œå®ƒä»¬å¾ˆå¯èƒ½ä¼šå‘ç”Ÿå†²çªã€‚

## ğŸ›¡ ï¸Prevent å­˜å‚¨å˜é‡å†²çª

åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œæœ€å¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨å­˜å‚¨å˜é‡åå‰åŠ ä¸Šåº“çš„åç§°æˆ–å‘½åç©ºé—´ã€‚æ¯”å¦‚:`ERC20_balances`ã€`ReentrancyGuard_start`ã€`Ownable_owner`ã€‚

ä¸ºäº†éªŒè¯æ¦‚å¿µï¼Œè®©æˆ‘ä»¬å°†ç¤ºä¾‹åº“çš„å­˜å‚¨å˜é‡æ”¹ä¸º`LIBRARY_A_balance`å’Œ`LIBRARY_B_balance`ã€‚

è¿è¡Œå®Œå…¨ç›¸åŒçš„æµ‹è¯•åï¼Œç»“æœå¦‚ä¸‹:

![](img/696b3db883660a1ed4758ed6e7fa1282.png)

## ç»“è®º

é‰´äº StarkNet ç½‘ç»œå’Œ Cairo ç¼–ç¨‹è¯­è¨€æ˜¯å¦‚æ­¤æ–°é¢–å’Œå…ˆè¿›ï¼Œæœ€ä½³å®è·µå°†ä¸å¯é¿å…åœ°éšç€ç°æœ‰æ¨¡å¼å’Œæƒ¯ä¾‹çš„å‘å±•å’Œæ–°çš„æ¨¡å¼å’Œæƒ¯ä¾‹çš„å‡ºç°è€Œæ”¹å˜ã€‚åŒæ—¶ï¼Œç»™ä½ çš„å­˜å‚¨å˜é‡åŠ ä¸Šå‰ç¼€ï¼

ç‰¹åˆ«æ„Ÿè°¢é©¬ä¸Â·ç‰¹é‡Œã€æœ±ä¸½èÂ·é‚“è’‚æ–¯å’Œ [OpenZeppelin](https://openzeppelin.com/) æ¿€å‘äº†è¿™é¡¹ç ”ç©¶ã€‚ç‚¹å‡»æŸ¥çœ‹åŸè®¨è®º[ã€‚](https://github.com/OpenZeppelin/cairo-contracts/pull/236#discussion_r838265315)

æœ‰å…´è¶£äº†è§£æ›´å¤šå…³äº StarkNet å’Œ Cairo çš„ä¿¡æ¯å—ï¼ŸæŸ¥çœ‹è¿™äº›ä¼˜ç§€çš„èµ„æº:

*   [StarkNet å’Œ Cairo å®˜æ–¹æ–‡æ¡£](https://www.cairo-lang.org/docs/)
*   [æ–¯å¡”å…‹å°¼è¨æ»¡](https://community.starknet.io/)
*   [Cairo open zeppelin åˆåŒå…¥é—¨](https://blog.openzeppelin.com/getting-started-with-openzeppelin-contracts-for-cairo/)
*   ä¸ºäº†æ›´å…¨é¢çš„åå•:[çœŸæ£’ StarkNet](https://github.com/gakonst/awesome-starknet)

> åŠ å…¥ Coinmonks [ç”µæŠ¥é¢‘é“](https://t.me/coincodecap)å’Œ [Youtube é¢‘é“](https://www.youtube.com/c/coinmonks/videos)äº†è§£åŠ å¯†äº¤æ˜“å’ŒæŠ•èµ„

# å¦å¤–ï¼Œé˜…è¯»

*   [æœ€ä½³ä»¥å¤ªåŠé’±åŒ…](https://coincodecap.com/best-ethereum-wallets) | [ç”µæŠ¥ä¸Šçš„åŠ å¯†è´§å¸æœºå™¨äºº](https://coincodecap.com/telegram-crypto-bots)
*   äº¤æ˜“æ æ†ä»£å¸çš„æœ€ä½³äº¤æ˜“æ‰€ | [è´­ä¹°å¼—æ´›åŸº](https://coincodecap.com/buy-floki-inu-token)
*   [3Commas å¯¹ Pionex å¯¹ Cryptohopper](https://coincodecap.com/3commas-vs-pionex-vs-cryptohopper) | [Bingbon è¯„è®º](https://coincodecap.com/bingbon-review)
*   [åŠ å¯†å¤åˆ¶äº¤æ˜“å¹³å°](/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c) | [å¦‚ä½•åœ¨ WazirX ä¸Šè´­ä¹°æ¯”ç‰¹å¸](/coinmonks/buy-bitcoin-on-wazirx-2d12b7989af1)
*   [CoinLoan è¯„è®º](https://coincodecap.com/coinloan-review)|[Crypto.com è¯„è®º](/coinmonks/crypto-com-review-f143dca1f74c)